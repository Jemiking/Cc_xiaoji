# CC小记模块架构详解

## 1. 模块总览

CC小记采用基于领域的模块化架构，共包含11个主要模块：

| 模块类型 | 模块名称 | 职责描述 | 依赖关系 |
|---------|---------|---------|----------|
| **应用模块** | app | 应用入口、全局导航、模块组装 | 依赖所有模块 |
| **核心模块** | core:common | 基础工具、扩展函数、常量定义 | 无依赖 |
| | core:database | Room数据库、DAO、实体定义 | 依赖core:common |
| | core:ui | UI主题、通用组件 | 依赖core:common |
| | core:data | 数据层基础设施 | 依赖core:common |
| **功能模块** | feature:ledger | 记账功能（财务管理） | 依赖core和shared |
| | feature:todo | 待办功能（任务管理） | 依赖core和shared |
| | feature:habit | 习惯功能（习惯养成） | 依赖core和shared |
| | feature:schedule | 排班功能（工作管理） | 依赖core和shared |
| **共享模块** | shared:user | 用户管理、认证 | 依赖core |
| | shared:sync | 数据同步管理 | 依赖core |
| | shared:backup | 备份恢复功能 | 依赖core |
| | shared:notification | 通知管理 | 依赖core |

## 2. 各模块详细说明

### 2.1 App模块

**路径**: `/app`

**主要职责**:
- 应用程序入口（MainActivity、Application）
- 全局导航管理（NavGraph）
- 模块依赖注入桥接
- 首页聚合展示
- 全局功能（个人中心、设置等）

**关键文件**:
```
app/
├── CcXiaoJiApplication.kt      # 应用入口
├── MainActivity.kt             # 单Activity架构
├── di/
│   ├── DatabaseModule.kt       # 数据库提供
│   ├── *BridgeModuleImpl.kt    # 模块桥接实现
├── initialization/
│   ├── AppInitializer.kt       # 懒加载管理
├── navigation/
│   ├── NavGraph.kt            # 全局导航图
└── presentation/
    ├── ui/home/               # 首页
    └── viewmodel/             # 全局ViewModel
```

### 2.2 Core模块

#### 2.2.1 core:common

**主要内容**:
- `BaseViewModel`: 所有ViewModel的基类
- `Result<T>`: 统一的结果封装
- `CurrencyFormatter`: 货币格式化
- `DateUtils`: 日期处理工具
- 各种Kotlin扩展函数

#### 2.2.2 core:database

**数据库版本**: 4

**实体数量**: 16个

**主要组件**:
- `CcDatabase`: Room数据库主类
- `Converters`: 类型转换器
- 13个DAO接口
- 数据库迁移文件

#### 2.2.3 core:ui

**主要内容**:
- Material3主题系统
- 通用UI组件（LoadingIndicator、ErrorDialog等）
- 颜色和字体定义

### 2.3 Feature模块

#### 2.3.1 feature:ledger（记账模块）

**功能范围**:
- 账户管理（支持多账户、信用卡）
- 交易记录（收支记录）
- 预算管理（月度/年度预算）
- 分类管理（层级分类）
- 存钱目标（储蓄计划）
- 统计分析（各种报表）
- 定期交易（自动记账）

**模块结构**:
```
feature:ledger/
├── api/
│   ├── LedgerApi.kt           # 对外接口（20+方法）
│   └── LedgerNavigator.kt     # 导航接口
├── data/
│   ├── repository/            # 8个Repository
│   ├── di/LedgerModule.kt    # 依赖注入
│   └── worker/               # 后台任务
├── domain/
│   └── model/                # 领域模型
└── presentation/
    ├── ui/                   # 20+个界面
    ├── viewmodel/            # 8个ViewModel
    └── navigation/           # 6个子导航
```

#### 2.3.2 feature:todo（待办模块）

**功能范围**:
- 任务创建和管理
- 任务分类
- 优先级设置
- 提醒通知
- 完成统计

**关键API方法**:
```kotlin
interface TodoApi {
    suspend fun getTodayTasks(): List<Task>
    suspend fun getTaskCount(): Int
    fun getAllTasks(): Flow<List<Task>>
    fun navigateToTodoList()
}
```

#### 2.3.3 feature:habit（习惯模块）

**功能范围**:
- 习惯创建和追踪
- 打卡记录
- 连续天数统计
- 习惯提醒
- 成就系统

**关键API方法**:
```kotlin
interface HabitApi {
    suspend fun getTodayHabits(): List<HabitItem>
    suspend fun getHabitStats(): HabitStats
    fun getAllHabits(): Flow<List<HabitWithStreak>>
    fun navigateToHabitList()
}
```

#### 2.3.4 feature:schedule（排班模块）

**功能范围**:
- 班次管理（创建、编辑、激活/停用）
- 灵活排班（单日、批量、循环、轮班）
- 日历视图（月度展示、快速导航）
- 统计分析（工时统计、班次分布）
- 数据导出（CSV、JSON格式）
- 排班提醒（通知管理）

**模块结构**:
```
feature:schedule/
├── api/
│   ├── ScheduleApi.kt         # 对外接口（10+方法）
│   └── ScheduleNavigator.kt   # 导航接口
├── data/
│   ├── repository/            # 2个Repository
│   ├── scheduler/             # 通知调度
│   └── worker/                # 后台任务
├── domain/
│   ├── model/                 # 4个领域模型
│   ├── repository/            # 仓库接口
│   └── usecase/               # 8个用例
└── presentation/
    ├── ui/                    # 10+个界面
    ├── viewmodel/             # 7个ViewModel
    └── navigation/            # 导航配置
```

**关键API方法**:
```kotlin
interface ScheduleApi {
    suspend fun getTodaySchedule(): ScheduleInfo?
    suspend fun getMonthStatistics(): ScheduleStatistics
    fun getAllSchedules(): Flow<List<Schedule>>
    fun navigateToSchedule()
}
```

### 2.4 Shared模块

#### 2.4.1 shared:user

**功能**:
- 用户登录/注册
- 用户信息管理
- 认证状态维护

#### 2.4.2 shared:sync

**功能**:
- 数据同步管理
- 冲突解决
- 同步状态追踪

#### 2.4.3 shared:backup

**功能**:
- 本地备份
- 数据导出/导入
- 备份调度

#### 2.4.4 shared:notification

**功能**:
- 通知调度
- 通知渠道管理
- 各模块通知支持

## 3. 模块间依赖矩阵

```
            │ app │ ledger │ todo │ habit │schedule│ user │ sync │ backup │ notif │ common │ db │ ui │ data │
────────────┼─────┼────────┼──────┼───────┼────────┼──────┼──────┼────────┼───────┼────────┼────┼────┼──────┤
app         │  -  │   ✓    │  ✓   │   ✓   │   ✓    │  ✓   │  ✓   │   ✓    │   ✓   │   ✓    │ ✓  │ ✓  │  ✓   │
ledger      │  ✗  │   -    │  ✗   │   ✗   │   ✗    │  ✓   │  ✓   │   ✓    │   ✓   │   ✓    │ ✓  │ ✓  │  ✓   │
todo        │  ✗  │   ✗    │  -   │   ✗   │   ✗    │  ✓   │  ✓   │   ✓    │   ✓   │   ✓    │ ✓  │ ✓  │  ✓   │
habit       │  ✗  │   ✗    │  ✗   │   -   │   ✗    │  ✓   │  ✓   │   ✓    │   ✓   │   ✓    │ ✓  │ ✓  │  ✓   │
schedule    │  ✗  │   ✗    │  ✗   │   ✗   │   -    │  ✓   │  ✓   │   ✓    │   ✓   │   ✓    │ ✓  │ ✓  │  ✓   │
user        │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  -   │  ✗   │   ✗    │   ✗   │   ✓    │ ✓  │ ✗  │  ✓   │
sync        │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  ✗   │  -   │   ✗    │   ✗   │   ✓    │ ✓  │ ✗  │  ✓   │
backup      │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  ✗   │  ✗   │   -    │   ✗   │   ✓    │ ✓  │ ✗  │  ✓   │
notif       │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  ✗   │  ✗   │   ✗    │   -   │   ✓    │ ✓  │ ✗  │  ✓   │
common      │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  ✗   │  ✗   │   ✗    │   ✗   │   -    │ ✗  │ ✗  │  ✗   │
database    │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  ✗   │  ✗   │   ✗    │   ✗   │   ✓    │ -  │ ✗  │  ✗   │
ui          │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  ✗   │  ✗   │   ✗    │   ✗   │   ✓    │ ✗  │ -  │  ✗   │
data        │  ✗  │   ✗    │  ✗   │   ✗   │   ✗    │  ✗   │  ✗   │   ✗    │   ✗   │   ✓    │ ✗  │ ✗  │  -   │

✓ = 依赖  ✗ = 不依赖  - = 自身
```

## 4. 模块通信流程

### 4.1 数据流示例

```
用户操作 → UI层 → ViewModel → API接口 → Repository → DAO → Database
   ↑                                                              ↓
   └──────────────────── UI更新 ←────── Flow/LiveData ←─────────┘
```

### 4.2 跨模块调用示例

```kotlin
// 在HomeViewModel中聚合多个模块数据
class HomeViewModel @Inject constructor(
    private val ledgerApi: LedgerApi,
    private val todoApi: TodoApi,
    private val habitApi: HabitApi
) : ViewModel() {
    
    fun loadHomeData() {
        viewModelScope.launch {
            // 并发获取各模块数据
            val expense = async { ledgerApi.getTodayExpense() }
            val tasks = async { todoApi.getTodayTasks() }
            val habits = async { habitApi.getTodayHabits() }
            
            // 更新UI状态
            _uiState.update { state ->
                state.copy(
                    todayExpense = expense.await(),
                    pendingTasks = tasks.await(),
                    todayHabits = habits.await()
                )
            }
        }
    }
}
```

### 4.3 导航示例

```kotlin
// 从首页导航到记账模块
ledgerApi.navigateToAddTransaction()

// 实际实现（在app模块）
class LedgerNavigatorImpl @Inject constructor(
    private val navController: NavController
) : LedgerNavigator {
    override fun navigateToAddTransaction() {
        navController.navigate("ledger_add_transaction")
    }
}
```

## 5. 模块大小统计

| 模块 | Kotlin文件数 | 代码行数(估算) | 主要功能数 |
|------|-------------|---------------|-----------|
| app | 30+ | 3000+ | 10+ |
| core:common | 15+ | 1500+ | - |
| core:database | 35+ | 3500+ | - |
| core:ui | 10+ | 1000+ | - |
| feature:ledger | 60+ | 8000+ | 8 |
| feature:todo | 15+ | 2000+ | 1 |
| feature:habit | 20+ | 2500+ | 1 |
| feature:schedule | 65+ | 7500+ | 6 |
| shared:* | 20+ | 2000+ | 4 |
| **总计** | **270+** | **31000+** | **30+** |

## 6. 构建配置特点

### 6.1 Convention Plugins

- `AndroidApplicationConventionPlugin`: 应用模块配置
- `AndroidLibraryConventionPlugin`: 库模块配置
- `AndroidFeatureConventionPlugin`: 功能模块配置
- `AndroidHiltConventionPlugin`: Hilt配置

### 6.2 统一配置

- JVM Toolchain: JDK 17
- Kotlin版本: 1.9.21
- Compose编译器: 1.5.7
- 最小SDK: 26 (Android 8.0)
- 目标SDK: 34

## 7. 模块化收益

### 7.1 开发效率
- **并行开发**: 不同团队可以独立开发不同模块
- **编译速度**: 增量编译只影响修改的模块
- **代码隔离**: 减少意外的相互影响

### 7.2 代码质量
- **清晰边界**: 每个模块职责明确
- **强制解耦**: 通过API接口通信
- **易于测试**: 模块可独立测试

### 7.3 可维护性
- **易于理解**: 按业务领域组织代码
- **便于重构**: 模块内部可自由重构
- **版本管理**: 可独立升级模块

## 8. 后续优化方向

1. **动态化支持**: 支持模块动态下载
2. **性能监控**: 添加模块级性能监控
3. **更多模块**: 添加日记、健康等新模块
4. **插件化**: 支持第三方模块接入

---

*最后更新：2025-06-14*