# 自动记账 · 支付结果“多通道捕获”设计（通知监听 = 无障碍 丶并行同级｜当前：全自动软关闭）

> 定位更新：无障碍并非通知监听的补丁/兜底，而是“与通知监听同级的第二捕获通道”。用户可选择：
> - 轻量：通知栏监听（NotificationListener）
> - 重量：无障碍捕获（Accessibility）
> 二者可独立启用。当前仅提供“半自动”体验；“全自动”为软关闭（保留实现，默认不生效）。默认开启“通知栏监听”，无障碍作为“实验功能”默认关闭。

---

## 1. 目标与原则
- 目标：通过“多通道捕获”（通知/无障碍），在不同App与不同系统策略下稳定捕获支付结果，并进入记账流程（当前仅半自动）。
- 原则：
  - 限定目标：仅微信（后续可扩展支付宝）；仅在支付结果界面触发；仅读取与支付文本相关的可见内容。
  - 默认半自动：先弹提示横幅，点击进入“记一笔”；全自动需用户主动开启，并保留撤销/去重护栏。
  - 合规与回退：默认关闭；醒目说明用途与边界；一键关闭、随时回退。

## 1.1 捕获通道（Channel）与并行架构
- 通道定义：
  - NL（Notification Listener）：系统通知事件→RawNotificationEvent
  - A11Y（Accessibility）：支付结果页文本→RawNotificationEvent
- 并行启用：两通道可同时启用；统一汇入同一事件流与去重/解析/决策管线。
- 去重优先：跨通道短窗（默认5s）指纹去重，确保同一支付只处理一次（先到先得）。

## 2. 适用范围
- 适用：微信（com.tencent.mm）“发红包/向他人转账/付款成功”等不会产生系统通知的场景。
- 不适用：后台/锁屏下的不可见界面；无金额/方向的模糊界面；第三方修改版客户端。

## 3. 总体架构（并行通道）
```
NL: System Notification  ─┐
                          │  emit(RawNotificationEvent)
A11Y: Accessibility Text ─┘
         │  (去抖/短窗指纹)
         ▼
NotificationEventRepository (shared)
         ▼
DeduplicationManager（跨通道短窗去重 + 解析后指纹）
         ▼
NotificationParserFactory（Alipay/WeChat/...）
         ▼
AutoLedgerManager（半自动 + 撤销；全自动软关闭）
```

## 4. 技术实现
### 4.1 捕获通道能力
- NL：沿用现有 PaymentNotificationListener（白名单App→支付关键词放宽→事件流）
- A11Y（shared/accessibility，新）：见下

### 4.2 无障碍服务（shared/accessibility）
- Service：`PaymentAccessibilityService`
  - Manifest 声明 `BIND_ACCESSIBILITY_SERVICE`；限制 `packageNames=["com.tencent.mm"]`；监听 `TYPE_WINDOW_STATE_CHANGED | TYPE_WINDOW_CONTENT_CHANGED`。
  - 连接/断开：更新诊断状态（沿用 shared/notification 的 diagnostics 风格）。

### 4.3 轻量解析器
- `WeChatAccessibilityParser`
  - 输入：根节点 `AccessibilityNodeInfo`；宽度/深度/节点数上限（如≤200节点、深度≤12）。
  - 输出：`TextSnapshot`（标题、正文、金额字符串、对方昵称/备注、关键标识）。
  - 去抖：对内容变更事件做 ~300ms 去抖；同窗口短窗（5s）内的相同匹配结果只触发一次。

### 4.4 事件适配器
- `AccessibilityEventAdapter`
  - 将 `TextSnapshot` 转为 `RawNotificationEvent`：
    - `packageName = com.tencent.mm`
    - `title/text =` 摘要拼接
    - `postTime = SystemClock.elapsedRealtimeNanos/当前毫秒`
    - `isGroupSummary = false`
  - 通过 `NotificationEventRepository.emit(event)` 投递至现有事件流。

### 4.5 既有链路复用
- 去重：`DeduplicationManager`（20s窗口 + 解析后指纹）
- 解析：`WechatNotificationParser`（金额/方向/商户/方式 + 通用回退）
- 决策：`AutoLedgerManager`（半自动、撤销、通知等；全自动软关闭）

## 5. 触发与识别规则（初版，A11Y）
- 触发前置：前台包名=微信；窗口/内容变更产生事件。
- 关键词（命中其一）：
  - 红包：红包、已发出/已发放、已领取、已收款
  - 转账：转账、已转账、已转出、对方已收款、收款到账
  - 支付：付款成功/支付成功/已支付
- 金额提取：沿用 `amountRegex`（支持 ￥/¥/元，千分位/小数）。
- 对方/商户：优先匹配“向XX转账/已收款XX/备注/昵称行”，取最近节点文本；提取不到可为空。
- 方向判定：
  - 优先：红包→收入；转账→转账；支付/付款→支出；
  - 回退：`AbstractNotificationParser.inferDirection`。
- 置信度：金额+方向为核心，商户/方式加分；<0.6 直接跳过（宁缺勿滥）。

## 6. 安全与合规（两通道）
- 用户授权与说明：
  - “自动记账设置 → 权限与兼容性”新增“微信支付页辅助识别（实验）”开关。
  - 跳转系统无障碍授权页；提供醒目标注：仅在支付结果页解析可见文本；不做广泛读取/录屏/持久化。
- 默认关闭：Release 构建默认关闭，仅在用户主动开启后生效。
- 数据最小化：仅提取必要字段；调试导出支持脱敏；不上传、不云端持久化。

（补充）NL 通道：沿用“通知权限/通知使用权/渠道直达/一键自检”引导；默认开启。

## 7. 性能与稳健性
- 去抖：内容变更 300ms 去抖；同窗口短窗指纹 5s 去重；
- 解析限额：节点数/深度限制；异常即止（不上报）。
- 失败回退：未提取到金额/方向则不触发，用户可手动记账。

## 8. 交互与体验（两通道、一套模式）
- 半自动（当前生效）：
  - 捕获成功 → 弹“发现支付结果”横幅（高优先渠道）→ 点击进入“记一笔”，预填金额/方向；商户缺失不预填，账户/分类给出候选。
- 全自动（软关闭）：
  - 保留实现但默认不生效；后续按需求恢复。
- 紧急回退：设置页一键关闭；通知渠道直达；导出调试便于反馈。

模式策略（当前策略）：
- 仅启用半自动；全自动软关闭，待产品需要再开启。

## 9. 测试与验收
- 设备矩阵：MIUI/EMUI/ColorOS/原生；Android 11–15。
- 用例：
  1) 微信发红包（我发出）：半自动提示；金额/方向=收入预填。
  2) 微信转账（我向对方转）：半自动提示；方向=转账预填。
  3) 页面频繁切换/内容连续变动：无重复提示（去抖+短窗指纹生效）。
  4) 全自动（软关闭）：保留实现但默认不生效；后续按需开启。
- 性能：无明显耗电增加；非目标包名/界面不解析。

## 10. 风险与对策
- UI变更导致规则失效 → 关键词+通用回退；词库与用例快速迭代；
- 审核合规风险 → 默认关闭+用途说明；按渠道策略控制可见性；
- 误触发 → 多重阈值（金额/方向/置信/去重/白名单文本），且默认半自动。

## 11. 里程碑（建议）
- M0（0.5天）：PoC（识别+emit到事件流；日志验证命中）。
- M1（1–1.5天）：完善解析/去抖/短窗指纹；设置开关与引导；当前仅半自动贯通（全自动软关闭）。
- M2（0.5天）：机型适配核验与调优（关键词/节点采样与白/黑名单）。

## 12. 后续优化清单（待补充）
- [ ] 适配支付宝“付款成功/转账成功”界面（可配置包名）。
- [ ] 提供机型指引文案与直达设置入口（通知/无障碍）。
- [ ] 无障碍解析的可观测性：采样日志（仅Debug，脱敏）。
- [ ] 词库与样例库：构建真实样例集，自动化回归。
- [ ] 与“分享至小记/剪贴板”方案的互补与优先级规则。

---

更新记录：
- 2025-09-02：首版草案（新增无障碍捕获整体方案与实施路径）。

---

## 13. 用户故事与边界清单（补充）
- 我发红包：我在微信给好友发红包，支付完成后，希望弹出提示，点进去“记一笔”，预填收入金额与对象。
- 我转账给他人：转账成功后，希望弹出提示，点进去“记一笔”，预填“转账”方向与金额。
- 我付款（扫码/收款码向商户付款）：若微信无系统通知，仍希望在支付完成页捕获并提示。
- 不适用（不触发）：后台/锁屏、界面未显示成功文案、金额缺失、方向未知、广告/活动/红包封面、卡券等非支付页面。

## 14. 失败场景与回退矩阵（补充）
- 金额未解析 → 不触发，记录一次“跳过-无金额”，用户可手动记账。
- 方向未知 → 不触发，或作为“半自动降级”提示但不预填方向（默认不触发）。
- 页面频繁刷新/变换 → 去抖/短窗指纹避免重复提示。
- 性能超阈值 → 自降级：暂停解析N分钟（默认5分钟），期间仅记录诊断。
- 误触发用户反馈 → 一键关闭“实验功能”，或远端Kill-Switch 熔断。

## 15. 无障碍匹配细则（补充）
- 页面校验：
  - 前台包名必须为 com.tencent.mm；
  - Window title 包含：支付成功/已转账/对方已收款/红包已发出/已领取/收款到账（子集匹配）；
  - 可选：若后续能获得稳定控件id（content-desc/id），加入白名单匹配提高可靠度。
- 节点优先级：
  - 金额特征：带￥/¥/元，且字体较大/在标题或摘要区域；同一窗口取“最大金额文本”。
  - 对方/商户：邻近“向/已收款/备注/昵称”等关键词的文本节点。
  - 正样关键词（提升置信度）：红包/转账/已收款/付款成功/支付成功/已支付/收款到账。
  - 负样关键词（直接排除）：红包封面/活动/广告/卡券/优惠/充值提醒/订阅消息/消息通知。
- 置信度计算（示例）：
  - 金额(+0.4)、方向(+0.2)、对方/商户(+0.2)、方式(+0.1)、正样关键词覆盖度(×0.3加权)；
  - 阈值：<0.6 不触发；≥0.85 可进入全自动判定（满足金额与方向约束）。

## 16. 性能预算与耗电控制（补充）
- 预算：单次解析平均<20ms，P95<40ms；节点扫描≤200，深度≤12；事件去抖300ms。
- 后台/非目标包名：不解析；仅在前台且命中微信包名时解析。
- 耗电监控：
  - 指标：每分钟解析次数、平均耗时、CPU 时间；
  - 超阈值（如一分钟内解析>60次或平均耗时>50ms）→ 自降级（暂停解析5分钟）。

## 17. 合规与用户知情（补充）
- 开关与文案：
  - “微信支付页辅助识别（实验）”：默认关闭；说明“仅在支付结果页解析可见文本，不采集、不上传个人数据；可随时关闭”。
  - 首次开启需二次确认（说明风险与适配性）。
- 隐私条款增补（样例）：
  - “为提升记账便捷性，我们在您明确授权后，使用无障碍服务在微信支付结果界面读取必要的可见文本并在本地解析，用于预填记账信息。我们不收集、不存储、不上传原始文本，您可随时关闭该功能。”
- 发布策略：
  - Release 默认隐藏为“实验开关”且默认关闭；企业版/内测版可默认显示。

## 18. 运维与灰度（补充）
- Feature Flag / DataStore 键：
  - `capture_nl_enabled`（bool，默认true）
  - `capture_a11y_enabled`（bool，默认false）
  - `a11y_wechat_enabled`（bool，默认false） // 可按App维度细分
  - `a11y_debounce_ms`（int，默认300）
  - `a11y_window_dedup_sec`（int，默认5）
  - `capture_cross_channel_dedup_sec`（int，默认5）
  - `a11y_kill_switch`（bool，默认false）

（进阶）模式覆写键（可选）：
（软关闭）历史模式配置草案：SEMI/FULL 相关覆写不作为当前执行内容，保留于历史以便后续启用时参考。
- 灰度：按构建渠道/用户白名单启用；遇异常通过 Kill-Switch 远端熔断（若后续接入远端配置）。
- 诊断与KPI：
  - 分通道统计：捕获数/跳过数（含原因）、跨通道去重命中率；
  - 质量：误触发率、自动/半自动占比、撤销率；
  - 性能：平均解析时延（NL/A11Y分别）、去抖命中率、短窗指纹命中率、耗电估计。

## 19. 设置与UX文案（补充）
- 设置项（示例）：
  - 开关标题：微信支付页辅助识别（实验）
  - 说明文案：仅在微信支付结果页读取必要可见文本用于记账预填，不采集/上传。默认关闭，可随时关闭。
  - 按钮：去授权（跳系统无障碍设置）、通知渠道设置（直达）
- 引导页：
  - 一页式说明 + 两步启用（1. 开启开关 2. 跳系统无障碍页授权）；
  - 常见问题：不生效时检查微信版本/系统权限/是否处于支付页面。

## 20. 流程伪代码（补充）
```
onAccessibilityEvent(event):
  if !settings.a11y_wechat_enabled: return
  if event.packageName != "com.tencent.mm": return
  if event.type !in {STATE_CHANGED, CONTENT_CHANGED}: return
  if now - lastParseTs < settings.debounceMs: return

  root = getRootNode() ?: return
  snapshot = WeChatAccessibilityParser.parse(root)
  if !snapshot.hasAmount || snapshot.confidence < 0.6: return

  raw = toRawNotificationEvent(snapshot)  // package=com.tencent.mm, title/text 拼摘要
  NotificationEventRepository.emit(raw)
  lastParseTs = now
```

## 21. 测试矩阵与样例（补充）
- 机型矩阵：小米(MIUI 14/15)、华为(EMUI/鸿蒙)、OPPO(ColorOS)、vivo、Pixel(原生)，Android 11–15。
- 样例词库：
  - 正样：红包已发出/对方已收款/已转账/支付成功/付款成功/收款到账（脱敏样例 20 条）。
  - 负样：红包封面/活动/广告/卡券/订阅消息/充值提醒（脱敏样例 20 条）。
- 用例：正常、金额边界（0.99/1.00/大额）、方向边界（红包/转账/支付）、页面快速切换、长时运行、CPU/耗电采样。

组合用例（关键）：
- 仅NL开启、仅A11Y开启、二者同时开启（验证跨通道短窗去重）。
（软关闭）模式：当前仅半自动；SEMI/FULL 与通道覆写方案暂不执行。

## 22. 验收与回滚（补充）
- 验收：
  - 功能：红包/转账半自动命中率≥95%（样例集），全自动在阈值条件下可达并可撤销。
  - 性能：平均解析<20ms，P95<40ms；长时运行无明显耗电。
  - 合规：默认关闭；开关文案/隐私条款已更新；灰度/熔断可用。
  - 回归：通知监听链路不退化；其他模块不受影响。
- 回滚：
  - 设置页一键关闭；必要时远端Kill-Switch 熔断；移除模块不影响主流程。
