# 钱迹导入数据修复方案

## 问题诊断结果

### 1. 识别的问题
- **转账对象误判为账户**：4个（>劳闻文、>翁显、>哥、么明）
- **正常支付账户**：8个（微信零钱、支付宝、花呗等）
- **默认账户交易**：1275条（可能是账户名为空）

### 2. 根本原因
1. **QianjiMapper问题**：
   - `accountName.split("-").last()` 错误截断账户名
   - 忽略了account2字段（转账收款人）
   - 空账户名全部放入默认账户

2. **数据结构差异**：
   - 钱迹有二级分类，CC小记没有
   - 钱迹的转账用account2字段，CC小记没有对应字段

## 修复方案

### 方案A：最小化修复（推荐）
**只修复明显错误，保持数据完整性**

#### 步骤1：修复转账对象账户
```kotlin
// 识别转账对象账户（以">"开头）
val transferAccounts = accounts.filter { it.name.startsWith(">") }

// 将这些账户的交易迁移到合适的账户
transferAccounts.forEach { account ->
    val transactions = getTransactionsByAccount(account.id)
    transactions.forEach { trans ->
        // 根据金额正负判断
        val targetAccountId = if (trans.amountCents < 0) {
            // 支出：从某个支付账户转出
            findMostLikelyPaymentAccount(trans)
        } else {
            // 收入：转入某个账户
            getDefaultAccount()
        }
        
        // 将转账对象信息添加到备注
        trans.note = "${trans.note ?: ""} [转账对象: ${account.name.removePrefix(">")}]"
        trans.accountId = targetAccountId
        updateTransaction(trans)
    }
    
    // 删除错误账户
    deleteAccount(account.id)
}
```

#### 步骤2：优化QianjiMapper
```kotlin
// 1. 移除错误的split逻辑
val realAccountName = accountName // 不再split("-")

// 2. 处理account2字段
if (!record.account2.isNullOrEmpty()) {
    // 将转账对象添加到备注
    note += " [转账对象: ${record.account2}]"
}

// 3. 改进账户类型检测
private fun detectAccountType(accountName: String): String {
    return when {
        accountName.startsWith(">") -> return null // 不创建账户
        accountName.contains("零钱通") -> "INVESTMENT" // 理财账户
        accountName.contains("中行") -> "BANK_CARD"
        // ...
    }
}
```

### 方案B：完整重构
**重新设计数据结构，完整支持多源导入**

#### 改进点
1. 添加`transfer_party`字段到Transaction表
2. 支持二级分类（添加sub_category字段）
3. 建立账户映射规则表
4. 实现智能账户识别

### 方案C：重新导入
**修复导入器后重新导入数据**

#### 步骤
1. 备份当前数据
2. 修复QianjiMapper的所有问题
3. 清空错误数据
4. 重新导入CSV

## 推荐方案

**推荐方案A（最小化修复）**，理由：
1. **风险最小**：不会丢失数据
2. **快速见效**：立即解决显示问题
3. **可逆**：保留了修复记录
4. **渐进式**：为未来优化留空间

## 实施计划

### 第一阶段（立即）
1. ✅ 创建分析工具
2. ✅ 识别问题账户
3. ⏳ 实施账户迁移
4. ⏳ 删除错误账户

### 第二阶段（短期）
1. 修复QianjiMapper
2. 添加转账对象字段
3. 改进账户识别逻辑

### 第三阶段（长期）
1. 支持二级分类
2. 建立账户映射系统
3. 支持更多APP导入

## 注意事项

1. **执行前备份数据**
2. **分批处理避免锁表**
3. **保留修复日志**
4. **测试验证结果**

---
更新时间：2025-08-15