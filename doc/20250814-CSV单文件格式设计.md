# CSV单文件格式设计文档

## 📅 实施时间
2025-08-14

## 🎯 设计背景
之前的导出方案会生成多个CSV文件并打包为ZIP，导入时需要处理多个文件，增加了复杂性。为了简化导入流程，设计了新的单文件CSV格式。

## 📊 格式规范

### 基本结构
- **文件格式**: UTF-8编码的CSV文件
- **字段数量**: 固定10列（数据类型 + 9个数据字段）
- **数据类型标识**: 每行第一列标识该行数据的类型
- **字段分隔符**: 逗号（,）
- **文本限定符**: 双引号（"）用于包含特殊字符的字段

### 标题行
```csv
数据类型,字段1,字段2,字段3,字段4,字段5,字段6,字段7,字段8,字段9
```

## 📝 数据类型定义

### 1. HEADER - 文件头元数据
记录导出文件的基本信息和统计数据
```
[HEADER, 导出时间, 版本号, 货币, 用户ID, 交易数, 账户数, 分类数, 空, 说明]
```
示例：
```csv
HEADER,2025-08-14_21_33_07,2.0,CNY,current_user_id,2,1,15,,CC小记数据导出
```

### 2. ACCOUNT - 账户信息
包含基本账户信息和信用卡专属字段
```
[ACCOUNT, 创建时间, 名称, 类型, 余额, 信用额度, 账单日, 还款日, 是否默认, 图标]
```
示例：
```csv
ACCOUNT,2025-08-14,现金账户,CASH,0,,,,,是
ACCOUNT,2025-08-14,招行信用卡,CREDIT_CARD,-3500,10000,10,3,否,💳
```

### 3. CATEGORY - 分类信息
收入和支出的分类定义
```
[CATEGORY, 创建时间, 名称, 类型, 图标, 颜色, 父分类, 排序, 空, 空]
```
示例：
```csv
CATEGORY,2025-08-14,餐饮,EXPENSE,🍜,#FF5252,,0,,
CATEGORY,2025-08-14,工资,INCOME,💰,#4CAF50,,0,,
```

### 4. TRANSACTION - 交易记录
具体的收支记录
```
[TRANSACTION, 交易时间, 账户名, 分类名, 金额, 备注, 是否定期生成, 空, 空, 空]
```
示例：
```csv
TRANSACTION,2025-08-14 21:32:03,现金账户,餐饮,-100,午餐,否,,,
TRANSACTION,2025-08-14 09:00:00,工资卡,工资,8000,8月工资,否,,,
```

### 5. BUDGET - 预算信息
月度或年度预算设置
```
[BUDGET, 年月, 分类名, 预算额, 警戒值, 已用, 剩余, 空, 空, 备注]
```
示例：
```csv
BUDGET,2025-08,餐饮,3000,80%,300,2700,,,本月餐饮预算
```

### 6. RECURRING - 定期交易
自动生成的周期性交易设置
```
[RECURRING, 频率, 执行日, 账户名, 分类名, 金额, 名称, 开始日, 结束日, 备注]
```
示例：
```csv
RECURRING,每月,25号,工资卡,工资,8000,月工资,2025-01-01,,每月25号发工资
RECURRING,每周,周一,现金账户,交通,-50,公交卡充值,2025-01-01,2025-12-31,
```

### 7. SAVINGS - 储蓄目标
理财目标设置和进度跟踪
```
[SAVINGS, 名称, 目标额, 当前额, 目标日期, 进度, 颜色, 空, 空, 描述]
```
示例：
```csv
SAVINGS,买房首付,500000,50000,2026-12-31,10%,#4CAF50,,,攒首付
SAVINGS,旅游基金,30000,5000,2025-06-30,17%,#2196F3,,,日本旅游
```

### 8. CREDITBILL - 信用卡账单
信用卡账单记录
```
[CREDITBILL, 账户名, 开始日, 结束日, 账单额, 已还, 最低还款, 到期日, 是否逾期, 空]
```
示例：
```csv
CREDITBILL,招行信用卡,2025-07-10,2025-08-09,3500,2000,350,2025-08-25,否,
```

### 9. CREDITPAYMENT - 信用卡还款（待实现）
信用卡还款记录
```
[CREDITPAYMENT, 账户名, 还款日期, 还款金额, 关联账单ID, 还款方式, 空, 空, 空, 备注]
```

## 🔄 导入处理流程

### 1. 文件读取和验证
```kotlin
1. 读取CSV文件
2. 验证标题行格式
3. 验证HEADER行存在性
4. 检查版本兼容性
```

### 2. 数据分类和缓存
```kotlin
val dataMap = mutableMapOf<String, MutableList<List<String>>>()
csvRows.forEach { row ->
    val dataType = row[0]
    dataMap.getOrPut(dataType) { mutableListOf() }.add(row)
}
```

### 3. 按依赖顺序导入
```kotlin
导入顺序：
1. ACCOUNT - 账户（基础数据）
2. CATEGORY - 分类（基础数据）
3. BUDGET - 预算（依赖分类）
4. TRANSACTION - 交易（依赖账户和分类）
5. RECURRING - 定期交易（依赖账户和分类）
6. SAVINGS - 储蓄目标（独立数据）
7. CREDITBILL - 信用卡账单（依赖账户）
8. CREDITPAYMENT - 信用卡还款（依赖账单）
```

## 🎯 设计优势

### 1. 简化导入流程
- 单文件处理，无需解压和多文件管理
- 按行顺序读取，内存占用小
- 数据类型明确，解析逻辑清晰

### 2. 良好的扩展性
- 新增数据类型只需定义新的TYPE标识
- 字段预留空间，可扩展到9个字段
- 版本控制支持向后兼容

### 3. 人类可读性
- Excel/WPS直接打开即可查看
- 数据类型标识清晰
- 中文字段值，用户友好

### 4. 数据完整性
- HEADER行包含统计信息，可验证导入完整性
- 支持数据依赖关系处理
- 错误隔离，单条失败不影响整体

## 📈 性能考虑

### 内存优化
- 流式读取，避免一次性加载全部数据
- 分批处理，每100条提交一次事务
- 使用StringBuilder构建字符串，减少内存分配

### 导入性能
- 批量插入，减少数据库操作次数
- 事务处理，提高写入效率
- 索引优化，加快查询速度

## 🔧 实现细节

### CSV转义处理
```kotlin
private fun csvEscape(value: String): String {
    return if (value.contains(",") || value.contains("\"") || value.contains("\n")) {
        "\"${value.replace("\"", "\"\"\")}\""
    } else {
        value
    }
}
```

### 日期格式
- 完整时间：`yyyy-MM-dd HH:mm:ss`
- 仅日期：`yyyy-MM-dd`
- 年月：`yyyy-MM`

### 金额处理
- 数据库存储：分（整数）
- CSV导出：元（小数，保留2位）
- 正负号表示收支类型

## 📋 测试用例

### 1. 空数据导出
- 仅包含HEADER和基础分类
- 验证文件结构完整性

### 2. 完整数据导出
- 包含所有数据类型
- 验证数据关联正确性

### 3. 特殊字符处理
- 包含逗号、引号、换行的字段
- 验证转义处理正确性

### 4. 大数据量测试
- 10000+条交易记录
- 验证性能和内存占用

## 🚀 后续优化

1. **压缩支持**：支持导出为.csv.gz格式，减小文件体积
2. **增量导出**：支持按时间范围增量导出
3. **导入冲突处理**：提供合并、覆盖、跳过等选项
4. **导入预览**：导入前显示数据统计和预览
5. **导入进度**：实时显示导入进度和状态

## 📚 相关文档
- [记账数据导出功能实施](20250813-记账数据导出功能实施.md)
- [数据导入导出重构完成总结](开发进度/20250811-数据导入导出重构完成总结.md)

---
*创建时间: 2025-08-14*
*作者: CC小记开发团队*
*版本: 1.0*