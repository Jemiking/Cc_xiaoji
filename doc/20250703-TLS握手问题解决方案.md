# TLS握手问题解决方案

> **创建日期**: 2025-07-03
> **问题描述**: MCP编译时依赖下载出现TLS握手失败
> **错误信息**: The server may not support the client's requested TLS protocol versions

## 问题分析

### 错误原因
1. **TLS版本不兼容**：客户端（Gradle/JDK）与服务器（Maven仓库）之间的TLS协议版本不匹配
2. **证书验证失败**：某些仓库使用的证书可能不被JDK信任
3. **加密算法限制**：JDK默认禁用了某些被认为不安全的加密算法
4. **网络环境影响**：代理、防火墙等可能干扰TLS握手

## 解决方案实施

### 方案一：标准TLS配置（已实施）

在`gradle.properties`中添加了以下配置：

```properties
# JVM参数中添加TLS配置
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8 -Dhttps.protocols=TLSv1.2,TLSv1.3 -Djdk.tls.client.protocols=TLSv1.2,TLSv1.3 -Dcom.sun.net.ssl.checkRevocation=false -Djdk.http.auth.tunneling.disabledSchemes=""

# 系统属性配置
systemProp.https.protocols=TLSv1.2,TLSv1.3,TLSv1.1,TLSv1
systemProp.jdk.tls.client.protocols=TLSv1.2,TLSv1.3,TLSv1.1,TLSv1
systemProp.https.cipherSuites=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_RSA_WITH_AES_256_GCM_SHA384,TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256
systemProp.jdk.tls.ephemeralDHKeySize=2048
systemProp.jdk.tls.rejectClientInitiatedRenegotiation=false
systemProp.jdk.internal.httpclient.disableHostnameVerification=true
systemProp.com.sun.net.ssl.checkRevocation=false
```

### 配置说明

1. **TLS协议版本**：支持TLSv1、TLSv1.1、TLSv1.2、TLSv1.3，确保与各种服务器兼容
2. **加密套件**：配置了常用的加密套件，包括ECDHE、DHE、RSA等
3. **证书验证**：临时禁用了证书撤销检查和主机名验证（仅开发环境）
4. **DH密钥大小**：设置为2048位，平衡安全性和兼容性

### 测试方法

1. **清理并重启Gradle守护进程**
   ```bash
   ./gradlew --stop
   rm -rf .gradle/
   ```

2. **测试配置是否生效**
   ```bash
   ./gradlew --version
   ./gradlew dependencies --info
   ```

3. **调试TLS握手**（如需要）
   取消注释：`systemProp.javax.net.debug=ssl:handshake`

### 备用方案

如果标准配置不起作用，可以尝试更激进的配置（见`scripts/gradle-tls-aggressive.properties`）：

1. 允许所有TLS版本（包括SSLv3）
2. 完全禁用证书验证
3. 允许所有加密算法

**警告**：激进配置仅用于开发环境，生产环境必须移除！

## 其他可选方案

### 方案二：使用国内镜像
- 完全避免访问可能有TLS问题的国外仓库
- 配置阿里云、腾讯云等国内镜像源

### 方案三：JDK版本调整
- 降级到JDK 8或11（更好的兼容性）
- 或升级到最新的JDK 21（更好的TLS支持）

### 方案四：代理配置
- 当前已配置代理：127.0.0.1:7897
- 如果代理本身有TLS问题，可以尝试禁用代理

### 方案五：离线依赖
- 手动下载所有依赖到本地
- 配置离线Maven仓库

## 注意事项

1. **安全性**：某些配置降低了安全性，仅在开发环境使用
2. **性能影响**：TLS握手调试会显著降低构建速度
3. **清理缓存**：修改配置后需要清理Gradle缓存
4. **版本兼容**：不同JDK版本对TLS的支持不同

## 问题状态

- ✅ 已实施标准TLS配置
- ⏳ 等待测试验证
- 📝 备用方案已准备