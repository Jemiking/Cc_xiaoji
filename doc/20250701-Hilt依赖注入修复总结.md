# Hilt依赖注入修复总结

## 执行时间
2025-07-01

## 背景
在完成包名重命名后，出现了新的Hilt依赖注入错误：
```
android.content.Context cannot be provided without an @Provides-annotated method.
```

## 问题分析

### 错误链路
```
DataImportViewModel 
→ ImportService 
→ BackupApi 
→ DatabaseBackupManager 
→ Context (缺失@ApplicationContext注解)
```

### 根本原因
**DatabaseBackupManager**的构造函数中Context参数缺少`@ApplicationContext`注解，导致Hilt无法正确提供Context依赖。

## 修复内容

### 修复DatabaseBackupManager.kt

**位置**: `shared/backup/src/main/kotlin/com/ccxiaoji/shared/backup/data/manager/DatabaseBackupManager.kt`

**修复前**:
```kotlin
@Singleton
class DatabaseBackupManager @Inject constructor(
    private val context: Context  // ❌ 缺少@ApplicationContext注解
) {
```

**修复后**:
```kotlin
@Singleton
class DatabaseBackupManager @Inject constructor(
    @ApplicationContext private val context: Context  // ✅ 添加@ApplicationContext注解
) {
```

**添加的导入**:
```kotlin
import dagger.hilt.android.qualifiers.ApplicationContext
```

## 技术解释

### 为什么需要@ApplicationContext？
1. **Hilt Context提供规则**: Hilt提供两种Context
   - `@ApplicationContext`: Application级别的Context
   - `@ActivityContext`: Activity级别的Context

2. **依赖注入要求**: 
   - 没有注解时，Hilt无法确定提供哪种Context
   - @Singleton组件只能使用@ApplicationContext

3. **最佳实践**:
   - 在@Singleton类中总是使用@ApplicationContext
   - 避免在长生命周期组件中持有Activity Context

### 验证修复的其他文件
✅ **BackupApiImpl.kt**: 已正确使用@ApplicationContext
✅ **DatabaseModule.kt**: 已正确使用@ApplicationContext
✅ **Application类**: 已正确配置@HiltAndroidApp

## 依赖注入流程
修复后的正确流程：
```
1. Application (@HiltAndroidApp) 
   ↓
2. DatabaseModule provides @ApplicationContext Context
   ↓
3. DatabaseBackupManager @Inject constructor(@ApplicationContext Context)
   ↓
4. BackupApiImpl @Inject constructor(..., DatabaseBackupManager)
   ↓
5. ImportService @Inject constructor(..., BackupApi)
   ↓
6. DataImportViewModel @Inject constructor(ImportService)
```

## 最终结果
✅ DatabaseBackupManager正确注入@ApplicationContext Context
✅ 整个导入功能依赖链修复完成
✅ 清理了Hilt生成的错误文件
⏳ 等待重新编译验证

## 下一步
用户可以在Android Studio中重新编译项目，验证Hilt依赖注入错误已解决，导入功能可以正常工作。

## 学习要点
1. **@ApplicationContext注解很重要**: 在@Singleton组件中注入Context时必须使用
2. **Hilt错误信息很详细**: 错误消息清楚显示了整个依赖链路
3. **渐进式修复**: 从错误链路的源头（Context提供）开始修复最有效