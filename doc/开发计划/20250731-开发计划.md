# CC小记功能升级方案

## 项目背景

### 当前状态
- **项目定位**：综合性生活管理应用（记账、待办、习惯、排班、计划）
- **技术架构**：已完成模块化架构迁移，代码质量良好
- **数据库版本**：7（包含23个表）
- **核心模块**：5个业务模块 + 4个基础模块 + 4个共享模块
- **发布状态**：未发布，有较大调整空间
- **当前任务**：数据导出导入功能重构中（CSV+JSON方案）

### 升级动因
1. **功能完善需求**：通过与钱迹对比，发现记账模块功能较为基础
2. **用户体验提升**：需要增强专业性，提供更完整的财务管理功能
3. **市场竞争力**：在保持综合性优势的同时，提升单项功能的专业度
4. **数据兼容性**：支持从其他记账软件迁移数据，降低用户迁移成本

### 升级原则
1. **保持平衡**：不过度偏向记账，保持各模块均衡发展
2. **务实渐进**：分阶段实施，每个阶段都能交付可用功能
3. **向后兼容**：确保现有数据和功能不受影响
4. **用户优先**：优先实现用户最需要的功能

## 升级方案概述

### 总体目标（3个月）
1. **记账功能专业化**：达到主流记账软件70%的功能覆盖
2. **数据互通性**：支持主流记账软件数据导入导出
3. **用户体验优化**：UI界面现代化，操作流程简化
4. **性能提升**：大数据量下的性能优化

### 分阶段计划
- **第一阶段（第1个月）**：基础功能增强 - 夯实基础
- **第二阶段（第2个月）**：核心功能扩展 - 提升专业性
- **第三阶段（第3个月）**：高级功能实现 - 差异化竞争

## 第一阶段：基础功能增强（2025年8月）

### 1.1 数据导出导入完善（第1-2周）
**目标**：完成CSV+JSON方案实施，支持钱迹格式兼容

**具体任务**：
- [ ] 完成CSV+JSON导出功能开发
- [ ] 实现钱迹CSV格式完全兼容
- [ ] 支持选择性导出（按时间、账户、分类筛选）
- [ ] 实现批量导入功能（支持10万+记录）
- [ ] 添加导入数据预览和验证
- [ ] 导入冲突处理机制（重复检测、合并策略）

**技术要点**：
```kotlin
// 导出配置扩展
data class ExportConfig(
    val dateRange: DateRange? = null,
    val accounts: List<String>? = null,
    val categories: List<String>? = null,
    val includeDeleted: Boolean = false,
    val format: ExportFormat = ExportFormat.CSV_JSON
)

// 导入验证器
class ImportValidator {
    fun validateTransaction(row: CsvRow): ValidationResult
    fun detectDuplicates(transactions: List<Transaction>): List<Duplicate>
    fun suggestMergeStrategy(duplicate: Duplicate): MergeStrategy
}
```

### 1.2 二级分类系统（第2-3周）
**目标**：支持分类层级管理，提升分类灵活性

**具体任务**：
- [ ] 数据库迁移：添加parentId和level字段
- [ ] 分类管理界面：树形结构展示
- [ ] 分类选择器：支持层级选择
- [ ] 数据迁移：现有分类平滑升级
- [ ] 分类统计：按层级汇总统计

**数据库变更**：
```sql
-- 数据库版本 7 → 8
ALTER TABLE categories ADD COLUMN parentId TEXT;
ALTER TABLE categories ADD COLUMN level INTEGER NOT NULL DEFAULT 1;
ALTER TABLE transactions ADD COLUMN subCategoryId TEXT;

-- 创建分类层级视图
CREATE VIEW category_hierarchy AS
SELECT 
    c1.id, c1.name, c1.parentId, c1.level,
    c2.name as parentName
FROM categories c1
LEFT JOIN categories c2 ON c1.parentId = c2.id;
```

### 1.3 转账功能基础（第3-4周）
**目标**：支持账户间转账，完善资金流转记录

**具体任务**：
- [ ] UI设计：转账模式切换界面
- [ ] 转账逻辑：创建双向交易记录
- [ ] 转账历史：独立的转账记录页面
- [ ] 手续费支持：可选的手续费记录
- [ ] 数据统计：转账不计入收支统计

**核心实现**：
```kotlin
class TransferUseCase {
    suspend fun createTransfer(
        fromAccountId: String,
        toAccountId: String,
        amount: Long,
        fee: Long = 0,
        note: String? = null
    ): Result<TransferResult> {
        // 创建转出记录
        val fromTransaction = Transaction(
            type = TransactionType.TRANSFER_OUT,
            accountId = fromAccountId,
            toAccountId = toAccountId,
            amount = amount + fee,
            note = note
        )
        
        // 创建转入记录
        val toTransaction = Transaction(
            type = TransactionType.TRANSFER_IN,
            accountId = toAccountId,
            fromAccountId = fromAccountId,
            amount = amount,
            note = note,
            relatedTransactionId = fromTransaction.id
        )
        
        // 原子操作保存
        return transactionRepository.saveTransfer(fromTransaction, toTransaction)
    }
}
```

### 1.4 测试与优化（第4周）
- [ ] 单元测试覆盖率达到70%
- [ ] 集成测试：导入导出全流程
- [ ] 性能测试：10万记录导入导出
- [ ] 用户测试：邀请10名用户试用

## 第二阶段：核心功能扩展（2025年9月）

### 2.1 多币种支持（第1-2周）
**目标**：支持多币种记账，自动汇率转换

**具体任务**：
- [ ] 币种管理：支持常用币种设置
- [ ] 汇率服务：在线获取实时汇率
- [ ] 自动转换：统计时自动换算
- [ ] 历史汇率：保存交易时的汇率
- [ ] UI适配：显示原始金额和转换金额

**技术架构**：
```kotlin
interface ExchangeRateService {
    suspend fun getLatestRates(): Map<String, Double>
    suspend fun getHistoricalRate(currency: String, date: LocalDate): Double
}

class CurrencyConverter {
    fun convert(
        amount: Long,
        fromCurrency: String,
        toCurrency: String,
        rate: Double? = null
    ): ConvertedAmount
}
```

### 2.2 附件管理系统（第2-3周）
**目标**：支持交易附件（发票、小票等）

**具体任务**：
- [ ] 图片拍照/选择功能
- [ ] 图片压缩和存储优化
- [ ] 附件预览界面
- [ ] OCR识别（可选）：自动提取金额
- [ ] 存储管理：本地/云端存储

**存储策略**：
```kotlin
class AttachmentManager {
    suspend fun addAttachment(
        transactionId: String,
        imageUri: Uri
    ): Result<Attachment> {
        // 1. 压缩图片
        val compressed = imageCompressor.compress(imageUri, quality = 80)
        
        // 2. 生成存储路径
        val fileName = "${transactionId}_${System.currentTimeMillis()}.jpg"
        val localPath = File(attachmentDir, fileName)
        
        // 3. 保存到本地
        compressed.copyTo(localPath)
        
        // 4. 可选：上传到云端
        if (syncEnabled) {
            cloudStorage.upload(localPath)
        }
        
        return Attachment(
            id = UUID.randomUUID().toString(),
            transactionId = transactionId,
            fileName = fileName,
            localPath = localPath.path,
            cloudUrl = null,
            size = localPath.length()
        )
    }
}
```

### 2.3 标签系统增强（第3周）
**目标**：灵活的标签管理，支持智能推荐

**具体任务**：
- [ ] 标签管理界面：创建、编辑、删除
- [ ] 标签颜色自定义
- [ ] 智能标签推荐
- [ ] 标签使用统计
- [ ] 批量标签操作

### 2.4 报表功能升级（第4周）
**目标**：专业的财务报表和分析

**具体任务**：
- [ ] 收支趋势图：支持多维度对比
- [ ] 分类占比分析：饼图、环形图
- [ ] 账户资产变化：折线图
- [ ] 自定义报表周期
- [ ] 报表导出功能

## 第三阶段：高级功能实现（2025年10月）

### 3.1 预算管理完善（第1-2周）
**目标**：灵活的预算设置和超支提醒

**具体任务**：
- [ ] 分类预算：按分类设置月度预算
- [ ] 总额预算：设置月度总支出预算
- [ ] 预算进度：实时显示预算使用情况
- [ ] 超支预警：推送通知提醒
- [ ] 预算报告：月度预算执行分析

### 3.2 定期交易增强（第2周）
**目标**：更智能的定期交易管理

**具体任务**：
- [ ] 灵活周期：支持各种重复模式
- [ ] 智能提醒：提前提醒确认
- [ ] 批量管理：一次性修改多个定期交易
- [ ] 自动分类：基于历史数据自动分类

### 3.3 数据分析引擎（第3周）
**目标**：提供深度的财务洞察

**具体任务**：
- [ ] 消费习惯分析
- [ ] 异常支出检测
- [ ] 财务健康评分
- [ ] 个性化建议
- [ ] 对比分析（同比、环比）

### 3.4 性能优化与发布准备（第4周）
**目标**：确保应用性能和稳定性

**具体任务**：
- [ ] 数据库索引优化
- [ ] 查询性能优化
- [ ] 内存使用优化
- [ ] 启动速度优化
- [ ] 全面测试和修复

## 技术实施细节

### 数据库迁移策略
```kotlin
object DatabaseMigrations {
    val MIGRATION_7_8 = object : Migration(7, 8) {
        override fun migrate(database: SupportSQLiteDatabase) {
            // 1. 分类表扩展
            database.execSQL("ALTER TABLE categories ADD COLUMN parentId TEXT")
            database.execSQL("ALTER TABLE categories ADD COLUMN level INTEGER NOT NULL DEFAULT 1")
            
            // 2. 交易表扩展
            database.execSQL("ALTER TABLE transactions ADD COLUMN subCategoryId TEXT")
            database.execSQL("ALTER TABLE transactions ADD COLUMN currency TEXT NOT NULL DEFAULT 'CNY'")
            database.execSQL("ALTER TABLE transactions ADD COLUMN exchangeRate REAL NOT NULL DEFAULT 1.0")
            database.execSQL("ALTER TABLE transactions ADD COLUMN toAccountId TEXT")
            database.execSQL("ALTER TABLE transactions ADD COLUMN attachmentCount INTEGER NOT NULL DEFAULT 0")
            
            // 3. 创建附件表
            database.execSQL("""
                CREATE TABLE IF NOT EXISTS attachments (
                    id TEXT PRIMARY KEY NOT NULL,
                    transactionId TEXT NOT NULL,
                    fileName TEXT NOT NULL,
                    filePath TEXT NOT NULL,
                    fileSize INTEGER NOT NULL,
                    uploadedAt INTEGER,
                    cloudUrl TEXT,
                    FOREIGN KEY(transactionId) REFERENCES transactions(id) ON DELETE CASCADE
                )
            """)
            
            // 4. 创建索引
            database.execSQL("CREATE INDEX idx_categories_parentId ON categories(parentId)")
            database.execSQL("CREATE INDEX idx_attachments_transactionId ON attachments(transactionId)")
        }
    }
}
```

### 模块间通信优化
```kotlin
// LedgerApi 扩展
interface LedgerApi {
    // 现有方法...
    
    // 新增方法
    suspend fun createTransfer(request: TransferRequest): Result<TransferResult>
    suspend fun getCategoriesHierarchy(): List<CategoryNode>
    suspend fun addAttachment(transactionId: String, uri: Uri): Result<Attachment>
    suspend fun getExchangeRate(from: String, to: String): Double
    suspend fun getBudgetStatus(): BudgetStatus
    
    // 导航方法
    fun navigateToCategoryManagement()
    fun navigateToTransferHistory()
    fun navigateToBudgetSettings()
}
```

### 性能监控指标
```kotlin
class PerformanceMonitor {
    fun trackMetrics() {
        // 启动时间
        trackAppStartTime()
        
        // 数据库查询性能
        trackDatabaseQueryTime("getAllTransactions")
        
        // 内存使用
        trackMemoryUsage()
        
        // UI渲染性能
        trackFrameRate()
        
        // 网络请求
        trackNetworkLatency("exchangeRateApi")
    }
}
```

## 风险管理

### 技术风险
1. **数据库迁移风险**
   - 缓解措施：充分测试，提供回滚机制
   - 备份策略：迁移前自动备份

2. **性能退化风险**
   - 缓解措施：性能基准测试，持续监控
   - 优化策略：分页加载，缓存机制

3. **兼容性风险**
   - 缓解措施：多设备测试，灰度发布
   - 支持版本：Android 8.0+

### 项目风险
1. **进度延期风险**
   - 缓解措施：敏捷开发，及时调整范围
   - 优先级管理：核心功能优先

2. **资源不足风险**
   - 缓解措施：分阶段交付，外包部分工作
   - 人力规划：2名开发，1名测试

## 成功标准

### 功能指标
- [ ] 完成80%以上的计划功能
- [ ] 支持钱迹数据完整导入导出
- [ ] 二级分类使用率达到30%
- [ ] 转账功能日活用户10%

### 性能指标
- [ ] 应用启动时间 < 2秒
- [ ] 10万记录查询 < 500ms
- [ ] 内存占用 < 150MB
- [ ] 崩溃率 < 0.1%

### 用户指标
- [ ] 用户满意度 > 4.5分
- [ ] 功能完整性评分 > 4.0分
- [ ] 推荐意愿 > 80%

## 后续规划

### 2025年Q4计划
1. **AI智能助手**：基于用户数据的智能分析和建议
2. **家庭账本**：支持多人协作记账
3. **投资理财**：整合投资账户管理
4. **国际化**：支持多语言

### 2026年展望
1. **企业版本**：面向小微企业的财务管理
2. **开放平台**：第三方应用接入
3. **区块链**：去中心化的账本同步

---

**文档信息**
- 创建时间：2025-07-31
- 最后更新：2025-07-31
- 负责人：开发团队
- 状态：待审批