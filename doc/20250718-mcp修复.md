# MCP服务器修复计划

**日期**: 2025-07-18  
**问题**: Claude Code MCP服务器连接失败，o3mcp 和 android-compiler 均显示 "✘ failed" 状态

## 问题分析

### 1. o3mcp 失败原因
- **依赖未安装**: `node_modules` 目录不存在
- **Node.js版本要求**: 需要 Node.js >= 18.0.0
- **环境变量**: 启动时检查 `OPENAI_API_KEY`，如果缺失会直接退出

### 2. android-compiler 失败原因
- **路径错误**: 配置中使用了WSL路径 `/home/hua/android-compiler-mcp/index.js`
- **Windows系统无法识别WSL路径**，导致服务器启动失败

## 修复计划

### 一、o3mcp 修复步骤 ✅ 已完成

#### 1. 依赖安装和验证 ✅
```bash
# 步骤1.1：进入o3mcp目录
cd D:\开发项目\mcp\o3mcp

# 步骤1.2：安装依赖（已修复TypeScript编译错误）
npm install  # ✅ 成功安装550个包

# 步骤1.3：验证构建
npm run build  # ✅ 编译成功

# 步骤1.4：测试环境变量
npm run verify:env  # ✅ 执行成功（环境变量从.env文件读取）
```

#### 2. 验证Node.js版本 ✅
```bash
# 检查Node.js版本（需要 >= 18.0.0）
node --version  # ✅ v22.16.0 满足要求
```

#### 3. 测试o3mcp独立运行 ✅
```bash
# 测试启动
npm run start  # ✅ 成功启动，显示"O3MCP is running"
```

**修复记录**：
- 修复了`src/verify/test-mcp-call.ts`中的TypeScript错误
- 将`result.hidden_requirements?.join(', ')`改为`result.essence.hidden_requirements.join(', ')`
- o3mcp服务器成功启动并运行在stdio传输模式

### 二、android-compiler 修复步骤

#### 1. 查找android-compiler的实际位置 ✅
```bash
# 方案A：如果在WSL中
wsl -e ls -la /home/hua/android-compiler-mcp/  # ❌ Git Bash环境干扰

# 方案B：查找Windows本地是否有副本
dir C:\Users\Hua\android-compiler-mcp 2>nul  # ❌ 不存在
dir D:\android-compiler-mcp 2>nul  # ❌ 不存在
```

**发现的问题**：
- Claude配置中的路径被错误解析为 "D:/Program Files/Git/home/ua/android-compiler-mcp/index.js"
- 实际应该是WSL路径 "/home/hua/android-compiler-mcp/index.js"

**解决方案**：
创建批处理脚本包装WSL调用：
```batch
# 已创建 scripts\android-compiler-wrapper.bat
@echo off
wsl node /home/hua/android-compiler-mcp/index.js %*
```

#### 2. 路径转换方案
**如果在WSL中**：
- WSL路径：`/home/hua/android-compiler-mcp/index.js`
- 转换为：`\\wsl$\Ubuntu\home\hua\android-compiler-mcp\index.js`
- 或使用：`wsl node /home/hua/android-compiler-mcp/index.js`

**如果有Windows副本**：
- 直接使用Windows路径，例如：`C:\Users\Hua\android-compiler-mcp\index.js`

### 三、修改Claude配置文件 ✅ 已完成

#### 1. 备份当前配置 ✅
```bash
cp C:\Users\Hua\.claude.json C:\Users\Hua\.claude.json.backup-20250718  # ✅ 备份成功
```

#### 2. 修改配置文件 ✅
已修改 `C:\Users\Hua\.claude.json` 中的 mcpServers 部分：

```json
"mcpServers": {
  "o3mcp": {
    "type": "stdio",
    "command": "node",
    "args": ["D:/开发项目/mcp/o3mcp/dist/index.js"],
    "env": {
      "OPENAI_API_KEY": "sk-AjLiv6wVrbxtroActCAuqeirwwBhgLx1dBy6VQaLL8hnHAGgB2ET",
      "OPENAI_BASE_URL": "https://api.oaipro.com/v1",
      "O3_MODEL": "o3-2025-04-16",
      "NODE_ENV": "development",
      "LOG_LEVEL": "debug"
    }
  },
  "android-compiler": {
    "type": "stdio",
    "command": "D:\\kotlin\\Cc_xiaoji\\scripts\\android-compiler-wrapper.bat",
    "args": [],
    "env": {}
  }
}
```

**修改内容**：
1. o3mcp：添加了必需的环境变量
2. android-compiler：改用批处理脚本避免WSL路径解析问题

### 四、验证和测试

#### 1. 重启Claude Code
- 完全退出Claude Code
- 重新启动Claude Code

#### 2. 验证MCP状态
- 运行 `/mcp` 命令查看两个服务器状态
- 检查是否显示为运行状态而非failed

#### 3. 测试工具可用性
- 检查是否出现 `mcp__o3mcp__` 开头的工具
- 检查是否出现 `mcp__android-compiler__` 开头的工具

### 五、故障排除

#### o3mcp故障排除
1. 检查防火墙/杀毒软件是否阻止
2. 验证API密钥是否有效
3. 查看Claude日志文件

#### android-compiler故障排除
1. 考虑将android-compiler项目复制到Windows本地
2. 创建批处理脚本包装WSL调用
3. 使用Node.js的Windows版本运行

## 执行顺序

1. **先修复o3mcp**（依赖明确，修复相对简单）
2. **再修复android-compiler**（需要确定文件位置和路径问题）
3. **修改配置文件**
4. **重启Claude Code并验证**

## 配置文件位置参考

- Claude用户配置：`C:\Users\Hua\.claude.json`
- o3mcp项目位置：`D:\开发项目\mcp\o3mcp`
- android-compiler位置：`/home/hua/android-compiler-mcp/` (WSL)

## 环境要求

- Node.js >= 18.0.0
- npm（用于安装依赖）
- WSL（如果android-compiler在WSL中）

## 注意事项

1. 修改配置文件后必须重启Claude Code
2. 环境变量中的API密钥需要保密
3. 路径分隔符在Windows中使用正斜杠或双反斜杠

## 修复完成总结 ✅

**修复日期**: 2025-07-18 13:30

### 已完成的修复：

1. **o3mcp 修复** ✅
   - 修复TypeScript编译错误
   - 安装npm依赖（550个包）
   - 验证Node.js版本（v22.16.0）
   - 成功启动服务器

2. **android-compiler 修复** ✅
   - 发现WSL路径解析问题
   - 创建批处理脚本包装器
   - 修改配置使用批处理脚本

3. **Claude配置更新** ✅
   - 备份原配置文件
   - 为o3mcp添加环境变量
   - 修复android-compiler路径问题

### 下一步操作：
1. **重启Claude Code** - 使配置生效
2. 使用 `/mcp` 命令验证服务器状态
3. 检查是否出现 `mcp__o3mcp__` 和 `mcp__android-compiler__` 开头的工具

### 创建的文件：
- `scripts/android-compiler-wrapper.bat` - 解决WSL路径问题
- `C:\Users\Hua\.claude.json.backup-20250718` - 配置备份