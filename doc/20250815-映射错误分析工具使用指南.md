# 映射错误分析工具使用指南

## 概述
为了精确定位钱迹CSV导入时的字段映射错误，创建了专门的分析工具`ImportMappingAnalyzer`。

## 核心功能

### ImportMappingAnalyzer
位置：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/data/diagnostic/ImportMappingAnalyzer.kt`

**功能特性**：
- 自动识别转账对象（人名）被错误创建为账户
- 识别正常的支付方式账户
- 分析账户交易特征
- 生成修复建议

## 账户分类逻辑

### 1. 转账对象识别
- 账户名以">"开头（转账标记）
- 符合人名模式（2-4个汉字）
- 交易次数少（≤5笔）
- 平均金额大（>500元）

### 2. 支付方式识别
- 包含关键词：微信、支付宝、花呗、银行等
- 交易频繁（>10笔）
- 涉及多个分类

### 3. 可疑账户识别
- 所有交易在同一分类（可能是二级分类）
- UUID格式账户ID
- 无交易记录

## 使用方法

### 自动运行
应用启动时会自动运行分析：
```kotlin
// 在LedgerViewModel的init块中
mappingAnalyzer.analyzeMappingErrors(userId)
```

### 手动触发
```kotlin
// 在LedgerViewModel中调用
analyzeMappingErrors()
```

## 查看分析结果

### Logcat过滤
使用标签 `MAPPING_ANALYZER` 查看详细分析

### 输出示例
```
========================================
     导入映射错误精准分析
========================================

【账户分类分析】
总账户数: 17
总交易数: 6510

账户: >劳闻文
  类型识别: TRANSFER_PARTY
  交易数: 1
  总金额: 10000.0元
  判断理由: 账户名以'>'开头，疑似转账标记

账户: 微信零钱  
  类型识别: PAYMENT_METHOD
  交易数: 3229
  判断理由: 包含支付关键词，交易频繁

【分析结果汇总】
🔴 转账对象（错误创建为账户）: 4个
✅ 正常支付方式: 4个
⚠️ 可疑账户: 9个

【修复建议】
1. 发现4个转账对象被错误创建为账户，建议：
   a) 将这些交易的转账对象信息移到备注字段
   b) 根据交易类型确定正确的支付账户
   c) 删除这些错误创建的账户
```

## 关键发现

### 错误模式
1. **转账对象被当作账户**
   - ">劳闻文"、">翁显"等应该是转账收款人
   - 这些信息应该在备注字段，不是账户

2. **可能的字段错位**
   - CSV某列可能包含混合信息
   - 解析器没有正确识别字段含义

3. **二级分类缺失影响**
   - 钱迹有二级分类，CC小记没有
   - 二级分类可能被误判为账户

## 后续步骤

1. **验证分析结果**
   - 运行应用查看MAPPING_ANALYZER日志
   - 确认识别的错误账户

2. **检查原始数据**
   - 查看钱迹CSV文件结构
   - 确认字段映射逻辑

3. **制定修复方案**
   - 基于分析结果决定修复策略
   - 可以是数据迁移或导入器改进

## 注意事项

- 分析工具只读取数据，不会修改
- 建议在修复前备份数据
- 修复应该基于精确的分析结果

---
更新时间：2025-08-15