# 账户修复方案实施记录

## 问题诊断
导入钱迹数据后，交易记录不显示的根本原因是账户ID不匹配：
- 查询时使用的账户ID：`default_account_id`
- 导入数据时创建的账户ID：`eacd3aae-f896-457f-8e41-4cdf20208d9d`
- SQL查询会过滤掉不匹配的账户，导致查询结果为空

## 实施方案

### 第一阶段：立即修复（已完成）

#### 1. QianjiMapper.kt 修改
- 添加 `getOrCreateDefaultAccount()` 方法
- 空账户名统一映射到默认账户 `default_account_$userId`
- 确保所有导入的数据使用一致的账户ID

#### 2. LedgerViewModel.kt 修改
- 智能账户选择逻辑
- 默认账户查询所有交易（不指定accountId）
- 添加数据修复方法 `fixOrphanAccountData()`

#### 3. DataMigrationTool.kt 创建
- 修复历史导入的孤儿账户数据
- 将交易从临时账户迁移到默认账户
- 自动在ViewModel初始化时执行

## 验证步骤

### 1. 编译项目
```bash
.\compile_ledger.bat
```

### 2. 运行应用并查看日志
在Logcat中过滤 `LEDGER_DEBUG` 和 `DATA_MIGRATION` 标签，观察：
- 数据修复过程
- 账户加载情况
- 交易查询结果

### 3. 预期结果
- 默认账户自动创建
- 历史数据迁移到默认账户
- 2024年10月的交易记录正常显示

## 关键日志标签

| 标签 | 用途 |
|------|------|
| LEDGER_DEBUG | 记账模块查询和加载日志 |
| DATA_MIGRATION | 数据修复过程日志 |
| QIANJI_DEBUG | 钱迹数据导入日志 |

## 修改的文件

1. `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/data/importer/qianji/QianjiMapper.kt`
   - 添加默认账户管理逻辑
   
2. `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/viewmodel/LedgerViewModel.kt`
   - 智能账户选择
   - 数据修复集成
   
3. `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/data/migration/DataMigrationTool.kt`
   - 新增数据修复工具类

## 后续优化建议

### 第二阶段：长期优化
1. 创建账户映射表支持多源数据导入
2. 优化账户选择UI，显示账户余额
3. 添加账户管理功能（添加、编辑、删除）
4. 支持多账户筛选和统计

### 兼容性考虑
- 支持钱迹、随手记等多个记账APP数据导入
- 统一的账户映射策略
- 保留原始账户信息用于追溯

## 测试清单

- [ ] 编译通过
- [ ] 应用启动正常
- [ ] 数据修复日志正常
- [ ] 默认账户创建成功
- [ ] 交易记录正常显示
- [ ] 月度统计数据正确
- [ ] 账户切换功能正常

## 更新时间
2025-08-15