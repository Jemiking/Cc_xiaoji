# 数据库迁移说明：v18 -> v19

本次迁移将 Schedule 模块的 `sync_status` 字段由 `INTEGER` 统一为 `TEXT`，对应全局 `SyncStatus` 枚举（由全局 `Converters` 负责转换）。

## 变更背景
- 目标：跨模块统一同步状态的表示，降低维护成本与歧义。
- 现状：Schedule 使用整型本地常量（0/1/2），其他模块使用全局 `SyncStatus`（字符串）。

## 具体变更
- 实体更新：
  - `feature/schedule/.../ShiftEntity.syncStatus: Int` → `SyncStatus`
  - `feature/schedule/.../ScheduleEntity.syncStatus: Int` → `SyncStatus`
- 迁移脚本：`core/database/.../Migration_18_19.kt`
  - 新建临时表（`*_new`），将旧表数据搬迁并做值映射，然后替换旧表。
  - 值映射（旧 -> 新）：
    - 0 → `PENDING`
    - 1 → `SYNCED`
    - 2 → `PENDING_SYNC`
  - 重建索引：`index_schedules_date`（唯一）、`index_schedules_shift_id`。
- 版本号：
  - `CcDatabase.version` 升级至 `19`。
  - `DatabaseMigrations.getAllMigrations()` 增加 `MIGRATION_18_19`。

## 测试与验证
- 本地与 CI：
  - 执行 `./gradlew check`（包含：重复枚举名校验 + 单元测试）。
  - 新增单测：`ConvertersTest.syncStatus_roundTrip`，确保枚举与字符串的往返转换正确。
- 仪器测试（建议在设备/模拟器上执行）：
  - 准备含旧版本（v18）的测试数据库，`schedules.sync_status` 与 `shifts.sync_status` 分别包含值 0/1/2；
  - 安装新版本（v19），启动应用触发自动迁移；
  - 校验迁移后两张表 `sync_status` 值变更为 `PENDING`/`SYNCED`/`PENDING_SYNC`，索引存在且查询正常。
  - 命令：`./gradlew connectedAndroidTest`（如有对应测试用例）。

## 风险与回滚
- 风险：低。仅两张表的字段类型变更，无跨表依赖变更。
- 回滚：如需回退，可按需准备 `Migration_19_18`（将 `TEXT` 值反向映射回 `INTEGER`）。

## 开发者提示
- 后续在 Schedule 相关查询中若需要按同步状态筛选，请统一使用 `SyncStatus` 枚举（字符串）进行比较。
- 新增/更新记录请确保赋值 `SyncStatus`（实体默认 `PENDING`）。

