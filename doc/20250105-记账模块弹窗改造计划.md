# 记账模块弹窗改造计划

> 创建日期：2025-01-05
> 最后更新：2025-01-05
> 状态：规划中 🔄

## 背景与问题

### 当前问题
1. **弹窗层级冲突**：FlatBudgetDialog中嵌套BottomSheet导致无法点击
2. **用户体验受限**：弹窗空间有限，复杂操作不便
3. **导航不一致**：混合使用弹窗和页面，缺乏统一性
4. **维护困难**：弹窗内状态管理复杂

### 改造目标
- 将复杂弹窗改造为独立页面
- 提供更好的用户体验和更大的操作空间
- 统一导航模式，符合Android设计规范
- 简化状态管理和数据流

## 弹窗清单（共28个）

### 1. 交易管理弹窗（4个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| AddTransactionDialog | 添加交易记录 | AlertDialog | `ledger/dialogs/AddTransactionDialog.kt` | 🔴 高 | ⏳ 待改造 |
| EditTransactionDialog | 编辑交易记录 | AlertDialog | `ledger/dialogs/EditTransactionDialog.kt` | 🔴 高 | ⏳ 待改造 |
| FilterTransactionDialog | 筛选交易 | AlertDialog | `ledger/dialogs/FilterTransactionDialog.kt` | 🟡 中 | ⏳ 待改造 |
| CustomDatePickerDialog | 日期选择 | DatePickerDialog | `ledger/dialogs/CustomDatePickerDialog.kt` | 🟢 低 | ⏳ 待改造 |

### 2. 账户管理弹窗（3个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| AddAccountDialog | 添加账户 | AlertDialog | `account/dialogs/AddAccountDialog.kt` | 🔴 高 | ⏳ 待改造 |
| EditAccountDialog | 编辑账户 | AlertDialog | `account/dialogs/EditAccountDialog.kt` | 🔴 高 | ⏳ 待改造 |
| AccountTransferDialog | 账户转账 | AlertDialog | `account/dialogs/AccountTransferDialog.kt` | 🔴 高 | ⏳ 待改造 |

### 3. 预算管理弹窗（1个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| FlatBudgetDialog | 预算设置 | FlatDialog + BottomSheet | `budget/components/FlatBudgetDialog.kt` | 🔴 高 | ⏳ 待改造 |

### 4. 分类管理弹窗（2个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| FlatAddCategoryDialog | 添加分类 | FlatDialog | `category/components/FlatAddCategoryDialog.kt` | 🟡 中 | ⏳ 待改造 |
| FlatEditCategoryDialog | 编辑分类 | FlatDialog | `category/components/FlatEditCategoryDialog.kt` | 🟡 中 | ⏳ 待改造 |

### 5. 信用卡管理弹窗（5个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| AddCreditCardDialog | 添加信用卡 | AlertDialog | `creditcard/CreditCardDialogs.kt` | 🟡 中 | ⏳ 待改造 |
| CreditCardDetailDialog | 信用卡详情 | AlertDialog | `creditcard/CreditCardDialogs.kt` | 🟡 中 | ⏳ 待改造 |
| PaymentDialog | 还款操作 | AlertDialog | `creditcard/CreditCardDialogs.kt` | 🟡 中 | ⏳ 待改造 |
| EditCreditCardDialog | 编辑信用卡 | AlertDialog | `creditcard/CreditCardDialogs.kt` | 🟡 中 | ⏳ 待改造 |
| PaymentHistoryDialog | 还款历史 | Dialog（全屏） | `creditcard/PaymentHistoryDialog.kt` | 🟢 低 | ⏳ 待改造 |

### 6. 储蓄目标弹窗（3个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| FlatSavingsGoalDialog | 储蓄目标设置 | FlatDialog | `savings/dialogs/FlatSavingsGoalDialog.kt` | 🟡 中 | ⏳ 待改造 |
| FlatContributionDialog | 存入资金 | FlatDialog | `savings/dialogs/FlatContributionDialog.kt` | 🟡 中 | ⏳ 待改造 |
| FlatDeleteConfirmDialog | 删除确认 | FlatDialog | `savings/dialogs/FlatDeleteConfirmDialog.kt` | 🟢 低 | ⏳ 待改造 |

### 7. 批量操作弹窗（3个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| BatchDeleteDialog | 批量删除 | AlertDialog | `component/BatchOperationDialogs.kt` | 🟢 低 | ⏳ 待改造 |
| BatchUpdateCategoryDialog | 批量修改分类 | AlertDialog | `component/BatchOperationDialogs.kt` | 🟢 低 | ⏳ 待改造 |
| BatchUpdateAccountDialog | 批量修改账户 | AlertDialog | `component/BatchOperationDialogs.kt` | 🟢 低 | ⏳ 待改造 |

### 8. 设置相关弹窗（4个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| CurrencySelectionDialog | 币种选择 | FlatDialog | `settings/dialogs/CurrencySelectionDialog.kt` | 🟢 低 | ⏳ 待改造 |
| AccountSelectionDialog | 默认账户选择 | Dialog | `settings/dialogs/AccountSelectionDialog.kt` | 🟢 低 | ⏳ 待改造 |
| ReminderSettingsDialog | 提醒设置 | Dialog | `settings/dialogs/ReminderSettingsDialog.kt` | 🟢 低 | ⏳ 待改造 |
| HomeDisplaySettingsDialog | 首页显示设置 | Dialog | `settings/dialogs/HomeDisplaySettingsDialog.kt` | 🟢 低 | ⏳ 待改造 |

### 9. 其他弹窗（3个）
| 弹窗名称 | 功能描述 | 类型 | 文件位置 | 优先级 | 状态 |
|---------|---------|------|---------|-------|------|
| FlatDeleteDialog | 通用删除确认 | FlatDialog | `transaction/components/FlatDeleteDialog.kt` | 🟢 低 | ⏳ 待改造 |
| FlatRecurringDialog | 定期交易设置 | FlatDialog | `recurring/components/FlatRecurringDialog.kt` | 🟡 中 | ⏳ 待改造 |
| AdvancedFilterDialog | 高级筛选 | AlertDialog | `component/AdvancedFilterDialog.kt` | 🟡 中 | ⏳ 待改造 |

## 改造方案

### 第一阶段：高优先级弹窗（7个）
目标：解决最影响用户体验的核心功能弹窗

1. **FlatBudgetDialog → AddEditBudgetScreen**
   - 原因：存在弹窗嵌套问题，影响操作
   - 新页面：全屏页面，分类选择使用内嵌列表或单独页面
   
2. **AddTransactionDialog → AddTransactionScreen**
   - 原因：最常用功能，需要更好的输入体验
   - 新页面：全屏页面，更大的分类选择区域
   
3. **EditTransactionDialog → EditTransactionScreen**
   - 原因：编辑需要更多空间展示原始信息
   - 新页面：与添加页面类似，支持删除操作

4. **账户管理三个弹窗 → 对应页面**
   - AddAccountDialog → AddAccountScreen
   - EditAccountDialog → EditAccountScreen
   - AccountTransferDialog → TransferScreen

### 第二阶段：中优先级弹窗（10个）
目标：统一用户体验，提升操作便利性

- 分类管理弹窗 → 页面
- 信用卡管理弹窗 → 页面（除历史记录外）
- 储蓄目标弹窗 → 页面
- 定期交易弹窗 → 页面
- 高级筛选弹窗 → 页面

### 第三阶段：低优先级弹窗（11个）
目标：完善整体改造，部分可保留为弹窗

- 批量操作弹窗（可保留）
- 设置相关弹窗（可保留）
- 删除确认弹窗（保留）
- 日期选择器（保留）

## 实施步骤

### 1. 创建新页面
```kotlin
// 示例：AddTransactionScreen
@Composable
fun AddTransactionScreen(
    navController: NavController,
    viewModel: TransactionViewModel = hiltViewModel()
) {
    // 页面实现
}
```

### 2. 添加导航路由
```kotlin
// 在 LedgerNavigation.kt 中添加
const val ADD_TRANSACTION_ROUTE = "add_transaction"
const val EDIT_TRANSACTION_ROUTE = "edit_transaction/{transactionId}"
```

### 3. 更新调用处
```kotlin
// 原来：showAddTransactionDialog = true
// 改为：navController.navigate(ADD_TRANSACTION_ROUTE)
```

### 4. 迁移业务逻辑
- 将弹窗中的状态管理迁移到ViewModel
- 处理导航参数传递
- 实现返回结果处理

## 技术要点

### 导航参数传递
```kotlin
// 传递参数
navController.navigate("edit_transaction/$transactionId")

// 接收参数
@Composable
fun EditTransactionScreen(
    transactionId: String,
    navController: NavController
)
```

### 返回结果处理
```kotlin
// 使用 SavedStateHandle 返回结果
navController.previousBackStackEntry
    ?.savedStateHandle
    ?.set("transaction_added", true)
```

### 动画过渡
```kotlin
// 使用 Compose Navigation 动画
enterTransition = { slideInHorizontally() }
exitTransition = { slideOutHorizontally() }
```

## 进度追踪

### 完成标准
- [ ] 页面创建完成
- [ ] 导航路由配置
- [ ] 原弹窗调用处更新
- [ ] 功能测试通过
- [ ] UI/UX审查通过

### 当前进度
- 总弹窗数：28个
- 待改造：28个
- 进行中：0个
- 已完成：0个
- 完成率：0%

## 注意事项

1. **保持功能一致性**：改造后功能不能缺失
2. **数据迁移**：确保ViewModel正确管理状态
3. **返回处理**：正确处理用户取消和确认操作
4. **动画体验**：使用合适的页面过渡动画
5. **测试覆盖**：每个改造都需要充分测试

## 更新记录

### 2025-01-05
- 创建初始计划文档
- 完成28个弹窗的统计和分类
- 制定三阶段改造计划

---
*本文档将持续更新，记录每个弹窗的改造进度*