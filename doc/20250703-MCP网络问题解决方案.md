# MCP Kotlin编译器网络问题解决方案

## 问题症状
- Gradle wrapper下载超时
- Maven依赖下载失败
- 连接services.gradle.org超时
- SocketTimeoutException错误

## 解决方案汇总

### 方案1：使用国内镜像（推荐）
已经配置的镜像源：
- **Gradle Wrapper**: 腾讯云镜像
- **Maven仓库**: 阿里云镜像
- **插件仓库**: 阿里云镜像

### 方案2：增加超时时间
已配置的超时设置：
```properties
# gradle.properties
systemProp.http.connectionTimeout=120000
systemProp.http.socketTimeout=120000
networkTimeout=60000
```

### 方案3：配置代理
如果使用代理，在`gradle.properties`中配置：
```properties
systemProp.http.proxyHost=127.0.0.1
systemProp.http.proxyPort=7890
systemProp.https.proxyHost=127.0.0.1
systemProp.https.proxyPort=7890
systemProp.http.nonProxyHosts=localhost|127.0.0.1|*.aliyun.com
```

### 方案4：手动下载Gradle
当自动下载失败时：
```bash
chmod +x scripts/manual-download-gradle.sh
./scripts/manual-download-gradle.sh
```

## 已创建的修复脚本

### 1. fix-mcp-network.sh
综合网络修复脚本，包括：
- 配置全局Gradle镜像
- 设置项目镜像源
- 清理缓存
- 网络诊断

### 2. manual-download-gradle.sh
手动下载Gradle脚本：
- 提供多个下载源选择
- 自动安装到正确位置
- 验证文件完整性

### 3. diagnose-network.sh
网络诊断脚本（自动生成在MCP项目中）：
- DNS解析测试
- 连接测试
- 代理检查

## 修复步骤

### 步骤1：运行网络修复脚本
```bash
chmod +x scripts/fix-mcp-network.sh
./scripts/fix-mcp-network.sh
```

### 步骤2：测试Gradle下载
```bash
cd /mnt/d/kotlin/mcp-kotlin-compiler/test-project
./gradlew --version
```

### 步骤3：如果仍然失败，手动下载
```bash
./scripts/manual-download-gradle.sh
```

### 步骤4：编译测试
```bash
./gradlew clean build
```

## 配置文件更改

### 1. gradle-wrapper.properties
```properties
distributionUrl=https\://mirrors.cloud.tencent.com/gradle/gradle-8.5-bin.zip
networkTimeout=60000
```

### 2. settings.gradle.kts
```kotlin
pluginManagement {
    repositories {
        maven { url = uri("https://maven.aliyun.com/repository/gradle-plugin") }
        maven { url = uri("https://maven.aliyun.com/repository/public") }
        gradlePluginPortal()
        mavenCentral()
    }
}
```

### 3. build.gradle.kts
```kotlin
repositories {
    maven { url = uri("https://maven.aliyun.com/repository/public") }
    maven { url = uri("https://maven.aliyun.com/repository/gradle-plugin") }
    mavenCentral()
    google()
}
```

### 4. ~/.gradle/init.gradle.kts（全局配置）
自动配置所有项目使用国内镜像

## 常见问题

### Q1: 仍然无法下载Gradle
A: 尝试以下方法：
1. 使用VPN
2. 修改DNS为8.8.8.8或114.114.114.114
3. 使用手动下载脚本
4. 从其他机器复制~/.gradle目录

### Q2: 依赖下载慢
A: 检查是否正确配置了阿里云镜像，可以尝试：
1. 清理缓存：`rm -rf ~/.gradle/caches`
2. 使用`--refresh-dependencies`参数
3. 配置更多镜像源

### Q3: SSL证书错误
A: 可能是代理或防火墙问题：
1. 检查系统时间是否正确
2. 尝试关闭SSL验证（不推荐）：`-Dcom.sun.net.ssl.checkRevocation=false`
3. 更新Java证书库

## 镜像源列表

### 推荐镜像
1. **阿里云**（最快）
   - https://maven.aliyun.com/repository/public
   - https://maven.aliyun.com/repository/gradle-plugin

2. **腾讯云**
   - https://mirrors.cloud.tencent.com/nexus/repository/maven-public/
   - https://mirrors.cloud.tencent.com/gradle/

3. **华为云**
   - https://repo.huaweicloud.com/repository/maven/

## 验证配置

运行以下命令验证配置是否生效：
```bash
# 查看实际使用的仓库
./gradlew dependencies --info | grep "repository"

# 测试下载速度
time ./gradlew clean

# 查看详细日志
./gradlew build --debug > build.log 2>&1
```

## 总结
通过以上配置，MCP Kotlin编译器应该能够正常工作。关键是：
1. 使用国内镜像源
2. 增加超时时间
3. 正确配置代理（如果需要）
4. 必要时手动下载Gradle

如果仍有问题，请检查网络环境或联系网络管理员。