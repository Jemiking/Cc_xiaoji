# 增强调试工具使用指南

## 概述
为了精确定位记账数据显示不全的问题，创建了一个综合诊断工具，能够提供详细的数据分析和问题诊断。

## 核心组件

### 1. LedgerDiagnosticTool
位置：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/data/diagnostic/LedgerDiagnosticTool.kt`

提供两个主要功能：
- **runFullDiagnostic()** - 完整诊断报告
- **analyzeQueryLogic()** - 查询逻辑分析

## 诊断内容

### 完整诊断报告包含：

#### 1. 账户分析
- 所有账户列表（ID、名称、类型）
- 每个账户的交易数量
- 账户创建时间
- 是否为默认账户
- 识别临时账户（疑似问题账户）

#### 2. 交易分布
- 总交易数
- 各账户交易分布
- 月度分布统计
- 时间范围分析

#### 3. 问题识别
- 孤儿交易（没有有效账户的交易）
- 临时账户（UUID格式的账户ID）
- 默认账户交易占比

#### 4. 查询逻辑分析
- 不同查询条件的结果对比
- 账户过滤的影响
- 分页查询结果

## 日志输出示例

```
========================================
       记账模块综合诊断报告
========================================
用户ID: current_user_id
诊断时间: 2025-08-15T22:30:00

【账户分析】
账户总数: 5
----------------------------------------
1. 账户: 默认账户
   ID: default_account_current_user_id
   类型: CASH
   默认: 是 ✓
   交易数: 1274 条
   交易额: 156780.50 元
   首笔: 2024-01-15T10:30:00
   末笔: 2024-10-20T18:45:00
   创建: 2025-08-15T20:00:00

2. 账户: 临时账户
   ID: eacd3aae-f896-457f-8e41-4cdf20208d9d
   类型: OTHER
   默认: 否
   交易数: 5235 条
   交易额: 458920.30 元
   ⚠️ 疑似临时账户

【月度分布】
----------------------------------------
2024-01: ████ 520 条
2024-02: ███ 380 条
2024-10: ████████ 980 条

【问题诊断】
----------------------------------------
⚠️ 发现 4 个疑似临时账户
⚠️ 大部分交易不在默认账户中，建议执行数据迁移
```

## 查看调试日志

### 1. 编译并运行
```bash
.\compile_quick.bat
```

### 2. 在Logcat中过滤
使用标签 `DIAGNOSTIC` 查看诊断报告

### 3. 关键信息点
- **账户分布**：查看有多少个账户，每个账户的交易数
- **问题账户**：识别临时账户（UUID格式的ID）
- **数据占比**：默认账户的交易占比
- **查询分析**：为什么某些查询返回空结果

## 问题定位

根据诊断报告，可以确定：

1. **是否存在多个账户**
   - 正常账户 vs 临时账户
   - 交易如何分布在各账户

2. **查询逻辑是否正确**
   - 账户ID过滤的影响
   - 时间范围是否正确

3. **是否需要数据迁移**
   - 临时账户的交易量
   - 是否需要合并到默认账户

## 修复建议

基于诊断结果，工具会提供修复建议：

- **如果发现临时账户**：建议将交易迁移到默认账户
- **如果默认账户交易占比低**：建议执行数据整合
- **如果查询返回空**：检查账户ID过滤逻辑

## 手动触发诊断

可以在需要时手动触发诊断：

```kotlin
// 在LedgerViewModel中
fun runManualDiagnostic() {
    // 触发完整诊断
}
```

## 下一步

1. 运行应用，查看诊断报告
2. 根据报告确定问题原因
3. 选择合适的修复方案：
   - 数据迁移（合并账户）
   - 修改查询逻辑
   - 完善账户管理

## 注意事项

- 诊断工具不会修改任何数据
- 仅用于分析和问题定位
- 建议在修复前先备份数据

---
更新时间：2025-08-15