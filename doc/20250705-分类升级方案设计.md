# åˆ†ç±»å‡çº§æ–¹æ¡ˆè®¾è®¡

> åˆ›å»ºæ—¥æœŸï¼š2025-07-05
> ç›®æ ‡ï¼šä»8ä¸ªåˆ†ç±»å‡çº§åˆ°15ä¸ªåˆ†ç±»
> æŒ‘æˆ˜ï¼šé¿å…é‡å¤åˆ›å»ºï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§

## é—®é¢˜åˆ†æ

### å½“å‰çŠ¶æ€
- å·²æœ‰8ä¸ªåˆ†ç±»ï¼ˆæ–¹æ¡ˆä¸€åˆ›å»ºï¼‰
- éœ€è¦15ä¸ªåˆ†ç±»ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
- ç¼ºå°‘7ä¸ªé‡è¦åˆ†ç±»

### æŠ€æœ¯éšœç¢
1. **åˆå§‹åŒ–æ£€æŸ¥é€»è¾‘**
   ```kotlin
   if (categories.isEmpty()) {
       // åªåœ¨å®Œå…¨æ²¡æœ‰åˆ†ç±»æ—¶æ‰§è¡Œ
   }
   ```
   
2. **UUIDç”Ÿæˆæœºåˆ¶**
   - æ¯æ¬¡éƒ½ç”Ÿæˆæ–°çš„UUID
   - æ— æ³•è¯†åˆ«"åŒååˆ†ç±»"
   
3. **æ•°æ®åº“çº¦æŸ**
   - åªæœ‰IDä¸»é”®çº¦æŸ
   - æ²¡æœ‰(userId, name, type)å”¯ä¸€çº¦æŸ

## å¯è¡Œæ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ™ºèƒ½å¢é‡å‡çº§ï¼ˆæ¨èï¼‰
```kotlin
suspend fun upgradeDefaultCategories() {
    val existingCategories = categoryDao.getCategoriesByUser(userId).first()
    val existingNames = existingCategories.map { it.name to it.type }.toSet()
    
    val allDefaultCategories = listOf(
        // å®Œæ•´çš„15ä¸ªåˆ†ç±»å®šä¹‰
    )
    
    // åªæ·»åŠ ç¼ºå¤±çš„åˆ†ç±»
    val missingCategories = allDefaultCategories.filter { category ->
        (category.name to category.type) !in existingNames
    }
    
    if (missingCategories.isNotEmpty()) {
        categoryDao.insertCategories(missingCategories)
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¼šåˆ›å»ºé‡å¤åˆ†ç±»
- âœ… ä¿ç•™ç”¨æˆ·å·²æœ‰æ•°æ®
- âœ… å¯å¤šæ¬¡å®‰å…¨æ‰§è¡Œ

### æ–¹æ¡ˆBï¼šç‰ˆæœ¬åŒ–å‡çº§
```kotlin
// åœ¨SharedPreferencesä¸­è®°å½•åˆ†ç±»ç‰ˆæœ¬
const val CATEGORY_VERSION_KEY = "default_category_version"
const val CURRENT_CATEGORY_VERSION = 2 // 15ä¸ªåˆ†ç±»ç‰ˆæœ¬

suspend fun checkAndUpgradeCategories() {
    val currentVersion = prefs.getInt(CATEGORY_VERSION_KEY, 0)
    
    when {
        currentVersion < 1 -> createInitialCategories() // 8ä¸ª
        currentVersion < 2 -> addMissingCategories()   // +7ä¸ª
    }
    
    prefs.putInt(CATEGORY_VERSION_KEY, CURRENT_CATEGORY_VERSION)
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ¸…æ™°çš„ç‰ˆæœ¬ç®¡ç†
- âœ… æ”¯æŒæœªæ¥æ‰©å±•
- âœ… å¯è¿½è¸ªå‡çº§å†å²

### æ–¹æ¡ˆCï¼šå›ºå®šIDæ–¹æ¡ˆ
```kotlin
object DefaultCategories {
    // ä½¿ç”¨å›ºå®šçš„UUIDï¼Œè€Œä¸æ˜¯éšæœºç”Ÿæˆ
    const val CATEGORY_FOOD_ID = "00000000-0000-0000-0000-000000000001"
    const val CATEGORY_TRANSPORT_ID = "00000000-0000-0000-0000-000000000002"
    // ...
    
    val ALL_CATEGORIES = listOf(
        CategoryEntity(
            id = CATEGORY_FOOD_ID, // å›ºå®šID
            name = "é¤é¥®",
            // ...
        )
    )
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… IDå¯é¢„æµ‹ï¼Œä¾¿äºç®¡ç†
- âœ… å¯ä»¥ä½¿ç”¨REPLACEç­–ç•¥
- âœ… è·¨è®¾å¤‡åŒæ­¥å‹å¥½

## æ¨èå®æ–½æ­¥éª¤

### 1. ç«‹å³ä¿®å¤ï¼ˆä¿æŒç°çŠ¶ï¼‰
- ç»§ç»­ä½¿ç”¨æ–¹æ¡ˆä¸€çš„8ä¸ªåˆ†ç±»
- ä¸å½±å“ç°æœ‰ç”¨æˆ·ä½¿ç”¨

### 2. å‡†å¤‡å‡çº§ï¼ˆ1-2å¤©ï¼‰
- å®ç°æ–¹æ¡ˆAçš„æ™ºèƒ½å¢é‡å‡çº§
- æ·»åŠ å•å…ƒæµ‹è¯•
- æµ‹è¯•å„ç§å‡çº§åœºæ™¯

### 3. å‘å¸ƒå‡çº§ï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰
```kotlin
// åœ¨CcXiaoJiApplication.onCreate()ä¸­
CoroutineScope(Dispatchers.IO).launch {
    // ç°æœ‰é€»è¾‘...
    
    // æ–°å¢ï¼šæ£€æŸ¥å¹¶å‡çº§åˆ†ç±»
    categoryRepository.upgradeDefaultCategories()
}
```

### 4. é•¿æœŸä¼˜åŒ–
- ç»Ÿä¸€åˆ†ç±»å®šä¹‰åˆ°Category.kt
- æ·»åŠ æ•°æ®åº“å”¯ä¸€çº¦æŸ
- å®Œå–„åˆ†ç±»ç®¡ç†åŠŸèƒ½

## æ•°æ®è¿ç§»ç¤ºä¾‹

```kotlin
// éœ€è¦æ·»åŠ çš„7ä¸ªåˆ†ç±»
val missingCategories = listOf(
    CategoryEntity(name = "åŒ»ç–—", icon = "ğŸ¥", type = "EXPENSE", ...),
    CategoryEntity(name = "æ•™è‚²", icon = "ğŸ“š", type = "EXPENSE", ...),
    CategoryEntity(name = "å±…ä½", icon = "ğŸ ", type = "EXPENSE", ...),
    CategoryEntity(name = "æ°´ç”µ", icon = "ğŸ’¡", type = "EXPENSE", ...),
    CategoryEntity(name = "é€šè®¯", icon = "ğŸ“±", type = "EXPENSE", ...),
    CategoryEntity(name = "æŠ•èµ„", icon = "ğŸ“ˆ", type = "INCOME", ...),
    CategoryEntity(name = "å…¼èŒ", icon = "ğŸ’¼", type = "INCOME", ...)
)
```

## é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| é‡å¤åˆ†ç±» | ç”¨æˆ·å›°æƒ‘ | åŸºäºåç§°å»é‡ |
| IDå†²çª | æ•°æ®é”™è¯¯ | ä½¿ç”¨UUID |
| å‡çº§å¤±è´¥ | åŠŸèƒ½å—é™ | ä¿ç•™é™çº§é€»è¾‘ |

## æ€»ç»“

ç›´æ¥æ‰§è¡Œæ–¹æ¡ˆäºŒä¼šå¤±è´¥ï¼Œå› ä¸ºåˆå§‹åŒ–æ£€æŸ¥ä¼šé˜»æ­¢æ‰§è¡Œã€‚éœ€è¦å®ç°æ™ºèƒ½å¢é‡å‡çº§æœºåˆ¶ï¼Œç¡®ä¿ï¼š
1. ä¸åˆ›å»ºé‡å¤åˆ†ç±»
2. ä¿ç•™ç”¨æˆ·æ•°æ®
3. æ”¯æŒå¤šæ¬¡æ‰§è¡Œ

æ¨èé‡‡ç”¨æ–¹æ¡ˆAï¼ˆæ™ºèƒ½å¢é‡å‡çº§ï¼‰é…åˆç‰ˆæœ¬ç®¡ç†ï¼Œç¡®ä¿å¹³æ»‘è¿‡æ¸¡ã€‚

---
*è®¾è®¡æ—¶é—´ï¼š2025-07-05*