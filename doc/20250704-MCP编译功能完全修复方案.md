# MCP编译功能完全修复方案

## 1. 问题分析

### 根本原因
- WSL2环境使用Windows的Android SDK
- Build Tools 34.0.0中的工具是.exe文件，无法在Linux环境中执行
- Gradle检查Build Tools完整性时会失败

### 具体错误
- "Installed Build Tools revision 34.0.0 is corrupted"
- "Build-tool 34.0.0 is missing AAPT at .../aapt"
- "Build-tool 34.0.0 is missing DEXDUMP at .../dexdump"

## 2. 解决方案

### 步骤1：创建工具占位符
执行 `scripts/fix-wsl-build-tools.sh` 脚本，为所有必需的工具创建占位符：
```bash
chmod +x scripts/fix-wsl-build-tools.sh
./scripts/fix-wsl-build-tools.sh
```

此脚本会创建以下占位符文件：
- aapt, aapt2
- aidl, d8, dx
- dexdump, zipalign
- apksigner, mainDexClasses
- split-select, llvm-rs-cc, bcc_compat

### 步骤2：更新MCP服务器配置
MCP服务器 `/home/ua/android-compiler-mcp/index.js` 已更新，跳过更多Android资源相关任务：
```javascript
// 跳过的任务包括：
-x lint -x processDebugManifest -x processDebugResources 
-x mergeDebugResources -x generateDebugBuildConfig 
-x createDebugCompatibleScreenManifests -x extractDeepLinksDebug 
-x processDebugMainManifest -x mergeDebugAssets 
-x compressDebugAssets -x mergeDebugJniLibFolders 
-x mergeDebugNativeLibs -x stripDebugDebugSymbols 
-x validateSigningDebug -x writeDebugAppMetadata 
-x writeDebugSigningConfigVersions
```

### 步骤3：重启Claude Code
由于修改了MCP服务器代码，需要重启Claude Code使更改生效：
```bash
# 退出Claude Code
# 重新启动
claude
```

## 3. 使用方法

### 方法1：使用MCP工具（重启后）
```
# 检查环境
使用check_gradle工具检查环境，projectPath是"/mnt/d/kotlin/Cc_xiaoji"

# 编译整个项目
使用compile_kotlin工具编译项目，projectPath是"/mnt/d/kotlin/Cc_xiaoji"

# 编译特定模块
使用compile_kotlin工具编译feature-ledger模块，projectPath是"/mnt/d/kotlin/Cc_xiaoji"，module是"feature-ledger"
```

### 方法2：使用脚本（立即可用）
```bash
# 检查单个模块
./scripts/simple-kotlin-check.sh feature:ledger

# 检查所有模块
./scripts/mcp-compile.sh
```

## 4. 功能限制

### ✅ 可以做到
- 验证Kotlin代码语法正确性
- 检查类型错误和依赖问题
- 快速发现编译错误
- 支持所有模块的Kotlin编译

### ❌ 无法做到
- 处理Android资源文件
- 生成APK文件
- 执行lint检查
- 运行测试

## 5. 推荐工作流程

1. **在Claude Code中开发**
   - 使用AI辅助编写代码
   - 使用MCP工具验证语法
   - 快速迭代和修复错误

2. **语法验证循环**
   ```
   编写代码 → MCP编译验证 → 
     ↓成功：继续开发
     ↓失败：修复错误 → 重新验证
   ```

3. **完整构建**
   - 在Windows/Android Studio中进行最终构建
   - 处理资源文件和生成APK
   - 运行完整的测试套件

## 6. 注意事项

1. **环境变量**：MCP服务器已配置正确的ANDROID_HOME
2. **编译时间**：大型模块可能需要1-2分钟
3. **错误信息**：重点关注 "error:" 和 "e:" 开头的行
4. **警告信息**：可以暂时忽略警告，专注于错误修复

## 7. 故障排除

如果仍然遇到问题：
1. 确保执行了 `fix-wsl-build-tools.sh`
2. 检查 Build Tools 34.0.0 目录是否存在
3. 确保项目的 `local.properties` 文件存在
4. 尝试清理构建：`./gradlew clean`

## 总结

通过创建工具占位符和跳过资源处理任务，我们成功让MCP在WSL环境下能够编译Kotlin代码。这为自动化开发提供了基础，让Claude Code能够：
- 自动编写代码
- 立即验证语法正确性
- 根据编译结果进行修复
- 实现高效的开发循环

虽然无法进行完整的Android构建，但对于日常的代码开发和验证已经完全足够。