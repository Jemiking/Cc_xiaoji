# 数据导入问题修复记录

## 修复日期
2025-08-15

## 问题描述

### 问题1：文件选择器无法选择CSV文件
- **现象**：在数据导入界面，文件选择器显示为灰色，无法选择任何文件
- **原因**：使用了 `text/csv` MIME类型过滤，但某些Android设备不正确识别CSV文件的MIME类型
- **影响**：用户无法选择要导入的CSV文件

### 问题2：交易导入失败
- **现象**：导入统计显示失败2条，跳过16条，成功0条
- **错误信息**：第35行和第36行提示"找不到对应的账户"
- **原因**：账户和分类因已存在被跳过时，没有建立名称到ID的映射
- **影响**：依赖这些基础数据的交易记录无法正确导入

## 解决方案

### 修复1：改进文件选择器
**文件**: `LedgerImportScreen.kt`

1. 更换文件选择器类型
```kotlin
// 原来
val launcher = rememberLauncherForActivityResult(
    contract = ActivityResultContracts.GetContent()
)

// 修改后
val launcher = rememberLauncherForActivityResult(
    contract = ActivityResultContracts.OpenDocument()
)
```

2. 修改MIME类型过滤
```kotlin
// 支持多种MIME类型
launcher.launch(arrayOf("text/csv", "text/plain", "text/*", "*/*"))
```

3. 添加备选按钮
```kotlin
OutlinedButton(
    onClick = { launcher.launch(arrayOf("*/*")) },
    modifier = Modifier.fillMaxWidth(0.8f)
) {
    Icon(Icons.Default.Search, contentDescription = null)
    Spacer(modifier = Modifier.width(8.dp))
    Text("浏览所有文件")
}
```

### 修复2：建立正确的数据映射

**文件**: `ConflictResolver.kt`

1. 修改Skip结果类
```kotlin
// 原来
data class Skip<T>(val reason: String) : ResolveResult<T>()

// 修改后
data class Skip<T>(val reason: String, val existingData: T? = null) : ResolveResult<T>()
```

2. Skip时返回已存在实体
```kotlin
// 账户冲突处理
ConflictStrategy.SKIP -> ResolveResult.Skip("账户已存在: ${account.name}", existing)

// 分类冲突处理
ConflictStrategy.SKIP -> ResolveResult.Skip("分类已存在: ${category.name}", existing)
```

**文件**: `CsvLedgerImporter.kt`

3. Skip时建立名称到ID映射
```kotlin
// 账户Skip处理
is ResolveResult.Skip -> {
    skipped++
    Log.d(TAG, resolveResult.reason)
    // 将已存在账户的ID添加到映射中
    resolveResult.existingData?.let { existingAccount ->
        context.accountMap[existingAccount.name] = existingAccount.id
    }
}

// 分类Skip处理（类似）
is ResolveResult.Skip -> {
    skipped++
    Log.d(TAG, resolveResult.reason)
    // 将已存在分类的ID添加到映射中
    resolveResult.existingData?.let { existingCategory ->
        context.categoryMap[existingCategory.name] = existingCategory.id
    }
}
```

## 修复效果

### 修复前
- 文件选择器无法选择文件
- 交易导入失败，提示找不到账户

### 修复后
- ✅ 文件选择器可以正常选择所有文件类型
- ✅ 提供备选方案确保兼容性
- ✅ 已存在的账户/分类正确建立映射
- ✅ 交易记录可以正确导入
- ✅ 所有冲突策略（SKIP、MERGE、RENAME、OVERWRITE）都能正确工作

## 技术要点

### 数据导入的层级关系
```
基础数据（必须先处理）
├── 账户 → 生成 accountName->ID 映射
├── 分类 → 生成 categoryName->ID 映射
│
依赖数据（使用映射表）
├── 交易记录 → 查找账户ID和分类ID
├── 预算 → 查找分类ID
├── 定期交易 → 查找账户ID和分类ID
└── 信用卡账单 → 查找账户ID
```

### 关键原则
无论采用什么冲突策略，都必须建立正确的名称到ID映射：
- **SKIP（跳过）** → 使用已存在实体的ID
- **MERGE（合并）** → 使用合并后实体的ID
- **RENAME（重命名）** → 使用新创建实体的ID
- **OVERWRITE（覆盖）** → 使用覆盖后实体的ID

## 测试验证
1. ✅ 文件选择器可以选择CSV文件
2. ✅ 导入包含已存在账户/分类的数据
3. ✅ 交易记录正确关联到账户和分类
4. ✅ 导入统计正确显示成功、失败、跳过数量

## 相关文件
- `feature/ledger/src/.../importer/resolver/ConflictResolver.kt`
- `feature/ledger/src/.../importer/CsvLedgerImporter.kt`
- `feature/ledger/src/.../screen/import/LedgerImportScreen.kt`
- `feature/ledger/src/.../viewmodel/ImportViewModel.kt`

## 后续优化建议
1. 添加导入历史记录
2. 提供更详细的冲突预览
3. 支持选择性导入特定数据
4. 添加导入前自动备份功能

---
*记录人：Claude Code*
*日期：2025-08-15*