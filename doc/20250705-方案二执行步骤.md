# æ–¹æ¡ˆäºŒæ‰§è¡Œæ­¥éª¤ï¼šç»Ÿä¸€åˆ†ç±»ç®¡ç†

> åˆ›å»ºæ—¥æœŸï¼š2025-07-05
> ç›®æ ‡ï¼šå°†åˆ†ç±»ç®¡ç†ç»Ÿä¸€åˆ° CategoryRepository
> æŒ‘æˆ˜ï¼šå¤„ç†å·²æœ‰æ•°æ®çš„å‡çº§

## æ‰§è¡Œæ­¥éª¤

### Step 1: æ‰©å±• CategoryRepository æ¥å£
```kotlin
// feature/ledger/src/.../domain/repository/CategoryRepository.kt
interface CategoryRepository {
    // ... ç°æœ‰æ–¹æ³•
    
    /**
     * åˆå§‹åŒ–æˆ–å‡çº§é»˜è®¤åˆ†ç±»
     * @return æ–°åˆ›å»ºçš„åˆ†ç±»æ•°é‡
     */
    suspend fun initializeOrUpgradeDefaultCategories(): Int
}
```

### Step 2: æ”¹é€  CategoryRepositoryImpl
```kotlin
// feature/ledger/src/.../data/repository/CategoryRepositoryImpl.kt

// 1. æ·»åŠ å®Œæ•´çš„é»˜è®¤åˆ†ç±»å®šä¹‰
companion object {
    private val DEFAULT_CATEGORIES = listOf(
        // æ”¯å‡ºåˆ†ç±»ï¼ˆ10ä¸ªï¼‰
        DefaultCategory("é¤é¥®", "ğŸœ", "#FF6B6B", Category.Type.EXPENSE, 1),
        DefaultCategory("äº¤é€š", "ğŸš‡", "#4ECDC4", Category.Type.EXPENSE, 2),
        DefaultCategory("è´­ç‰©", "ğŸ›ï¸", "#45B7D1", Category.Type.EXPENSE, 3),
        DefaultCategory("å¨±ä¹", "ğŸ®", "#F7DC6F", Category.Type.EXPENSE, 4),
        DefaultCategory("åŒ»ç–—", "ğŸ¥", "#E74C3C", Category.Type.EXPENSE, 5),
        DefaultCategory("æ•™è‚²", "ğŸ“š", "#3498DB", Category.Type.EXPENSE, 6),
        DefaultCategory("å±…ä½", "ğŸ ", "#9B59B6", Category.Type.EXPENSE, 7),
        DefaultCategory("æ°´ç”µ", "ğŸ’¡", "#1ABC9C", Category.Type.EXPENSE, 8),
        DefaultCategory("é€šè®¯", "ğŸ“±", "#34495E", Category.Type.EXPENSE, 9),
        DefaultCategory("å…¶ä»–", "ğŸ“Œ", "#95A5A6", Category.Type.EXPENSE, 10),
        
        // æ”¶å…¥åˆ†ç±»ï¼ˆ5ä¸ªï¼‰
        DefaultCategory("å·¥èµ„", "ğŸ’°", "#27AE60", Category.Type.INCOME, 1),
        DefaultCategory("å¥–é‡‘", "ğŸ", "#F39C12", Category.Type.INCOME, 2),
        DefaultCategory("æŠ•èµ„", "ğŸ“ˆ", "#8E44AD", Category.Type.INCOME, 3),
        DefaultCategory("å…¼èŒ", "ğŸ’¼", "#2980B9", Category.Type.INCOME, 4),
        DefaultCategory("å…¶ä»–", "ğŸ’¸", "#16A085", Category.Type.INCOME, 5)
    )
}

// 2. å®ç°æ™ºèƒ½å‡çº§æ–¹æ³•
override suspend fun initializeOrUpgradeDefaultCategories(): Int {
    val userId = userApi.getCurrentUserId()
    val existingCategories = categoryDao.getCategoriesByUser(userId).first()
    
    // æ„å»ºç°æœ‰åˆ†ç±»çš„ç´¢å¼•ï¼ˆname+typeä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
    val existingIndex = existingCategories
        .filter { it.isSystem } // åªè€ƒè™‘ç³»ç»Ÿåˆ†ç±»
        .map { "${it.name}_${it.type}" }
        .toSet()
    
    // æ‰¾å‡ºç¼ºå¤±çš„åˆ†ç±»
    val missingCategories = DEFAULT_CATEGORIES.filter { default ->
        "${default.name}_${default.type.name}" !in existingIndex
    }
    
    // åˆ›å»ºç¼ºå¤±çš„åˆ†ç±»
    if (missingCategories.isNotEmpty()) {
        val timestamp = System.currentTimeMillis()
        val newEntities = missingCategories.map { default ->
            CategoryEntity(
                id = UUID.randomUUID().toString(),
                userId = userId,
                name = default.name,
                icon = default.icon,
                color = default.color,
                type = default.type.name,
                displayOrder = default.order,
                isSystem = true,
                createdAt = timestamp,
                updatedAt = timestamp
            )
        }
        categoryDao.insertCategories(newEntities)
    }
    
    return missingCategories.size
}

// 3. æ•°æ®ç±»å®šä¹‰
private data class DefaultCategory(
    val name: String,
    val icon: String,
    val color: String,
    val type: Category.Type,
    val order: Int
)
```

### Step 3: ä¿®æ”¹ CcXiaoJiApplication
```kotlin
// app/src/main/java/com/ccxiaoji/app/CcXiaoJiApplication.kt

@HiltAndroidApp
class CcXiaoJiApplication : Application(), Configuration.Provider {
    
    // ... ç°æœ‰æ³¨å…¥
    
    @Inject
    lateinit var categoryRepository: CategoryRepository
    
    override fun onCreate() {
        super.onCreate()
        
        CoroutineScope(Dispatchers.IO).launch {
            try {
                // ... ç°æœ‰çš„ç”¨æˆ·å’Œè´¦æˆ·åˆå§‹åŒ–
                
                // ä½¿ç”¨ CategoryRepository åˆå§‹åŒ–åˆ†ç±»
                val createdCount = categoryRepository.initializeOrUpgradeDefaultCategories()
                if (createdCount > 0) {
                    Log.d(TAG, "Created $createdCount new default categories")
                } else {
                    Log.d(TAG, "All default categories already exist")
                }
                
            } catch (e: Exception) {
                Log.e(TAG, "Error during initialization", e)
            }
        }
    }
    
    // åˆ é™¤ createDefaultCategories æ–¹æ³•
}
```

### Step 4: å¤„ç†è¾¹ç•Œæƒ…å†µ

#### 4.1 é˜²æ­¢ç«æ€æ¡ä»¶
```kotlin
// ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§
@Transaction
suspend fun initializeOrUpgradeDefaultCategories(): Int {
    // ... å®ç°
}
```

#### 4.2 ç‰ˆæœ¬ç®¡ç†ï¼ˆå¯é€‰ï¼‰
```kotlin
// åœ¨ DataStore ä¸­è®°å½•åˆ†ç±»ç‰ˆæœ¬
@Singleton
class CategoryVersionManager @Inject constructor(
    private val dataStore: DataStore<Preferences>
) {
    companion object {
        val CATEGORY_VERSION_KEY = intPreferencesKey("category_version")
        const val CURRENT_VERSION = 2 // 15ä¸ªåˆ†ç±»
    }
    
    suspend fun shouldUpgrade(): Boolean {
        val currentVersion = dataStore.data.first()[CATEGORY_VERSION_KEY] ?: 0
        return currentVersion < CURRENT_VERSION
    }
    
    suspend fun markAsUpgraded() {
        dataStore.edit { it[CATEGORY_VERSION_KEY] = CURRENT_VERSION }
    }
}
```

### Step 5: æµ‹è¯•è®¡åˆ’

1. **å•å…ƒæµ‹è¯•**
```kotlin
@Test
fun `test category upgrade from 8 to 15`() {
    // 1. åˆ›å»º8ä¸ªåˆ†ç±»
    // 2. è°ƒç”¨ initializeOrUpgradeDefaultCategories
    // 3. éªŒè¯æ€»å…±æœ‰15ä¸ªåˆ†ç±»
    // 4. éªŒè¯æ²¡æœ‰é‡å¤
}
```

2. **é›†æˆæµ‹è¯•**
```kotlin
@Test
fun `test multiple calls are idempotent`() {
    // 1. è°ƒç”¨ä¸¤æ¬¡ initializeOrUpgradeDefaultCategories
    // 2. éªŒè¯åˆ†ç±»æ•°é‡ä»ä¸º15
}
```

## ä¼˜åŠ¿åˆ†æ

### âœ… ä¼˜ç‚¹
1. **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰åˆ†ç±»å®šä¹‰åœ¨ä¸€å¤„
2. **æ™ºèƒ½å‡çº§**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ ç¼ºå¤±åˆ†ç±»
3. **æ— é‡å¤é£é™©**ï¼šåŸºäºåç§°+ç±»å‹å»é‡
4. **å¯é‡å¤æ‰§è¡Œ**ï¼šå¤šæ¬¡è°ƒç”¨å®‰å…¨
5. **æ˜“äºç»´æŠ¤**ï¼šæœªæ¥æ·»åŠ æ–°åˆ†ç±»åªéœ€ä¿®æ”¹ä¸€å¤„

### âš ï¸ æ³¨æ„äº‹é¡¹
1. **ä¾èµ–æ³¨å…¥æ—¶åº**ï¼šç¡®ä¿ Repository åœ¨ Application ä¸­å¯ç”¨
2. **æ•°æ®åº“äº‹åŠ¡**ï¼šä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
3. **æ€§èƒ½è€ƒè™‘**ï¼šåªåœ¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡

## æ‰§è¡Œæ—¶é—´è¡¨

| æ­¥éª¤ | å·¥ä½œå†…å®¹ | é¢„è®¡æ—¶é—´ |
|------|---------|----------|
| 1 | ä¿®æ”¹æ¥å£å’Œå®ç° | 30åˆ†é’Ÿ |
| 2 | ä¿®æ”¹Application | 15åˆ†é’Ÿ |
| 3 | ç¼–å†™æµ‹è¯• | 45åˆ†é’Ÿ |
| 4 | æµ‹è¯•éªŒè¯ | 30åˆ†é’Ÿ |
| **æ€»è®¡** | | **2å°æ—¶** |

## å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. ä¿ç•™åŸæœ‰çš„ createDefaultCategories æ–¹æ³•
2. åœ¨ feature flag åé¢åˆ‡æ¢æ–°æ—§é€»è¾‘
3. é€šè¿‡ç‰ˆæœ¬æ§åˆ¶å¿«é€Ÿå›æ»š

---
*è®¾è®¡æ—¶é—´ï¼š2025-07-05*