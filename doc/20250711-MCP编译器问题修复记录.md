# MCP编译器问题修复记录

## 概述
- **日期**：2025-07-11
- **问题**：MCP Android编译器无法正常编译项目，报告多个中间文件缺失
- **解决状态**：已修复 ✅

## 问题描述

### 错误信息
```
A problem was found with the configuration of task ':module:generateDebugRFile' 
property 'mergedManifestFile' specifies file 'build/intermediates/merged_manifest/debug/AndroidManifest.xml' 
which doesn't exist.
```

所有模块都报告类似错误，包括：
- core/common
- core/database
- core/network
- core/ui
- shared/sync
- shared/notification
- shared/user
- shared/backup
- feature/todo
- feature/habit
- feature/ledger
- feature/schedule
- feature/plan

### 根本原因
MCP编译器为了加速编译，使用了优化的命令：
```bash
./gradlew :app:compileDebugKotlin 
  -x lint 
  -x processDebugManifest    # 跳过了Manifest处理
  -x processDebugResources 
  -x mergeDebugResources 
  -x generateDebugBuildConfig # 跳过了BuildConfig生成
  ...
```

这导致必要的中间文件没有生成，后续任务无法执行。

## 解决方案

### 1. 手动生成中间文件
```bash
# 停止所有Gradle守护进程
./gradlew --stop

# 生成Manifest文件
./gradlew processDebugManifest mergeDebugResources --parallel

# 生成BuildConfig文件
./gradlew :app:generateDebugBuildConfig
```

### 2. 创建自动化脚本
创建了 `scripts/mcp-prepare.sh` 脚本：

```bash
#!/bin/bash
# MCP编译器预处理脚本

echo "🔧 准备MCP编译环境..."

# 停止所有Gradle守护进程
echo "⏹️  停止Gradle守护进程..."
./gradlew --stop

# 生成必要的中间文件
echo "📦 生成Manifest文件..."
./gradlew processDebugManifest --parallel

echo "🏗️  生成BuildConfig文件..."
./gradlew :app:generateDebugBuildConfig

echo "📋 生成资源文件..."
./gradlew mergeDebugResources --parallel

echo "✅ MCP编译环境准备完成！"
```

## 使用流程

### 首次使用或clean后
```bash
# 1. 运行准备脚本
./scripts/mcp-prepare.sh

# 2. 使用MCP编译器
mcp__android-compiler__compile_kotlin
```

### 日常开发
1. 主要使用Android Studio进行开发和调试
2. MCP编译器作为快速验证工具
3. 如果遇到编译错误，运行准备脚本

## 技术分析

### MCP与Android Studio的差异
1. **Gradle守护进程**：两者使用独立的守护进程，可能导致状态不一致
2. **缓存机制**：构建缓存不共享，中间文件可能缺失
3. **优化策略**：MCP跳过许多任务以加速，但可能导致依赖问题

### 长期优化建议

1. **修改MCP配置**
   - 使用完整的构建任务而非优化版本
   - 或在启动时自动运行准备任务

2. **共享构建缓存**
   ```kotlin
   // gradle.properties
   org.gradle.caching=true
   org.gradle.parallel=false
   ```

3. **监控构建状态**
   ```bash
   # 查看Gradle守护进程
   ./gradlew --status
   
   # 查看构建缓存
   ls -la ~/.gradle/caches/
   ```

## 相关文件
- 准备脚本：`/scripts/mcp-prepare.sh`
- MCP配置：`~/android-compiler-mcp/index.js`
- 项目构建配置：`build.gradle.kts`

## 经验总结
1. MCP编译器适合作为辅助工具，不应替代Android Studio
2. 定期同步构建状态很重要
3. 了解工具的限制，合理使用
4. 保持构建环境的一致性

---
*最后更新：2025-07-11*