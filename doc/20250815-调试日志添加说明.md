# 调试日志添加说明

## 添加日期
2025-08-15

## 问题背景
钱迹数据导入成功后，记账界面显示有统计数据（收入¥3500，支出¥22749.85），但交易列表为空。需要添加调试日志来定位问题原因。

## 添加的调试日志位置

### 1. 导入流程日志

#### QianjiImporter.kt
- **导入开始**：记录文件路径、用户ID、导入选项
- **映射过程**：记录每条记录的映射情况
- **批量保存**：记录保存的交易数量和第一条交易详情
- **导入完成**：统计导入、跳过、失败的数量
- **验证查询**：查询数据库中的总交易数和用户交易数

#### QianjiMapper.kt
- **映射开始**：记录原始记录信息和用户ID
- **账户映射**：记录账户名称到ID的映射
- **分类映射**：记录分类名称到ID的映射
- **映射结果**：记录生成的交易实体详情

### 2. 查询流程日志

#### LedgerViewModel.kt
- **加载交易**：记录查询月份、日期范围、账户ID、分页参数
- **查询结果**：记录返回的交易数量和第一条记录

#### GetPaginatedTransactionsUseCase.kt
- **查询参数**：记录分页、账户、日期范围
- **查询结果**：记录返回的记录数和总数

#### TransactionRepositoryImpl.kt
- **分页查询**：记录当前用户ID和查询参数
- **DAO结果**：记录实际查询到的记录数
- **月度统计**：记录统计查询的用户ID和结果

### 3. 数据验证日志

#### TransactionDao.kt
新增三个调试方法：
- `getAllTransactionsCount()` - 查询所有交易数量
- `getUserTransactionsCount(userId)` - 查询指定用户的交易数量
- `getRecentTransactions()` - 获取最近10条交易记录

## 关键日志标签
使用以下标签过滤Logcat：
- `QianjiImporter` - 导入主流程
- `QianjiMapper` - 数据映射
- `QianjiParser` - CSV解析
- `LedgerViewModel` - 界面数据加载
- `GetPaginatedTransactions` - 分页查询
- `TransactionRepository` - 数据库操作

## 调试步骤

### 1. 清空Logcat
```
adb logcat -c
```

### 2. 设置过滤器
在Android Studio的Logcat中：
- 过滤级别：Verbose
- 包名：`com.ccxiaoji.app`

### 3. 执行导入操作
1. 选择钱迹CSV文件
2. 开始导入
3. 观察日志输出

### 4. 检查关键信息
重点关注以下信息：
- **用户ID是否一致**：导入时的用户ID和查询时的用户ID
- **数据是否保存**：`数据库中总交易数` 和 `当前用户交易数`
- **日期范围**：查询的日期范围是否包含导入的数据
- **映射失败**：是否有账户或分类映射失败

## 可能的问题原因

### 1. 用户ID不匹配
- 导入时使用的用户ID与查询时不同
- 解决：确保使用相同的用户ID

### 2. 日期范围不匹配
- 导入的是历史数据，但查询的是当前月份
- 解决：切换到有数据的月份

### 3. 账户/分类映射失败
- 找不到对应的账户或分类导致交易被跳过
- 解决：确保创建必要的账户和分类

### 4. 数据保存失败
- 数据库插入失败但没有报错
- 解决：检查数据库约束和权限

## 验证方法

### 通过日志验证
```
// 查看导入验证日志
QianjiImporter: 数据库中总交易数: X
QianjiImporter: 当前用户交易数: Y

// 查看查询日志
TransactionRepository: 当前用户ID: XXX
TransactionRepository: DAO查询结果: X 条记录
```

### 通过代码验证
在适当位置添加临时代码：
```kotlin
// 直接查询数据库
val count = transactionDao.getAllTransactionsCount()
Log.d("DEBUG", "Total transactions: $count")
```

## 后续优化建议

1. **添加导入成功提示**
   - 显示导入了多少条记录
   - 提示数据所在的月份范围

2. **自动跳转到有数据的月份**
   - 导入后自动切换到最早有数据的月份

3. **改进错误处理**
   - 详细记录每条失败的原因
   - 提供导入报告

4. **添加调试模式**
   - 开发环境自动启用详细日志
   - 生产环境禁用敏感日志

---
*文档创建：Claude Code*
*状态：已完成*