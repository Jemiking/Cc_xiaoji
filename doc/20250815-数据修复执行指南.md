# 数据修复执行指南

## 修复内容总结

### 方案A实施完成
我们选择了**最小化修复方案**，保持数据完整性同时解决显示问题。

## 实施的修复

### 1. 数据修复工具 (`DataRepairTool.kt`)

**功能**：
- ✅ 优化默认账户为"现金"账户
- ✅ 修复4个转账对象账户
- ✅ 清理空账户

**修复步骤**：
1. 将`default_account_current_user_id`改名为"现金"
2. 识别转账对象账户（>劳闻文、>翁显、>哥、么明）
3. 将这些账户的交易迁移到现金账户
4. 在备注中添加转账对象信息
5. 删除错误创建的账户

### 2. QianjiMapper优化

**修复内容**：
- ✅ 移除错误的`split("-").last()`逻辑
- ✅ 空账户名创建为"现金"账户
- ✅ 以">"开头的账户名不创建账户
- ✅ 处理account2字段（转账对象）添加到备注

## 测试验证步骤

### 方法一：自动修复（推荐）

应用启动时会**自动执行修复**：

1. **运行应用**
2. **查看Logcat**，过滤标签：
   - `DATA_REPAIR` - 修复过程
   - `LEDGER_DEBUG` - 修复触发
3. **检查结果**：
   - 进入记账模块
   - 查看账户列表
   - 确认"现金"账户存在
   - 确认转账对象账户已删除

### 方法二：手动触发修复

如果需要手动执行：

```kotlin
// 在LedgerViewModel中调用
executeDataRepair()
```

## 预期结果

### 修复前
```
账户列表：
- 微信零钱（3229笔）
- 花呗（1032笔）
- >劳闻文（1笔）❌
- >翁显（1笔）❌
- >哥（1笔）❌
- 么明（1笔）❌
- 默认账户（1275笔）
```

### 修复后
```
账户列表：
- 微信零钱（3229笔）
- 花呗（1032笔）
- 现金（1279笔）✅ （原默认账户+4笔转账）
- 支付宝（419笔）
- 建行卡（207笔）
```

## 验证要点

### 1. 账户变化
- ✅ "默认账户"改名为"现金"
- ✅ 4个转账对象账户被删除
- ✅ 总账户数从17个减少到13个左右

### 2. 交易完整性
- ✅ 总交易数保持6510条不变
- ✅ 转账对象信息保留在备注中
- ✅ 查询2024年10月数据正常显示

### 3. 备注格式
修复后的转账交易备注格式：
```
原备注 [付款方: 劳闻文] [钱迹ID: xxx]
```

## 日志输出示例

```
DATA_REPAIR: ========================================
DATA_REPAIR:          开始执行数据修复
DATA_REPAIR: ========================================

DATA_REPAIR: 【步骤1】优化默认账户
DATA_REPAIR: ✓ 已将默认账户改名为'现金'
DATA_REPAIR:   包含交易: 1275 条

DATA_REPAIR: 【步骤2】修复转账对象账户
DATA_REPAIR: 发现 4 个转账对象账户需要修复
DATA_REPAIR: 处理账户: >劳闻文
DATA_REPAIR:   ✓ 已迁移 1 条交易
DATA_REPAIR:   ✓ 已删除账户: >劳闻文

DATA_REPAIR: 【步骤3】清理空账户
DATA_REPAIR:   ✓ 已删除: 现金账户

DATA_REPAIR: ========================================
DATA_REPAIR:          数据修复完成
DATA_REPAIR: ========================================
```

## 注意事项

1. **修复是不可逆的**（建议先备份数据）
2. **只执行一次**（重复执行不会有副作用）
3. **修复后需要重启应用**查看最终效果

## 后续优化

### 已完成
- ✅ 修复转账对象账户
- ✅ 优化默认账户命名
- ✅ 防止未来再次发生

### 待优化
- 提供UI界面执行修复
- 添加修复前数据备份
- 支持修复历史记录

---
更新时间：2025-08-15