# CC小记 UI层面小程序化改造详细计划

## 改造目标
将现有的底部导航模式改造为小程序风格的模块化首页，提升用户体验，增强可扩展性。

## 改造原则
1. **渐进式改造**：分阶段实施，每个阶段都能独立运行
2. **向后兼容**：保留原有功能，提供切换选项
3. **最小化改动**：尽量复用现有代码和组件
4. **用户友好**：提供平滑的过渡体验

---

## 第一阶段：重构首页和导航结构（2-3天）

### 1.1 调整底部导航（第1天）

#### 修改文件：`app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/Screen.kt`

```kotlin
// 1. 简化底部导航项
val bottomNavItems = listOf(
    Screen.Home,      // 保留首页
    Screen.Profile    // 保留我的
    // 移除：Ledger, Todo, Habit, Schedule
)

// 2. 添加模块定义
data class ModuleInfo(
    val id: String,
    val name: String,
    val icon: ImageVector,
    val color: Color,
    val route: String,
    val badge: Int = 0
)

// 3. 定义所有模块
val allModules = listOf(
    ModuleInfo(
        id = "ledger",
        name = "记账",
        icon = Icons.Default.AccountBalanceWallet,
        color = Color(0xFF4CAF50),
        route = Screen.Ledger.route
    ),
    // ... 其他模块
)
```

#### 修改文件：`app/src/main/java/com/ccxiaoji/app/presentation/MainActivity.kt`

```kotlin
// 添加FAB支持
Scaffold(
    modifier = Modifier.fillMaxSize(),
    bottomBar = {
        ModularBottomNavBar(navController = navController)
    },
    floatingActionButton = {
        QuickActionFAB(
            navController = navController
        )
    },
    floatingActionButtonPosition = FabPosition.Center
)
```

### 1.2 重构首页布局（第2天）

#### 创建新文件：`app/src/main/java/com/ccxiaoji/app/presentation/ui/home/ModularHomeScreen.kt`

```kotlin
@Composable
fun ModularHomeScreen(
    viewModel: HomeViewModel = hiltViewModel(),
    onModuleClick: (ModuleInfo) -> Unit
) {
    val uiState by viewModel.uiState.collectAsState()
    
    LazyColumn(
        modifier = Modifier.fillMaxSize(),
        contentPadding = PaddingValues(16.dp)
    ) {
        // 1. 欢迎区域
        item {
            WelcomeCard(
                userName = uiState.userName,
                date = LocalDate.now()
            )
        }
        
        // 2. 数据概览
        item {
            QuickStatsCard(
                todayExpense = uiState.todayExpense,
                pendingTasks = uiState.pendingTasks,
                habitProgress = uiState.habitProgress
            )
        }
        
        // 3. 模块网格
        item {
            Text(
                "功能模块",
                style = MaterialTheme.typography.titleMedium,
                modifier = Modifier.padding(vertical = 16.dp)
            )
        }
        
        item {
            ModuleGrid(
                modules = allModules,
                onModuleClick = onModuleClick
            )
        }
    }
}
```

#### 创建模块网格组件：`app/src/main/java/com/ccxiaoji/app/presentation/ui/home/components/ModuleGrid.kt`

```kotlin
@Composable
fun ModuleGrid(
    modules: List<ModuleInfo>,
    columns: Int = 4,
    onModuleClick: (ModuleInfo) -> Unit
) {
    LazyVerticalGrid(
        columns = GridCells.Fixed(columns),
        horizontalArrangement = Arrangement.spacedBy(12.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp),
        modifier = Modifier.fillMaxWidth().height(((modules.size + columns - 1) / columns * 100).dp)
    ) {
        items(modules) { module ->
            ModuleCard(
                module = module,
                onClick = { onModuleClick(module) }
            )
        }
    }
}
```

### 1.3 实现模块卡片（第3天）

#### 创建文件：`app/src/main/java/com/ccxiaoji/app/presentation/ui/home/components/ModuleCard.kt`

```kotlin
@Composable
fun ModuleCard(
    module: ModuleInfo,
    onClick: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .aspectRatio(1f)
            .clickable { onClick() },
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(
            containerColor = module.color.copy(alpha = 0.1f)
        )
    ) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                // 图标背景
                Box(
                    modifier = Modifier
                        .size(48.dp)
                        .clip(CircleShape)
                        .background(module.color),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        imageVector = module.icon,
                        contentDescription = module.name,
                        tint = Color.White,
                        modifier = Modifier.size(28.dp)
                    )
                }
                
                Spacer(modifier = Modifier.height(8.dp))
                
                Text(
                    text = module.name,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurface
                )
            }
            
            // 角标
            if (module.badge > 0) {
                Badge(
                    modifier = Modifier
                        .align(Alignment.TopEnd)
                        .padding(8.dp)
                ) {
                    Text(module.badge.toString())
                }
            }
        }
    }
}
```

---

## 第二阶段：实现快捷操作和动画（2天）

### 2.1 创建快捷操作FAB（第1天）

#### 创建文件：`app/src/main/java/com/ccxiaoji/app/presentation/ui/components/QuickActionFAB.kt`

```kotlin
@Composable
fun QuickActionFAB(
    navController: NavController
) {
    var isExpanded by remember { mutableStateOf(false) }
    
    Box {
        // 背景遮罩
        AnimatedVisibility(
            visible = isExpanded,
            enter = fadeIn(),
            exit = fadeOut()
        ) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(Color.Black.copy(alpha = 0.5f))
                    .clickable { isExpanded = false }
            )
        }
        
        // FAB按钮组
        Column(
            horizontalAlignment = Alignment.End,
            modifier = Modifier.padding(16.dp)
        ) {
            // 快捷操作项
            AnimatedVisibility(visible = isExpanded) {
                Column(
                    verticalArrangement = Arrangement.spacedBy(12.dp),
                    modifier = Modifier.padding(bottom = 16.dp)
                ) {
                    QuickActionItem(
                        icon = Icons.Default.Add,
                        label = "记一笔",
                        color = Color(0xFF4CAF50),
                        onClick = {
                            navController.navigate(AddTransactionRoute.route)
                            isExpanded = false
                        }
                    )
                    
                    QuickActionItem(
                        icon = Icons.Default.Task,
                        label = "新待办",
                        color = Color(0xFF2196F3),
                        onClick = {
                            navController.navigate(AddEditTaskRoute.route)
                            isExpanded = false
                        }
                    )
                    
                    QuickActionItem(
                        icon = Icons.Default.CheckCircle,
                        label = "习惯打卡",
                        color = Color(0xFFFF9800),
                        onClick = {
                            navController.navigate(Screen.Habit.route)
                            isExpanded = false
                        }
                    )
                }
            }
            
            // 主FAB
            FloatingActionButton(
                onClick = { isExpanded = !isExpanded },
                containerColor = MaterialTheme.colorScheme.primary
            ) {
                AnimatedContent(
                    targetState = isExpanded,
                    transitionSpec = {
                        scaleIn() with scaleOut()
                    }
                ) { expanded ->
                    Icon(
                        imageVector = if (expanded) Icons.Default.Close else Icons.Default.Add,
                        contentDescription = "快捷操作"
                    )
                }
            }
        }
    }
}
```

### 2.2 添加过渡动画（第2天）

#### 更新导航动画：`app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavGraph.kt`

```kotlin
// 为模块导航添加动画
composable(
    route = Screen.Ledger.route,
    enterTransition = {
        slideIntoContainer(
            towards = AnimatedContentTransitionScope.SlideDirection.Left,
            animationSpec = tween(300)
        )
    },
    exitTransition = {
        slideOutOfContainer(
            towards = AnimatedContentTransitionScope.SlideDirection.Right,
            animationSpec = tween(300)
        )
    }
) {
    ledgerApi.getLedgerScreen(navController, null)
}
```

---

## 第三阶段：个性化功能（3天）

### 3.1 模块管理功能（第1-2天）

#### 创建DataStore配置：`app/src/main/java/com/ccxiaoji/app/data/preferences/ModulePreferences.kt`

```kotlin
@Serializable
data class ModulePreferences(
    val hiddenModules: Set<String> = emptySet(),
    val moduleOrder: Map<String, Int> = emptyMap(),
    val favoriteModules: Set<String> = emptySet()
)

class ModulePreferencesRepository @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val dataStore = context.createDataStore(
        fileName = "module_preferences.pb",
        serializer = ModulePreferencesSerializer
    )
    
    val preferences = dataStore.data
    
    suspend fun toggleModuleVisibility(moduleId: String) {
        dataStore.updateData { prefs ->
            prefs.copy(
                hiddenModules = if (moduleId in prefs.hiddenModules) {
                    prefs.hiddenModules - moduleId
                } else {
                    prefs.hiddenModules + moduleId
                }
            )
        }
    }
    
    suspend fun updateModuleOrder(modules: List<ModuleInfo>) {
        dataStore.updateData { prefs ->
            prefs.copy(
                moduleOrder = modules.mapIndexed { index, module ->
                    module.id to index
                }.toMap()
            )
        }
    }
}
```

### 3.2 编辑模式（第3天）

#### 创建编辑模式界面：`app/src/main/java/com/ccxiaoji/app/presentation/ui/home/ModuleEditScreen.kt`

```kotlin
@Composable
fun ModuleEditScreen(
    onBack: () -> Unit
) {
    var modules by remember { mutableStateOf(allModules) }
    var draggedItem by remember { mutableStateOf<ModuleInfo?>(null) }
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("编辑模块") },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Default.ArrowBack, "返回")
                    }
                },
                actions = {
                    TextButton(onClick = {
                        // 保存更改
                        onBack()
                    }) {
                        Text("完成")
                    }
                }
            )
        }
    ) { paddingValues ->
        LazyVerticalGrid(
            columns = GridCells.Fixed(4),
            contentPadding = paddingValues,
            modifier = Modifier.padding(16.dp)
        ) {
            items(modules, key = { it.id }) { module ->
                DraggableModuleCard(
                    module = module,
                    isBeingDragged = draggedItem == module,
                    onDragStart = { draggedItem = module },
                    onDragEnd = { 
                        // 更新模块顺序
                        draggedItem = null
                    }
                )
            }
        }
    }
}
```

---

## 第四阶段：优化和完善（2天）

### 4.1 添加搜索功能（第1天）

```kotlin
@Composable
fun ModuleSearchBar(
    onSearch: (String) -> Unit
) {
    var searchText by remember { mutableStateOf("") }
    
    OutlinedTextField(
        value = searchText,
        onValueChange = { 
            searchText = it
            onSearch(it)
        },
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp),
        placeholder = { Text("搜索功能模块") },
        leadingIcon = {
            Icon(Icons.Default.Search, "搜索")
        },
        shape = RoundedCornerShape(28.dp),
        colors = OutlinedTextFieldDefaults.colors(
            unfocusedBorderColor = Color.Transparent,
            focusedBorderColor = Color.Transparent
        )
    )
}
```

### 4.2 使用引导（第2天）

```kotlin
@Composable
fun FirstTimeGuide() {
    // 使用 Accompanist 的 Spotlight 或自定义实现
    var currentStep by remember { mutableStateOf(0) }
    
    when (currentStep) {
        0 -> HighlightOverlay(
            targetArea = Rect(/* 首页位置 */),
            text = "欢迎使用新版首页！所有功能都在这里",
            onNext = { currentStep++ }
        )
        1 -> HighlightOverlay(
            targetArea = Rect(/* FAB位置 */),
            text = "点击这里快速创建内容",
            onNext = { currentStep++ }
        )
        // ...
    }
}
```

---

## 实施建议

### 1. 开发顺序
- **必做**：第一、二阶段（基础功能）
- **推荐**：第三阶段（提升体验）
- **可选**：第四阶段（锦上添花）

### 2. 测试重点
- 导航功能是否正常
- 动画是否流畅
- 数据是否正确显示
- 偏好设置是否持久化

### 3. 回滚方案
在设置中提供"使用经典布局"选项，允许用户切换回原始的6个底部导航模式。

### 4. 性能优化
- 使用`remember`缓存计算结果
- 图片和图标使用适当的大小
- 列表使用`LazyColumn`和`LazyGrid`
- 避免在组合中进行重计算

## 时间估算

- 第一阶段：2-3天
- 第二阶段：2天
- 第三阶段：3天
- 第四阶段：2天

**总计：9-10天**（可分阶段实施）

## 风险控制

1. **保留原有代码**：不删除现有的Screen和导航逻辑
2. **功能开关**：通过SharedPreferences控制新旧UI切换
3. **逐步迁移**：先实现基础功能，再添加高级特性
4. **充分测试**：每个阶段完成后进行完整测试