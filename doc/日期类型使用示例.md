# 日期类型使用示例

本文档提供CC小记项目中日期类型使用的最佳实践示例。

## 1. 基本转换示例

### 1.1 LocalDate 转换
```kotlin
// Java to Kotlin
val javaDate = java.time.LocalDate.of(2025, 1, 14)
val kotlinDate = DateConverter.toKotlinDate(javaDate)

// Kotlin to Java
val kotlinDate2 = kotlinx.datetime.LocalDate(2025, 1, 14)
val javaDate2 = DateConverter.toJavaDate(kotlinDate2)
```

### 1.2 时间戳转换
```kotlin
// kotlinx.datetime.LocalDate 转时间戳
val timestamp = DateConverter.kotlinDateToTimestamp(kotlinDate)

// java.time.LocalDate 转时间戳
val timestamp2 = DateConverter.javaDateToTimestamp(javaDate)
```

### 1.3 工时计算
```kotlin
// 普通班次
val hours1 = DateConverter.calculateHours("09:00", "17:00") // 8.0

// 跨夜班次
val hours2 = DateConverter.calculateHours("22:00", "06:00") // 8.0

// 24小时班次
val hours3 = DateConverter.calculateHours("00:00", "00:00") // 24.0
```

## 2. 数据映射器使用示例

### 2.1 排班数据映射
```kotlin
@Inject lateinit var scheduleDataMapper: ScheduleDataMapper

// API返回的排班信息
val scheduleInfo = ScheduleInfo(
    date = java.time.LocalDate.now(),
    shiftName = "早班",
    startTime = "09:00",
    endTime = "17:00",
    color = "#4CAF50",
    isRestDay = false
)

// 转换为导出数据
val kotlinDate = kotlinx.datetime.Clock.System.todayIn(TimeZone.currentSystemDefault())
val exportData = scheduleDataMapper.mapScheduleInfoToExportData(scheduleInfo, kotlinDate)
```

### 2.2 记账数据映射
```kotlin
@Inject lateinit var ledgerDataMapper: LedgerDataMapper

// 交易记录转换
val transaction = TransactionItem(
    id = "1",
    amount = -50.0,
    categoryName = "餐饮",
    accountName = "支付宝",
    date = kotlinx.datetime.LocalDate(2025, 1, 14),
    // ...
)
val exportData = ledgerDataMapper.mapTransactionToExportData(transaction)

// 金额转换
val yuan = ledgerDataMapper.centsToYuan(5000) // 50.0
val cents = ledgerDataMapper.yuanToCents(50.0) // 5000
```

## 3. 模块边界处理示例

### 3.1 API实现类
```kotlin
@Singleton
class ScheduleApiImpl @Inject constructor(
    private val repository: ScheduleRepository
) : ScheduleApi {
    
    override suspend fun getScheduleByDate(date: java.time.LocalDate): ScheduleInfo? {
        // API接口使用java.time，内部转换为kotlinx.datetime
        val kotlinDate = DateConverter.toKotlinDate(date)
        
        // 调用Repository（使用kotlinx.datetime）
        val schedule = repository.getScheduleByDate(kotlinDate) ?: return null
        
        // 返回时保持java.time类型
        return ScheduleInfo(
            date = date, // 保持原始类型
            shiftName = schedule.shiftName,
            // ...
        )
    }
}
```

### 3.2 UseCase层
```kotlin
class GetMonthlyScheduleUseCase @Inject constructor(
    private val scheduleApi: ScheduleApi,
    private val scheduleDataMapper: ScheduleDataMapper
) {
    suspend operator fun invoke(
        year: Int,
        month: Int
    ): List<ScheduleData> {
        val schedules = mutableListOf<ScheduleData>()
        
        // 使用java.time进行日期计算
        val startDate = java.time.LocalDate.of(year, month, 1)
        val endDate = startDate.plusMonths(1).minusDays(1)
        
        var currentDate = startDate
        while (!currentDate.isAfter(endDate)) {
            // 调用API（使用java.time）
            scheduleApi.getScheduleByDate(currentDate)?.let { info ->
                // 转换为kotlinx.datetime进行内部处理
                val kotlinDate = scheduleDataMapper.convertDate(currentDate)
                schedules.add(
                    scheduleDataMapper.mapScheduleInfoToExportData(info, kotlinDate)
                )
            }
            currentDate = currentDate.plusDays(1)
        }
        
        return schedules
    }
}
```

## 4. 常见错误及正确写法

### 4.1 避免直接创建日期对象
```kotlin
// ❌ 错误：直接创建，容易出错
val kotlinDate = kotlinx.datetime.LocalDate(
    javaDate.year, 
    javaDate.monthValue, 
    javaDate.dayOfMonth
)

// ✅ 正确：使用转换器
val kotlinDate = DateConverter.toKotlinDate(javaDate)
```

### 4.2 避免硬编码时区
```kotlin
// ❌ 错误：硬编码时区
val timestamp = date.atStartOfDayIn(TimeZone.of("Asia/Shanghai")).toEpochMilliseconds()

// ✅ 正确：使用系统时区
val timestamp = date.atStartOfDayIn(TimeZone.currentSystemDefault()).toEpochMilliseconds()
```

### 4.3 正确处理空值
```kotlin
// ❌ 错误：使用空字符串
data class ScheduleData(
    val note: String = ""
)

// ✅ 正确：使用可空类型
data class ScheduleData(
    val note: String? = null
)
```

### 4.4 数据类型一致性
```kotlin
// ❌ 错误：混用字符串和数值
data class WorkRecord(
    val duration: String // "8小时"
)

// ✅ 正确：使用数值类型，格式化在展示层处理
data class WorkRecord(
    val duration: Double // 8.0
)

// 展示时格式化
fun formatDuration(hours: Double): String {
    return if (hours == hours.toInt().toDouble()) {
        "${hours.toInt()}小时"
    } else {
        "${hours}小时"
    }
}
```

## 5. 单元测试示例

### 5.1 测试日期转换
```kotlin
@Test
fun `test date conversion round trip`() {
    val originalJavaDate = java.time.LocalDate.of(2025, 1, 14)
    
    // Java → Kotlin → Java
    val kotlinDate = DateConverter.toKotlinDate(originalJavaDate)
    val convertedBack = DateConverter.toJavaDate(kotlinDate)
    
    assertEquals(originalJavaDate, convertedBack)
}
```

### 5.2 测试边界情况
```kotlin
@Test
fun `test 24 hour shift calculation`() {
    // 测试24小时班次
    val hours = DateConverter.calculateHours("00:00", "00:00")
    assertEquals(24.0, hours, 0.01)
}

@Test
fun `test overnight shift calculation`() {
    // 测试跨夜班次
    val hours = DateConverter.calculateHours("22:00", "06:00")
    assertEquals(8.0, hours, 0.01)
}
```

## 6. 性能优化建议

### 6.1 批量转换
```kotlin
// ❌ 避免：循环中重复创建映射器
schedules.map { schedule ->
    ScheduleDataMapper().mapScheduleInfoToExportData(schedule, date)
}

// ✅ 推荐：注入单例映射器
@Inject lateinit var mapper: ScheduleDataMapper
schedules.map { schedule ->
    mapper.mapScheduleInfoToExportData(schedule, date)
}
```

### 6.2 缓存转换结果
```kotlin
class DateCache {
    private val cache = mutableMapOf<java.time.LocalDate, kotlinx.datetime.LocalDate>()
    
    fun convert(javaDate: java.time.LocalDate): kotlinx.datetime.LocalDate {
        return cache.getOrPut(javaDate) {
            DateConverter.toKotlinDate(javaDate)
        }
    }
}
```

## 7. 迁移建议

### 7.1 渐进式迁移
1. 先创建转换器和映射器
2. 在新代码中使用规范
3. 逐步迁移旧代码
4. 保持API稳定

### 7.2 迁移检查清单
- [ ] 识别所有日期类型使用
- [ ] 创建模块专属映射器
- [ ] 更新单元测试
- [ ] 验证功能正常
- [ ] 更新文档

---

**文档版本**：1.0  
**创建日期**：2025-01-14  
**最后更新**：2025-01-14