# 版本迁移防跑偏检查清单

## 🎯 核心目标提醒
**唯一目标**：将硬编码版本替换为版本目录引用，其他一切保持不变。

## 🚨 防跑偏10条红线

### 1. 只改build.gradle.kts
```bash
# ✅ 正确
git status
# 只应该看到：
# modified: shared/user/build.gradle.kts

# ❌ 错误（跑偏了）
# modified: shared/user/src/main/java/...
# modified: shared/user/build.gradle.kts
# modified: settings.gradle.kts
```

### 2. 只改版本引用
```diff
# ✅ 正确的改动
- implementation("androidx.core:core-ktx:1.12.0")
+ implementation(libs.androidx.core.ktx)

# ❌ 错误的改动（跑偏了）
- implementation("androidx.core:core-ktx:1.12.0")
+ implementation("androidx.core:core-ktx:1.13.0")  // 改了版本号
```

### 3. 不动版本号
```kotlin
// ✅ 保持版本一致
// 原来是1.12.0，libs.versions.toml中也必须是1.12.0

// ❌ 跑偏示例
// 原来是1.12.0，迁移时"顺便"升级到1.13.0
```

### 4. 不加新依赖
```kotlin
// ❌ 跑偏示例
dependencies {
    implementation(libs.androidx.core.ktx)
    implementation(libs.new.fancy.library)  // 新加的，跑偏了！
}
```

### 5. 不删除依赖
```kotlin
// ❌ 跑偏示例
dependencies {
    // implementation(libs.some.old.library)  // 删除了，跑偏了！
}
```

### 6. 不改变依赖类型
```kotlin
// ✅ 正确
ksp("androidx.room:room-compiler:2.6.1")
↓
ksp(libs.room.compiler)

// ❌ 跑偏
ksp("androidx.room:room-compiler:2.6.1")
↓
implementation(libs.room.compiler)  // 改了类型，跑偏了！
```

### 7. 不动业务逻辑
```kotlin
// ❌ 跑偏示例
// 看到代码有问题，"顺便"修复了
// 看到TODO，"顺便"实现了
// 看到注释错误，"顺便"改了
```

### 8. 一次一个模块
```bash
# ✅ 正确
git add shared/user/build.gradle.kts
git commit -m "refactor: 迁移shared-user模块到版本目录"

# ❌ 跑偏
git add shared/*/build.gradle.kts  # 多个模块一起改，跑偏了！
```

### 9. 验证编译通过
```bash
# ✅ 每个模块改完必须能编译
./gradlew :shared-user:build

# ❌ 跑偏
# "先改完所有模块再统一修复编译错误" - 错误思路！
```

### 10. 保持代码格式
```kotlin
// ✅ 正确（保持原格式）
implementation(libs.androidx.core.ktx)

// ❌ 跑偏（改了格式）
implementation(
    libs.androidx.core.ktx
)  // 加了换行，跑偏了！
```

## 🔍 快速自检（每5分钟一次）

问自己3个问题：
1. **我在改什么文件？** → 只能是build.gradle.kts
2. **我改了什么内容？** → 只能是版本字符串
3. **编译还能通过吗？** → 必须通过

## 📊 跑偏征兆识别

出现以下情况说明已经跑偏：
- 修改超过1个文件
- git diff显示import变化
- 编译失败超过5分钟
- 开始思考"要不要顺便..."
- 修改了任何.kt/.java文件

## 🛡️ 防跑偏工具使用

### 每次改动前
```bash
# 记录初始状态
git status > before.txt
./gradlew :module:dependencies > deps-before.txt
```

### 每次改动后
```bash
# 验证只改了版本
./scripts/verify-version-migration.sh shared/user
```

### 如果跑偏了
```bash
# 立即回滚，不要试图修复
git checkout HEAD -- shared/user/build.gradle.kts
```

## 📝 跑偏日志模板

如果发现跑偏，记录下来避免再犯：
```
时间：2025-06-28 15:30
模块：shared-user
跑偏行为：试图升级lifecycle版本从2.7.0到2.8.0
原因：看到新版本发布了
教训：迁移≠升级，保持专注
```

## ✅ 成功标志

迁移成功的模块应该：
1. ✅ 编译通过
2. ✅ 0个硬编码版本
3. ✅ git diff只有版本引用变化
4. ✅ 依赖树完全一致
5. ✅ 没有"顺便"做的事

## 🎯 终极原则

> **如果不确定，就不要改。**
> 
> **如果想"顺便"，就停下来。**
> 
> **如果编译失败，就回滚。**

---
*记住：完美的版本迁移是"无聊"的——只有机械的替换，没有任何创新。*