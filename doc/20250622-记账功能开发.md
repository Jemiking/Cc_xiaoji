# 记账功能开发指南

## 文档信息
- **创建日期**: 2025-06-22
- **最后更新**: 2025-06-22
- **负责人**: 开发团队
- **文档目的**: 确保记账模块未完成功能的开发不偏离设计目标

## 一、功能开发总览

### 1.1 开发原则
1. **数据一致性**: 所有金额以分为单位存储，避免浮点数精度问题
2. **用户体验优先**: 功能设计要简洁直观，减少用户操作步骤
3. **性能考虑**: 大数据量场景下保持流畅（如1000+交易记录）
4. **安全性**: 涉及金融数据，需要严格的数据校验和权限控制
5. **可扩展性**: 预留接口，方便后续功能扩展

### 1.2 技术约束
- 使用Room数据库，遵循现有的数据库架构
- 遵循Clean Architecture + MVVM模式
- 使用Hilt进行依赖注入
- UI使用Jetpack Compose和Material 3设计
- 所有Repository方法返回BaseResult包装的结果

## 二、信用卡功能开发规范

### 2.1 信用卡账单管理

#### 2.1.1 功能需求
**账单生成**
- 自动生成：每月账单日自动生成上月账单
- 手动生成：用户可手动触发生成当期账单
- 账单内容：
  - 账单周期（起止日期）
  - 本期消费总额
  - 本期还款总额
  - 上期结余
  - 本期应还金额
  - 最低还款额（应还金额的10%）
  - 到期还款日
  - 账单明细（关联的交易列表）

**账单查询**
- 按账户查询历史账单列表
- 查看账单详情和交易明细
- 账单状态：未出账、已出账、已还清、部分还款、逾期

#### 2.1.2 数据模型设计
```kotlin
// 新增实体：CreditCardBillEntity
@Entity(tableName = "credit_card_bill")
data class CreditCardBillEntity(
    @PrimaryKey
    val id: String = UUID.randomUUID().toString(),
    val accountId: String, // 关联信用卡账户
    val billPeriodStart: LocalDate, // 账单周期开始
    val billPeriodEnd: LocalDate, // 账单周期结束
    val billDate: LocalDate, // 账单日
    val dueDate: LocalDate, // 到期还款日
    val previousBalance: Int, // 上期结余（分）
    val currentCharges: Int, // 本期消费（分）
    val currentPayments: Int, // 本期还款（分）
    val totalAmount: Int, // 应还总额（分）
    val minimumPayment: Int, // 最低还款额（分）
    val paidAmount: Int = 0, // 已还金额（分）
    val status: BillStatus, // 账单状态
    val createdAt: Instant = Clock.System.now(),
    val updatedAt: Instant = Clock.System.now(),
    val syncStatus: SyncStatus = SyncStatus.LOCAL
)

enum class BillStatus {
    PENDING,      // 未出账
    GENERATED,    // 已出账
    PAID,         // 已还清
    PARTIAL_PAID, // 部分还款
    OVERDUE       // 逾期
}
```

#### 2.1.3 Repository实现
```kotlin
interface CreditCardBillRepository {
    // 生成账单
    suspend fun generateBill(
        accountId: String,
        periodStart: LocalDate,
        periodEnd: LocalDate
    ): BaseResult<CreditCardBillEntity>
    
    // 查询账单列表
    fun getBillsByAccount(accountId: String): Flow<List<CreditCardBill>>
    
    // 查询账单详情
    suspend fun getBillById(billId: String): BaseResult<CreditCardBill>
    
    // 更新账单状态
    suspend fun updateBillStatus(
        billId: String,
        status: BillStatus
    ): BaseResult<Unit>
    
    // 记录还款
    suspend fun recordPayment(
        billId: String,
        amount: Int
    ): BaseResult<Unit>
    
    // 获取待还款账单
    fun getPendingBills(): Flow<List<CreditCardBill>>
    
    // 标记逾期账单
    suspend fun markOverdueBills(): BaseResult<Int>
}
```

#### 2.1.4 UI设计要求
**账单列表页面**
- 顶部显示当期账单摘要卡片
- 列表显示历史账单，按时间倒序
- 每个账单项显示：账单月份、应还金额、还款状态
- 支持下拉刷新

**账单详情页面**
- 账单信息卡片（周期、金额、状态等）
- 还款进度条（已还/应还）
- 交易明细列表（本期所有交易）
- 底部还款按钮（未还清时显示）

### 2.2 信用卡还款功能

#### 2.2.1 功能需求
- 记录还款：支持全额还款和部分还款
- 还款历史：查看所有还款记录
- 还款提醒：到期前3天自动提醒
- 还款统计：年度还款总额、手续费统计

#### 2.2.2 数据模型设计
```kotlin
// 新增实体：CreditCardPaymentEntity
@Entity(tableName = "credit_card_payment")
data class CreditCardPaymentEntity(
    @PrimaryKey
    val id: String = UUID.randomUUID().toString(),
    val billId: String, // 关联账单
    val accountId: String, // 信用卡账户
    val fromAccountId: String?, // 还款来源账户
    val amount: Int, // 还款金额（分）
    val paymentDate: LocalDate, // 还款日期
    val paymentType: PaymentType, // 还款类型
    val note: String? = null,
    val createdAt: Instant = Clock.System.now(),
    val syncStatus: SyncStatus = SyncStatus.LOCAL
)

enum class PaymentType {
    FULL_PAYMENT,    // 全额还款
    PARTIAL_PAYMENT, // 部分还款
    MINIMUM_PAYMENT, // 最低还款
    AUTO_PAYMENT     // 自动还款
}
```

#### 2.2.3 还款流程设计
1. 用户点击"还款"按钮
2. 显示还款对话框：
   - 显示应还金额
   - 输入还款金额（默认全额）
   - 选择还款账户
   - 可选添加备注
3. 确认还款后：
   - 创建还款记录
   - 更新账单已还金额
   - 如果还清，更新账单状态
   - 在还款账户创建支出交易

### 2.3 信用卡账户扩展

#### 2.3.1 扩展Account实体
```kotlin
// 在AccountEntity中添加信用卡专属字段
@Entity(tableName = "account")
data class AccountEntity(
    // ... 现有字段 ...
    
    // 信用卡专属字段
    val creditLimit: Int? = null, // 信用额度（分）
    val billDay: Int? = null, // 账单日（1-28）
    val paymentDay: Int? = null, // 还款日（1-28）
    val annualFeeAmount: Int? = null, // 年费金额（分）
    val annualFeeWaiverThreshold: Int? = null, // 免年费门槛（分）
    val cashAdvanceLimit: Int? = null, // 取现额度（分）
    val interestRate: Double? = null // 利率（日利率，如0.0005表示万分之五）
)
```

#### 2.3.2 信用卡设置界面
- 基本信息：卡号后四位、银行、卡片等级
- 额度管理：总额度、可用额度、临时额度
- 账单设置：账单日、还款日、自动还款设置
- 费用设置：年费、取现手续费率、分期费率

## 三、其他功能开发规范

### 3.1 资产总览页面

#### 3.1.1 功能需求
- 资产分布图：饼图显示各账户余额占比
- 资产趋势图：折线图显示近6个月资产变化
- 账户列表：显示所有账户余额和占比
- 负债情况：信用卡欠款、贷款等
- 净资产计算：总资产 - 总负债

#### 3.1.2 实现要点
```kotlin
// 新增ViewModel
class AssetOverviewViewModel @Inject constructor(
    private val accountRepository: AccountRepository,
    private val transactionRepository: TransactionRepository
) : ViewModel() {
    // 获取资产分布数据
    fun getAssetDistribution(): Flow<List<AssetItem>>
    
    // 获取资产趋势数据
    fun getAssetTrend(months: Int = 6): Flow<List<TrendPoint>>
    
    // 计算净资产
    fun getNetWorth(): Flow<NetWorthData>
}
```

### 3.2 记账设置页面

#### 3.2.1 功能需求
**基础设置**
- 默认账户设置
- 默认币种设置
- 首页显示设置（显示/隐藏余额）
- 记账提醒设置

**高级设置**
- 分类管理快捷入口
- 账户管理快捷入口
- 预算管理快捷入口
- 数据导入导出

**自动化设置**
- 定期交易管理
- 自动分类规则
- 智能记账建议开关

### 3.3 批量操作功能

#### 3.3.1 功能需求
- 批量删除：选择多笔交易批量删除
- 批量修改分类：统一修改选中交易的分类
- 批量修改账户：统一修改选中交易的账户
- 批量导出：导出选中的交易记录

#### 3.3.2 实现要点
- 使用现有的SelectionViewModel进行多选管理
- 在工具栏显示批量操作按钮
- 操作前显示确认对话框
- 支持撤销操作（至少删除操作）

## 四、API改进计划

### 4.1 返回完整对象
现有问题：部分API方法只返回ID，需要额外查询获取完整信息

改进方案：
```kotlin
// 修改前
override suspend fun addTransaction(...): String

// 修改后
override suspend fun addTransaction(...): Transaction

// 实现示例
override suspend fun addTransaction(
    amountCents: Int,
    categoryId: String,
    accountId: String,
    note: String?,
    date: LocalDate,
    type: TransactionType
): Transaction {
    val result = transactionRepository.addTransaction(
        amountCents, categoryId, accountId, note, date, type
    )
    return when (result) {
        is BaseResult.Success -> {
            // 直接返回创建的交易对象
            transactionRepository.getTransactionById(result.data)
                .getOrThrow()
        }
        is BaseResult.Error -> throw result.exception
    }
}
```

### 4.2 需要改进的方法
1. `addTransaction()` - 返回Transaction而非String
2. `createAccount()` - 返回Account而非String
3. `createBudget()` - 返回Budget而非String

## 五、开发优先级和时间线

### 5.1 第一阶段（2周）
**高优先级 - 信用卡核心功能**
- [x] 创建CreditCardBillEntity和相关数据模型（2025-06-22 完成）
  - ✅ 创建BillStatus枚举
  - ✅ 创建CreditCardBillRepository接口
  - ✅ 实现CreditCardBillRepositoryImpl
  - ✅ 添加依赖注入配置
- [x] 实现账单生成Worker（2025-06-22 完成）
  - ✅ 更新CreditCardBillWorker使用CreditCardBillRepository
  - ✅ 实现自动生成账单逻辑
  - ✅ 实现逾期标记功能
- [x] 开发账单列表和详情UI（2025-06-22 完成）
  - ✅ 账单列表界面（CreditCardBillsScreen）
  - ✅ 账单详情界面（CreditCardBillDetailScreen）
  - ✅ 账单详情ViewModel（CreditCardBillDetailViewModel）
- [x] 实现基础还款功能（2025-06-22 完成）
  - ✅ 创建RecordCreditCardPaymentUseCase
  - ✅ 实现还款对话框支持账户选择
  - ✅ 集成还款流程到ViewModel
  - ✅ 支持全额/最低/自定义金额还款

### 5.2 第二阶段（1周）
**中优先级 - 完善信用卡功能**
- [x] 扩展Account实体支持信用卡字段（2025-06-22 完成）
  - ✅ 添加年费金额字段（annualFeeAmountCents）
  - ✅ 添加免年费门槛字段（annualFeeWaiverThresholdCents）
  - ✅ 添加取现额度字段（cashAdvanceLimitCents）
  - ✅ 添加利率字段（interestRate）
  - ✅ 创建数据库迁移（版本6到7）
  - ✅ 更新领域模型和映射器
- [x] 实现还款历史查询（已在第一阶段实现）
  - ✅ PaymentHistoryDialog组件
  - ✅ 显示还款统计（按时还款率、还款次数、累计还款）
  - ✅ 还款记录列表（金额、类型、日期、备注）
  - ✅ 删除还款记录功能
- [x] 添加还款提醒功能（已实现）
  - ✅ CreditCardReminderWorker每天运行
  - ✅ 在还款日前3天、1天、当天发送提醒
  - ✅ 通过NotificationApi发送通知
  - ✅ 应用启动时自动注册定时任务
- [x] 信用卡设置界面（2025-06-22 完成）
  - ✅ 创建CreditCardSettingsScreen
  - ✅ 创建CreditCardSettingsViewModel
  - ✅ 支持编辑所有信用卡字段（包括新增字段）
  - ✅ 集成还款提醒开关
  - ✅ 添加导航和高级设置入口

### 5.3 第三阶段（1周）
**中优先级 - 其他功能**
- [x] 资产总览页面（2025-06-22 完成）
  - ✅ 创建AssetItem、TrendPoint、NetWorthData等数据模型
  - ✅ 实现AssetOverviewViewModel
  - ✅ 创建AssetOverviewScreen界面
  - ✅ 添加导航支持和路由配置
- [x] 记账设置页面（2025-06-22 完成）
  - ✅ 创建LedgerSettings数据模型
  - ✅ 实现LedgerSettingsViewModel（含DataStore持久化）
  - ✅ 创建LedgerSettingsScreen界面
  - ✅ 添加导航支持和Gson依赖
  - ✅ 修复所有编译错误
- [x] API改进（返回完整对象）（2025-06-22 完成）
  - ✅ 修改addTransaction返回Transaction对象
  - ✅ 修改createAccount返回Account对象
  - ✅ 修改createBudget返回Budget对象
  - ✅ 新增getTransactionById和getBudgetById方法

### 5.4 第四阶段（3天）
**低优先级 - 增强功能**
- [x] 批量操作功能（2025-06-22 完成）
  - ✅ 创建BatchDeleteTransactionsUseCase、BatchUpdateTransactionsCategoryUseCase、BatchUpdateTransactionsAccountUseCase
  - ✅ 扩展SelectionViewModel支持批量操作
  - ✅ 更新LedgerScreen添加批量操作菜单
  - ✅ 创建批量操作对话框组件（删除确认、分类选择、账户选择）
  - ✅ 集成DialogViewModel管理对话框状态
  - ✅ 添加refreshTransactions方法刷新数据
- [x] 高级筛选选项（2025-06-22 完成）
  - ✅ 扩展TransactionFilter支持关键词搜索
  - ✅ 实现FilterViewModel的预设筛选功能
  - ✅ 创建AdvancedFilterDialog组件
  - ✅ 添加快速筛选预设（今日、本周、本月、仅收入、仅支出、大额交易）
  - ✅ 支持按备注关键词筛选
  - ✅ 集成到LedgerScreen并应用筛选结果
- [x] 性能优化（2025-06-22 完成）
  - ✅ 创建GetPaginatedTransactionsUseCase实现分页加载
  - ✅ 创建LedgerCacheManager管理频繁访问的数据缓存
  - ✅ 创建DatabaseOptimization配置数据库索引优化
  - ✅ 更新LedgerViewModel支持分页和缓存
  - ✅ 创建InfiniteScrollHandler组件处理无限滚动
  - ✅ 实现账户和分类数据缓存机制
  - ✅ 优化查询性能，支持大数据量场景

## 六、测试要求

### 6.1 单元测试
- Repository层测试覆盖率 > 80%
- UseCase层测试覆盖率 > 90%
- ViewModel层测试覆盖率 > 70%

### 6.2 集成测试
- 信用卡账单生成流程
- 还款流程（包括部分还款）
- 账单状态转换
- Worker定时任务

### 6.3 UI测试
- 账单列表的显示和交互
- 还款对话框的各种场景
- 批量操作的用户流程

## 七、验收标准

### 7.1 功能验收
1. **信用卡账单**
   - 能够正确生成月度账单
   - 账单金额计算准确
   - 状态转换逻辑正确
   
2. **还款功能**
   - 支持全额和部分还款
   - 还款后账单状态正确更新
   - 还款记录可查询

3. **用户体验**
   - 操作流程顺畅
   - 错误提示清晰
   - 加载状态明确

### 7.2 性能验收
- 账单生成时间 < 2秒
- 列表滚动流畅（60fps）
- 内存使用合理

### 7.3 代码质量
- 遵循项目代码规范
- 有完善的注释
- 通过代码审查

## 八、风险和注意事项

### 8.1 数据迁移
- 新增数据表需要创建数据库迁移脚本
- 考虑现有用户的数据兼容性
- 提供数据回滚方案

### 8.2 性能影响
- 信用卡功能增加了数据复杂度
- 需要优化查询，避免N+1问题
- 考虑添加适当的索引

### 8.3 安全考虑
- 金额计算使用整数避免精度问题
- 敏感信息（如完整卡号）不存储
- 操作日志记录

## 九、相关文档
- [架构设计文档](./架构迁移计划与原则.md)
- [数据库设计文档](./database-design.md)
- [UI设计规范](./ui-design-guide.md)

---
*本文档将随开发进展持续更新*