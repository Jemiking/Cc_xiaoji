# 记账模块功能开发文档

## 开发状态说明
- ✅ 已完成
- 🚧 开发中
- ❌ 未开始

## 一、交易记录管理

### 1. 交易记录管理
- [✅] 添加收入/支出记录
- [✅] 编辑交易记录
- [✅] 删除交易记录
- [✅] 批量删除交易
- [✅] 复制交易记录
- [🚧] 交易记录搜索（已实现文本搜索，语音搜索待开发）
- [✅] 交易记录筛选（类型、金额、分类、日期范围筛选）
- [✅] 交易记录分组查看（按天/周/月/年）
- [✅] 交易详情查看
- [❌] 添加交易备注（注：当前只有简单备注字段）
- [❌] 添加交易位置信息
- [❌] 添加交易附件/图片

### 2. 账户管理
- [✅] 创建多个账户（现金、银行卡、支付宝、微信等）
- [✅] 编辑账户信息
- [✅] 删除账户
- [✅] 设置默认账户
- [✅] 账户余额调整
- [✅] 账户间转账
- [✅] 账户分类管理
- [❌] 多币种账户支持
- [✅] 账户余额实时更新

### 3. 信用卡管理
- [❌] 添加信用卡账户
- [❌] 信用卡账单周期设置
- [❌] 信用卡还款提醒
- [❌] 信用卡额度管理
- [❌] 信用卡消费记录
- [❌] 信用卡还款记录

## 二、分类与标签系统

### 1. 分类管理
- [✅] 支出分类管理
- [✅] 收入分类管理
- [✅] 自定义分类
- [✅] 分类图标设置
- [✅] 分类颜色设置
- [🚧] 父子分类层级（数据结构已支持，UI待实现）
- [✅] 分类使用统计

### 2. 标签管理
- [❌] 创建自定义标签
- [❌] 编辑标签
- [❌] 删除标签
- [❌] 标签搜索
- [❌] 批量标签操作
- [❌] 交易标签关联

## 三、预算管理

### 1. 预算设置
- [✅] 创建月度预算
- [✅] 设置分类预算
- [🚧] 预算周期设置（月度/季度/年度）（目前支持月度）
- [✅] 预算金额调整

### 2. 预算监控
- [✅] 预算使用进度追踪
- [✅] 预算超支提醒
- [✅] 预算节约统计
- [✅] 分类预算分析

## 四、统计分析功能

### 1. 统计报表
- [✅] 收支趋势图
- [✅] 分类占比饼图
- [✅] 支出/收入排行
- [✅] 储蓄率分析
- [🚧] 时间段对比分析（基础功能已实现，对比功能待完善）

### 2. 财务报告
- [❌] 月度财务报告
- [❌] 季度财务报告
- [❌] 年度财务报告
- [❌] 自定义报告生成
- [❌] 报告导出功能

## 五、高级功能

### 1. 储蓄目标
- [✅] 创建储蓄目标
- [✅] 目标进度追踪
- [🚧] 自动储蓄计划（需要关联定期交易）
- [🚧] 到期提醒（UI已显示剩余天数，通知功能待实现）

### 2. 定期交易
- [✅] 设置定期收入/支出
- [✅] 自动记账功能
- [🚧] 定期交易提醒（待实现通知功能）
- [✅] 执行频率设置（每天/每周/每月/每年）

### 3. 投资理财追踪
- [❌] 添加投资产品
- [❌] 投资收益记录
- [❌] 投资到期提醒
- [❌] 投资业绩分析

## 开发进度记录

### 2025-05-27
- 创建功能开发文档
- 已有基础功能：添加收入/支出记录、删除交易记录、简单的月度统计
- 完成编辑交易记录功能：
  - 在LedgerViewModel中添加了updateTransaction和setEditingTransaction方法
  - 在LedgerScreen中添加了编辑对话框
  - 创建了EditTransactionDialog组件，支持修改金额、分类和备注
- 完成交易详情查看功能：
  - 创建了TransactionDetailScreen页面
  - 添加了导航路由支持
  - 详情页显示完整交易信息，包括金额、分类、备注、时间等
  - 在详情页可以编辑和删除交易
- 完成批量删除交易功能：
  - 在LedgerViewModel中添加了选择模式状态管理
  - 实现了多选、全选、清除选择功能
  - 在LedgerScreen中添加了选择模式UI，包括复选框和操作栏
  - 支持批量删除选中的交易记录
- 完成复制交易记录功能：
  - 在LedgerViewModel中添加了copyTransaction方法
  - 在TransactionItem中添加了长按显示菜单功能
  - 菜单包含复制、编辑、删除选项
  - 复制的交易保留原有金额、分类和备注，时间更新为当前时间
- 完成交易记录搜索功能（文本搜索）：
  - 在TransactionDao中添加了searchTransactions方法，支持按备注、分类和金额搜索
  - 在LedgerViewModel中添加了搜索状态管理和搜索方法
  - 在LedgerScreen中添加了搜索模式UI，包括搜索框和搜索结果显示
  - 支持实时搜索，搜索结果即时更新
- 完成交易记录筛选功能（部分）：
  - 创建了TransactionFilter数据类，支持多维度筛选
  - 在LedgerViewModel中实现了筛选逻辑，支持按交易类型、分类、金额范围筛选
  - 创建了FilterTransactionDialog对话框，提供友好的筛选界面
  - 支持清除筛选和筛选状态显示

- 开始实现账户管理系统基础架构：
  - 创建了AccountEntity实体类，支持多种账户类型（现金、银行卡、支付宝、微信等）
  - 创建了AccountDao数据访问对象，提供账户的增删改查操作
  - 创建了AccountRepository仓库类，实现账户业务逻辑
  - 修改了TransactionEntity添加accountId外键关联
  - 更新了数据库版本并添加迁移逻辑
- 完成账户管理UI功能：
  - 创建了AccountScreen账户管理主页面，显示所有账户列表和总余额
  - 创建了AccountViewModel处理账户相关业务逻辑
  - 实现了添加新账户功能，支持设置账户名称、类型和初始余额
  - 实现了编辑账户信息功能，可修改账户名称和余额
  - 实现了删除账户功能，包含确认对话框
  - 实现了设置默认账户功能，新交易默认使用该账户
  - 实现了账户间转账功能，支持在多个账户间转移资金
  - 创建了AccountSelector组件，用于在交易中选择账户
  - 更新了AddTransactionDialog，添加了账户选择器
  - 集成了账户余额实时更新，交易后自动更新对应账户余额
  - 在LedgerScreen顶部栏添加了账户管理入口

- 完善日期范围筛选功能：
  - 确认日期筛选功能已经完全实现，包括快速选择和自定义日期范围
  - 日期选择器对话框正常工作
  - 筛选逻辑正确处理日期范围
- 完成交易记录分组查看功能：
  - 创建了GroupingMode枚举，支持按天、周、月、年分组
  - 创建了TransactionGroup数据类存储分组信息
  - 实现了智能分组标题（今天、昨天、本周、上周等）
  - 在LedgerScreen中添加了分组模式切换按钮
  - 实现了分组视图显示，包含每组的收支汇总
  - 支持在分组和非分组视图之间切换

- 完成分类管理系统：
  - 创建了CategoryEntity实体类，支持自定义分类、图标、颜色、父子关系
  - 创建了CategoryDao数据访问对象，提供分类的增删改查操作
  - 创建了CategoryRepository仓库类，实现分类业务逻辑
  - 创建了Category域模型，包含默认图标和颜色列表
  - 创建了CategoryManagementScreen分类管理界面
  - 创建了CategoryViewModel处理分类管理业务逻辑
  - 实现了添加自定义分类功能，支持设置名称、图标和颜色
  - 实现了编辑分类功能（系统分类名称不可修改）
  - 实现了删除分类功能（系统分类和已使用的分类不可删除）
  - 实现了分类使用统计显示
  - 支持支出和收入分类分开管理
  - 在LedgerScreen顶部栏添加了分类管理入口
  - 数据库初始化时自动创建默认分类

- 更新交易功能使用动态分类：
  - 更新了Transaction域模型，添加categoryDetails字段存储分类详情
  - 修改了TransactionRepository，支持使用categoryId创建交易
  - 更新了添加交易对话框，显示动态加载的分类列表
  - 更新了编辑交易对话框，使用动态分类
  - 更新了交易列表显示，使用分类的图标、名称和颜色
  - 更新了筛选功能，支持基于动态分类的筛选
  - 创建了CategoryChip组件美观地显示分类选项
  - 应用启动时自动初始化默认分类
  - 保持了向后兼容性

- 完成预算管理功能：
  - 创建了BudgetEntity实体类，支持总预算和分类预算
  - 创建了BudgetDao，提供预算的增删改查和使用情况查询
  - 创建了BudgetRepository，实现预算业务逻辑
  - 创建了BudgetScreen预算管理界面，支持月份切换
  - 创建了BudgetViewModel管理预算状态
  - 实现了添加/编辑预算功能，支持设置总预算和分类预算
  - 实现了预算进度可视化，使用进度条和颜色状态
  - 在HomeScreen添加了预算概览卡片
  - 在添加交易时自动检查预算并发出提醒
  - 支持预算预警功能（默认80%触发）
  - 在ProfileScreen添加了预算管理入口
  - 更新数据库版本从3到4

- 完成统计分析功能：
  - 创建了StatisticsScreen统计分析界面
  - 创建了StatisticsViewModel管理统计数据
  - 实现了时间段选择（本月、本年、自定义日期范围）
  - 实现了收支趋势折线图，使用Canvas API绘制
  - 实现了分类占比饼图，显示各分类支出占比
  - 实现了支出/收入排行榜，显示TOP5分类
  - 实现了储蓄率计算和显示
  - 在TransactionRepository添加了统计查询方法
  - 在HomeScreen添加了统计入口（查看详情按钮）
  - 在LedgerScreen顶部栏添加了统计图标
  - 支持动态时间段切换和数据刷新

- 完成定期交易功能：
  - 创建了RecurringTransactionEntity实体类，支持多种频率设置
  - 创建了RecurringTransactionDao和Repository
  - 创建了RecurringTransactionScreen定期交易管理界面
  - 创建了RecurringTransactionViewModel管理状态
  - 实现了添加/编辑定期交易功能
  - 支持每天、每周、每月、每年的频率选择
  - 实现了启用/禁用定期交易功能
  - 创建了RecurringTransactionWorker使用WorkManager定期执行
  - 实现了自动计算下次执行时间
  - 在LedgerScreen菜单中添加了定期交易入口
  - 更新数据库版本从4到5

- 完成储蓄目标管理功能：
  - 创建了SavingsGoalEntity和SavingsContributionEntity实体类
  - 创建了SavingsGoalDao提供数据库操作
  - 创建了SavingsGoalRepository实现业务逻辑
  - 创建了SavingsGoalScreen储蓄目标列表界面
  - 创建了SavingsGoalDetailScreen目标详情和历史记录界面
  - 创建了SavingsGoalViewModel管理状态
  - 实现了创建/编辑/删除储蓄目标功能
  - 实现了存款/取款记录功能
  - 实现了目标进度可视化（进度条和百分比）
  - 实现了预计完成时间计算
  - 在HomeScreen添加了储蓄目标概览卡片
  - 在ProfileScreen添加了储蓄目标管理入口
  - 支持自定义图标和颜色
  - 更新数据库版本从5到6

### 2025-05-28
- 修复应用闪退问题：
  - 问题原因：数据库从版本1升级到版本6缺少迁移路径
  - 临时解决：添加了fallbackToDestructiveMigration()
  - 根本解决：实现完整的数据库迁移机制

- 完成数据库迁移系统：
  - 创建了DatabaseMigrations对象，包含所有版本迁移路径
  - 实现了版本1到6的5个Migration对象
  - 每个迁移包含完整的表结构变更和数据迁移逻辑
  - 迁移过程自动创建默认数据（默认账户、分类等）
  - 保证外键约束的完整性
  - 使用临时表策略处理复杂的表结构变更

- 实现备份恢复机制：
  - 创建了DatabaseBackupManager管理备份功能
  - 支持手动备份和自动备份
  - 备份包含主数据库文件及wal、shm文件
  - 自动管理备份数量（最多保留5个）
  - 支持备份恢复，包含失败回滚机制
  - 为迁移操作提供安全保障

- 编写详细文档：
  - 创建了《数据库迁移最佳实践》指南
  - 创建了《数据库迁移功能设计文档》
  - 记录了版本历史、迁移策略、开发指南
  - 提供了常见操作的代码示例
  - 制定了问题排查和应急方案

### 下一步开发计划
1. 交易备注增强（位置信息、附件/图片）
2. 标签管理系统
3. 信用卡管理功能

## 开发总结

截至 2025-05-28，记账模块已完成以下核心功能：

### 已完成功能统计
- **交易记录管理**：添加、编辑、删除、批量删除、复制、搜索（文本）、筛选（类型/金额/分类/日期）、分组查看、详情查看
- **账户管理**：多账户支持、账户间转账、余额管理、默认账户设置
- **分类管理**：自定义分类、系统分类、图标和颜色设置、使用统计、动态分类列表
- **预算管理**：月度总预算、分类预算、进度追踪、超支提醒、预警功能
- **统计分析**：收支趋势图、分类占比饼图、支出收入排行、储蓄率分析、时间段选择
- **定期交易**：自动记账、多种频率支持（天/周/月/年）、启用禁用控制
- **储蓄目标**：目标设定、进度追踪、存款取款记录、历史记录查看
- **数据库迁移**：版本1-6完整迁移路径、数据完整性保证、自动默认数据创建
- **备份恢复**：手动/自动备份、备份文件管理、恢复失败回滚、迁移前备份

### 技术亮点
1. 使用Room数据库，支持数据迁移和外键约束
2. 采用MVVM架构，使用ViewModel和StateFlow管理状态
3. 使用Hilt进行依赖注入
4. 使用WorkManager实现后台定期任务
5. 使用Canvas API自定义绘制图表，无需额外依赖
6. 支持动态主题和Material Design 3
7. 完整的数据同步状态管理（为云同步预留）
8. **完善的数据库迁移机制**：
   - 支持从任意历史版本平滑升级
   - 迁移过程保证数据完整性
   - 自动创建默认数据和外键关联
   - 使用临时表策略处理复杂变更
9. **数据备份恢复系统**：
   - 自动备份和手动备份支持
   - 备份文件完整性保证（包含wal/shm）
   - 恢复失败自动回滚
   - 历史备份自动管理

### 待实现功能
- 语音搜索
- 交易位置信息
- 交易附件/图片
- 标签系统
- 信用卡管理
- 财务报告导出
- 投资理财追踪
- 多币种支持
- 通知提醒系统
- 备份恢复UI界面（后端已实现）

记账模块的核心功能已经基本完成，可以满足日常记账需求。