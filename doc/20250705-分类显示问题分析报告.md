# 分类显示问题分析报告

> 创建日期：2025-07-05
> 问题状态：已定位 🔍
> 影响范围：记账模块分类选择

## 问题描述

用户截图显示，在"记一笔"页面的分类选择中，显示的不是中文分类名称，而是英文字符串：
- `restaur`（restaurant 的截断）
- `directio`（directions 的截断）
- `shoppi`（shopping 的截断）
- `sports`
- `home`

## 问题分析

### 1. 代码检查结果
通过追踪代码流程，确认代码逻辑正确：
- ✅ `CategoryChip` 组件正确显示 `category.name` 和 `category.icon`
- ✅ `AddTransactionDialog` 正确传递分类数据
- ✅ `LedgerViewModel` 通过 `GetCategoriesUseCase` 获取分类
- ✅ `CategoryRepositoryImpl` 从数据库读取分类数据

### 2. 根本原因
**数据库中存储了错误的分类数据**：
- `name` 字段错误地存储了 Material Icons 的名称（如 "restaurant"）
- 应该存储的是中文分类名称（如 "餐饮"）

### 3. 问题来源
可能的原因：
1. **初始数据插入错误**：在某个版本中，初始化代码可能将 icon 名称错误地赋值给了 name 字段
2. **数据未更新**：虽然我们修复了初始化代码，但数据库中仍保留着旧的错误数据
3. **检查逻辑**：`existingCategories.isEmpty()` 检查阻止了重新初始化

## 解决方案

### 方案一：清除应用数据（推荐用于开发环境）
```bash
# 通过 ADB 清除应用数据
adb shell pm clear com.ccxiaoji.app

# 或者在手机设置中：
# 设置 → 应用管理 → CC小记 → 存储 → 清除数据
```

**优点**：
- 简单直接
- 确保获得干净的初始状态
- 适合开发测试阶段

**缺点**：
- 会丢失所有数据
- 不适合生产环境

### 方案二：数据库迁移修复（适合生产环境）
创建数据库迁移，修复现有分类数据：

```kotlin
// Migration_7_to_8.kt
val MIGRATION_7_8 = object : Migration(7, 8) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 修复分类名称
        database.execSQL("""
            UPDATE categories 
            SET name = CASE icon
                WHEN 'restaurant' THEN '餐饮'
                WHEN 'directions_car' THEN '交通'
                WHEN 'shopping_cart' THEN '购物'
                WHEN 'sports_esports' THEN '娱乐'
                WHEN 'home' THEN '居住'
                -- 添加更多映射
                ELSE name
            END
            WHERE isSystem = 1
        """)
        
        // 修复图标
        database.execSQL("""
            UPDATE categories 
            SET icon = CASE name
                WHEN '餐饮' THEN '🍜'
                WHEN '交通' THEN '🚗'
                WHEN '购物' THEN '🛍️'
                WHEN '娱乐' THEN '🎮'
                WHEN '居住' THEN '🏠'
                -- 添加更多映射
                ELSE icon
            END
            WHERE isSystem = 1
        """)
    }
}
```

**优点**：
- 保留用户数据
- 自动修复问题
- 适合生产环境

**缺点**：
- 需要增加数据库版本号
- 需要测试迁移逻辑

### 方案三：运行时检查修复（临时方案）
在 `CategoryRepositoryImpl` 添加数据修复逻辑：

```kotlin
suspend fun fixCategoryData() {
    val categories = categoryDao.getCategoriesByUser(userId).first()
    categories.forEach { category ->
        if (category.isSystem && category.name.contains("restaurant", true)) {
            // 修复错误的分类数据
            val fixed = when(category.name.lowercase()) {
                "restaurant" -> category.copy(name = "餐饮", icon = "🍜")
                "directions_car" -> category.copy(name = "交通", icon = "🚗")
                "shopping_cart" -> category.copy(name = "购物", icon = "🛍️")
                // ... 更多映射
                else -> category
            }
            categoryDao.updateCategory(fixed)
        }
    }
}
```

## 推荐操作

### 开发环境
1. **立即执行**：清除应用数据（方案一）
2. **验证修复**：重新安装应用，检查分类显示正确

### 生产环境准备
1. **实施方案二**：创建数据库迁移
2. **充分测试**：确保迁移逻辑正确
3. **版本控制**：在下个版本发布时包含此修复

## 验证步骤
1. 清除应用数据或执行迁移
2. 打开应用
3. 进入记账 → 记一笔
4. 检查分类显示：
   - ✅ 应显示中文名称：餐饮、交通、购物等
   - ✅ 图标应显示为 Emoji
   - ❌ 不应显示英文字符串

---
*分析时间：2025-07-05*