# 排班模块渐进式迁移指南 v2.0

> ⚠️ **重要提醒**：本文档是v1.0的增强版，修复了原版本中的所有缺失内容。每次执行迁移前必须阅读此文档，确保理解所有步骤和注意事项。

## 📋 迁移概述

本指南详细说明如何将独立开发的排班模块（Cc_xiaoji_paiban）完整迁移到CC小记主项目的模块化架构中。

### 关键信息
- **源项目路径**：`D:\kotlin\Cc_xiaoji_paiban`
- **目标模块路径**：`feature/schedule/`
- **预计时间**：5-7天（增加验证时间）
- **迁移策略**：渐进式分步迁移，每步验证
- **风险等级**：中等（涉及复杂功能迁移）

### 版本更新说明（v2.0）
- 增加了完整的文件迁移清单
- 补充了依赖配置和权限迁移
- 添加了业务逻辑迁移指导
- 增强了验证步骤
- 添加了测试策略
- 补充了资源文件迁移

## 🚀 迁移前准备

### 1. 环境检查清单
- [ ] 确认主项目编译通过：`./gradlew build`
- [ ] 确认数据库版本为5（包含排班表）
- [ ] 备份当前代码：`git add -A && git commit -m "备份：排班模块迁移前状态"`
- [ ] 创建迁移分支：`git checkout -b feature/schedule-migration-v2`
- [ ] 确认排班模块源代码完整性
- [ ] 记录源项目的所有功能点（用于后续验证）
- [ ] 准备依赖版本对比表

### 2. 依赖映射表（增强版）
```
排班模块依赖 → 主项目依赖
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
基础依赖：
ScheduleDatabase     → CcDatabase
Theme/Color/Type     → com.ccxiaoji.core.ui.theme.*
ThemeManager        → 迁移周起始日功能到主项目DataStore
包名前缀            → com.ccxiaoji.feature.schedule

特殊依赖：
coreLibraryDesugaring → 确认主项目是否已配置
kotlinx-datetime     → 评估是否需要（或用java.time）
compose-bom:2024.06.00 → 统一使用主项目版本

数据模型：
SyncStatus (Int)    → SyncStatus (枚举)
Schedule业务逻辑    → 保留所有计算方法
Shift.PRESET_COLORS → 迁移预设颜色常量
```

### 3. 关键差异处理方案（增强版）
| 差异项 | 排班模块 | 主项目 | 处理方案 |
|--------|----------|--------|----------|
| 数据库版本 | v2 | v5 | 直接使用v5，无需迁移 |
| SyncStatus | Int (0/1) | 枚举 | 创建转换函数 |
| 日期存储 | Long | Long | 保持一致 |
| 主题管理 | 独立ThemeManager | DataStore | 迁移周起始日设置功能 |
| 权限管理 | 通知、闹钟权限 | 评估 | 合并到主项目manifest |
| 文件导出 | FileProvider | 评估 | 确认主项目配置 |
| minSdk | 24 | 26 | 使用coreLibraryDesugaring |

## 📝 第一阶段：基础架构准备（第1天）

### 步骤1.1：创建模块结构
```bash
# 确保在主项目根目录
cd /mnt/d/kotlin/Cc_xiaoji

# feature/schedule目录应该已存在，检查结构
ls -la feature/schedule/

# 如果需要，创建缺失的子目录
mkdir -p feature/schedule/{api,data,domain,presentation}/src/main/kotlin/com/ccxiaoji/feature/schedule/{api,data,domain,presentation}
```

### 步骤1.2：配置build.gradle.kts
```kotlin
// feature/schedule/build.gradle.kts
plugins {
    id("ccxiaoji.android.feature")
    id("ccxiaoji.android.hilt")
}

android {
    namespace = "com.ccxiaoji.feature.schedule"
}

dependencies {
    // Core modules
    implementation(project(":core:common"))
    implementation(project(":core:ui"))
    implementation(project(":core:database"))
    implementation(project(":core:data"))
    
    // Shared modules
    implementation(project(":shared:notification"))
    implementation(project(":shared:backup"))
    
    // WorkManager for notifications
    implementation(libs.androidx.work.runtime.ktx)
    implementation(libs.hilt.work)
    
    // DataStore for preferences
    implementation(libs.androidx.datastore.preferences)
    
    // Date/Time support (if needed)
    coreLibraryDesugaring(libs.android.desugarJdkLibs)
}
```

### 步骤1.3：配置API模块
```bash
# 1. 迁移API接口
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/api/ScheduleApi.kt \
   feature/schedule/api/src/main/kotlin/com/ccxiaoji/feature/schedule/api/

# 2. 创建导航接口
```

**创建ScheduleNavigator.kt：**
```kotlin
package com.ccxiaoji.feature.schedule.api

import java.time.LocalDate

interface ScheduleNavigator {
    fun navigateToScheduleHome()
    fun navigateToShiftManage()
    fun navigateToScheduleEdit(date: LocalDate? = null)
    fun navigateToSchedulePattern()
    fun navigateToScheduleStatistics()
    fun navigateToExport()
    fun navigateToSettings()
    fun navigateToAbout()
}
```

### 步骤1.4：迁移权限配置
在主项目的AndroidManifest.xml中添加：
```xml
<!-- 排班模块所需权限 -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
<uses-permission android:name="android.permission.USE_EXACT_ALARM" />
```

### 步骤1.5：调整包名和导入
```bash
# 批量替换包名脚本
find feature/schedule -name "*.kt" -type f -exec sed -i \
    's/com.example.cc_xiaoji/com.ccxiaoji.feature.schedule/g' {} \;

# 编译检查
./gradlew :feature:schedule:api:compileDebugKotlin
```

### 验证检查点 ✅
- [ ] API模块编译通过
- [ ] ScheduleApi接口定义完整
- [ ] ScheduleNavigator接口创建（包含所有导航方法）
- [ ] 包名全部更新正确
- [ ] 权限配置已添加
- [ ] 依赖配置完整

## 📝 第二阶段：Domain层迁移（第2天）

### 步骤2.1：迁移领域模型（保留业务逻辑）
```bash
# 1. 创建目录结构
mkdir -p feature/schedule/domain/src/main/kotlin/com/ccxiaoji/feature/schedule/domain/{model,repository,usecase}

# 2. 复制模型类
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/domain/model/*.kt \
   feature/schedule/domain/src/main/kotlin/com/ccxiaoji/feature/schedule/domain/model/

# 3. 调整包名
find feature/schedule/domain -name "*.kt" -type f -exec sed -i \
    's/com.example.cc_xiaoji/com.ccxiaoji.feature.schedule/g' {} \;
```

**重要：保留Schedule模型的业务逻辑**
```kotlin
// Schedule.kt中需要保留的方法：
- isCheckedIn: Boolean
- actualWorkHours: Double?（包含跨天计算逻辑）
- isToday(): Boolean
- isPast(): Boolean
- isFuture(): Boolean

// Shift.kt中需要保留的常量：
companion object {
    val PRESET_COLORS = listOf(
        0xFF4CAF50.toInt(), // 绿色
        0xFF2196F3.toInt(), // 蓝色
        // ... 其他预设颜色
    )
}
```

### 步骤2.2：迁移Repository接口
```kotlin
// 在 domain/repository/ScheduleRepository.kt
package com.ccxiaoji.feature.schedule.domain.repository

import kotlinx.coroutines.flow.Flow
import java.time.LocalDate
import java.time.YearMonth

interface ScheduleRepository {
    // 排班相关
    fun getSchedulesByMonth(yearMonth: YearMonth): Flow<List<Schedule>>
    fun getScheduleByDate(date: LocalDate): Flow<Schedule?>
    suspend fun saveSchedule(schedule: Schedule): Long
    suspend fun updateSchedule(schedule: Schedule)
    suspend fun deleteSchedule(scheduleId: Long)
    suspend fun deleteScheduleByDate(date: LocalDate)
    suspend fun saveSchedules(schedules: List<Schedule>)
    suspend fun clearSchedules(startDate: LocalDate, endDate: LocalDate)
    suspend fun getMonthlyStatistics(yearMonth: YearMonth): ScheduleStatistics
    suspend fun getStatistics(startDate: LocalDate, endDate: LocalDate): ScheduleStatistics
    
    // 班次相关
    fun getAllShifts(): Flow<List<Shift>>
    fun getActiveShifts(): Flow<List<Shift>>
    suspend fun getShiftById(shiftId: Long): Shift?
    suspend fun createShift(shift: Shift): Long
    suspend fun updateShift(shift: Shift)
    suspend fun deleteShift(shiftId: Long)
    suspend fun isShiftNameExists(name: String, excludeId: Long = 0): Boolean
}
```

### 步骤2.3：迁移UseCase（完整列表）
```bash
# 核心UseCase迁移清单：
# 1. 排班操作
- GetScheduleByDateUseCase
- CreateScheduleUseCase（包含复杂的模式处理逻辑）
- UpdateScheduleUseCase
- DeleteScheduleUseCase
- GetMonthScheduleUseCase

# 2. 班次管理
- GetShiftsUseCase
- GetActiveShiftsUseCase
- GetQuickShiftsUseCase
- ManageShiftUseCase

# 3. 统计分析
- GetScheduleStatisticsUseCase
- GetStatisticsUseCase
- ExportScheduleDataUseCase

# 4. 数据管理
- BackupDatabaseUseCase
- RestoreDatabaseUseCase
- ClearAllDataUseCase

# 复制并调整
cp -r /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/domain/usecase/*.kt \
   feature/schedule/domain/src/main/kotlin/com/ccxiaoji/feature/schedule/domain/usecase/
```

**特别注意CreateScheduleUseCase的业务规则：**
- 支持2-365天的循环排班
- Weekly模式需要转换为Cycle处理
- 轮班模式包含休息日计算
- 自定义模式的数组处理逻辑

### 验证检查点 ✅
- [ ] Domain模块编译通过
- [ ] 所有模型类迁移完成（包含业务逻辑）
- [ ] Repository接口定义完整
- [ ] 所有15个UseCase迁移完成
- [ ] 复杂业务逻辑保留完整
- [ ] 预设常量（如颜色）已迁移

## 📝 第三阶段：Data层实现（第3天）

### 步骤3.1：实现DAO扩展
```kotlin
// 在 feature/schedule/data/src/.../local/dao/ScheduleDaoExtensions.kt
package com.ccxiaoji.feature.schedule.data.local.dao

import com.ccxiaoji.core.database.dao.ScheduleDao
import com.ccxiaoji.core.database.dao.ShiftDao
import com.ccxiaoji.core.database.entity.ScheduleEntity
import kotlinx.coroutines.flow.Flow
import java.time.LocalDate

// 扩展主项目的DAO，添加排班模块特定查询
suspend fun ScheduleDao.getSchedulesByDateRange(
    startDate: LocalDate,
    endDate: LocalDate
): List<ScheduleEntity> {
    return getSchedulesBetweenDates(
        startDate.toEpochDay() * 86400000,
        endDate.toEpochDay() * 86400000
    )
}

// 添加快速班次查询
fun ShiftDao.getQuickShifts(): Flow<List<ShiftEntity>> {
    // 获取最常用的5个班次
    return getAllShifts() // 后续可以根据使用频率排序
}
```

### 步骤3.2：实现Repository（包含完整转换逻辑）
```kotlin
// 在 feature/schedule/data/src/.../repository/ScheduleRepositoryImpl.kt
@Singleton
class ScheduleRepositoryImpl @Inject constructor(
    private val scheduleDao: ScheduleDao,
    private val shiftDao: ShiftDao
) : ScheduleRepository {
    
    // Entity到Domain的转换（保留所有业务字段）
    private fun ScheduleEntity.toDomainModel(shift: Shift): Schedule {
        return Schedule(
            id = id,
            date = LocalDate.ofEpochDay(date / 86400000),
            shift = shift,
            note = note,
            actualStartTime = actualStartTime?.let { parseTime(it) },
            actualEndTime = actualEndTime?.let { parseTime(it) }
        )
    }
    
    // Domain到Entity的转换
    private fun Schedule.toEntity(): ScheduleEntity {
        return ScheduleEntity(
            id = id,
            date = date.toEpochDay() * 86400000,
            shiftId = shift.id,
            note = note,
            actualStartTime = actualStartTime?.let { formatTime(it) },
            actualEndTime = actualEndTime?.let { formatTime(it) },
            syncStatus = SyncStatus.SYNCED,
            createdAt = System.currentTimeMillis(),
            updatedAt = System.currentTimeMillis()
        )
    }
    
    // 时间字符串转换辅助方法
    private fun parseTime(timeStr: String): LocalTime {
        val parts = timeStr.split(":")
        return LocalTime.of(parts[0].toInt(), parts[1].toInt())
    }
    
    private fun formatTime(time: LocalTime): String {
        return String.format("%02d:%02d", time.hour, time.minute)
    }
    
    // 实现所有Repository方法...
}
```

### 步骤3.3：迁移Worker和Scheduler
```bash
# 1. 创建worker目录
mkdir -p feature/schedule/data/src/main/kotlin/com/ccxiaoji/feature/schedule/data/{worker,scheduler}

# 2. 复制Worker类
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/notification/ScheduleNotificationWorker.kt \
   feature/schedule/data/src/main/kotlin/com/ccxiaoji/feature/schedule/data/worker/

# 3. 复制Scheduler类
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/notification/ScheduleNotificationScheduler.kt \
   feature/schedule/data/src/main/kotlin/com/ccxiaoji/feature/schedule/data/scheduler/

# 4. 调整包名和依赖
# 注意：使用 @HiltWorker 注解，依赖shared:notification模块
```

### 步骤3.4：创建数据模块配置
```kotlin
// 在 feature/schedule/data/src/.../di/ScheduleModule.kt
@Module
@InstallIn(SingletonComponent::class)
object ScheduleModule {
    
    @Provides
    @Singleton
    fun provideScheduleRepository(
        scheduleDao: ScheduleDao,
        shiftDao: ShiftDao
    ): ScheduleRepository = ScheduleRepositoryImpl(scheduleDao, shiftDao)
    
    @Binds
    abstract fun bindScheduleApi(
        impl: ScheduleApiImpl
    ): ScheduleApi
    
    @Binds
    abstract fun bindScheduleNavigator(
        navigator: ScheduleNavigator
    ): ScheduleNavigator
}
```

### 验证检查点 ✅
- [ ] Data模块编译通过
- [ ] Repository实现完整（包含所有转换逻辑）
- [ ] 时间转换函数正确
- [ ] Worker配置正确（使用@HiltWorker）
- [ ] Scheduler实现完整
- [ ] 依赖注入配置完整

## 📝 第四阶段：Presentation层迁移（第4天）- 重点修订

### 步骤4.1：迁移ViewModel（完整功能）
```bash
# 1. 复制所有ViewModel文件
cp -r /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/viewmodel/*.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/viewmodel/

# 2. 调整包名
find feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/viewmodel \
    -name "*.kt" -type f -exec sed -i \
    's/com.example.cc_xiaoji/com.ccxiaoji.feature.schedule/g' {} \;
```

**ViewModel调整要点：**
```kotlin
// 1. 修改继承关系
- import androidx.lifecycle.ViewModel
+ import com.ccxiaoji.core.common.base.BaseViewModel

- class CalendarViewModel : ViewModel()
+ class CalendarViewModel : BaseViewModel()

// 2. 保留所有状态管理逻辑
// 3. 保留UI交互逻辑
```

### 步骤4.2：迁移核心UI组件（重要！）
```bash
# 1. 创建组件目录
mkdir -p feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/{calendar,components,export,pattern,schedule,settings,shift,statistics}

# 2. 迁移核心组件（这些是功能的关键！）
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/calendar/CalendarView.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/calendar/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/components/*.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/components/

# 3. 迁移所有日期选择器组件
- CustomDatePickerDialog.kt
- CustomDateRangePickerDialog.kt  
- CustomYearMonthPickerDialog.kt
- CustomTimePickerDialog.kt
- QuickShiftSelector.kt
```

### 步骤4.3：迁移所有Screen文件（完整功能实现）
```bash
# 复制所有Screen文件（不是创建占位符！）
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/calendar/CalendarScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/calendar/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/shift/ShiftManageScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/shift/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/shift/ShiftEditDialog.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/shift/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/schedule/ScheduleEditScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/schedule/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/pattern/SchedulePatternScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/pattern/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/statistics/ScheduleStatisticsScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/statistics/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/export/ExportScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/export/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/settings/SettingsScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/settings/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/settings/AboutScreen.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/settings/
```

### 步骤4.4：迁移UI相关的枚举和数据类
```bash
# 复制UI相关的辅助类
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/statistics/TimeRange.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/statistics/

cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/java/com/example/cc_xiaoji/presentation/export/ExportFormat.kt \
   feature/schedule/presentation/src/main/kotlin/com/ccxiaoji/feature/schedule/presentation/ui/export/

# ... 其他UI相关类
```

### 步骤4.5：调整主题和导入
```bash
# 批量替换主题引用
find feature/schedule/presentation -name "*.kt" -type f -exec sed -i \
    's/com.example.cc_xiaoji.presentation.theme/com.ccxiaoji.core.ui.theme/g' {} \;

# 替换包名
find feature/schedule/presentation -name "*.kt" -type f -exec sed -i \
    's/com.example.cc_xiaoji/com.ccxiaoji.feature.schedule/g' {} \;
```

### 步骤4.6：创建模块导航
```kotlin
// 在 feature/schedule/presentation/src/.../navigation/ScheduleNavigation.kt
package com.ccxiaoji.feature.schedule.presentation.navigation

import androidx.navigation.NavController
import androidx.navigation.NavGraphBuilder
import androidx.navigation.compose.composable
import androidx.navigation.navigation
import java.time.LocalDate

fun NavGraphBuilder.scheduleGraph(
    navController: NavController
) {
    navigation(
        startDestination = "schedule_calendar",
        route = "schedule_graph"
    ) {
        composable("schedule_calendar") {
            CalendarScreen(
                onNavigateToShiftManage = { navController.navigate("schedule_shift_manage") },
                onNavigateToScheduleEdit = { date ->
                    navController.navigate("schedule_edit/${date}")
                },
                onNavigateToSchedulePattern = { navController.navigate("schedule_pattern") },
                onNavigateToStatistics = { navController.navigate("schedule_statistics") },
                onNavigateToSettings = { navController.navigate("schedule_settings") }
            )
        }
        
        // 添加所有其他路由...
    }
}
```

### 验证检查点 ✅（严格验证）
- [ ] Presentation模块编译通过
- [ ] 所有ViewModel迁移完成（功能完整）
- [ ] CalendarView.kt已迁移（核心组件）
- [ ] 所有日期选择器组件已迁移
- [ ] 所有Screen文件包含完整功能（非占位符）
- [ ] UI枚举和辅助类已迁移
- [ ] 主题引用已更新
- [ ] 导航配置完整
- [ ] 验证每个Screen的行数与源文件相近

## 📝 第五阶段：集成和测试（第5天）

### 步骤5.1：实现模块API和导航
```kotlin
// 1. 在 feature/schedule/data/src/.../ScheduleApiImpl.kt
@Singleton
class ScheduleApiImpl @Inject constructor(
    private val repository: ScheduleRepository,
    private val navigator: ScheduleNavigator
) : ScheduleApi {
    override suspend fun getTodaySchedule(): ScheduleInfo? {
        return repository.getScheduleByDate(LocalDate.now())
            .first()
            ?.let { schedule ->
                ScheduleInfo(
                    date = schedule.date,
                    shiftName = schedule.shift.name,
                    startTime = schedule.shift.startTime.toString(),
                    endTime = schedule.shift.endTime.toString(),
                    color = schedule.shift.color.toString(),
                    isRestDay = false
                )
            }
    }
    
    // 实现其他API方法...
}

// 2. 在 app/src/.../navigation/ScheduleNavigatorImpl.kt
@Singleton
class ScheduleNavigatorImpl @Inject constructor() : ScheduleNavigator {
    private var navController: NavController? = null
    
    fun setNavController(navController: NavController) {
        this.navController = navController
    }
    
    override fun navigateToScheduleHome() {
        navController?.navigate("schedule_calendar")
    }
    
    // 实现其他导航方法...
}
```

### 步骤5.2：更新主项目集成点
```kotlin
// 1. 在 MainActivity
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    @Inject lateinit var scheduleNavigator: ScheduleNavigatorImpl
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            val navController = rememberNavController()
            
            // 设置导航器
            scheduleNavigator.setNavController(navController)
            
            CcXiaojiTheme {
                // 主导航
            }
        }
    }
}

// 2. 在 NavGraph.kt 添加排班模块
NavHost(...) {
    // 其他路由
    scheduleGraph(navController)
}

// 3. 在 HomeScreen 添加排班卡片
ScheduleModuleCard(
    todaySchedule = todaySchedule,
    onNavigateToSchedule = { navController.navigate("schedule_graph") }
)
```

### 步骤5.3：迁移资源文件
```bash
# 1. 复制必要的资源文件
cp /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/main/res/xml/file_paths.xml \
   app/src/main/res/xml/

# 2. 合并字符串资源
# 将排班模块的strings.xml内容添加到主项目

# 3. 确认FileProvider配置
# 在主项目AndroidManifest.xml中确认FileProvider已配置
```

### 步骤5.4：功能验证测试

创建功能验证清单：
```markdown
## 排班模块功能验证清单

### 1. 日历视图
- [ ] 月度日历正确显示
- [ ] 排班标记正确显示
- [ ] 左右滑动切换月份（150像素阈值）
- [ ] 点击年月快速跳转
- [ ] 今天按钮功能
- [ ] 视图模式切换（舒适/紧凑）
- [ ] 长按触发快速班次选择

### 2. 班次管理
- [ ] 班次列表显示
- [ ] 新增班次（包含颜色选择）
- [ ] 编辑班次
- [ ] 删除班次
- [ ] 班次激活/停用

### 3. 排班编辑
- [ ] 单日排班选择
- [ ] 显示当前排班
- [ ] 修改排班
- [ ] 删除排班

### 4. 批量排班
- [ ] 单次排班模式
- [ ] 循环排班（2-365天）
- [ ] 轮班模式
- [ ] 自定义模式
- [ ] 日期范围选择

### 5. 统计分析
- [ ] 时间范围选择
- [ ] 工时统计显示
- [ ] 班次分布图表
- [ ] 导出功能入口

### 6. 数据导出
- [ ] CSV格式导出
- [ ] JSON格式导出
- [ ] 统计报表导出
- [ ] 文件分享功能
- [ ] 导出历史记录

### 7. 设置功能
- [ ] 通知设置
- [ ] 提醒时间设置
- [ ] 周起始日设置
- [ ] 数据备份/恢复
- [ ] 深色模式切换
- [ ] 关于页面

### 8. 通知功能
- [ ] 排班提醒通知
- [ ] 通知权限请求
- [ ] 自定义提醒时间
```

### 验证检查点 ✅
- [ ] 整个项目编译通过
- [ ] 排班模块可以正常访问
- [ ] 所有功能验证清单通过
- [ ] 性能无明显下降
- [ ] 无内存泄漏
- [ ] UI体验与源项目一致

## 🔧 常见问题解决（增强版）

### 1. 编译错误处理
```bash
# 分模块编译查找问题
./gradlew :feature:schedule:api:compileDebugKotlin
./gradlew :feature:schedule:domain:compileDebugKotlin
./gradlew :feature:schedule:data:compileDebugKotlin
./gradlew :feature:schedule:presentation:compileDebugKotlin

# 查看详细错误
./gradlew :feature:schedule:compileDebugKotlin --stacktrace

# 清理并重新编译
./gradlew clean
./gradlew :feature:schedule:compileDebugKotlin
```

### 2. 依赖版本冲突
```kotlin
// 在根项目build.gradle.kts中统一版本
buildscript {
    extra.apply {
        set("compose_version", "1.5.4")
        set("hilt_version", "2.48.1")
    }
}
```

### 3. 资源冲突解决
```xml
<!-- 如果资源名称冲突，使用命名空间前缀 -->
<string name="schedule_app_name">排班管理</string>
<color name="schedule_primary">#FF6200EE</color>
```

### 4. 权限兼容性
```kotlin
// Android 13+通知权限处理
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
    if (ContextCompat.checkSelfPermission(
        context,
        Manifest.permission.POST_NOTIFICATIONS
    ) != PackageManager.PERMISSION_GRANTED) {
        // 请求权限
    }
}
```

## 📋 迁移后验证工作

### 1. 单元测试迁移
```bash
# 复制测试文件
cp -r /mnt/d/kotlin/Cc_xiaoji_paiban/app/src/test/java/com/example/cc_xiaoji/* \
   feature/schedule/src/test/kotlin/com/ccxiaoji/feature/schedule/

# 运行测试
./gradlew :feature:schedule:test
```

### 2. 性能基准测试
- 应用启动时间对比
- 内存使用对比
- 页面加载时间对比
- 数据库查询性能对比

### 3. 回归测试
使用功能验证清单进行完整的回归测试

## ⏮️ 回滚方案（详细版）

### 识别迁移失败的标志
1. 核心功能无法正常工作
2. 性能严重下降（>30%）
3. 频繁崩溃或ANR
4. 数据丢失或损坏

### 回滚步骤
```bash
# 1. 保存当前工作和错误日志
git add -A
git commit -m "保存迁移失败状态用于分析"
git tag migration-failed-v2

# 2. 创建问题报告
echo "迁移失败原因：" > migration-failure-report.md
echo "错误日志：" >> migration-failure-report.md
# 添加具体错误信息

# 3. 回到迁移前状态
git checkout main

# 4. 如果需要部分保留
git cherry-pick <有用的提交>

# 5. 重新评估迁移策略
# - 考虑分阶段迁移
# - 识别问题根源
# - 制定新的迁移计划
```

## 📝 迁移完成标志

迁移成功的标准：
1. ✅ 所有模块编译通过（无警告）
2. ✅ 功能验证清单100%通过
3. ✅ 单元测试通过率>80%
4. ✅ 性能无明显下降（<10%）
5. ✅ 无新增崩溃或ANR
6. ✅ 代码审查通过
7. ✅ 用户体验一致性验证通过

## 🎯 后续优化建议

1. **性能优化**
   - 实施懒加载策略
   - 优化数据库查询
   - 减少不必要的重组

2. **代码质量**
   - 添加更多单元测试
   - 实施代码规范检查
   - 添加性能监控

3. **用户体验**
   - 收集用户反馈
   - A/B测试新功能
   - 持续改进UI/UX

---

**文档版本**：2.0
**最后更新**：2025-06-13
**更新内容**：修复了v1.0中所有缺失内容，提供完整可执行的迁移指南