# 记账模块UI布局优化Demo开发规范

> 📅 创建日期：2025-09-05  
> 🎯 目标：统一记账模块Demo的UI风格，确保所有页面具有一致的视觉体验  
> 📍 位置：`feature/ledger/src/main/kotlin/.../demo/unified/`

## 一、项目背景

### 1.1 现状分析
- **已完成**：交易列表和添加交易页面已优化（OptimizedTransactionListPage、OptimizedAddTransactionPage）
- **待优化**：账户、分类、统计、设置等页面仍使用基础实现
- **核心问题**：页面间视觉风格不统一，缺少一致的交互体验

### 1.2 设计目标
- 建立统一的视觉语言和交互模式
- 支持双风格切换（BALANCED平衡风格 / HIERARCHICAL层次风格）
- 提供流畅的动画过渡效果
- 确保所有页面遵循相同的设计规范

## 二、核心设计原则

### 2.1 设计理念
- **一致性**：所有页面使用相同的设计语言
- **层次感**：通过间距、颜色、大小建立视觉层次
- **响应性**：及时的视觉反馈和状态变化
- **简洁性**：减少视觉噪音，突出核心功能

### 2.2 风格系统
复用现有领域模型，避免重复定义：
```kotlin
// 引用自：feature/ledger/src/.../domain/model/LedgerUIPreferences.kt:21
enum class LedgerUIStyle {
    BALANCED,      // 平衡风格：丰富的视觉元素、渐变背景、emoji图标
    HIERARCHICAL   // 层次风格：极简设计、纯色背景、线条图标
}
```

## 三、视觉规范

### 3.1 颜色系统

引用统一的设计令牌，避免双处维护：
```kotlin
// 引用自：core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt
object BrandColors {
    val Ledger = Color(0xFF66BB6A)     // 主色-柔和绿
    val Primary = Color(0xFF4A90E2)    // 主题蓝
    val Secondary = Color(0xFF9C27B0)  // 辅助紫
    
    // 语义色
    val Success = Color(0xFF66BB6A)    // 成功/收入
    val Error = Color(0xFFEF5350)      // 错误/支出
    val Warning = Color(0xFFFFA726)    // 警告
    val Info = Color(0xFF42A5F5)       // 信息
}
```

#### 使用规则
- **收入相关**：始终使用 Success 绿色
- **支出相关**：始终使用 Error 红色
- **主要操作**：使用 Ledger 品牌色
- **次要信息**：使用 onSurfaceVariant 灰色

### 3.2 间距系统
```kotlin
// 引用自：core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt
object DesignTokens.Spacing {
    val xs = 4.dp      // 极小间距
    val small = 8.dp   // 小间距
    val medium = 16.dp // 中等间距（标准）
    val large = 24.dp  // 大间距
    val xl = 32.dp     // 特大间距
}
```

#### 使用规则
- **页面边距**：`DesignTokens.Spacing.medium`
- **卡片内边距**：`DesignTokens.Spacing.medium`
- **列表项间距**：`DesignTokens.Spacing.small`
- **组件内部间距**：`DesignTokens.Spacing.small` 或 `xs`

### 3.3 圆角系统
```kotlin
// 引用自：core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt
object DesignTokens.BorderRadius {
    val small = 4.dp   // 小圆角（按钮、芯片）
    val medium = 8.dp  // 中圆角（卡片、输入框）
    val large = 12.dp  // 大圆角（底部弹窗、特殊卡片）
    val xl = 16.dp     // 特大圆角（全屏弹窗）
}
```

### 3.4 阴影系统
```kotlin
// 引用自：core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt
object DesignTokens.Elevation {
    val flat = 0.dp    // 扁平（无阴影）
    val low = 1.dp     // 低阴影（卡片）
    val medium = 2.dp  // 中阴影（浮动元素）
    val high = 4.dp    // 高阴影（弹窗、FAB）
}
```

## 四、组件规范

### 4.1 必须使用的统一组件

#### 数据概览栏 - UnifiedOverviewBar
```kotlin
@Composable
fun UnifiedOverviewBar(
    primaryValue: String,      // 主要数值
    primaryLabel: String,      // 主要标签
    secondaryItems: List<Pair<String, String>>, // 次要指标
    accentColor: Color,        // 强调色
    modifier: Modifier = Modifier
)
```
**使用场景**：所有页面顶部的数据展示

#### 操作栏 - UnifiedActionBar
```kotlin
@Composable
fun UnifiedActionBar(
    filterOptions: List<FilterOption>?,
    primaryAction: ActionConfig?,
    secondaryActions: List<ActionConfig>,
    modifier: Modifier = Modifier
)
```
**使用场景**：筛选和快捷操作

#### 列表项 - UnifiedListItem
```kotlin
@Composable
fun UnifiedListItem(
    title: String,
    subtitle: String? = null,
    leadingContent: @Composable (() -> Unit)? = null,
    trailingContent: @Composable (() -> Unit)? = null,
    onClick: (() -> Unit)? = null
)
```
**使用场景**：所有列表展示

#### 空状态 - UnifiedEmptyState
```kotlin
@Composable
fun UnifiedEmptyState(
    icon: ImageVector,
    title: String,
    message: String,
    actionLabel: String? = null,
    onAction: (() -> Unit)? = null
)
```
**使用场景**：无数据时的展示

### 4.2 风格化组件工厂
```kotlin
// 所有支持风格切换的组件都通过工厂创建
StyleableComponentFactory.TransactionItem(
    transaction = transaction,
    style = currentStyle,
    // ...
)
```

## 五、页面结构规范

### 5.1 标准页面结构
```kotlin
@Composable
fun StandardPage() {
    Column(modifier = Modifier.fillMaxSize()) {
        // 1. 数据概览区（必选）
        UnifiedOverviewBar(...)
        
        // 2. 筛选/Tab区（可选）
        FilterSection(...)
        
        // 3. 操作栏（可选）
        UnifiedActionBar(...)
        
        // 4. 内容区（必选）
        ContentArea(...)
    }
    
    // 5. FAB悬浮按钮（可选）
    Box {
        FloatingActionButton(...)
    }
}
```

### 5.2 页面间距规范
- **顶部概览栏**：上边距 medium，下边距 xs
- **筛选区**：水平边距 medium，垂直边距 small
- **内容区**：contentPadding = medium
- **FAB位置**：右下角，边距 medium，底部边距 large

## 六、动画规范

### 6.1 动效令牌化系统（建议新增到 DesignTokens）
```kotlin
// 建议添加到：core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt
object DesignTokens.Motion {
    // 动画时长
    object Duration {
        const val fast = 150       // 快速过渡（芯片选择、小元素）
        const val normal = 300     // 标准过渡（页面切换、列表项）
        const val slow = 500       // 缓慢过渡（大型动画、首次加载）
    }
    
    // 动画延迟
    object Delay {
        const val stagger = 50     // 列表项错开延迟
        const val cascade = 100    // 级联动画延迟
    }
    
    // 缓动函数（建议统一使用 tween 或 spring）
    fun standardEasing() = tween<Float>(Duration.normal)
    fun emphasizedEasing() = spring<Float>(dampingRatio = 0.8f, stiffness = 380f)
}
```

使用示例：
```kotlin
// 替代硬编码的 tween(300)
animationSpec = tween(DesignTokens.Motion.Duration.normal)

// 列表项错开动画
delayMillis = index * DesignTokens.Motion.Delay.stagger
```

### 6.2 动画类型
```kotlin
// 页面切换
fadeIn(tween(300)) + slideInVertically { it / 4 }

// 列表项进入（错开动画）
items.forEachIndexed { index, item ->
    AnimatedVisibility(
        enter = fadeIn(
            tween(300, delayMillis = index * 50)
        )
    )
}

// 数值变化
AnimatedContent(
    targetState = value,
    transitionSpec = {
        fadeIn(tween(300)) togetherWith fadeOut(tween(300))
    }
)
```

### 6.3 动画使用规则
- **列表项**：错开50ms进入，营造流畅感
- **数值变化**：使用AnimatedContent淡入淡出
- **Tab切换**：水平滑动过渡
- **展开/收起**：使用expandVertically/shrinkVertically

## 七、实施计划

### 7.1 第一阶段：基础规范落地（已完成）
- [x] 优化交易列表页面 (OptimizedTransactionListPage)
- [x] 优化添加交易页面 (OptimizedAddTransactionPage)
- [x] 创建统一组件库 (UnifiedLayoutComponents)

### 7.2 第二阶段：全面统一化（进行中）
- [ ] 优化账户资产页面 (AccountAssetPage, AccountManagePage, AssetAnalysisPage)
- [ ] 优化分类管理页面 (CategoryGridPage, CategoryEditPage)
- [ ] 优化统计分析页面 (StatisticsOverviewPage, ChartAnalysisPage, ReportExportPage)
- [ ] 优化设置相关页面 (LedgerSettingsPage, AutoLedgerPage, DataPortPage)

### 7.3 第三阶段：细节完善
- [ ] 添加加载状态动画
- [ ] 完善错误状态展示
- [ ] 实现全局风格切换
- [ ] 优化过渡动画细节

## 八、开发检查清单

### 每个页面必须检查：
- [ ] 使用 UnifiedOverviewBar 作为顶部数据展示
- [ ] 遵循标准页面结构
- [ ] 使用 DesignTokens 中定义的颜色和间距
- [ ] 实现空状态展示
- [ ] 添加适当的动画效果
- [ ] 支持风格切换（如适用）
- [ ] FAB按钮位置统一（右下角）
- [ ] 列表使用 UnifiedListItem 或 StyleableTransactionItem
- [ ] 卡片使用统一的圆角和阴影

### 代码规范：
- [ ] 组件拆分合理，避免过大的单一组件
- [ ] 使用remember和mutableStateOf管理状态
- [ ] 避免硬编码颜色值，使用DesignTokens
- [ ] 添加适当的Modifier参数以支持自定义

## 九、验收标准

### 9.1 页面改造验收清单
每个优化后的页面必须满足以下验收点：

#### 基础要求
- [ ] **组件使用**：使用统一组件（UnifiedOverviewBar、UnifiedListItem等）
- [ ] **布局一致性**：遵循标准页面结构（概览→筛选→内容→FAB）
- [ ] **动效达标**：所有动画使用Motion令牌，时长符合规范
- [ ] **风格支持**：正确实现BALANCED和HIERARCHICAL两种风格切换

#### 无障碍要求
- [ ] **TalkBack可读性**：所有交互元素设置contentDescription
- [ ] **颜色对比度**：文字与背景对比度≥4.5:1（小字）或3:1（大字）
- [ ] **触控目标**：可点击区域≥48dp×48dp
- [ ] **字号缩放**：支持系统字体缩放设置（0.85x-1.3x）

#### 国际化要求
- [ ] **文本国际化**：所有文本使用stringResource
- [ ] **货币格式化**：使用本地化货币格式（¥/$等）
- [ ] **日期时间**：根据locale显示适当格式
- [ ] **RTL支持**：布局支持从右到左语言（阿拉伯语等）

#### 性能要求
- [ ] **重组优化**：合理使用remember避免不必要的重组
- [ ] **列表性能**：大列表使用LazyColumn/LazyGrid
- [ ] **图片优化**：使用适当的图片加载策略
- [ ] **启动时间**：页面首次渲染<500ms

### 9.2 性能测试方案
```kotlin
// 建议使用 Macrobenchmark 进行性能测试
@Test
fun measurePageStartup() {
    benchmarkRule.measureRepeated(
        packageName = "com.ccxiaoji.app",
        metrics = listOf(StartupTimingMetric(), FrameTimingMetric()),
        startupMode = StartupMode.COLD,
        iterations = 5
    ) {
        startActivityAndWait()
        // 测试页面加载性能
    }
}
```

## 十、示例代码模板

### 10.1 标准页面模板
```kotlin
@Composable
fun OptimizedXxxPage(navController: NavController) {
    var currentStyle by remember { mutableStateOf(LedgerUIStyle.BALANCED) }
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.background)
    ) {
        // 数据概览
        UnifiedOverviewBar(
            primaryValue = "主要数值",
            primaryLabel = "标签",
            secondaryItems = listOf(
                "次要1" to "值1",
                "次要2" to "值2"
            ),
            accentColor = DesignTokens.BrandColors.Ledger
        )
        
        // 内容区
        LazyColumn(
            modifier = Modifier.fillMaxSize(),
            contentPadding = PaddingValues(DesignTokens.Spacing.medium),
            verticalArrangement = Arrangement.spacedBy(DesignTokens.Spacing.small)
        ) {
            // 内容实现
        }
    }
}
```

### 10.2 列表项模板
```kotlin
@Composable
fun CustomListItem(
    item: ItemData,
    style: LedgerUIStyle,
    onClick: () -> Unit
) {
    UnifiedListItem(
        title = item.title,
        subtitle = item.subtitle,
        leadingContent = {
            Icon(
                item.icon,
                contentDescription = null,
                tint = DesignTokens.BrandColors.Ledger
            )
        },
        trailingContent = {
            Text(
                text = item.value,
                color = if (item.isPositive) 
                    DesignTokens.BrandColors.Success 
                else 
                    DesignTokens.BrandColors.Error
            )
        },
        onClick = onClick
    )
}
```

## 十一、注意事项

1. **保持一致性**：所有页面必须使用相同的设计语言
2. **避免过度设计**：保持简洁，不要添加不必要的装饰
3. **性能优化**：合理使用remember，避免不必要的重组
4. **可访问性**：确保所有交互元素有合适的contentDescription
5. **响应式设计**：考虑不同屏幕尺寸的适配

## 十二、现有实现参考链接

为方便开发者快速定位相关代码，以下是关键实现文件的位置：

### 核心设计系统
- **设计令牌定义**：`core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt`
- **Material主题配置**：`core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/Theme.kt`

### Demo导航与入口
- **导航图注册**：`app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavGraph.kt:875`
- **侧边栏入口**（Debug Only）：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/component/ledger/LedgerDrawerContent.kt:136`

### 统一组件实现
- **布局组件**：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/screen/demo/unified/components/UnifiedLayoutComponents.kt`
- **通用组件**：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/screen/demo/unified/UnifiedCommonComponents.kt`
- **风格化工厂**：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/component/StyleableComponentFactory.kt`

### 领域模型
- **UI偏好设置**：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/domain/model/LedgerUIPreferences.kt`
- **风格枚举**：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/domain/model/LedgerUIStyle.kt`

### 已优化页面参考
- **交易列表**：`feature/ledger/src/.../demo/unified/pages/transaction/OptimizedTransactionListPage.kt`
- **添加交易**：`feature/ledger/src/.../demo/unified/pages/transaction/OptimizedAddTransactionPage.kt`

### 生产代码参考
- **实际记账首页**：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/screen/ledger/LedgerScreen.kt`
- **风格化组件示例**：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/component/StyleableTransactionItem.kt`

---

## 更新日志

- 2025-09-05：初始版本，制定统一设计规范
- 2025-09-05：根据GPT-5点评优化：
  - 改为引用现有DesignTokens，避免重复定义
  - 新增动效令牌化系统（Motion）
  - 添加完整的验收标准（基础、无障碍、国际化、性能）
  - 补充现有实现参考链接清单
  - 明确Demo仅Debug可见的发布策略
---

## 评审点评（Codex）

### 总体评价
- 目标清晰：从设计原则 → 设计令牌 → 统一组件 → 页面骨架 → 动效规范 → 分阶段推进，闭环完整，易落地。
- 与实现衔接好：已存在 Demo 路由与统一组件，能边写边验；阶段 TODO 明确。

### 与现有代码一致性
- 路由：`UnifiedLedgerStyleDemoRoute` 已在导航中注册，便于直达验收（`app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavGraph.kt:875`）。
- 入口可见性：记账侧边栏“统一风格 Demo”仅 Debug 显示（`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/component/ledger/LedgerDrawerContent.kt:136`）。
- 统一组件：`UnifiedOverviewBar/UnifiedActionBar/UnifiedListItem/UnifiedEmptyState` 已实现（`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/screen/demo/unified/components/UnifiedLayoutComponents.kt:31`）。
- 风格配置：请复用 Domain 枚举 `LedgerUIStyle` 与偏好模型（`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/domain/model/LedgerUIPreferences.kt:21`），避免文档重复定义。

### 改进建议
- 令牌来源统一：文档中的颜色/间距/圆角/海拔建议引用 `DesignTokens` 名称而非写死数值，避免双处维护（`core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt`）。
- 动效令牌化：新增 `DesignTokens.Motion`（如 `fast/normal/slow`）替代 `tween(300)` 等魔法数，并在统一组件与 Demo 中落地。
- 发布策略：在文档“发布策略”明确 Demo 仅 Debug 可见与入口位置，后续如有灰度/内测，补充开关策略。
- 验收标准：为各改造页面列出“组件使用 + 布局一致性 + 动效达标 + 无障碍 + 性能”验收点；可附 Macrobenchmark/JankStats 方案。
- 无障碍/国际化：补充 TalkBack 可读性、颜色对比度、触达面积、字号缩放、货币/日期本地化等约束。

### 可执行优化（建议纳入下一步）
- 在文档末附“现有实现链接”清单，便于新成员跳转：
  - `app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavGraph.kt:875`
  - `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/component/ledger/LedgerDrawerContent.kt:136`
  - `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/screen/demo/unified/components/UnifiedLayoutComponents.kt:31`
  - `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/domain/model/LedgerUIPreferences.kt:21`
  - `core/ui/src/main/kotlin/com/ccxiaoji/ui/theme/DesignTokens.kt:1`

### 小问题提示
- 编码显示：在部分终端（如 PowerShell）中文会显示乱码，建议统一使用 UTF-8 并在 README 备注“建议在 IDE 中查看”。
