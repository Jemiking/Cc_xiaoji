# 2025-08-31｜自动化记账｜实施记录

## 背景与目标
- 背景：在既有记账（Ledger）功能基础上，引入“自动化记账”，通过系统通知监听与解析，自动识别支付结果并落账，降低手动记账成本。
- 目标：实现“半自动优先、全自动可控、可回退”的自动记账闭环，包括通知监听→解析→去重→推荐/决策→记账→通知交互→调试与追踪。
  - 更新（2025-09-04）：按甲方指示，“全自动”改为“软关闭”（保留实现但默认不生效）；阶段聚焦“半自动”体验与稳定性。
- 范围：仅涉及 `feature/ledger` 与 `shared/notification` 纵向能力，遵循依赖方向 `app → feature → shared → core`，不引入跨 Feature 横向依赖。

## 方案对比
1) 通知监听（NLS）+ 解析规则（推荐）
   - 优点：实时、无需 Root；覆盖微信/支付宝/云闪付/银行 App；与现有 UI 和数据流整合顺畅。
   - 缺点：依赖各 App 通知文案与结构，易受版本与 ROM 差异影响；需处理权限与前后台限制。

2) 短信读取解析
   - 优点：适配部分银行短信通知（无 App 场景）；实现门槛较低。
   - 缺点：权限敏感、部分系统限制读取；短信格式差异大；延迟可能高于通知。

3) Webhook/邮件中转（长线）
   - 优点：可做跨设备与稳定输入源；可由云函数做统一解析与风控。
   - 缺点：需额外服务与配置，用户门槛高；离线/网络失败路径复杂。

推荐与理由：优先落地方案1（NLS 监听 + 本地解析 + 去重 + 半自动/全自动决策），在不破坏用户体验与安全边界前提下，逐步纳入微信/银联/银行 App；方案2 作为补充渠道，方案3 作为长线能力预研。

## 当前进展（本次增量的关键能力）
- 通知监听与事件总线
  - `shared/notification/data/PaymentNotificationListener`：继承 `NotificationListenerService`，监听系统通知并发射 `RawNotificationEvent` 到仓库流 `NotificationEventRepository.events`。
  - 支持群组摘要过滤、正文提取、运行时开关（透传未匹配日志）。

- 管道编排与策略决策（已两键化）
  - `feature/ledger/domain/usecase/AutoLedgerManager`：
    - 订阅通知事件→解析→去重→推荐→落账→通知交互→记录调试。
    - 半自动：统一为“通知横幅→点击进入添加页”；移除行内确认与一键分支；商户缺失不预填，账户/分类给候选。
    - 全自动：软关闭（仅保留撤销/编辑链路以兼容历史调用）。
    - 设置精简：总开关保留；模式选择隐藏为“当前模式：半自动（全自动软关闭）”。

- 通知解析与去重
  - `feature/ledger/domain/parser/NotificationParserFactory` 与 `AlipayNotificationParser`：按包名选择解析器，产出标准化 `PaymentNotification`。
  - `feature/ledger/data/manager/DeduplicationManager`：
    - 双阶段去重：原始文本文本短窗 + 解析后指纹（金额/商户/时间）存档。
    - 支持电商应用黑名单与关键字屏蔽、群组摘要跳过、简单频控。

- 账户/分类推荐与记账
  - `AccountCategoryRecommender`（已集成调用）：结合“上一次/默认/固定账本”生成推荐；
  - `AddTransactionUseCase`：根据推荐或默认项创建交易。

- 通知交互与回退（已更新）
  - `feature/ledger/domain/service/AutoLedgerNotificationManager`：
    - 全自动成功通知；半自动仅保留“点击主体→添加交易页”的极简交互；移除“一键记账/行内确认/快速保存”。
    - `AutoLedgerBroadcastReceiver` 仅保留 ACTION_UNDO/ACTION_EDIT；编辑通过 DeepLink `ccxiaoji://app/edit_transaction/{id}` 进入编辑模式。
    - 添加页 DeepLink：`ccxiaoji://app/add_transaction?...`（金额/方向/商户/账户/分类/备注 预填）；导航与 Manifest 已对齐。

- 调试与观测
  - `AutoLedgerDebugRepository`（内存实现，可扩展持久化）+ `RecordAutoLedgerDebugUseCase`：
    - 记录解析状态、置信度、耗时、重复跳过、异常等；支持导出 JSON（可脱敏）。
  - `presentation/screen/debug/AutoLedgerDebugScreen`：
    - 显示统计（成功/失败/重复/24h/平均耗时/平均置信度）、诊断（监听透传/跳过原因），支持刷新、导出与敏感信息开关。

## 配置项与默认值（已精简为两键）
- 全局开关：`auto_ledger_global_enabled`（默认 false）。
- 对外键：
  - `auto_ledger_global_enabled`（默认 false）
  - `auto_ledger_mode`（`SEMI`/`FULL`）
- 内部常量：阈值 0.85、最小金额 100 分、去重 20s、撤销 30s、方向过滤（退款/转账/未知不自动）。

## 涉及代码位置（摘）
- 监听：`shared/notification/data/PaymentNotificationListener.kt`
- 管理器：`feature/ledger/domain/usecase/AutoLedgerManager.kt`
  - 两键化：仅订阅 `auto_ledger_mode` 控制自动创建，其余用内部常量。
- 去重：`feature/ledger/data/manager/DeduplicationManager.kt`
- 解析：`feature/ledger/domain/parser/NotificationParserFactory.kt`、`AlipayNotificationParser`
- 通知交互：`feature/ledger/domain/service/AutoLedgerNotificationManager.kt`、`AutoLedgerBroadcastReceiver.kt`
- 调试：`feature/ledger/data/repository/AutoLedgerDebugRepositoryImpl.kt`、`presentation/screen/debug/AutoLedgerDebugScreen.kt`
- DI：`feature/ledger/di/LedgerModule.kt`

## 已完成与验收标准（最新）
- 已完成
  - NLS 监听与事件流打通；解析器与去重；半自动统一为“通知→添加页”；全自动具备撤销/编辑；两键化设置落地；调试面板与导出。
- 验收标准
  - 开启通知使用权与全局开关后：
    - 解析记录可见（置信度/耗时）；
    - 满足阈值→自动创建并推送“已自动记账”通知；不满足→半自动提示并跳转添加页；
    - 重复短窗跳过；撤销/编辑可用；
    - 调试面板统计与导出可用，脱敏生效。

## UI 提示（新增）
- Ledger 设置页“自动记账设置”入口新增说明：
  - “如未弹横幅，请检查通知权限与渠道设置”。

## 运行与测试（更新：半自动为主，全自动软关闭）
- 环境准备
  - Android Studio 2023.1.1+、JDK 17、AGP 8.2.1、Target 34/Min 26。
  - 设备上授予“通知使用权”（系统设置→通知→通知使用权→本应用）。

- 构建安装
  - Debug 构建：`./gradlew :app:installDebug`

- 手动验证（建议顺序）
  - 在应用设置页开启“自动化记账”总开关（当前仅半自动，模式选择已隐藏）。
  - 触发微信/支付宝收/支通知（小额测试）；观察：
    - 调试面板出现解析记录，统计增长；
    - 半自动：弹出“记一笔”通知，点击进入添加页，金额/收支预填；商户缺失不预填；账户/分类有候选。
    - 全自动：不生效（软关闭）。

- 单元/集成测试（后续补充）
  - 单元：解析器规则、去重窗口、决策函数；
  - 集成：伪造 `RawNotificationEvent` 流并断言产物；
  - 命令：`./gradlew test`、`./gradlew connectedAndroidTest`。

## 风险与对策
- 权限与兼容：不同 ROM 的 NLS 管控差异大；提供“监听状态诊断”与“重绑请求”，失败回退半自动或手动。
- 误记账：默认关闭全自动；提供撤销入口与短窗撤销 Worker；低金额阈值与方向过滤（退款/转账不自动）。
- 隐私合规：调试导出支持脱敏；敏感信息仅本地存储；避免将原始正文持久化。
- 稳定性：解析异常/不支持类型均纳入统计；频控与短窗去重避免风暴。

## 后续计划
- 短期（T+1 周）
  - 微信解析器（收入/支出场景、红包/转账过滤）；
  - 账户/分类“来源优先级”完善与 UI 配置；
  - 调试记录落地到数据库，并提供分页与筛选；
  - 监听器设置页接入“无关键词透传/群组摘要透传”开关（已在调试面板展示统计）。

- 中期（T+1 月）
  - 银联/银行 App 解析器；
  - 短信渠道补充；
  - 规则管理（黑白名单/正则/映射）；
  - 云端模板同步（仅配置，不上传用户数据）。

## 下一轮衔接
- 详细迭代拆解与验收请参见：`doc/开发进度/20250901-自动化记账-下一轮迭代计划.md`。

## 关联提交 / 关键更新
- 2025-08-28 `开发自动记账-1`（`47642c5`）
- 2025-08-20 `记账簿优化未完成-1-准备实现自动记账功能`（`d4d7475`）
 - 2025-09-04 半自动完善（微信规则扩充/去重白名单/记忆细化/一键自检），全自动软关闭（设置页隐藏模式选择）。

## 回滚与禁用
- 用户级：关闭“自动化记账”全局开关或关闭通知使用权。
- 开发级：在 `AutoLedgerManager.start()` 前置返回或屏蔽事件订阅；关闭 `auto_ledger_autocreate_enabled` 退回半自动。

—— 本文档将随解析器扩展与 UI 配置完善持续更新 ——
