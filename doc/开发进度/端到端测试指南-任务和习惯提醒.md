# 端到端测试指南 - 任务和习惯提醒功能

**测试目标**：验证 Phase 2 实现的单条提醒功能是否正常工作

**前置条件**：
- ✅ 代码已编译通过
- ✅ APK 已安装到测试设备
- ✅ 应用已授予通知权限

**预计测试时间**：
- Task-006（任务提醒）：约 2 小时（含等待时间）
- Task-007（习惯提醒）：约 1 天（需跨天验证）

---

## 🛠️ 测试前准备

### 1. 编译并安装应用

```bash
# 步骤1：清理构建缓存
./gradlew clean

# 步骤2：编译 Debug APK
./gradlew assembleDebug

# 步骤3：安装到设备（确保设备已连接）
adb install -r app/build/outputs/apk/debug/app-debug.apk

# 或使用合并命令
./gradlew installDebug
```

**预期结果：**
- ✅ 编译成功，无错误
- ✅ APK 安装成功
- ✅ 应用可以正常启动

---

### 2. 授予必要权限

```bash
# 授予通知权限（Android 13+）
adb shell pm grant com.ccxiaoji.app android.permission.POST_NOTIFICATIONS

# 授予精确闹钟权限（可选，用于未来精确提醒）
adb shell pm grant com.ccxiaoji.app android.permission.SCHEDULE_EXACT_ALARM
```

**UI 操作验证：**
1. 打开应用 → 设置 → 通知设置
2. 确认"允许通知"开关已开启
3. 如提示权限未授予，点击"授予权限"

---

### 3. 安装测试工具

**Android Studio App Inspection**（推荐）
1. 打开 Android Studio
2. 连接设备并运行应用
3. 打开 `View → Tool Windows → App Inspection`
4. 选择 `WorkManager` 标签页

**或使用 ADB 命令**
```bash
# 查看 WorkManager 状态
adb shell dumpsys activity service WorkManagerService
```

---

## ✅ Task-006: 任务提醒端到端测试

### 测试场景 1：创建任务并验证 Work 存在

**测试步骤：**

1. **创建测试任务**
   - 打开应用 → 待办事项 → 点击"+"按钮
   - 输入任务标题：`测试任务提醒功能`
   - 设置截止时间：当前时间 + 35 分钟
   - **关键步骤**：展开"提醒设置"区域
   - 选择提醒模式：
     - ☐ 使用全局配置（默认30分钟）
     - ☑ 自定义提醒（选择"30分钟"）
     - ☐ 关闭提醒
   - 点击"保存"

2. **验证 WorkManager 中的 Work**
   ```bash
   # 方法1：使用 adb 命令查看
   adb shell dumpsys activity service WorkManagerService | grep "task_reminder"

   # 方法2：使用 Android Studio
   # App Inspection → WorkManager → 查找 "task_reminder_[taskId]"
   ```

**预期结果：**
- ✅ WorkManager 中存在名为 `task_reminder_[taskId]` 的 Work
- ✅ Work 状态为 `ENQUEUED`
- ✅ Work 的初始延迟约为 5 分钟（35 - 30）
- ✅ Work 的 Tag 包含 `task_reminder` 和 `[taskId]`

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| Work 存在 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 初始延迟正确 | ~5分钟 |  | ☐ 通过 / ☐ 未通过 |  |
| Tag 正确 | task_reminder |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 2：验证提前 30 分钟收到通知

**测试步骤：**

1. **等待提醒触发**
   - 等待约 5-15 分钟（WorkManager 允许 ±10 分钟误差）
   - 保持设备屏幕开启或定期唤醒

2. **检查通知**
   - 下拉通知栏
   - 查找标题为"任务提醒"的通知

**预期结果：**
- ✅ 收到通知（允许 ±10 分钟误差）
- ✅ 通知标题：`任务提醒`
- ✅ 通知内容包含：
  - 任务标题：`测试任务提醒功能`
  - 到期时间：`[截止时间]`
- ✅ 通知渠道：`任务提醒`
- ✅ 通知优先级：默认或更高

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| 收到通知 | ✅ |  | ☐ 通过 / ☐ 未通过 | 记录实际触发时间 |
| 通知标题正确 | "任务提醒" |  | ☐ 通过 / ☐ 未通过 |  |
| 通知内容正确 | 包含任务信息 |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 3：点击通知跳转到任务详情

**测试步骤：**

1. **点击通知**
   - 在通知栏点击"任务提醒"通知

2. **验证跳转**
   - 应用应该打开到待办事项页面
   - 任务列表中应高亮显示对应任务

**预期结果：**
- ✅ 应用自动打开
- ✅ 跳转到待办事项页面
- ✅ 可以看到刚才创建的任务

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| 应用打开 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 跳转正确 | 待办事项页面 |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 4：关闭开关后 Work 被取消

**测试步骤：**

1. **再次创建任务**
   - 创建新任务：`测试关闭提醒`
   - 截止时间：当前时间 + 60 分钟
   - 提醒设置：使用全局配置
   - 保存

2. **验证 Work 存在**
   ```bash
   adb shell dumpsys activity service WorkManagerService | grep "task_reminder"
   ```

3. **关闭全局提醒**
   - 打开应用 → 设置 → 通知设置
   - 关闭"任务到期提醒"开关

4. **验证 Work 被取消**
   ```bash
   adb shell dumpsys activity service WorkManagerService | grep "task_reminder"
   ```

**预期结果：**
- ✅ 关闭开关前：存在 `task_reminder_*` Work
- ✅ 关闭开关后：所有 `task_reminder_*` Work 被取消
- ✅ Logcat 显示：`Cancelling all task reminders`

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| Work 初始存在 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| Work 被取消 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 日志正确 | 显示取消日志 |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 5：验证 P0 修复（用户配置生效）

**测试目标：** 验证用户配置的"提前 N 分钟"是否生效

**测试步骤：**

1. **修改全局配置**
   - 打开应用 → 设置 → 通知设置
   - 开启"任务到期提醒"
   - 修改"提前提醒时间"为 **60 分钟**

2. **创建任务**
   - 创建任务：`测试60分钟提醒`
   - 截止时间：当前时间 + 65 分钟
   - 提醒设置：使用全局配置
   - 保存

3. **验证 Work 延迟时间**
   ```bash
   # 查看 Work 的初始延迟
   adb shell dumpsys activity service WorkManagerService | grep -A 10 "task_reminder"
   ```

**预期结果：**
- ✅ Work 的初始延迟约为 5 分钟（65 - 60）
- ✅ **不是** 35 分钟（65 - 30，硬编码情况）
- ✅ Logcat 显示：`reminderMinutes=60`

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| Work 延迟正确 | ~5分钟 |  | ☐ 通过 / ☐ 未通过 | 不是35分钟 |
| 日志显示60分钟 | reminderMinutes=60 |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 6：验证单条提醒优先级

**测试目标：** 验证单任务自定义提醒可以覆盖全局配置

**测试步骤：**

1. **设置全局配置**
   - 全局提醒：30 分钟

2. **创建自定义提醒任务**
   - 创建任务：`重要会议`
   - 截止时间：当前时间 + 125 分钟
   - 提醒设置：自定义提醒 → 选择"2小时"
   - 保存

3. **验证 Work 延迟时间**
   ```bash
   adb shell dumpsys activity service WorkManagerService | grep -A 10 "task_reminder"
   ```

**预期结果：**
- ✅ Work 的初始延迟约为 5 分钟（125 - 120）
- ✅ **不是** 95 分钟（125 - 30，使用全局配置的情况）
- ✅ Logcat 显示：`reminderMinutes=120`（单任务配置）

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| 使用单任务配置 | 2小时（120分钟） |  | ☐ 通过 / ☐ 未通过 |  |
| 未使用全局配置 | 不是30分钟 |  | ☐ 通过 / ☐ 未通过 |  |

---

## ✅ Task-007: 习惯提醒端到端测试

### 测试场景 1：首次提醒触发

**测试步骤：**

1. **设置提醒时间**
   - 打开应用 → 设置 → 通知设置
   - 开启"习惯打卡提醒"
   - 设置提醒时间为：**当前时间 + 5 分钟**（例如现在是 14:00，设置为 14:05）

2. **创建习惯**
   - 打开应用 → 习惯 → 点击"+"按钮
   - 输入习惯名称：`测试习惯提醒`
   - 提醒设置：使用全局配置
   - 保存

3. **等待提醒触发**
   - 等待约 5-15 分钟
   - 检查通知栏

**预期结果：**
- ✅ 收到通知（允许 ±10 分钟误差）
- ✅ 通知标题：`习惯提醒`
- ✅ 通知内容包含习惯名称：`测试习惯提醒`

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| 收到通知 | ✅ |  | ☐ 通过 / ☐ 未通过 | 记录实际触发时间 |
| 通知标题正确 | "习惯提醒" |  | ☐ 通过 / ☐ 未通过 |  |
| 通知内容正确 | 包含习惯名称 |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 2：点击通知跳转到习惯页面

**测试步骤：**

1. **点击通知**
   - 在通知栏点击"习惯提醒"通知

2. **验证跳转**
   - 应用应该打开到习惯打卡页面

**预期结果：**
- ✅ 应用自动打开
- ✅ 跳转到习惯页面
- ✅ 可以看到刚才创建的习惯

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| 应用打开 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 跳转正确 | 习惯页面 |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 3：次日重复提醒（需跨天验证）

**测试步骤：**

1. **首日设置**
   - 全局提醒时间：20:00
   - 创建习惯：`每日阅读`
   - 提醒设置：使用全局配置
   - 保存

2. **首日验证**
   - 当天 20:00 左右收到提醒

3. **次日验证**
   - 次日 20:00 左右再次收到提醒

**预期结果：**
- ✅ 首日 20:00 收到提醒
- ✅ 次日 20:00 再次收到提醒
- ✅ Work 为 `PeriodicWork`，间隔 1 天

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| 首日提醒 | ✅ |  | ☐ 通过 / ☐ 未通过 | 记录时间 |
| 次日提醒 | ✅ |  | ☐ 通过 / ☐ 未通过 | 记录时间 |
| Work 类型正确 | PeriodicWork |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 4：修改提醒时间后生效

**测试步骤：**

1. **修改全局时间**
   - 打开应用 → 设置 → 通知设置
   - 修改"习惯提醒时间"为新时间（例如从 20:00 改为 21:00）

2. **验证 Work 重新安排**
   ```bash
   adb shell dumpsys activity service WorkManagerService | grep "habit_reminder"
   ```

3. **次日验证**
   - 次日 21:00 收到提醒（新时间）
   - **不应该**在 20:00 收到提醒（旧时间）

**预期结果：**
- ✅ Work 被重新创建
- ✅ 新 Work 的初始延迟指向新时间
- ✅ 次日按新时间触发

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| Work 重新创建 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 新时间生效 | 21:00 |  | ☐ 通过 / ☐ 未通过 |  |
| 旧时间失效 | 20:00 不触发 |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 5：关闭开关停止提醒

**测试步骤：**

1. **关闭全局提醒**
   - 打开应用 → 设置 → 通知设置
   - 关闭"习惯打卡提醒"开关

2. **验证 Work 被取消**
   ```bash
   adb shell dumpsys activity service WorkManagerService | grep "habit_reminder"
   ```

3. **次日验证**
   - 次日原定时间不应收到提醒

**预期结果：**
- ✅ 所有 `habit_reminder_*` Work 被取消
- ✅ Logcat 显示：`Cancelling all habit reminders`
- ✅ 次日不再收到提醒

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| Work 被取消 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 日志正确 | 显示取消日志 |  | ☐ 通过 / ☐ 未通过 |  |
| 次日无提醒 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |

---

### 测试场景 6：单习惯自定义时间

**测试目标：** 验证单习惯可以设置不同于全局的提醒时间

**测试步骤：**

1. **设置全局时间**
   - 全局提醒时间：20:00

2. **创建自定义时间习惯**
   - 创建习惯：`晨跑`
   - 提醒设置：自定义时间 → 选择"07:00"
   - 保存

3. **创建另一个自定义时间习惯**
   - 创建习惯：`睡前阅读`
   - 提醒设置：自定义时间 → 选择"21:00"
   - 保存

4. **验证 Work**
   ```bash
   adb shell dumpsys activity service WorkManagerService | grep -A 20 "habit_reminder"
   ```

**预期结果：**
- ✅ 存在 3 个 habit_reminder Work
- ✅ `晨跑` 的 Work 初始延迟指向明天 07:00
- ✅ `睡前阅读` 的 Work 初始延迟指向今天 21:00
- ✅ 使用全局配置的习惯指向 20:00

**验收记录：**
| 检查项 | 预期 | 实际 | 通过/未通过 | 备注 |
|--------|------|------|------------|------|
| 晨跑 07:00 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 睡前阅读 21:00 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |
| 其他习惯 20:00 | ✅ |  | ☐ 通过 / ☐ 未通过 |  |

---

## 🐛 常见问题排查

### 问题1：收不到通知

**可能原因：**
1. 通知权限未授予
2. 系统省电模式限制 WorkManager
3. WorkManager Doze 优化

**解决方法：**
```bash
# 1. 检查权限
adb shell dumpsys package com.ccxiaoji.app | grep "POST_NOTIFICATIONS"

# 2. 禁用电池优化（仅测试）
adb shell dumpsys deviceidle whitelist +com.ccxiaoji.app

# 3. 强制触发 WorkManager（测试用）
adb shell am broadcast -a android.intent.action.TIME_SET
```

---

### 问题2：Work 未创建

**可能原因：**
1. Hilt 依赖注入失败
2. Repository 返回空数据
3. NotificationScheduler 抛出异常

**排查步骤：**
```bash
# 查看 Logcat
adb logcat -s CcXiaoJi:* NotificationSettings:*

# 期待看到的日志：
# - "Scheduling task reminder: taskId=..., reminderMinutes=..."
# - "Task reminder scheduled successfully: taskId=..."
```

---

### 问题3：Work 延迟时间不正确

**可能原因：**
1. P0 问题修复未生效（仍然硬编码 30 分钟）
2. DataStore 配置未保存
3. ViewModel 未正确读取配置

**排查步骤：**
```bash
# 查看 Logcat，确认 reminderMinutes 参数
adb logcat -s CcXiaoJi:* | grep "reminderMinutes"

# 期待看到：
# - "Scheduling task reminder: ..., reminderMinutes=60"（如果用户设置了60分钟）
# - 而不是：reminderMinutes=30（硬编码）
```

---

## 📋 测试总结

### Task-006 汇总

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 1. Work 存在 | ☐ 通过 / ☐ 未通过 |  |
| 2. 30分钟前收到通知 | ☐ 通过 / ☐ 未通过 |  |
| 3. 点击通知跳转 | ☐ 通过 / ☐ 未通过 |  |
| 4. 关闭开关取消 Work | ☐ 通过 / ☐ 未通过 |  |
| 5. P0 修复验证（60分钟） | ☐ 通过 / ☐ 未通过 |  |
| 6. 单条优先级验证 | ☐ 通过 / ☐ 未通过 |  |

### Task-007 汇总

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 1. 首次提醒触发 | ☐ 通过 / ☐ 未通过 |  |
| 2. 点击通知跳转 | ☐ 通过 / ☐ 未通过 |  |
| 3. 次日重复提醒 | ☐ 通过 / ☐ 未通过 |  |
| 4. 修改时间生效 | ☐ 通过 / ☐ 未通过 |  |
| 5. 关闭开关停止 | ☐ 通过 / ☐ 未通过 |  |
| 6. 单习惯自定义时间 | ☐ 通过 / ☐ 未通过 |  |

---

## 📝 测试报告模板

测试完成后，请填写以下信息更新到主文档：

```markdown
### 端到端测试报告（2025-10-XX）

**测试设备：** [设备型号] / Android [版本]
**测试人员：** [姓名]
**测试时间：** [开始时间] - [结束时间]

**Task-006 测试结果：**
- 场景1-6 通过率：X/6
- 发现问题：[列出问题]

**Task-007 测试结果：**
- 场景1-6 通过率：X/6
- 发现问题：[列出问题]

**总体结论：**
- ✅ 核心功能正常 / ❌ 存在阻塞性问题
- 建议：[后续改进建议]
```

---

**文档创建时间：** 2025-10-04
**适用版本：** Phase 2 (Database v22)
**维护者：** Claude AI
