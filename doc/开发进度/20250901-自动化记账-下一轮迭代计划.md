# 2025-09-01｜自动化记账｜下一轮迭代计划（执行版）

## 目标与范围（更新：聚焦半自动；全自动软关闭）
- 目标：在现有“半自动优先（无一键；全自动软关闭）”的闭环上，补齐微信解析、调试记录持久化、设置体验完善与测试体系，提升稳定性与可验收性。
- 范围：仅涉及 `shared/notification` 与 `feature/ledger`；严格遵守依赖方向 `app → feature → shared → core`；不新增跨 Feature 依赖。

### 状态小结（2025-09-04）
- 已实施：全自动“软关闭”，仅半自动生效；设置页隐藏“模式选择”，显示“当前模式：半自动”。
- 已优化：微信规则扩充、去重黑名单/支付白名单、细化“上次选择”记忆、一键自检入口。

## 方案对比（关键决策点）
1) 调试记录存储
   - Room（推荐）：结构化查询、分页与筛选易做、与现有数据库一致；引入表/DAO。缺点：需迁移与版本控制。
   - DataStore/JSON：实现快、适合小量。缺点：查询/筛选能力弱，不利于长线维护。
   - 推荐：Room，新增表 `auto_ledger_debug`，支持索引（时间/状态/来源）。

2) 微信通知解析
   - 纯关键词+正则（推荐起步）：快速覆盖主流文案（收/支/红包），易调试。缺点：对文案变动敏感。
   - 机器学习/模板云端下发：长线选项；本轮不做。

3) 默认账本策略
   - 继续沿用“固定账本优先，否则用户默认账本”；设置页保留固定账本开关与选择器。

## 任务拆解（严格顺序）
### Task-04｜微信解析器（M1-扩展）
- 实现项：
  - 新增 `WechatNotificationParser`（`feature/ledger/domain/parser/WechatNotificationParser.kt`）。
  - 在 `NotificationParserFactory` 注册：包名 `com.tencent.mm`。
  - 解析规则：
    - 收入：关键词“收款/入账/已入账/转入/红包”等；
    - 支出：关键词“支付/扣款/已支出/转出”等；
    - 过滤：红包拆分、零钱转入转出、转账（默认半自动）。
  - 产出 `PaymentNotification`：方向、金额（分）、商户（联系人/备注）、置信度、原文片段与时间。
- 验收：模拟/真机通知触发能在调试面板看到记录；半自动路径可用；重复通知短窗跳过。
- 代码落点：
  - `feature/ledger/domain/parser/WechatNotificationParser.kt`
  - `feature/ledger/domain/parser/NotificationParserFactory.kt`

### Task-05｜调试记录持久化与筛选（M2-可观测性）
- 实现项：
  - 新表：`auto_ledger_debug`
    - 字段建议：`id`（PK）、`status`、`source`、`direction`、`amountCents`、`merchant`、`confidence`、`processingTimeMs`、`isDuplicate`、`error`、`createdAt`。
    - 索引：`(createdAt DESC)`、`status`、`source`。
  - DAO/Repository：分页查询、按状态/时间/来源筛选、清理过期（30/60 天）。
  - UI：`AutoLedgerDebugScreen` 支持筛选与分页加载；导出仍支持脱敏。
- 验收：
  - 切到持久化实现后应用稳定；分页加载正常；导出数据与筛选条件一致。
- 代码落点：
  - `core/database`：Entity/Dao/Schema 升级（v9→v10）。
  - `feature/ledger/data/repository/AutoLedgerDebugRepositoryImpl` 改为 Room 实现，保留接口不变。
  - `feature/ledger/presentation/screen/debug/AutoLedgerDebugScreen` 增加筛选控件。

### Task-06｜设置体验完善（M2-易用性）
- 实现项：
  - Auto 设置页：
    - “来源优先级”展示与说明（上一次/固定）；
    - “最小金额（分）”可输入/调整（默认 100）；
    - （软关闭）自动创建阈值滑杆（暂不展示；内部常量保留）；
    - 监听层开关（无关键词透传/群组摘要透传/未匹配日志）分组与说明链接。
  - 开发者设置页：高风险项带确认弹窗（已具备，优化文案）。
- 验收：设置项读写正确；文案清晰；缺项有降级提示。
- 代码落点：
  - `feature/ledger/presentation/screen/settings/AutoLedgerSettingsScreen.kt`
  - `feature/ledger/presentation/screen/settings/AutoLedgerDeveloperSettingsScreen.kt`
  - `feature/ledger/presentation/viewmodel/AutoLedgerSettingsViewModel.kt`

### Task-07｜测试补齐（M3-稳定性）
- 单元测试：
  - 解析器：支付宝/微信样例用例（收/支/红包/转账/退款/群组摘要）。
  - 去重：窗口去重/事件指纹/频控。
  - 决策：阈值/最小金额/方向屏蔽。
- 仪器/集成：
  - 伪造 `RawNotificationEvent` 流；验证半自动/一键路径；撤销链路。
- 命令：`./gradlew test`、`./gradlew connectedAndroidTest`。
- 代码落点：
  - `feature/ledger/src/test/...`、`shared/notification/src/test/...`、`feature/ledger/src/androidTest/...`

### Task-08（可选）｜银联/银行解析器（M3-扩展）
- 包名：`com.unionpay` 等；
- 先覆盖“到账/扣款/刷卡”主流文案；方向不明降级半自动。

## 里程碑与时间
- M1（2 天）：Task-04 完成并联调；
- M2（3 天）：Task-05/06 完成并联调；
- M3（2 天）：Task-07 基础覆盖；Task-08 视进度切入。

## 验收标准（汇总）
- 微信解析生效，半自动路径可用，重复跳过；
- 调试记录持久化分页可用，筛选准确，脱敏导出；
- 设置项读写正确、默认值与文案符合规范；
- 单元/集成测试通过，关键路径覆盖（解析/去重/决策/撤销）。

## 风险与预案
- 文案差异/ROM 差异：解析器规则以正则为主，可快速热修（发版）；调试面板提供样本导出。
- Schema 升级：谨慎 bump 版本，提供迁移；备份导出通道可选。
- 通知权限/监听器：引导与直达入口完善，重连策略与诊断数据可视。

## 变更控制与回滚
- 任一 Task 引入回归或不达验收：
  - 解析器：回退到前一版本、透传调试样本；
  - 调试持久化：临时切回内存实现（接口不变）；
  - 设置项：仅隐藏新增控件，不影响原有开关与模式选择。

## 附：实现落点速查
- 解析器：`feature/ledger/domain/parser/*NotificationParser.kt`
- 去重：`feature/ledger/data/manager/DeduplicationManager.kt`
- 管理器：`feature/ledger/domain/usecase/AutoLedgerManager.kt`
- 通知交互：`feature/ledger/domain/service/AutoLedgerNotificationManager.kt`
- 设置与调试 UI：`feature/ledger/presentation/screen/settings/*`、`.../screen/debug/*`
- 持久化（新）：`core/database`（Entity/Dao/Schema v10）
