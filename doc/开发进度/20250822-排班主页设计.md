# 2025-08-22｜排班主页设计 Demo 进度（A3 收敛版）

本次目标：重做与收敛排班主页月视图（A3 定稿基线），实现上下拖拽在“紧凑/展开”两种层级视图间切换；格内在紧凑态渲染彩色长条，展开态放大格子并展示“名称+时段”列表。

## 当前状态
- 单页 Demo：`home_redesign_a3_demo`
  - 入口：Calendar 页面 → 右上角“更多” → 主页设计 Demo (A3)
  - 固定基线：A3（月视图·轻量边界+选中底色增强）
- 双态显示：`DisplayMode`
  - 紧凑模式（Compact）：顶部总览卡片 + 月历（格内“彩色长条”）+ 当日卡片
  - 展开模式（Expanded）：隐藏总览与当日卡片，放大格子（默认 112dp 行高），格内显示“多班次名称（含时段）”
- 格内渲染：`DayContentMode`
  - BarsOnly：彩色长条（4dp 高/2dp 间距/圆角 6dp）上下堆叠
  - NamesList：色标 + 班次简称 + 时段（自动多行）
- 重要参数
  - `rowHeightDp`：紧凑 56dp / 展开 112dp（可调）
  - `LabelRenderConfig`：`visual=AbbrevSmall`、`multiMode=TwoChipsPlusMore`、`forcePlusNPreview=false`（已关闭 +N 强制预览）

## 交互说明（下拉/上推切换）
- 手势区域：月历网格区域（非顶部条/总览卡/当日卡）。
- 下拉展开：在网格中部按住向下拖动，拖动距离超过约 100dp 即切换至“展开模式”。
- 上推收起：在“展开模式”同一区域向上拖动超过约 100dp 回到“紧凑模式”。
- 首次展开提示：会出现 Snackbar“上滑收起”。

## 样例数据（为观察多班次与时段）
- 新增班次：加班（17:30–20:30，绿色）
- 指定多班次日期：本月 5/12/19 号
  - 5 号：早/晚/夜 → +1
  - 12 号：早/晚/夜/加班 → +2
  - 19 号：晚/夜/加班 → +1

## 主要代码位置
- 路由与入口
  - `feature/schedule/.../navigation/ScheduleNavigation.kt`：`Screen.HomeRedesignA3Demo`
  - `app/.../NavGraph.kt`：注册 `home_redesign_a3_demo`，从 Calendar 菜单进入
- 页面与面板
  - `feature/schedule/.../demo/HomeRedesignDemoScreen.kt`：容器与模式切换、Snackbar 提示
  - `feature/schedule/.../demo/parts/MonthCalendarPanel.kt`：`DisplayMode`/`DayContentMode`/`rowHeightDp`、BarsOnly/NamesList 渲染、拖拽检测

## 已知问题（用户反馈：仍无法下拉触发）
- 现象：部分设备/环境中，在月历网格区域下拉未能进入“展开模式”。
- 可能原因（排查方向）：
  1) 与 `LazyVerticalGrid` 的滚动手势存在竞争，`detectVerticalDragGestures` 的拖拽识别被滚动消费。
  2) `pointerInput` 装配顺序导致命中区域或优先级不理想（修饰符链先后影响事件分发）。
  3) 100dp 阈值在某些 DPI/触摸灵敏度环境体感偏大，易误判为滚动或未达阈值。
  4) 实际拖拽发生在总览卡/当日卡区域，非网格区域（未接收到拖拽）。

## 现实现状（关键代码）
- 网格 `pointerInput`：在 `MonthCalendarPanel.kt` 内部对 `LazyVerticalGrid` 直接挂载拖拽识别。
  - 文件：`feature/schedule/.../demo/parts/MonthCalendarPanel.kt`
  - 片段（概念）：
    - `Modifier.pointerInput { detectVerticalDragGestures(...) { dragAccum += dragAmount } onDragEnd { if (dragAccum > threshold) onRequestExpand() ... } }`
  - 阈值：`100.dp.toPx()`，紧凑→展开与展开→紧凑共用。

## 调整计划（优先级从高到低）
1) 手势拦截升级为 draggable/nestedScroll（优先）
   - 改用 `Modifier.draggable(orientation = Vertical, state = rememberDraggableState { delta -> ... })`，在 `onDragStopped` 判断阈值；`draggable` 与滚动更易协同。
   - 或引入 `anchoredDraggable`（Compose 1.6+）：设定两个锚点（Compact=0f / Expanded=1f），根据停靠状态切换显示模式，手感更稳定。
   - 如使用 `nestedScroll`：在 `onPreScroll`/`onPostScroll` 里累计纵向位移并决定拦截或放行，以避免被 `LazyVerticalGrid` 抢占。

2) 提升命中面与优先级（兜底）
   - 在网格外包一层 `Box`，将手势放在外层容器上（覆盖整个网格区域），减少与内部滚动的直接竞争。
   - 确保手势修饰符在修饰符链靠后位置（更接近根侧），提高处理优先级。

3) 阈值与模式参数微调
   - 将阈值从 100dp 下调至 72–84dp（待实机确认）。
   - 展开态行高先试 112dp → 可在 104/112/120dp 做 A/B 对比。

4) 滚动交互降噪（如仍冲突）
   - 在当前月网格不需要滚动时，显式设置 `userScrollEnabled = false`，避免多余的滚动竞争。
   - 展开态可临时禁用网格滚动，只保留手势切换，确认手势路径后再恢复。

## 复现与验证建议
- 复现：进入 `主页设计 Demo (A3)` → 在月历网格区域自上而下拖动超过阈值；如无反应，重复并观察是否被误判为滚动（网格是否有位移）。
- 调试：
  - 打点日志：在 `onDragStart/onDrag` 记录累计位移；在 `onDragEnd` 打印触发/未触发原因。
  - 暂降阈值至 60dp 以确认是否仅为阈值过大问题。
  - 临时禁用 `LazyVerticalGrid` 滚动验证是否为手势竞争问题。

## 后续更新承诺
- 按上述“调整计划”先行切换 `draggable` 实现并下调阈值；若仍不理想，再引入 `anchoredDraggable` + 动画化停靠。
- 完成后将更新本页并在首次展开继续保留“上滑收起”提示。

---
如需我直接替换为 `draggable/anchoredDraggable` 方案并下调阈值，请回复确认我即可提交改动（不影响现有路由与数据）。
