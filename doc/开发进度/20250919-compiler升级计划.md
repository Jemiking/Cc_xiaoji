# 2025-09-19 Kotlin/Compose 编译链升级计划（含系统长截屏能力恢复）

本计划用于指导一次“可控、可回滚”的 Kotlin + Compose 升级，在不阻断主干功能交付的前提下，提升 HyperOS 上的系统级长截屏（ScrollCapture）支持能力。已并行交付的“应用内导出长图”作为长期兜底能力保留。

## 背景与目标
- 现状：项目使用 Compose BOM 1.6 系列（libs.versions.toml: compose-bom=2024.02.00，compiler=1.5.7，Kotlin=1.9.21）。在 HyperOS 设备上，系统“截长屏”对旧版 Compose 的滚动容器识别不稳定。
- 目标：升级到支持/完善 ScrollCapture 的新版 Compose（≥1.7），同步匹配 Kotlin/Compiler/KSP 等工具链；保持 UI/交互稳定，关键页面无明显视觉漂移。

## 升级策略
- 独立分支推进，主干继续迭代：`tech/compose-upgrade`
- 每天从 `main` 合并一次，保持改动面“小步快跑、随改随测”
- 优先“最小可行”：先完成工具链与 Compose 基座升级，业务代码只做必要最小改动
- 双轨兜底：系统长截屏若仍不可用，保留“应用内导出长图”作为功能保障

## 版本路线（两选一，建议先走“稳妥路线”）

### 路线A（稳妥，优先）
- Kotlin：1.9.24（或同代稳定版）
- Compose Compiler：与上述 Kotlin 匹配的 1.5.x 最新稳定（≥1.5.10）
- Compose BOM：1.7.x 稳定（具体号以官方兼容矩阵为准）
- AndroidX 同步：activity-compose / lifecycle / navigation 与 BOM 同步的稳定版本
- KSP/KAPT：与 Kotlin/AGP 匹配的稳定版本
- Hilt/Room：按 Kotlin/KSP 要求升级到对应稳定版

特点：对现有代码改动小、适配成本低，已包含 ScrollCapture 的主要修复。

### 路线B（前沿，第二阶段）
- Kotlin：2.0.x
- Compose Compiler：匹配 Kotlin 2.0 的新版
- Compose BOM：1.8.x 稳定

特点：可获得后续特性/性能，但对 IDE/AGP/KSP 与三方库要求更高，适配面更广。建议在路线A稳定落地后评估。

## 兼容矩阵与规则（不强行写死版本号，按规则匹配）
- Kotlin ↔ Compose Compiler ↔ KSP/AGP 必须成组匹配（以 JetBrains/Google 发布矩阵为准）
- Compose BOM 升级后，UI 相关组件（ui/ui-graphics/tooling-preview/material3/activity-compose/lifecycle/navigation）需与 BOM 同步
- Hilt/Room 与 Kotlin/KSP 对齐，避免编译期/运行期冲突（NoSuchMethodError 等）
- 与 UI 无关三方库（Retrofit/OkHttp/Gson/WorkManager）可保持现状，降低升级面

## 执行步骤（每一步保持可运行、可回退）
0. 预备与基线
   - 从 `main` 拉出分支 `tech/compose-upgrade`，打tag：`pre-upgrade-20250919`
   - CI 增加矩阵：`main`（旧链路）与 `tech/compose-upgrade`（新链路）并行构建
   - 冻结全仓大规模格式化/重构，降低冲突面
1. 工具链最小升级
   - 升级 libs.versions.toml 中 Kotlin / Compose Compiler / Compose BOM 至目标版本（路线A）
   - 首轮编译修复：仅处理编译错误/弃用API，以“最小改动”为原则
2. AndroidX 对齐
   - 升级 activity-compose / lifecycle / navigation 到与 BOM 同步的稳定版
   - 跑关键页面（账本报表、记账、分类、统计）烟囱测试
3. 专项验证
   - HyperOS 真机：系统“截长屏”入口是否出现，可否滚动合成
   - Insets/沉浸式：状态栏/导航栏避让是否一致（本页已采用 `statusBarsPadding`）
   - Lazy 列表/指针输入/动画/Material3 组件尺寸是否有可感变化
4. 灰度合并
   - 每日与 `main` 同步一次；选择半天合并窗口，合入主干
   - 合并后快速回归（关键路径+HyperOS），异常快速热修

## 验收标准
- 构建：CI 双线均为绿色（旧链路 `main`、新链路分支）
- 功能：关键页面无崩溃，UI 无明显视觉回退，性能无可感下降
- 目标能力：HyperOS 设备上系统“截长屏”正常；如机型差异仍存在，“导出长图”确保体验稳定

## 风险与回滚
- 风险点：
  - 工具链不匹配导致的编译/运行期问题（Kotlin/Compiler/KSP/Hilt/Room）
  - Material3 默认值/手势/动画行为变化引发的视觉细漂
  - Room Schema 在 `main` 改动与升级分支迁移冲突
- 回滚策略：
  - 合并后一周内保留回滚标签；若关键指标异常，使用 `pre-upgrade-20250919` 快速回退

## 时间安排（紧凑版，目标“今日可合”）
- 上午：分支创建、版本号调整、跑编译、修首轮问题
- 下午：HyperOS 真机验证与 UI 烟囱测试、CI 双线绿、准备合入
- 傍晚：选择合并窗口，合并主干并做快速回归；必要时热修

## 具体工程待办（TODO）
- [ ] 在 `tech/compose-upgrade` 上：
  - [ ] 更新 `gradle/libs.versions.toml`（按路线A规则匹配版本）
  - [ ] 如需，更新 AGP/KSP/Hilt/Room 版本以匹配 Kotlin/Compiler
  - [ ] 修复编译错误（仅最小化改动），避免扫仓式重构
  - [ ] 更新 CI：分支新增一条“新链路”构建任务
  - [ ] 关键页面冒烟测试（含 HyperOS 真机）
- [ ] 合并前：
  - [ ] 从 `main` 同步最新变更，解决冲突
  - [ ] 输出变更说明与回归清单
- [ ] 合并后：
  - [ ] 快速回归（关键业务流 + 设备矩阵）
  - [ ] 持续跟踪 HyperOS 上系统“截长屏”的可用性；若仍存在机型差异，保留“导出长图”入口

## 记录与后续
- 2025-09-19：确定并行策略（兜底+升级）；本页已完成状态栏避让与“导出长图”落地。
- 下一步：按照本计划在 `tech/compose-upgrade` 分支推进，版本号以路线A的兼容矩阵为准进行匹配与验证。

