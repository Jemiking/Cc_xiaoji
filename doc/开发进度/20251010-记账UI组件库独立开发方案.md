# 记账UI组件库独立开发方案

## 文档信息
- 创建日期：2025-10-10
- 方案类型：UI重构专项
- 状态：✅ 已批准待实施
- 优先级：⭐⭐⭐⭐⭐ 高优先级

## 背景与目标

### 问题背景
- 当前记账模块UI不够美观，需要全面重构
- 在主项目中直接修改效率低下（编译慢、影响稳定性）
- Demo环境虽然存在但修改流程仍然繁琐

### 核心目标
1. **提升UI迭代效率**：从分钟级降到秒级
2. **保证代码质量**：强制组件化设计
3. **简化迁移流程**：组件可直接复制到主项目
4. **支持激进实验**：不影响生产代码的情况下尝试新设计

## 方案概述：组件库项目

### 核心理念
**将UI组件视为独立的"产品"**，每个组件都是自包含、可复用、可预览的最小单元。借鉴前端Storybook思想，在Android Compose中通过`@Preview`实现。

### 技术选型
- **UI框架**：Jetpack Compose + Material 3（与主项目一致）
- **预览技术**：Compose @Preview + Android Studio实时渲染
- **项目结构**：多模块项目（app展示层 + components核心库）
- **版本管理**：独立Git仓库，支持分支实验

## 详细项目架构

### 1. 目录结构设计

```
LedgerUIDemo/                              # 独立项目根目录
├── settings.gradle.kts                    # Gradle设置
├── build.gradle.kts                       # 项目级构建文件
├── gradle.properties                      # Gradle属性配置
├── .gitignore                             # Git忽略配置
│
├── app/                                   # Demo应用模块
│   ├── build.gradle.kts
│   ├── proguard-rules.pro
│   └── src/
│       └── main/
│           ├── AndroidManifest.xml
│           ├── kotlin/
│           │   └── com.demo.ledgerui/
│           │       ├── MainActivity.kt    # 组件展示目录页
│           │       ├── theme/             # 主题（复制自主项目）
│           │       │   ├── Color.kt
│           │       │   ├── Theme.kt
│           │       │   ├── Type.kt
│           │       │   └── Shape.kt
│           │       ├── navigation/        # 导航设置
│           │       │   └── DemoNavigation.kt
│           │       └── screens/           # 完整页面Demo
│           │           ├── catalog/       # 组件目录
│           │           │   └── ComponentCatalogScreen.kt
│           │           ├── ledger/        # 记账相关页面
│           │           │   ├── AddTransactionDemoScreen.kt
│           │           │   ├── LedgerListDemoScreen.kt
│           │           │   ├── TransactionDetailDemoScreen.kt
│           │           │   └── MonthlyReportDemoScreen.kt
│           │           └── asset/         # 资产相关页面
│           │               ├── AssetOverviewDemoScreen.kt
│           │               └── AccountManagementDemoScreen.kt
│           └── res/
│               ├── drawable/
│               ├── values/
│               │   ├── strings.xml
│               │   ├── colors.xml
│               │   └── themes.xml
│               └── values-night/
│                   └── themes.xml
│
└── ledger-components/                    # 核心组件库模块
    ├── build.gradle.kts
    └── src/
        └── main/
            └── kotlin/
                └── com.demo.ledgerui.components/
                    ├── transaction/       # 交易相关组件
                    │   ├── core/         # 核心组件
                    │   │   ├── TransactionItem.kt
                    │   │   ├── TransactionHeader.kt
                    │   │   ├── TransactionGroupHeader.kt
                    │   │   └── TransactionSummaryBar.kt
                    │   ├── display/      # 显示组件
                    │   │   ├── AmountDisplay.kt
                    │   │   ├── CategoryBadge.kt
                    │   │   ├── AccountTag.kt
                    │   │   └── TimeDisplay.kt
                    │   └── preview/      # Preview定义
                    │       ├── TransactionItemPreviews.kt
                    │       ├── TransactionHeaderPreviews.kt
                    │       └── PreviewData.kt
                    │
                    ├── input/            # 输入组件
                    │   ├── amount/       # 金额输入
                    │   │   ├── AmountInput.kt
                    │   │   ├── AmountKeyboard.kt
                    │   │   └── AmountFormatter.kt
                    │   ├── category/     # 分类选择
                    │   │   ├── CategoryPicker.kt
                    │   │   ├── CategoryGrid.kt
                    │   │   └── CategorySearchBar.kt
                    │   ├── account/      # 账户选择
                    │   │   ├── AccountSelector.kt
                    │   │   └── AccountList.kt
                    │   ├── datetime/     # 日期时间
                    │   │   ├── DateTimePicker.kt
                    │   │   ├── DateRangePicker.kt
                    │   │   └── QuickDateChips.kt
                    │   └── preview/
                    │       ├── AmountInputPreviews.kt
                    │       ├── CategoryPickerPreviews.kt
                    │       └── DateTimePickerPreviews.kt
                    │
                    ├── card/             # 卡片组件
                    │   ├── asset/        # 资产卡片
                    │   │   ├── NetAssetCard.kt
                    │   │   ├── AssetDistributionCard.kt
                    │   │   └── AssetTrendCard.kt
                    │   ├── summary/      # 汇总卡片
                    │   │   ├── MonthlySummaryCard.kt
                    │   │   ├── DailySummaryCard.kt
                    │   │   └── CategorySummaryCard.kt
                    │   ├── budget/       # 预算卡片
                    │   │   ├── BudgetOverviewCard.kt
                    │   │   ├── BudgetProgressCard.kt
                    │   │   └── BudgetAlertCard.kt
                    │   └── preview/
                    │       ├── AssetCardPreviews.kt
                    │       └── SummaryCardPreviews.kt
                    │
                    ├── chart/            # 图表组件
                    │   ├── pie/          # 饼图
                    │   │   ├── PieChart.kt
                    │   │   ├── DonutChart.kt
                    │   │   └── PieChartLegend.kt
                    │   ├── bar/          # 柱状图
                    │   │   ├── BarChart.kt
                    │   │   ├── GroupedBarChart.kt
                    │   │   └── StackedBarChart.kt
                    │   ├── line/         # 折线图
                    │   │   ├── LineChart.kt
                    │   │   ├── AreaChart.kt
                    │   │   └── TrendLine.kt
                    │   └── preview/
                    │       ├── PieChartPreviews.kt
                    │       ├── BarChartPreviews.kt
                    │       └── LineChartPreviews.kt
                    │
                    ├── common/           # 通用组件
                    │   ├── state/        # 状态组件
                    │   │   ├── EmptyState.kt
                    │   │   ├── LoadingState.kt
                    │   │   ├── ErrorState.kt
                    │   │   └── SuccessState.kt
                    │   ├── button/       # 按钮组件
                    │   │   ├── PrimaryButton.kt
                    │   │   ├── FloatingActionButton.kt
                    │   │   └── IconButton.kt
                    │   ├── dialog/       # 对话框
                    │   │   ├── ConfirmDialog.kt
                    │   │   ├── InputDialog.kt
                    │   │   └── BottomSheet.kt
                    │   └── preview/
                    │       ├── StatePreviews.kt
                    │       └── ButtonPreviews.kt
                    │
                    └── utils/            # 工具类
                        ├── PreviewUtils.kt
                        ├── ThemeUtils.kt
                        └── FormatUtils.kt
```

### 2. 技术配置

#### 2.1 项目级配置

```kotlin
// settings.gradle.kts
rootProject.name = "LedgerUIDemo"
include(":app")
include(":ledger-components")

// build.gradle.kts (Project)
plugins {
    id("com.android.application") version "8.3.0" apply false
    id("com.android.library") version "8.3.0" apply false
    id("org.jetbrains.kotlin.android") version "1.9.24" apply false
}

tasks.register("clean", Delete::class) {
    delete(rootProject.buildDir)
}
```

#### 2.2 App模块配置

```kotlin
// app/build.gradle.kts
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
}

android {
    namespace = "com.demo.ledgerui"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.demo.ledgerui"
        minSdk = 26
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }

    buildFeatures {
        compose = true
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.14"
    }

    kotlinOptions {
        jvmTarget = "17"
    }
}

dependencies {
    implementation(project(":ledger-components"))

    // Compose BOM - 统一版本管理
    implementation(platform("androidx.compose:compose-bom:2024.10.00"))
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.ui:ui-graphics")
    implementation("androidx.compose.material3:material3")
    implementation("androidx.compose.material:material-icons-extended")
    implementation("androidx.compose.ui:ui-tooling-preview")
    debugImplementation("androidx.compose.ui:ui-tooling")
    debugImplementation("androidx.compose.ui:ui-test-manifest")

    // Navigation
    implementation("androidx.navigation:navigation-compose:2.7.6")

    // Core
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")
    implementation("androidx.activity:activity-compose:1.8.2")
}
```

#### 2.3 组件库模块配置

```kotlin
// ledger-components/build.gradle.kts
plugins {
    id("com.android.library")
    id("org.jetbrains.kotlin.android")
}

android {
    namespace = "com.demo.ledgerui.components"
    compileSdk = 34

    defaultConfig {
        minSdk = 26

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
        consumerProguardFiles("consumer-rules.pro")
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }

    buildFeatures {
        compose = true
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.14"

        // 启用Compose编译器报告（用于性能分析）
        kotlinOptions {
            freeCompilerArgs += listOf(
                "-P",
                "plugin:androidx.compose.compiler.plugins.kotlin:metricsDestination=${project.buildDir}/compose_metrics",
                "-P",
                "plugin:androidx.compose.compiler.plugins.kotlin:reportsDestination=${project.buildDir}/compose_reports"
            )
        }
    }

    kotlinOptions {
        jvmTarget = "17"
    }
}

dependencies {
    // Compose BOM
    implementation(platform("androidx.compose:compose-bom:2024.10.00"))
    api("androidx.compose.ui:ui")
    api("androidx.compose.ui:ui-graphics")
    api("androidx.compose.material3:material3")
    api("androidx.compose.material:material-icons-extended")
    api("androidx.compose.ui:ui-tooling-preview")
    debugImplementation("androidx.compose.ui:ui-tooling")

    // 使用api而不是implementation，让app模块也能访问这些依赖
}
```

## 核心优势详解

### 1. 极致迭代速度（60倍提升）
- **传统方式**：修改 → 编译(2分钟) → 安装 → 导航 → 查看 = **3-5分钟**
- **组件库方式**：修改 → 自动刷新Preview = **2-5秒**
- **Interactive Mode**：直接在Preview中交互测试

### 2. 强制组件化设计
- Preview要求组件必须自包含
- 不能依赖外部ViewModel或Repository
- 产出高质量、可复用的组件

### 3. 多状态并行预览
- 同时查看正常、加载、错误、空数据等所有状态
- 一眼发现UI问题和边界情况
- 支持不同主题、字体大小、设备尺寸的预览

### 4. 零成本迁移
- 相同技术栈（Compose + Material 3）
- 纯UI组件无业务逻辑
- 复制文件 + 调整导入 = 完成迁移

### 5. 自带文档系统
- 每个Preview都是使用示例
- 可视化文档比文字说明更直观
- 新成员看Preview即可上手

### 6. 版本控制独立
- 可以激进实验新设计
- 不影响主项目稳定性
- 支持多分支并行开发

## 开发流程规范

### Phase 1：环境搭建（1天）
1. 创建新的Android项目
2. 配置双模块结构（app + components）
3. 复制主项目的Theme文件
4. 创建基础的Preview工具类

### Phase 2：组件迁移与重构（2-3周）
1. **分析现有组件**
   - 列出所有需要重构的UI组件
   - 确定组件间依赖关系
   - 制定迁移优先级

2. **组件开发流程**
   ```
   对于每个组件：
   a. 创建组件文件（.kt）
   b. 实现基础功能
   c. 创建Preview文件（Previews.kt）
   d. 添加多状态Preview
   e. 在Demo App中集成测试
   f. 性能优化（查看Compose Metrics）
   ```

3. **重点组件清单**
   - [ ] TransactionItem - 交易列表项
   - [ ] AmountInput - 金额输入器
   - [ ] CategoryPicker - 分类选择器
   - [ ] AccountSelector - 账户选择器
   - [ ] DateTimePicker - 日期时间选择器
   - [ ] MonthlyOverviewBar - 月度概览条
   - [ ] NetAssetCard - 净资产卡片
   - [ ] PieChart - 饼图/甜甜圈图
   - [ ] EmptyState - 空状态提示
   - [ ] LoadingState - 加载状态

### Phase 3：页面组装（1周）
1. 在app模块中组装完整页面
2. 测试页面交互流程
3. 调整组件配合问题

### Phase 4：迁移到主项目（2-3天）
1. 复制组件文件到主项目
2. 调整包名和导入
3. 替换旧组件
4. 集成测试

## 迁移策略详解

### 文件迁移步骤

```bash
# 1. 复制组件文件
cp -r LedgerUIDemo/ledger-components/src/main/kotlin/com/demo/ledgerui/components/transaction/* \
      Cc_xiaoji/feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/component/

# 2. 批量调整包名（使用IDE的重构功能更安全）
# 查找：package com.demo.ledgerui.components
# 替换：package com.ccxiaoji.feature.ledger.presentation.component

# 3. 批量调整导入
# 查找：import com.demo.ledgerui.theme
# 替换：import com.ccxiaoji.core.ui.theme

# 4. 在主项目中使用
```

### 代码调整示例

```kotlin
// 原Demo组件
package com.demo.ledgerui.components.transaction

import com.demo.ledgerui.theme.*

@Composable
fun TransactionItem(
    data: TransactionUiModel,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    // 组件实现
}

// 迁移后
package com.ccxiaoji.feature.ledger.presentation.component.transaction

import com.ccxiaoji.core.ui.theme.*  // 仅需调整导入

@Composable
fun TransactionItem(
    data: TransactionUiModel,  // 数据模型可能需要映射
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    // 组件实现不变
}
```

## Preview最佳实践

### 1. 多状态Preview模板

```kotlin
// TransactionItemPreviews.kt
@Preview(name = "1.默认状态", group = "状态")
@Composable
private fun TransactionItem_Default() {
    LedgerTheme {
        TransactionItem(
            data = PreviewData.sampleTransaction,
            onClick = {}
        )
    }
}

@Preview(name = "2.选中状态", group = "状态")
@Composable
private fun TransactionItem_Selected() {
    LedgerTheme {
        TransactionItem(
            data = PreviewData.sampleTransaction,
            isSelected = true,
            onClick = {}
        )
    }
}

@Preview(name = "3.长文本", group = "边界")
@Composable
private fun TransactionItem_LongText() {
    LedgerTheme {
        TransactionItem(
            data = PreviewData.longTextTransaction,
            onClick = {}
        )
    }
}

@Preview(name = "4.暗色主题", group = "主题", uiMode = Configuration.UI_MODE_NIGHT_YES)
@Composable
private fun TransactionItem_Dark() {
    LedgerTheme {
        TransactionItem(
            data = PreviewData.sampleTransaction,
            onClick = {}
        )
    }
}
```

### 2. 组合注解减少重复

```kotlin
// PreviewAnnotations.kt
@Preview(name = "Light")
@Preview(name = "Dark", uiMode = Configuration.UI_MODE_NIGHT_YES)
annotation class ThemePreviews

@Preview(name = "Phone", device = Devices.PIXEL_4)
@Preview(name = "Tablet", device = Devices.PIXEL_C)
annotation class DevicePreviews

@Preview(name = "Small Font", fontScale = 0.85f)
@Preview(name = "Large Font", fontScale = 1.5f)
annotation class FontPreviews

// 使用组合注解
@ThemePreviews
@DevicePreviews
@Composable
private fun TransactionItem_AllVariants() {
    LedgerTheme {
        TransactionItem(
            data = PreviewData.sampleTransaction,
            onClick = {}
        )
    }
}
```

### 3. PreviewData管理

```kotlin
// PreviewData.kt
object PreviewData {

    // 基础数据
    val sampleTransaction = TransactionUiModel(
        id = "1",
        amount = "¥158.50",
        type = TransactionType.EXPENSE,
        category = "餐饮美食",
        categoryIcon = Icons.Default.Restaurant,
        account = "支付宝",
        time = "14:32",
        date = "今天",
        note = "午餐"
    )

    // 边界数据
    val longTextTransaction = sampleTransaction.copy(
        category = "餐饮美食 > 正餐 > 中式料理 > 川菜",
        account = "招商银行信用卡(尾号1234)",
        note = "和朋友聚餐，AA制，我的部分，包含服务费和茶水费，使用了优惠券抵扣20元"
    )

    // 批量数据
    val sampleTransactions = buildList {
        add(sampleTransaction)
        add(sampleTransaction.copy(
            id = "2",
            amount = "¥50.00",
            category = "交通出行",
            categoryIcon = Icons.Default.DirectionsBus
        ))
        add(sampleTransaction.copy(
            id = "3",
            amount = "¥3000.00",
            type = TransactionType.INCOME,
            category = "工资收入",
            categoryIcon = Icons.Default.AccountBalance
        ))
    }

    // 月度数据
    fun generateMonthlyData(month: Int): List<TransactionUiModel> {
        return (1..30).map { day ->
            sampleTransaction.copy(
                id = "$month-$day",
                amount = "¥${(50..500).random()}.${(0..99).random()}",
                date = "${month}月${day}日"
            )
        }
    }
}
```

## 性能优化指南

### 1. 启用Compose Metrics

```kotlin
// 在组件库的build.gradle.kts中添加
android {
    kotlinOptions {
        freeCompilerArgs += listOf(
            "-P",
            "plugin:androidx.compose.compiler.plugins.kotlin:metricsDestination=${project.buildDir}/compose_metrics",
            "-P",
            "plugin:androidx.compose.compiler.plugins.kotlin:reportsDestination=${project.buildDir}/compose_reports"
        )
    }
}
```

### 2. 分析报告
执行构建后查看：
- `compose_metrics/`: 重组次数统计
- `compose_reports/`: 组件稳定性分析

### 3. 优化建议
- 使用`@Stable`标记稳定的数据类
- 使用`remember`缓存计算结果
- 避免在组件中创建新对象

## 团队协作指南

### Git分支策略

```
main                    # 稳定版本，与主项目同步
├── develop            # 开发分支
│   ├── feature/transaction-item-v2    # 功能开发
│   ├── feature/dark-theme-optimize    # 主题优化
│   └── feature/animation-enhance      # 动画增强
├── experiment/        # 实验分支
│   ├── glassmorphism  # 毛玻璃效果
│   └── neumorphism    # 新拟态设计
└── release/v1.0       # 发布分支
```

### 代码审查要点
1. Preview覆盖率（每个组件至少3个Preview）
2. 组件API设计（参数是否合理）
3. 性能指标（查看Compose Metrics）
4. 代码复用性（避免重复代码）

## 风险管理

### 潜在风险
1. **学习成本**：团队需要熟悉Preview开发模式
2. **版本同步**：需要保持与主项目依赖版本一致
3. **迁移遗漏**：可能遗漏某些组件修改

### 应对策略
1. **培训计划**：制作Preview开发指南和示例
2. **版本锁定**：使用相同的BOM版本
3. **迁移清单**：维护详细的组件迁移检查表

## 效果评估

### 量化指标
| 指标 | 当前值 | 目标值 | 评估方法 |
|------|--------|--------|----------|
| UI迭代速度 | 3-5分钟/次 | <10秒/次 | 统计修改到查看的时间 |
| 组件复用率 | 30% | >70% | 统计组件使用次数 |
| UI缺陷率 | 5个/周 | <1个/周 | 统计UI相关Bug |
| 开发满意度 | 6/10 | >8/10 | 团队问卷调查 |

### 里程碑计划
- **Week 1**: 项目搭建完成，基础组件迁移
- **Week 2-3**: 核心组件开发，Demo页面组装
- **Week 4**: 性能优化，准备迁移
- **Week 5**: 迁移到主项目，集成测试

## 后续优化方向

### 短期（1-2个月）
1. 完成所有记账模块组件重构
2. 建立组件文档网站
3. 添加自动化测试

### 中期（3-6个月）
1. 扩展到其他模块（Todo、Habit等）
2. 建立设计系统（Design System）
3. 组件性能监控体系

### 长期（6个月+）
1. 组件市场化（内部组件库）
2. AI辅助组件生成
3. 跨项目组件共享

## 附录

### A. 相关资源
- [Compose官方文档](https://developer.android.com/jetpack/compose)
- [Material 3设计规范](https://m3.material.io/)
- [Compose性能最佳实践](https://developer.android.com/jetpack/compose/performance)

### B. 工具推荐
- **Compose Preview Scanner**: 批量生成Preview
- **Showkase**: 自动生成组件展示页
- **Paparazzi**: 组件截图测试

### C. 常见问题FAQ
1. **Q: Preview不显示怎么办？**
   A: 检查是否添加了`@Preview`注解，确保包含了`ui-tooling`依赖

2. **Q: 如何调试Preview中的组件？**
   A: 使用Interactive Mode，或在Demo App中运行

3. **Q: 迁移后样式不一致怎么办？**
   A: 确保Theme文件完全一致，检查依赖版本

---

## 更新日志
- 2025-10-10：初始方案制定，确定组件库架构