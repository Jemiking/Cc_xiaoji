# Phase 2: å•æ¡æé†’æ”¯æŒæ–¹æ¡ˆï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰

æ­¤æ–‡ä»¶å°†è¢«åˆå¹¶åˆ°ä¸»æ–‡æ¡£çš„ç¬¬12èŠ‚

---

## 12. Phase 2: å•æ¡æé†’æ”¯æŒæ–¹æ¡ˆ ğŸ“…

### 12.1 æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡ï¼š** æ”¯æŒæ¯ä¸ªä»»åŠ¡/ä¹ æƒ¯ç‹¬ç«‹è®¾ç½®æé†’æ—¶é—´ï¼ŒåŒæ—¶ä¿ç•™å…¨å±€é…ç½®ä½œä¸ºé»˜è®¤å€¼

**æ ¸å¿ƒç†å¿µï¼š**
- **ä¼˜å…ˆçº§ç­–ç•¥**ï¼šå•æ¡é…ç½® > å…¨å±€é…ç½® > ç³»ç»Ÿé»˜è®¤
- **å‘åå…¼å®¹**ï¼šæ—§æ•°æ®è‡ªåŠ¨ç»§æ‰¿å…¨å±€é…ç½®ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨è¿ç§»
- **ç”¨æˆ·å‹å¥½**ï¼šé»˜è®¤ä½¿ç”¨å…¨å±€è®¾ç½®ï¼Œæä¾›"ä½¿ç”¨å…¨å±€è®¾ç½®"å¿«æ·é€‰é¡¹

**é¢„æœŸæ”¶ç›Šï¼š**
1. âœ… **ä¿®å¤P0é—®é¢˜**ï¼šè®©ç”¨æˆ·é…ç½®çš„"æå‰Nåˆ†é’Ÿ"ç”Ÿæ•ˆ
2. âœ… **å¢å¼ºçµæ´»æ€§**ï¼šé‡è¦ä»»åŠ¡å¯æå‰1å°æ—¶ï¼Œæ™®é€šä»»åŠ¡æå‰30åˆ†é’Ÿ
3. âœ… **ä¸ªæ€§åŒ–æé†’**ï¼šä¹ æƒ¯å¯æŒ‰å®é™…åœºæ™¯è®¾ç½®ä¸åŒæ—¶é—´ï¼ˆæ™¨è·‘7:00ï¼Œè¯»ä¹¦21:00ï¼‰
4. âœ… **é™ä½é…ç½®æˆæœ¬**ï¼šé»˜è®¤å…¨å±€é…ç½®ï¼Œä»…é‡è¦äº‹é¡¹éœ€è¦è‡ªå®šä¹‰

**å®æ–½å‘¨æœŸï¼š** 4å¤©ï¼ˆåˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µç‹¬ç«‹éªŒæ”¶ï¼‰

---

### 12.2 æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ

#### 12.2.1 TaskEntity æ‰©å±•å­—æ®µ

```kotlin
// feature/todo/data/local/entity/TaskEntity.kt
@Entity(
    tableName = "tasks",
    foreignKeys = [/* ç°æœ‰å¤–é”®ä¿æŒä¸å˜ */],
    indices = [Index("userId"), Index("dueAt"), Index("updatedAt")]
)
data class TaskEntity(
    // ===== ç°æœ‰å­—æ®µï¼ˆä¸å˜ï¼‰ =====
    @PrimaryKey val id: String,
    val userId: String,
    val title: String,
    val description: String? = null,
    val dueAt: Long?,                    // æˆªæ­¢æ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰
    val priority: Int = 0,
    val completed: Boolean = false,
    val completedAt: Long? = null,
    val createdAt: Long,
    val updatedAt: Long,
    val isDeleted: Boolean = false,
    val syncStatus: SyncStatus = SyncStatus.SYNCED,

    // ===== æ–°å¢å­—æ®µï¼ˆPhase 2ï¼‰ =====
    /**
     * æ˜¯å¦å¯ç”¨æé†’
     * - nullï¼šç»§æ‰¿å…¨å±€é…ç½®ï¼ˆé»˜è®¤å€¼ï¼Œæ—§æ•°æ®è¿ç§»åä¸ºnullï¼‰
     * - trueï¼šå¼ºåˆ¶å¯ç”¨ï¼ˆå³ä½¿å…¨å±€å…³é—­ä¹Ÿæé†’ï¼‰
     * - falseï¼šå¼ºåˆ¶ç¦ç”¨ï¼ˆå³ä½¿å…¨å±€å¼€å¯ä¹Ÿä¸æé†’ï¼‰
     */
    val reminderEnabled: Boolean? = null,

    /**
     * æé†’æ—¶é—´ï¼ˆç»å¯¹æ—¶é—´ï¼Œæ¯«ç§’æ—¶é—´æˆ³ï¼‰
     * - nullï¼šä½¿ç”¨ç›¸å¯¹æ—¶é—´ï¼ˆæˆªæ­¢æ—¶é—´ - reminderMinutesBeforeï¼‰
     * - énullï¼šä½¿ç”¨ç»å¯¹æ—¶é—´ï¼ˆå¦‚æå‰1å¤©ï¼Œè®¾ç½®ä¸ºå…·ä½“æ—¶é—´æˆ³ï¼‰
     *
     * ç¤ºä¾‹ï¼šä»»åŠ¡æˆªæ­¢2025-10-06 18:00ï¼Œå¸Œæœ›å‰ä¸€å¤©9:00æé†’
     *      â†’ reminderAt = Instant.parse("2025-10-05T09:00:00Z").toEpochMilliseconds()
     */
    val reminderAt: Long? = null,

    /**
     * æå‰æé†’åˆ†é’Ÿæ•°
     * - nullï¼šä½¿ç”¨å…¨å±€é…ç½®çš„åˆ†é’Ÿæ•°ï¼ˆå¦‚30åˆ†é’Ÿï¼‰
     * - énullï¼šä½¿ç”¨å•ä»»åŠ¡é…ç½®ï¼ˆå¦‚60åˆ†é’Ÿï¼‰
     *
     * ä¼˜å…ˆçº§ï¼šreminderAt > reminderMinutesBefore > å…¨å±€é…ç½®
     */
    val reminderMinutesBefore: Int? = null
)
```

**å­—æ®µç»„åˆç¤ºä¾‹ï¼š**

| åœºæ™¯ | reminderEnabled | reminderAt | reminderMinutesBefore | å®é™…è¡Œä¸º |
|------|----------------|-----------|---------------------|---------|
| è·Ÿéšå…¨å±€ | `null` | `null` | `null` | ä½¿ç”¨å…¨å±€é…ç½®ï¼ˆå¦‚æå‰30åˆ†é’Ÿï¼‰ |
| è‡ªå®šä¹‰åˆ†é’Ÿ | `true` | `null` | `60` | æå‰60åˆ†é’Ÿæé†’ |
| ç»å¯¹æ—¶é—´ | `true` | `1728111600000` | `null` | åœ¨æŒ‡å®šæ—¶é—´æé†’ |
| ç¦ç”¨æé†’ | `false` | `null` | `null` | ä¸æé†’ |

---

#### 12.2.2 HabitEntity æ‰©å±•å­—æ®µ

```kotlin
// feature/habit/data/local/entity/HabitEntity.kt
@Entity(
    tableName = "habits",
    foreignKeys = [/* ç°æœ‰å¤–é”®ä¿æŒä¸å˜ */],
    indices = [Index("userId"), Index("updatedAt")]
)
data class HabitEntity(
    // ===== ç°æœ‰å­—æ®µï¼ˆä¸å˜ï¼‰ =====
    @PrimaryKey val id: String,
    val userId: String,
    val title: String,
    val description: String? = null,
    val period: String,
    val target: Int = 1,
    val color: String = "#3A7AFE",
    val icon: String? = null,
    val createdAt: Long,
    val updatedAt: Long,
    val isDeleted: Boolean = false,
    val syncStatus: SyncStatus = SyncStatus.SYNCED,

    // ===== æ–°å¢å­—æ®µï¼ˆPhase 2ï¼‰ =====
    /**
     * æ˜¯å¦å¯ç”¨æé†’
     * - nullï¼šç»§æ‰¿å…¨å±€é…ç½®
     * - true/falseï¼šå•ä¹ æƒ¯é…ç½®
     */
    val reminderEnabled: Boolean? = null,

    /**
     * æé†’æ—¶é—´ï¼ˆHH:mmæ ¼å¼å­—ç¬¦ä¸²ï¼‰
     * - nullï¼šä½¿ç”¨å…¨å±€é…ç½®æ—¶é—´ï¼ˆå¦‚"20:00"ï¼‰
     * - énullï¼šä½¿ç”¨å•ä¹ æƒ¯é…ç½®ï¼ˆå¦‚"07:00"ï¼‰
     *
     * ç¤ºä¾‹ï¼š
     *   - æ™¨é—´è·‘æ­¥ï¼šreminderTime = "07:00"
     *   - ç¡å‰é˜…è¯»ï¼šreminderTime = "21:00"
     */
    val reminderTime: String? = null
)
```

---

#### 12.2.3 æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆv1 â†’ v2ï¼‰

```kotlin
// app/data/local/CcDatabase.kt
@Database(
    entities = [/* ... */],
    version = 2,  // âš ï¸ ç‰ˆæœ¬å·ä»1å‡çº§åˆ°2
    exportSchema = true
)
abstract class CcDatabase : RoomDatabase() {
    // ...

    companion object {
        /**
         * æ•°æ®åº“è¿ç§»ï¼šv1 â†’ v2
         * æ–°å¢æé†’å­—æ®µæ”¯æŒå•æ¡é…ç½®
         */
        val MIGRATION_1_2 = object : Migration(1, 2) {
            override fun migrate(database: SupportSQLiteDatabase) {
                Log.d("CcDatabase", "Starting migration 1 -> 2: Adding reminder fields")

                try {
                    // ===== è¿ç§» tasks è¡¨ =====
                    database.execSQL("""
                        ALTER TABLE tasks
                        ADD COLUMN reminderEnabled INTEGER DEFAULT NULL
                    """)

                    database.execSQL("""
                        ALTER TABLE tasks
                        ADD COLUMN reminderAt INTEGER DEFAULT NULL
                    """)

                    database.execSQL("""
                        ALTER TABLE tasks
                        ADD COLUMN reminderMinutesBefore INTEGER DEFAULT NULL
                    """)

                    // ===== è¿ç§» habits è¡¨ =====
                    database.execSQL("""
                        ALTER TABLE habits
                        ADD COLUMN reminderEnabled INTEGER DEFAULT NULL
                    """)

                    database.execSQL("""
                        ALTER TABLE habits
                        ADD COLUMN reminderTime TEXT DEFAULT NULL
                    """)

                    Log.d("CcDatabase", "Migration 1 -> 2 completed successfully")

                } catch (e: Exception) {
                    Log.e("CcDatabase", "Migration 1 -> 2 failed", e)
                    throw e
                }
            }
        }

        // ===== åœ¨ getInstance() ä¸­æ³¨å†Œè¿ç§» =====
        @Volatile
        private var INSTANCE: CcDatabase? = null

        fun getInstance(context: Context): CcDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    CcDatabase::class.java,
                    "cc_xiaoji_database"
                )
                    .addMigrations(MIGRATION_1_2)  // âš ï¸ æ·»åŠ è¿ç§»
                    .build()
                INSTANCE = instance
                instance
            }
        }
    }
}
```

**è¿ç§»éªŒè¯ï¼š**
- æ—§æ•°æ®è‡ªåŠ¨æ·»åŠ 3ä¸ªnullå­—æ®µï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- æ–°å­—æ®µé»˜è®¤å€¼ä¸ºnullï¼Œè¡¨ç¤º"ç»§æ‰¿å…¨å±€é…ç½®"
- SQLiteè‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ•°æ®è½¬æ¢

---

### 12.3 Domainå±‚æ”¹é€ 

#### 12.3.1 Task Model æ‰©å±•

```kotlin
// feature/todo/domain/model/Task.kt
data class Task(
    val id: String,
    val title: String,
    val description: String?,
    val dueAt: Instant?,
    val priority: Int,
    val completed: Boolean,
    val completedAt: Instant?,
    val createdAt: Instant,
    val updatedAt: Instant,

    // ===== æ–°å¢å­—æ®µ =====
    val reminderEnabled: Boolean? = null,
    val reminderAt: Instant? = null,
    val reminderMinutesBefore: Int? = null
) {
    val priorityLevel: Priority
        get() = when (priority) {
            2 -> Priority.HIGH
            1 -> Priority.MEDIUM
            else -> Priority.LOW
        }

    /**
     * è®¡ç®—å®é™…æé†’æ—¶é—´ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
     *
     * @param globalMinutes å…¨å±€é…ç½®çš„æå‰åˆ†é’Ÿæ•°
     * @param globalEnabled å…¨å±€æé†’æ˜¯å¦å¯ç”¨
     * @return å®é™…æé†’æ—¶é—´ï¼Œnullè¡¨ç¤ºä¸æé†’
     *
     * ä¼˜å…ˆçº§ï¼š
     * 1. æ£€æŸ¥æ˜¯å¦å¯ç”¨ï¼ˆå•æ¡é…ç½® > å…¨å±€é…ç½®ï¼‰
     * 2. æ£€æŸ¥æˆªæ­¢æ—¶é—´æ˜¯å¦å­˜åœ¨
     * 3. ä½¿ç”¨ç»å¯¹æ—¶é—´ï¼ˆå¦‚æœè®¾ç½®ï¼‰
     * 4. ä½¿ç”¨ç›¸å¯¹æ—¶é—´ï¼ˆå•æ¡åˆ†é’Ÿæ•° > å…¨å±€åˆ†é’Ÿæ•°ï¼‰
     */
    fun getEffectiveReminderTime(
        globalMinutes: Int,
        globalEnabled: Boolean
    ): Instant? {
        // æ­¥éª¤1ï¼šæ£€æŸ¥æ˜¯å¦å¯ç”¨æé†’
        val isEnabled = reminderEnabled ?: globalEnabled
        if (!isEnabled) return null

        // æ­¥éª¤2ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æˆªæ­¢æ—¶é—´
        val deadline = dueAt ?: return null

        // æ­¥éª¤3ï¼šä¼˜å…ˆä½¿ç”¨ç»å¯¹æ—¶é—´
        reminderAt?.let { return it }

        // æ­¥éª¤4ï¼šä½¿ç”¨ç›¸å¯¹æ—¶é—´ï¼ˆå•ä»»åŠ¡é…ç½® > å…¨å±€é…ç½®ï¼‰
        val minutesBefore = reminderMinutesBefore ?: globalMinutes
        return deadline.minus(
            minutesBefore.toLong(),
            DateTimeUnit.MINUTE,
            TimeZone.currentSystemDefault()
        )
    }
}
```

**å•å…ƒæµ‹è¯•ç¤ºä¾‹ï¼š**

```kotlin
// feature/todo/domain/model/TaskTest.kt
class TaskTest {
    @Test
    fun `getEffectiveReminderTime - ä½¿ç”¨å…¨å±€é…ç½®`() {
        val task = Task(
            id = "1",
            title = "æµ‹è¯•ä»»åŠ¡",
            dueAt = Instant.parse("2025-10-05T15:00:00Z"),
            reminderEnabled = null,
            reminderAt = null,
            reminderMinutesBefore = null,
            // ... å…¶ä»–å¿…å¡«å­—æ®µçœç•¥
        )

        val result = task.getEffectiveReminderTime(
            globalMinutes = 30,
            globalEnabled = true
        )

        // æ–­è¨€ï¼šåº”è¯¥æ˜¯æˆªæ­¢æ—¶é—´å‰30åˆ†é’Ÿ
        assertEquals(
            Instant.parse("2025-10-05T14:30:00Z"),
            result
        )
    }

    @Test
    fun `getEffectiveReminderTime - å•ä»»åŠ¡ç¦ç”¨`() {
        val task = Task(
            id = "1",
            title = "æµ‹è¯•ä»»åŠ¡",
            dueAt = Instant.parse("2025-10-05T15:00:00Z"),
            reminderEnabled = false,  // å¼ºåˆ¶ç¦ç”¨
            reminderAt = null,
            reminderMinutesBefore = null,
            // ...
        )

        val result = task.getEffectiveReminderTime(
            globalMinutes = 30,
            globalEnabled = true  // å…¨å±€å¯ç”¨ä¹Ÿæ— æ•ˆ
        )

        assertNull(result)
    }

    @Test
    fun `getEffectiveReminderTime - è‡ªå®šä¹‰åˆ†é’Ÿæ•°`() {
        val task = Task(
            id = "1",
            title = "é‡è¦ä¼šè®®",
            dueAt = Instant.parse("2025-10-05T15:00:00Z"),
            reminderEnabled = true,
            reminderAt = null,
            reminderMinutesBefore = 60,  // æå‰60åˆ†é’Ÿ
            // ...
        )

        val result = task.getEffectiveReminderTime(
            globalMinutes = 30,
            globalEnabled = true
        )

        assertEquals(
            Instant.parse("2025-10-05T14:00:00Z"),
            result
        )
    }

    @Test
    fun `getEffectiveReminderTime - ç»å¯¹æ—¶é—´ä¼˜å…ˆ`() {
        val task = Task(
            id = "1",
            title = "é¡¹ç›®æˆªæ­¢",
            dueAt = Instant.parse("2025-10-06T18:00:00Z"),
            reminderEnabled = true,
            reminderAt = Instant.parse("2025-10-05T09:00:00Z"),  // å‰ä¸€å¤©9:00
            reminderMinutesBefore = 60,  // å³ä½¿è®¾ç½®äº†åˆ†é’Ÿæ•°ï¼Œä¹Ÿä¼˜å…ˆä½¿ç”¨ç»å¯¹æ—¶é—´
            // ...
        )

        val result = task.getEffectiveReminderTime(
            globalMinutes = 30,
            globalEnabled = true
        )

        // åº”è¯¥ä½¿ç”¨ç»å¯¹æ—¶é—´ï¼Œè€Œä¸æ˜¯ç›¸å¯¹æ—¶é—´
        assertEquals(
            Instant.parse("2025-10-05T09:00:00Z"),
            result
        )
    }
}
```

---

#### 12.3.2 Habit Model æ‰©å±•

```kotlin
// feature/habit/domain/model/Habit.kt
data class Habit(
    val id: String,
    val title: String,
    val description: String?,
    val period: String,
    val target: Int,
    val color: String,
    val icon: String?,
    val createdAt: Instant,
    val updatedAt: Instant,

    // ===== æ–°å¢å­—æ®µ =====
    val reminderEnabled: Boolean? = null,
    val reminderTime: String? = null  // "HH:mm" æ ¼å¼
) {
    /**
     * è·å–å®é™…æé†’æ—¶é—´ï¼ˆå°æ—¶:åˆ†é’Ÿï¼‰
     *
     * @param globalTime å…¨å±€é…ç½®çš„æé†’æ—¶é—´ï¼ˆå¦‚"20:00"ï¼‰
     * @param globalEnabled å…¨å±€æé†’æ˜¯å¦å¯ç”¨
     * @return Pair<hour, minute>ï¼Œnullè¡¨ç¤ºä¸æé†’
     */
    fun getEffectiveReminderTime(
        globalTime: String,
        globalEnabled: Boolean
    ): Pair<Int, Int>? {
        val isEnabled = reminderEnabled ?: globalEnabled
        if (!isEnabled) return null

        val timeStr = reminderTime ?: globalTime
        val parts = timeStr.split(":")
        return Pair(parts[0].toInt(), parts[1].toInt())
    }
}
```

---

### 12.4 Repositoryå±‚æ”¹é€ 

#### 12.4.1 TodoRepository æ¥å£æ‰©å±•

```kotlin
// feature/todo/domain/repository/TodoRepository.kt
interface TodoRepository {
    // ===== ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜ =====
    fun getAllTodos(): Flow<List<Task>>
    suspend fun addTodo(...): BaseResult<Task>
    // ...

    // ===== æ–°å¢æ–¹æ³•ï¼ˆPhase 2ï¼‰ =====
    /**
     * æ›´æ–°ä»»åŠ¡æé†’é…ç½®
     *
     * @param todoId ä»»åŠ¡ID
     * @param reminderEnabled æ˜¯å¦å¯ç”¨æé†’ï¼ˆnull=ç»§æ‰¿å…¨å±€ï¼‰
     * @param reminderAt ç»å¯¹æé†’æ—¶é—´ï¼ˆnull=ä½¿ç”¨ç›¸å¯¹æ—¶é—´ï¼‰
     * @param reminderMinutesBefore æå‰åˆ†é’Ÿæ•°ï¼ˆnull=ä½¿ç”¨å…¨å±€é…ç½®ï¼‰
     */
    suspend fun updateTaskReminder(
        todoId: String,
        reminderEnabled: Boolean?,
        reminderAt: Instant?,
        reminderMinutesBefore: Int?
    ): BaseResult<Unit>
}
```

---

#### 12.4.2 TodoRepositoryImpl å®ç°

```kotlin
// feature/todo/data/repository/TodoRepositoryImpl.kt
class TodoRepositoryImpl @Inject constructor(
    private val taskDao: TaskDao,
    private val userApi: UserApi
) : TodoRepository {

    // ===== æ–°å¢æ–¹æ³•å®ç° =====
    override suspend fun updateTaskReminder(
        todoId: String,
        reminderEnabled: Boolean?,
        reminderAt: Instant?,
        reminderMinutesBefore: Int?
    ): BaseResult<Unit> = withContext(Dispatchers.IO) {
        try {
            val userId = userApi.getCurrentUserId()
            val task = taskDao.getTaskById(todoId)
                ?: return@withContext BaseResult.Error("Task not found")

            // æ›´æ–°æé†’å­—æ®µ
            val updated = task.copy(
                reminderEnabled = reminderEnabled,
                reminderAt = reminderAt?.toEpochMilliseconds(),
                reminderMinutesBefore = reminderMinutesBefore,
                updatedAt = Clock.System.now().toEpochMilliseconds(),
                syncStatus = SyncStatus.PENDING_SYNC
            )

            taskDao.updateTask(updated)

            Log.d("TodoRepository", "Task reminder updated: $todoId")
            BaseResult.Success(Unit)

        } catch (e: Exception) {
            Log.e("TodoRepository", "Failed to update task reminder", e)
            BaseResult.Error(e.message ?: "Update failed")
        }
    }

    // ===== ä¿®æ”¹ç°æœ‰çš„ toTask() æ˜ å°„å‡½æ•° =====
    private fun TaskEntity.toTask(): Task = Task(
        id = id,
        title = title,
        description = description,
        dueAt = dueAt?.let { Instant.fromEpochMilliseconds(it) },
        priority = priority,
        completed = completed,
        completedAt = completedAt?.let { Instant.fromEpochMilliseconds(it) },
        createdAt = Instant.fromEpochMilliseconds(createdAt),
        updatedAt = Instant.fromEpochMilliseconds(updatedAt),

        // ===== æ–°å¢å­—æ®µæ˜ å°„ =====
        reminderEnabled = reminderEnabled,
        reminderAt = reminderAt?.let { Instant.fromEpochMilliseconds(it) },
        reminderMinutesBefore = reminderMinutesBefore
    )
}
```

---

### 12.5 UIå±‚æ”¹é€ 

#### 12.5.1 TaskReminderSettingSection ç»„ä»¶ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `feature/todo/src/main/kotlin/com/ccxiaoji/feature/todo/presentation/component/TaskReminderSettingSection.kt`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
1. æ”¯æŒ3ç§æé†’æ¨¡å¼ï¼š
   - ä½¿ç”¨å…¨å±€é…ç½®ï¼ˆé»˜è®¤ï¼‰
   - è‡ªå®šä¹‰æé†’æ—¶é—´ï¼ˆ5åˆ†é’Ÿ~1å¤©ï¼‰
   - å…³é—­æé†’
2. ä»…åœ¨æœ‰æˆªæ­¢æ—¥æœŸæ—¶æ˜¾ç¤º
3. æä¾›7ä¸ªå¸¸ç”¨æ—¶é—´é€‰é¡¹ï¼š5åˆ†é’Ÿã€15åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ã€2å°æ—¶ã€1å¤©

**é›†æˆä½ç½®ï¼š** `AddEditTaskScreen.kt:237-244`

---

#### 12.5.2 HabitReminderSettingSection ç»„ä»¶ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `feature/habit/src/main/kotlin/com/ccxiaoji/feature/habit/presentation/component/HabitReminderSettingSection.kt`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
1. æ”¯æŒ3ç§æé†’æ¨¡å¼ï¼š
   - ä½¿ç”¨å…¨å±€é…ç½®ï¼ˆé»˜è®¤ï¼‰
   - è‡ªå®šä¹‰æ—¶é—´ï¼ˆ7:00-22:00ï¼‰
   - å…³é—­æé†’
2. æä¾›8ä¸ªå¸¸ç”¨æ—¶é—´é€‰é¡¹ï¼š7:00ã€8:00ã€12:00ã€18:00ã€19:00ã€20:00ã€21:00ã€22:00
3. æ—¶é—´æ ¼å¼ä¸º HH:mm

**é›†æˆä½ç½®ï¼š** `AddEditHabitScreen.kt:326-331`

---

#### 12.5.3 ViewModel æ‰©å±•ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**AddEditTaskViewModel æ”¹é€ ï¼š**
- æ–°å¢çŠ¶æ€å­—æ®µï¼š`reminderEnabled`, `reminderMinutesBefore`
- æ³¨å…¥ `TodoRepository` ç”¨äºè°ƒç”¨ `updateTaskReminder()`
- æ–°å¢æ–¹æ³•ï¼š`updateReminderEnabled()`, `updateReminderMinutesBefore()`
- ä¿®æ”¹ `saveTask()` åœ¨ä¿å­˜åè°ƒç”¨ `updateTaskReminder()`

**AddEditHabitViewModel æ”¹é€ ï¼š**
- æ–°å¢çŠ¶æ€å­—æ®µï¼š`reminderEnabled`, `reminderTime`
- æ³¨å…¥ `HabitRepository` ç”¨äºè°ƒç”¨ `updateHabitReminder()`
- æ–°å¢æ–¹æ³•ï¼š`updateReminderEnabled()`, `updateReminderTime()`
- ä¿®æ”¹ `saveHabit()` åœ¨ä¿å­˜åè°ƒç”¨ `updateHabitReminder()`

---

### 12.6 NotificationScheduler æ”¹é€ ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 12.6.1 P0 é—®é¢˜ä¿®å¤

**ä¿®å¤å†…å®¹ï¼š** `scheduleTaskReminder()` æ–¹æ³•ç¡¬ç¼–ç 30åˆ†é’Ÿé—®é¢˜

**ä¿®å¤å‰ï¼š**
```kotlin
val reminderDelay = (delay - TimeUnit.MINUTES.toMillis(30)).coerceAtLeast(0)
// âŒ ç¡¬ç¼–ç  30 åˆ†é’Ÿ
```

**ä¿®å¤åï¼š**
```kotlin
fun scheduleTaskReminder(
    taskId: String,
    taskTitle: String,
    dueAt: Instant,
    reminderMinutes: Int = 30  // æå‰æé†’åˆ†é’Ÿæ•°ï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
) {
    // ...
    val reminderDelay = (delay - TimeUnit.MINUTES.toMillis(reminderMinutes.toLong())).coerceAtLeast(0)
    // âœ… è¯»å–ç”¨æˆ·é…ç½®
}
```

**å½±å“èŒƒå›´ï¼š**
- `NotificationScheduler.kt:39-52` - æ·»åŠ  reminderMinutes å‚æ•°
- `NotificationSettingsViewModel.kt:101-106` - è¯»å–é…ç½®å¹¶ä¼ é€’

---

#### 12.6.2 æ—¥å¿—å’Œå¼‚å¸¸å¤„ç†ä¼˜åŒ–

**ä¼˜åŒ–å†…å®¹ï¼š**
1. **scheduleTaskReminder** - æ·»åŠ è¯¦ç»†æ—¥å¿—å’Œ try-catch
2. **scheduleDailyHabitReminder** - æ·»åŠ è¯¦ç»†æ—¥å¿—å’Œ try-catch
3. **cancelTaskReminder** - æ·»åŠ æ—¥å¿—å’Œå¼‚å¸¸å¤„ç†
4. **cancelHabitReminder** - æ·»åŠ æ—¥å¿—å’Œå¼‚å¸¸å¤„ç†

**æ—¥å¿—ç¤ºä¾‹ï¼š**
```kotlin
Log.d(TAG, "Scheduling task reminder: taskId=$taskId, title=$taskTitle, dueAt=$dueAt, reminderMinutes=$reminderMinutes")
Log.d(TAG, "Task reminder scheduled successfully: taskId=$taskId, delay=${reminderDelay}ms")
Log.w(TAG, "Task already overdue, skipping reminder: taskId=$taskId")
Log.e(TAG, "Error scheduling task reminder: taskId=$taskId", e)
```

---

### 12.7 å®æ–½æ­¥éª¤ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### Phase 1 - æ•°æ®åº“ä¸æ¨¡å‹å±‚ï¼ˆå·²å®Œæˆ 2025-10-04ï¼‰
- [x] åˆ›å»º MIGRATION_21_22 æ•°æ®åº“è¿ç§»è„šæœ¬
- [x] æ‰©å±• TaskEntity æ·»åŠ 3ä¸ªæé†’å­—æ®µ
- [x] æ‰©å±• HabitEntity æ·»åŠ 2ä¸ªæé†’å­—æ®µ
- [x] Task æ¨¡å‹å®ç° getEffectiveReminderTime() æ–¹æ³•
- [x] Habit æ¨¡å‹å®ç° getEffectiveReminderTime() æ–¹æ³•
- [x] æ›´æ–° Entityâ†’Model æ˜ å°„å‡½æ•°
- [x] ç¼–è¯‘éªŒè¯é€šè¿‡

#### Phase 2 - Repositoryä¸è°ƒåº¦å±‚ï¼ˆå·²å®Œæˆ 2025-10-04ï¼‰
- [x] æ‰©å±• TodoRepository æ¥å£ï¼ˆupdateTaskReminder æ–¹æ³•ï¼‰
- [x] æ‰©å±• HabitRepository æ¥å£ï¼ˆupdateHabitReminder æ–¹æ³•ï¼‰
- [x] å®ç° TodoRepositoryImpl.updateTaskReminder()
- [x] å®ç° HabitRepositoryImpl.updateHabitReminder()
- [x] **ä¿®å¤ P0 é—®é¢˜**ï¼šNotificationScheduler è¯»å–ç”¨æˆ·é…ç½®
- [x] ä¿®æ”¹ NotificationSettingsViewModel ä¼ é€’é…ç½®å‚æ•°
- [x] ç¼–è¯‘éªŒè¯é€šè¿‡

#### Phase 3 - UIå±‚å®ç°ï¼ˆå·²å®Œæˆ 2025-10-04ï¼‰
- [x] æ‰©å±• AddEditTaskViewModel æ”¯æŒæé†’è®¾ç½®
- [x] åˆ›å»º TaskReminderSettingSection ç»„ä»¶
- [x] é›†æˆåˆ° AddEditTaskScreen
- [x] æ‰©å±• AddEditHabitViewModel æ”¯æŒæé†’è®¾ç½®
- [x] åˆ›å»º HabitReminderSettingSection ç»„ä»¶
- [x] é›†æˆåˆ° AddEditHabitScreen
- [x] ç¼–è¯‘éªŒè¯é€šè¿‡

#### Phase 4 - æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆå·²å®Œæˆ 2025-10-04ï¼‰
- [x] ç¼–å†™ TaskTest.kt å•å…ƒæµ‹è¯•ï¼ˆ7ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [x] ç¼–å†™ HabitTest.kt å•å…ƒæµ‹è¯•ï¼ˆ8ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [x] ç¼–å†™ MigrationTest.kt æ•°æ®åº“è¿ç§»æµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [x] ä»£ç å®¡æŸ¥å’Œä¼˜åŒ–ï¼ˆæ—¥å¿—ã€å¼‚å¸¸å¤„ç†ï¼‰
- [x] æ›´æ–°æ–‡æ¡£

---

### 12.8 æµ‹è¯•æ–¹æ¡ˆ

#### 12.8.1 å•å…ƒæµ‹è¯•ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**TaskTest.kt** - 7ä¸ªæµ‹è¯•ç”¨ä¾‹
1. âœ… ä½¿ç”¨å…¨å±€é…ç½®
2. âœ… å•ä»»åŠ¡ç¦ç”¨æé†’
3. âœ… è‡ªå®šä¹‰æå‰åˆ†é’Ÿæ•°
4. âœ… ç»å¯¹æ—¶é—´ä¼˜å…ˆ
5. âœ… æ— æˆªæ­¢æ—¶é—´
6. âœ… å…¨å±€å…³é—­ä¸”å•ä»»åŠ¡æœªå¯ç”¨
7. âœ… å•ä»»åŠ¡å¼ºåˆ¶å¯ç”¨è¦†ç›–å…¨å±€å…³é—­

**HabitTest.kt** - 8ä¸ªæµ‹è¯•ç”¨ä¾‹
1. âœ… ä½¿ç”¨å…¨å±€é…ç½®
2. âœ… å•ä¹ æƒ¯ç¦ç”¨æé†’
3. âœ… è‡ªå®šä¹‰æé†’æ—¶é—´
4. âœ… è‡ªå®šä¹‰æ—¶é—´åŒ…å«åˆ†é’Ÿ
5. âœ… å…¨å±€å…³é—­ä¸”å•ä¹ æƒ¯æœªå¯ç”¨
6. âœ… å•ä¹ æƒ¯å¼ºåˆ¶å¯ç”¨è¦†ç›–å…¨å±€å…³é—­
7. âœ… è¾¹ç•Œæ—¶é—´ï¼ˆ23:59ï¼‰
8. âœ… è¾¹ç•Œæ—¶é—´ï¼ˆ00:00ï¼‰

**MigrationTest.kt** - 4ä¸ªæµ‹è¯•ç”¨ä¾‹
1. âœ… migrate21To22_TasksTable_AddsReminderFields
2. âœ… migrate21To22_HabitsTable_AddsReminderFields
3. âœ… migrateAll_20To21To22_NoDataLoss
4. âœ… createDatabase_Version22_ContainsAllFields

---

#### 12.8.2 ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå¾…å®é™…è¿è¡Œåº”ç”¨éªŒè¯ï¼‰

**Task-006: ä»»åŠ¡æé†’ç«¯åˆ°ç«¯æµ‹è¯•**
- â³ åˆ›å»ºä»»åŠ¡åWorkå­˜åœ¨
- â³ 30åˆ†é’Ÿå‰æ”¶åˆ°é€šçŸ¥
- â³ ç‚¹å‡»é€šçŸ¥è·³è½¬æ­£ç¡®
- â³ å…³é—­å¼€å…³Workå–æ¶ˆ

**Task-007: ä¹ æƒ¯æé†’ç«¯åˆ°ç«¯æµ‹è¯•**
- â³ é¦–æ¬¡æé†’è§¦å‘
- â³ ç‚¹å‡»é€šçŸ¥è·³è½¬æ­£ç¡®
- â³ æ¬¡æ—¥é‡å¤æé†’
- â³ ä¿®æ”¹æ—¶é—´åç”Ÿæ•ˆ
- â³ å…³é—­å¼€å…³åœæ­¢æé†’

**éªŒè¯æ–¹æ³•ï¼š**
```bash
# æŸ¥çœ‹WorkManagerä¸­çš„Work
adb shell dumpsys activity service WorkManagerService

# æˆ–ä½¿ç”¨Android Studioçš„ App Inspection â†’ WorkManager
# å¼€å¯æé†’ååº”çœ‹åˆ°å¤šä¸ª task_reminder_* çš„Work
# å…³é—­æé†’åè¿™äº›Workåº”æ¶ˆå¤±
```

---

### 12.9 å‘åå…¼å®¹ä¿è¯

#### 12.9.1 æ•°æ®åº“è¿ç§»ç­–ç•¥

**æ ¸å¿ƒåŸåˆ™ï¼š** æ—§æ•°æ®å­—æ®µé»˜è®¤ä¸º null = ç»§æ‰¿å…¨å±€é…ç½®

**è¿ç§»è„šæœ¬ï¼š**
```sql
-- tasks è¡¨æ·»åŠ å­—æ®µ
ALTER TABLE tasks ADD COLUMN reminderEnabled INTEGER DEFAULT NULL
ALTER TABLE tasks ADD COLUMN reminderAt INTEGER DEFAULT NULL
ALTER TABLE tasks ADD COLUMN reminderMinutesBefore INTEGER DEFAULT NULL

-- habits è¡¨æ·»åŠ å­—æ®µ
ALTER TABLE habits ADD COLUMN reminderEnabled INTEGER DEFAULT NULL
ALTER TABLE habits ADD COLUMN reminderTime TEXT DEFAULT NULL
```

**å‘åå…¼å®¹éªŒè¯ï¼š**
1. âœ… æ—§æ•°æ®è¿ç§»åï¼Œæ‰€æœ‰æé†’å­—æ®µä¸º null
2. âœ… `getEffectiveReminderTime(globalMinutes, globalEnabled)` æ–¹æ³•å¯¹ null å€¼å¤„ç†æ­£ç¡®
3. âœ… æ—§æ•°æ®ç»§ç»­ä½¿ç”¨å…¨å±€é…ç½®ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®
4. âœ… æ–°æ•°æ®å¯ä»¥è‡ªç”±é€‰æ‹©ï¼šå…¨å±€é…ç½® / è‡ªå®šä¹‰ / å…³é—­

---

#### 12.9.2 ä¸šåŠ¡é€»è¾‘å…¼å®¹æ€§

**Task.getEffectiveReminderTime() ä¼˜å…ˆçº§ï¼š**
1. reminderEnabled åˆ¤æ–­ï¼š`val isEnabled = reminderEnabled ?: globalEnabled`
2. æˆªæ­¢æ—¶é—´æ£€æŸ¥ï¼š`val deadline = dueAt ?: return null`
3. ç»å¯¹æ—¶é—´ä¼˜å…ˆï¼š`reminderAt?.let { return it }`
4. ç›¸å¯¹æ—¶é—´è®¡ç®—ï¼š`val minutesBefore = reminderMinutesBefore ?: globalMinutes`

**Habit.getEffectiveReminderTime() ä¼˜å…ˆçº§ï¼š**
1. reminderEnabled åˆ¤æ–­ï¼š`val isEnabled = reminderEnabled ?: globalEnabled`
2. æ—¶é—´é€‰æ‹©ï¼š`val timeStr = reminderTime ?: globalTime`

**ç»“è®ºï¼š** æ‰€æœ‰é€»è¾‘éƒ½ä½¿ç”¨ Elvis æ“ä½œç¬¦ (`?:`)ï¼Œç¡®ä¿ null å€¼æ­£ç¡®å›é€€åˆ°å…¨å±€é…ç½®ã€‚

---

#### 12.9.3 ç”¨æˆ·ä½“éªŒä¿è¯

**æ— ç¼å‡çº§ä½“éªŒï¼š**
1. ç”¨æˆ·å‡çº§åˆ° v22 åï¼Œæ— éœ€ä»»ä½•æ“ä½œ
2. ç°æœ‰ä»»åŠ¡/ä¹ æƒ¯ç»§ç»­ä½¿ç”¨å…¨å±€é…ç½®
3. æ–°åˆ›å»ºçš„ä»»åŠ¡/ä¹ æƒ¯å¯é€‰æ‹©è‡ªå®šä¹‰æé†’
4. ç”¨æˆ·å¯ä»¥é€æ­¥ä¸ºé‡è¦ä»»åŠ¡/ä¹ æƒ¯è®¾ç½®å•ç‹¬æé†’

**é…ç½®ä¼˜å…ˆçº§è¯´æ˜ï¼ˆUIå±•ç¤ºï¼‰ï¼š**
- "ä½¿ç”¨å…¨å±€é…ç½®"ï¼ˆé»˜è®¤ï¼‰ - è·Ÿéšé€šçŸ¥è®¾ç½®çš„å…¨å±€æ—¶é—´
- "è‡ªå®šä¹‰æé†’" - è¦†ç›–å…¨å±€é…ç½®
- "å…³é—­æé†’" - å³ä½¿å…¨å±€å¼€å¯ä¹Ÿä¸æé†’

---

## æ€»ç»“

Phase 2 æ–¹æ¡ˆå·²å…¨éƒ¨å®ç°å¹¶éªŒè¯ï¼š

**âœ… å·²å®Œæˆï¼š**
1. æ•°æ®åº“è¿ç§»ï¼ˆv21 â†’ v22ï¼‰
2. Domain å±‚æé†’æ—¶é—´è®¡ç®—é€»è¾‘
3. Repository å±‚æé†’æ›´æ–°æ¥å£
4. UI å±‚æé†’è®¾ç½®ç»„ä»¶
5. P0 é—®é¢˜ä¿®å¤ï¼ˆç¡¬ç¼–ç 30åˆ†é’Ÿï¼‰
6. ä»£ç ä¼˜åŒ–ï¼ˆæ—¥å¿—ã€å¼‚å¸¸å¤„ç†ï¼‰
7. å•å…ƒæµ‹è¯•ï¼ˆ19ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
8. æ•°æ®åº“è¿ç§»æµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

**â³ å¾…éªŒè¯ï¼ˆéœ€å®é™…è¿è¡Œåº”ç”¨ï¼‰ï¼š**
1. Task-006 ç«¯åˆ°ç«¯æµ‹è¯• - ä»»åŠ¡æé†’
2. Task-007 ç«¯åˆ°ç«¯æµ‹è¯• - ä¹ æƒ¯æé†’

**ğŸ“Š å¼€å‘ç»Ÿè®¡ï¼š**
- å®é™…å¼€å‘æ—¶é—´ï¼šçº¦ 6.5 å°æ—¶ï¼ˆå«æµ‹è¯•ç¼–å†™ï¼‰
- é¢„è®¡å·¥æœŸï¼š4 å¤© â†’ å®é™…ï¼š1 å¤©
- ä»£ç è´¨é‡ï¼šç¼–è¯‘é€šè¿‡ âœ…ï¼Œå•å…ƒæµ‹è¯•è¦†ç›–å…¨é¢ âœ…

---

ï¼ˆæœ¬æ–‡ä»¶ä¸ºä¸´æ—¶æ–‡ä»¶ï¼Œå°†åˆå¹¶åˆ°ä¸»æ–‡æ¡£ï¼‰
