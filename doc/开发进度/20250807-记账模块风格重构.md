# 记账模块风格重构 Demo（方案2：独立入口）规划 v2.0

> 日期：2025-08-07（按甲方要求归档日期）
> 决策：采用“方案2｜独立入口”，在测试版中以单独入口打开 Demo 页面；不影响现有正式功能。

> 变更历史：
> - v2.0（范围升级）：范围扩展为“记账模块全部页面与完整操作链路”；风格=布局差异（不仅是颜色）；引入 LayoutSpec 协议族与风格派发；明确 Debug 独立导航覆盖新增/编辑/详情/筛选/批量/账户/预算/信用卡/统计/设置；提供可写“沙箱账本”开关；补充工程落地清单与验收标准。
> - v1.1（复评修订）：修正 LAUNCHER 导出设置；明确源集隔离到 debug；补充 Hilt 注入与 ViewModel 获取方式；新增 A–K 到基底风格映射；补充暗色微缩预览、可访问性与极端数据策略、合并验证与截图矩阵规范。

## 一、范围与目标（升级）
- 范围：记账模块“全部页面族”与“完整操作链路”的风格化 Demo（Debug 变体独立入口）。覆盖但不限于：账本首页/交易列表、交易详情/编辑/新增（含转账）、筛选/搜索/分页、批量操作、账户与资产、预算、分类、卡片、信用卡、定投、储蓄、统计、设置等。
- 目标：每套风格体现“可感知的布局差异”（信息层级、编排、密度、分隔、对齐、容器、控件样式），而不仅是颜色/圆角/阴影；A–K 共 11 套（含暗色）、两档密度（紧凑/中等）。
- 约束：不修改业务/数据结构与网络；生产页面外观不改变。Demo 改造全部放在 debug 源集；如需对生产代码做挂钩，仅做非侵入式“令牌/接口化”以支持风格注入（不改变现有外观）。

## 二、交互范围（升级）
- 顶部工具条：
  - 风格切换：A–K（默认 B）
  - 信息密度：紧凑 | 中等（默认中等）
  - 明/暗预览：随系统/风格自动切换，Demo 内提供明暗预览卡
- 导航与操作（全链路）：
  - 账本首页 → 列表 → 详情 → 编辑/新增/转账 → 选择器/筛选/批量 → 返回首页；各步可操作且与风格布局匹配
  - “写入行为”默认写入 Debug 专用“沙箱账本”（不污染生产数据）；提供只读/可写开关

## 三、入口方案（方案2：独立入口）
- 形式：独立 Activity，仅在 debug 构建可见；带 LAUNCHER 图标“风格 Demo（记账）”。
- 可见性：debug 变体添加 `LAUNCHER`，release 不包含该 Activity（零风险上线）。
- 导航：Demo 内自带独立导航栈（不接入主应用导航），覆盖记账模块主要页面链路；返回退出 Demo。

## 四、目录与文件（新增，示意）
- feature/ledger/src/debug/AndroidManifest.xml
  - 声明 `StyleCatalogDemoActivity`（`android:exported="true"`，含 `MAIN+LAUNCHER`；release 变体不合入）。
- feature/ledger/src/debug/kotlin/com/ccxiaoji/feature/ledger/presentation/demo/stylecatalog/
  - StyleCatalogDemoActivity.kt（`@AndroidEntryPoint`，设置 Content 为 DemoNavHost）
  - navigation/DemoNavHost.kt（独立导航，覆盖模块主要页面链路）
  - theme/DemoTheme.kt（组合 Local：风格/明暗/密度 → DesignTokens）
  - theme/DemoDensity.kt（紧凑/中等：行高/内边距/卡片 padding 等）
  - theme/DemoStyles.kt（A–K 风格到“基底风格+令牌”的映射，含暗色）
  - spec/（风格=布局协议族与实现）
    - LayoutSpec.kt（接口：ListSpec/ItemSpec/HeaderSpec/FilterSpec/OverviewSpec/FormSpec/DialogSpec/ChartsSpec）
    - SpecsRegistry.kt（A–K → 对应 Spec 实例派发）
    - impl/materialYou/*、impl/highContrast/*、impl/neoBrutalism/*（三套代表风格的布局实现）
  - adapters/（将 Spec 应用于现有可风格化组件，或提供 Demo 专用外观包裹）
- feature/ledger/src/debug/kotlin/com/ccxiaoji/feature/ledger/presentation/demo/pages/
  - LedgerHomePage.kt、TransactionListPage.kt、TransactionDetailPage.kt、AddEditTransactionPage.kt、FilterPage.kt、BatchPage.kt、AccountPages.kt、BudgetPages.kt、CategoryPages.kt、CreditCardPages.kt、StatisticsPages.kt、SettingsPages.kt（外层包裹生产 Screen，注入风格容器与只读/沙箱写入开关）
- feature/ledger/src/debug/res/values/strings.xml（Demo 文案）
- feature/ledger/src/debug/res/mipmap-anydpi-v26/ic_style_demo.xml（Demo 图标，或占位）

说明：以上均为“增量文件”，不替换、不修改现有生产页面与逻辑；必要时仅做非侵入式包裹。

## 五、技术方案要点（落地）
1) 风格=布局协议（LayoutSpec）
   - 定义接口族：ListSpec、ItemSpec、HeaderSpec、FilterSpec、OverviewSpec、FormSpec、DialogSpec、ChartsSpec。
   - A–K 每套风格映射到一组 Spec 实现（可引用“基底风格 Balanced/Hierarchical”并叠加差异）。

2) 令牌与主题复用
   - 必须复用 `core/ui/DesignTokens`；`DemoTheme` 仅做“风格/密度/明暗 → Tokens”的映射层，不自建平行主题体系。
   - 暗色按风格映射；Demo 提供明/暗预览卡，不单独交互。

3) 组件与数据复用
   - 全部页面复用现有 ViewModel 与仓库；列表/详情/编辑等读写真实数据。
   - 写入采用“沙箱账本”（Debug 专用）或配置只读模式；默认开启沙箱写入。
   - 优先通过 `StyleableComponentFactory` 注入 Spec；无法覆盖的外观差异用 `adapters` 层做“仅视觉包裹”。

4) 导航与隔离
   - Demo 使用独立 NavHost 覆盖记账模块主要链路；不接入主应用导航。
   - 所有新增文件放置于 debug 源集；生产代码仅在必要处暴露接口/令牌入口（不改变现有视觉）。

5) 性能与可访问性
   - 列表首屏 60fps；切换风格/密度仅替换 Spec/Token，不重建 ViewModel；`Lazy*` 提供稳定 `key`。
   - 对比度 AA：正文≥4.5:1，次要≥3:1；系统字号放大至 1.3x 版式不破。
   - 玻璃拟态（D）在低端机降级：降低模糊或改渐变；K 风格的硬阴影用容器绘制避免深层重绘。

## 六、风格映射（A–K，含布局差异要点）
为避免重复维护，颜色/圆角/阴影/边框等细节以《视觉规范 v1》为准；此处强调“布局差异”要点：
- A 现代极简：克制留白，卡片弱化，金额右对齐，两行信息；默认中等
- B 卡片化（默认）：卡片分区、柔和阴影，摘要三栏，日期吸顶；默认中等
- C 高对比：无卡片、强分隔线、单行紧凑，图标小且靠左；默认紧凑
- D 玻璃拟态：半透明叠层、毛玻璃顶部摘要、悬浮筛选；默认中等
- E 马卡龙：圆润容器、标签高可见、柔性色块条；默认中等
- F 账本质感：纸张纹理、细分隔、角标标签、可折叠节标题；默认中等
- G iOS 18：大标题、通透卡片、分段控件筛选、底部操作条；默认中等
- H Material You：Tonal surfaces、胶囊筛选、可扩展列表项；默认中等
- I Discord：深色分层、紧凑信息、频道式节标题；默认紧凑
- J Notion 极简：黑白灰、细分隔、清单式对齐、标签外露；默认中等
- K Neo‑Brutalism：硬边框+投影、块状布局、大按钮、标签块；默认紧凑

密度：紧凑（36 行高 / 8 内边距 / 12 卡片 padding）、中等（44/12/16）。

## 七、页面骨架（低保真，已拍板）
- 头部栏：标题“记账 · 交易列表 · Demo”，右侧“风格下拉 A–K + 密度切换”。
- 汇总卡：收入/支出/结余（展示用）。
- 筛选条：日期/分类/账户/搜索（禁用态）。
- 分组列表：日期分组 + 行内：日期 | 分类 | 备注 | 账户 | 金额 | 标签。
- 分页：页码展示（禁用态）。
 - 明/暗微缩预览：页头展示当前风格的明/暗两张迷你示意卡（只读、不可点），用于可读性对照。

## 八、实施步骤（按批次推进）
1) 搭建独立入口与骨架
   - 新增 debug Manifest 与 `StyleCatalogDemoActivity`。
   - 实现 `StyleCatalogDemoScreen` 最小骨架（静态文案 + 占位列表）。

2) 接入真实数据（只读）
   - 绑定 `LedgerViewModel` 的交易集合；禁用其它事件。

3) 主题与令牌
   - 完成 `DemoTheme/DemoStyles/DemoDensity`，可切换 A–K 与紧凑/中等。
   - 暗色映射接入但不暴露交互。

4) 视觉适配
   - 用外层容器 + 令牌完成 A、B、C、D 四种代表风格；
   - 扩展到其余 E、F、G、H、I、J、K。

5) 可访问性与性能专项
   - 对比度批量自检；
   - 检测切换卡顿（单帧生效、不触发重组风暴）。

6) 联调与验收
   - 核对风格一致性与密度一致性；
   - 通过清单逐项打勾（见下）。

## 九、测试与验收清单
- 交互
  - [ ] 仅风格下拉与密度切换可交互；其余控件灰态或无响应。
  - [ ] 切换风格不影响数据排序/分组/展示字段。
- 视觉
  - [ ] A–K 每个风格与 v1 规范一致（颜色/圆角/边框/阴影）。
  - [ ] 暗色与明色对照一致、可读性达标。
  - [ ] 紧凑/中等切换仅影响行高/内边距，不改变列字段、顺序与逻辑。
- 性能
  - [ ] 首屏 60fps，无明显掉帧；
  - [ ] 切换风格/密度时 1 帧生效，重组时间 < 16ms（设备：中端 Android）。
- 隔离性
  - [ ] Demo 不修改现有 `LedgerScreen` 与业务链路；
  - [ ] release 构建不包含 Demo 入口。
 - 可访问性
   - [ ] 页头控件具备清晰焦点样式与可达顺序；列表项的悬停/选中态与焦点环一致。
 - 极端数据版式
   - [ ] 长备注/超大金额/多标签不溢出：采用截断（省略号）+ 可选 Tooltip 或软换行策略，保持行高稳定。

## 十、风险与缓解
- 风格 K（新野性）需要强边框/硬阴影：采用容器包裹与局部绘制，避免触碰业务组件。
- 玻璃拟态（D）在低端机性能：降低模糊半径，改为渐变近似（Android < 11 或 GPU Jank 明显时自动降级）。
- 字体/字号在高密度模式可读性：上限压不低于 12sp，行高≥36px。

### 验收标准（Debug 构建）
1) 构建与入口：
   - `:app:assembleDebug` 成功；桌面出现“风格 Demo（记账）”图标；点击进入 Demo。
2) 导航与链路：
   - 可从首页进入列表、查看详情、进入编辑/新增/转账、使用筛选与批量、访问账户/预算/分类/信用卡/统计/设置（风格容器包裹）。
3) 风格差异：
   - 在 H/C/K 三套风格下，列表/表单/筛选/概览/分页布局存在明确差异（不仅颜色），密度切换有效；滚动与切换流畅。
4) 数据策略：
   - 默认写入沙箱账本；切换“只读/可写”后，新增/编辑/转账能成功提交（仅影响沙箱）。
5) 可访问性与性能：
   - 对比度满足 AA；字号 1.3x 布局稳定；列表首屏 60fps；切换风格/密度无明显抖动。
6) 合并清单检查：
   - `app/build/intermediates/merged_manifests/debug/AndroidManifest.xml` 中存在 `StyleCatalogDemoActivity`，且含 `MAIN+LAUNCHER` 与 `exported="true"`。

## 十一、时间规划（估算）
- D1：入口与独立导航骨架、接入只读数据（列表/详情/编辑容器）
- D2：LayoutSpec + H/C/K 三套代表风格（列表/表单/筛选/概览/分页）
- D3：其余风格 A/B/D/E/F/G/I/J；账户/预算/分类/信用卡等页面容器化
- D4：只读/可写沙箱写入、可访问性/性能优化 + 验收修订
- 交付：D4 提供 Debug APK 与源码变更清单（仅 debug 增量）

## 十二、里程碑与产物
- 里程碑 M1：可运行的独立导航骨架（只读）
- 里程碑 M2：H/C/K 三套风格完成，核心链路可操作（沙箱）
- 里程碑 M3：A–K 全部完成 + 明暗/密度矩阵
- 里程碑 M4：通过验收清单，提交 Demo APK 与源码变更列表（仅增量文件）

截图矩阵规范（评审物料）：
- 每个风格导出 3 张：明-中等、明-紧凑、暗-中等（共 33 张）。
- 命名：`theme-<A..K>__mode-<light|dark>__density-<medium|compact>.png`。
- 截图区域：优先“交易列表页”首屏（含页头/概览/分组列表），必要时补“表单页”首屏。

## 十三、后续路径（如 Demo 通过）
- 在生产页面逐步引入令牌（分屏迁移），保持功能不变，仅替换样式容器。
- 先 A/B/C 三种安全风格上线为主题包，D/K 等个性风格另行评审。

## 十四、TODO（与甲方同步清单）
- [ ] A–K 是否全部保留为最终交付主题？（默认：全部保留）
- [ ] 是否需要导出三张对照截图（明/暗/密度）用于评审归档？（默认：需要）
- [ ] Demo 入口图标与名称文案确认（默认：“风格 Demo（记账）”）。
- [ ] 是否默认开启“沙箱账本可写”？（默认：开启，可切换只读）


（本文件仅为实施计划，不包含任何功能改动；待甲方逐条确认后，再进入 Demo 开发阶段。）

---

## 技术评审意见（乙方专业评估）

> 评审人：技术乙方团队
> 评审日期：2025-09-07
> 评审版本：v1

### 一、总体评价

**评分：4/5 ⭐⭐⭐⭐☆**

本方案采用"独立Demo入口"策略，是一个**技术可行、风险可控、目标明确**的实施方案。方案在技术架构、风险控制、测试验证等方面都有充分考虑，特别是零风险上线的设计思路值得肯定。

### 二、方案优势分析

#### 1. 风险控制优秀
- ✅ 独立入口设计，完全隔离生产环境
- ✅ Debug版本限定，正式版零影响
- ✅ 只做展示层调整，不触碰业务核心
- ✅ 增量式开发，不修改现有代码

#### 2. 技术架构合理
- ✅ 采用设计令牌（Design Token）系统，符合业界最佳实践
- ✅ 组件复用策略得当，最大化利用现有资产
- ✅ 主题切换机制成熟，单帧响应设计合理
- ✅ CompositionLocal模式适合主题传递

#### 3. 质量保障完善
- ✅ 明确的性能指标（60fps、<16ms切换）
- ✅ 可访问性标准量化（AA级对比度）
- ✅ 完整的验收清单和测试方案
- ✅ 里程碑设置合理，便于进度管控

### 三、潜在风险及建议

#### 1. 风格数量风险
**问题**：11套风格可能导致开发和维护成本过高
**建议**：
- 考虑设置3个核心风格（A/B/G）精细打磨
- 其余8个风格可接受80%完成度
- 建立风格优先级：核心>特色>补充

#### 2. 时间估算风险
**问题**：4天完成11套风格+性能优化偏紧张
**建议**：
- 增加至5-6天，或增加人力至2人并行
- Day1完成框架和模板风格
- Day2-4批量产出其他风格
- Day5测试和优化

#### 3. 特殊风格技术挑战
**问题**：
- D风格（玻璃拟态）：低端机性能问题
- K风格（Neo-Brutalism）：特殊阴影效果复杂
**建议**：
- 准备降级方案（渐变代替模糊）
- 允许特殊风格简化实现
- 设置设备性能检测，自动降级

#### 4. 密度切换实现细节
**问题**：文档中密度参数较简单（仅行高和padding）
**建议**：
- 增加字号调整（紧凑:14sp/中等:16sp）
- 考虑图标尺寸适配
- 注意触摸目标最小尺寸（48dp）

### 四、实施优化建议

#### 1. 并行开发策略
```
开发轨道划分：
- 轨道1：A/B/C/D（传统商务风格）
- 轨道2：E/F/G/H（现代流行风格）
- 轨道3：I/J/K（个性极端风格）
```

#### 2. 风格开发模板化
- 建立BaseStyle抽象类
- 定义标准化的颜色、间距、圆角映射表
- 使用工厂模式批量生成风格实例

#### 3. 自动化测试建议
```kotlin
// 建议的自动化测试框架
@Test
fun testAllStylesPerformance() {
    StyleCatalog.getAllStyles().forEach { style ->
        measureTimeMillis {
            composeTestRule.setContent {
                DemoTheme(style = style) {
                    StyleCatalogDemoScreen()
                }
            }
        }.also { time ->
            assertTrue("Style ${style.name} 渲染时间超标", time < 16)
        }
    }
}
```

### 五、成本效益分析

#### 投入成本
- 开发：5天×2人 = 10人天
- 测试：1天×1人 = 1人天
- **总计：11人天**

#### 预期收益
- 快速验证11种视觉风格的用户接受度
- 建立可复用的设计系统架构
- 零风险获取真实用户偏好数据
- 为产品差异化奠定基础

#### ROI评估
- 单风格成本：1人天/风格
- 风险成本：0（完全隔离）
- **投资回报率：高**

### 六、关键成功因素

1. **设计令牌系统的完整性**
   - 必须覆盖所有视觉属性
   - 支持运行时动态切换

2. **性能优化到位**
   - 列表虚拟化
   - 图片懒加载
   - 主题切换防抖

3. **用户反馈机制**
   - Demo中集成简单投票
   - 记录用户停留时长
   - 收集切换行为数据

### 七、一次性完成vs分阶段实施

经过深入分析，**强烈建议一次性完成所有11个风格**：

**理由**：
1. 用户能完整对比，避免记忆偏差
2. 决策效率更高，避免多轮等待
3. 开发存在规模效应，边际成本递减
4. 保证实现标准的一致性

**前提条件**：
- 增加人力投入至2人
- 预留20%时间缓冲
- 接受部分特殊风格的简化

### 八、最终建议

**决策建议：批准执行**

**执行要点**：
1. 采用2人并行开发，5天交付
2. 优先保证3个核心风格质量（B卡片/A极简/G iOS）
3. 建立自动化截图和性能测试
4. Demo中加入用户偏好统计功能

**风险预案**：
- 若时间紧张，K风格可简化实现
- 若性能问题，D风格可降级处理
- 保持核心功能的稳定性优先级最高

### 九、复评建议关注点

供GPT-5复评时重点关注：

1. **技术债务评估**：11个风格的长期维护成本
2. **用户价值验证**：是否真的需要11种风格
3. **商业模式思考**：风格是否可作为付费功能
4. **竞品对标分析**：市场主流记账App的风格策略
5. **国际化考虑**：不同地区用户的风格偏好差异

---

*本评审意见基于技术可行性和风险控制角度，建议结合产品战略和用户研究做最终决策。*
