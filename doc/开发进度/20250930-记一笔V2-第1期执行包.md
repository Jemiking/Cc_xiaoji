# 记一笔 V2（第1期）执行包

> 注：2025-10-05 状态更新
> 
> 正式的 “记一笔 V2” 页面及导航开关已下线并从代码库移除。本文档仅作为历史记录保留，不再作为现行实现方案的依据。当前 Demo 交互与像素布局请参考：
> 
> - Demo 浮层：`feature/ledger/src/debug/.../screens/AddBillScreenV2.kt`
> - 生产页面：`feature/ledger/src/main/.../screen/transaction/AddTransactionScreen.kt`
> 
> 若需恢复或继续演进 V2 设计，请以 Demo 为参考基线，避免直接依赖已删除的正式页面。

目标：在不改动业务逻辑（ViewModel/UseCase/Repository）的前提下，交付“记一笔 V2”布局外壳，可灰度、可回退。

---

## UI 契约表（AddTransactionV2Screen）

- 输入（State）
  - `AddTransactionUiState`（来自现有 `AddTransactionViewModel`）
    - 账户/账本：`accounts`、`selectedAccount`、`ledgers`、`selectedLedger`
    - 分类：`categoryGroups`、`frequentCategories`、`selectedCategoryInfo`
    - 记账类型：`transactionType`（EXPENSE/INCOME/TRANSFER）、`isIncome`
    - 金额与校验：`amountText`、`amountError`、`canSave`
    - 时间与地点：`selectedDate`、`selectedTime`、`selectedLocation`
    - 转账：`fromAccount`、`toAccount`
    - 对话框可见性：`showLedgerSelector`、`showDateTimePicker`、`showFromAccountPicker`、`showToAccountPicker`、`showLinkTargetSelector`
    - 其他：`isLoading`、`hasLinkOptions`、`availableLinkTargets`、`selectedSyncTargets`
  - `LedgerUIPreferences`（来自现有 `LedgerUIStyleViewModel.uiPreferences`）
    - `uiStyle`、`iconDisplayMode`、`animationDurationMs`

- 事件（回调，直接转发至现有 ViewModel 方法）
  - 类型切换：`setTransactionType(TransactionType)`
  - 分类选择：`selectCategory(Category)` / 频繁分类点击
  - 账本：`showLedgerSelector()`、`selectLedger(Ledger)`、`hideLedgerSelector()`
  - 账户：`selectAccount(Account)`、`showFromAccountPicker()`、`setFromAccount(Account)`、`showToAccountPicker()`、`setToAccount(Account)`
  - 时间：`showDateTimePicker()`、`updateDate(LocalDate)`、`updateTime(LocalTime)`、`hideDateTimePicker()`
  - 金额：`updateAmount(String)`（数字/小数点/删除/运算符合并的唯一入口）
  - 备注/位置：`updateNote(String)`、`updateLocation(LocationData?)`
  - 链接目标：`showLinkTargetSelector()`、`toggleSyncTarget(String)`、`selectAllSyncTargets()`、`clearAllSyncTargets()`
  - 保存：`saveTransaction(onSuccess)`（V2 仅调用；禁用态显示原因由 `canSave` 与文案控制）

- 约束
  - V2 不直接访问仓库、不自建规则；所有业务判断、校验、保存逻辑由现有 ViewModel 承担。
  - V2 仅负责 UI 呈现与交互，组件化可复用（分类网格、键盘、顶部栏等）。

---

## Tokens 映射初稿（Qianji/IOS 风格 → DesignTokens）

- 调色盘（建议映射）
  - 主要品牌色：`Qianji Blue500` → `DesignTokens.BrandColors.Ledger`
  - 支出红：`Red500` → `DesignTokens.BrandColors.Error`
  - 收入绿：`Green500` → `DesignTokens.BrandColors.Success`
  - 卡片背景：白色/浅灰 → `MaterialTheme.colorScheme.surface`/`surfaceVariant`
  - 文本：主文本 → `onSurface`；次要文本 → `onSurfaceVariant`

- 圆角与间距（建议基线）
  - 圆角：顶部栏/按钮 12–16dp；卡片 12dp；图标容器 8–12dp
  - 间距：页面 16dp；网格垂直 16–20dp；水平 12–16dp

- 字号与动效
  - 金额：`headlineSmall` 或自定义 24–28sp
  - 标签：`labelSmall`/`titleSmall`
  - 动画：`animationDurationMs`（从 `LedgerUIPreferences` 读取，默认 300ms）

- 图标模式
  - 统一走 `IconDisplayMode`（Emoji/Vector 切换）
  - 分类图标使用现有 `DynamicCategoryIcon`

- 备注
  - 若 Demo 的 `QianjiInspiredSpecs` 中某些颜色/尺寸需要 1:1 复制，可在 `DesignTokens` 补充扩展变量，但优先复用现有 Token，避免双体系。

---

## 开关接线点清单（Feature Flag）

- 路由入口
  - 文件：`app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavGraph.kt:262`
  - 分支逻辑：按“布局开关”或 `LedgerUIPreferences.uiStyle` 决定渲染 V1/V2 的“记一笔”页面。
  - 临时实现：开发者设置或常量开关（Debug），便于灰度与回退。
  - 正式实现：持久化到 `LedgerUIPreferencesRepository`，在“界面风格设置”中暴露。

- 风格工厂（后续页面）
  - 文件：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/component/StyleableComponentFactory.kt:1`
  - 扩展 `LedgerUIStyle` 为 `QIANJI/IOS` 分支，用于主页头部/抽屉/条目/日期头等组件的风格切换。

- 兜底策略
  - 默认回退到 V1 布局；V2 任意异常可一键关闭。

---

## 埋点方案（Debug 阶段可日志 + 正式事件）

- 事件清单
  - `add_txn_open`：打开记一笔 V2（字段：entry=ledger/home/deeplink，uiStyle，ts）
  - `add_txn_switch_tab`：切换类型（字段：to=expense/income/transfer）
  - `add_txn_select_category`：选择分类（字段：parentId/categoryId，isFrequent）
  - `add_txn_amount_change`：金额变更（字段：len、hasDot、fromZero）—Debug 阶段仅日志
  - `add_txn_account_change`：账户变更（字段：accountId）
  - `add_txn_ledger_change`：账本变更（字段：ledgerId）
  - `add_txn_time_change`：时间变更（字段：hasTime=true/false）
  - `add_txn_save_tap`：点击保存（字段：canSave、amount、type、hasCategory、hasAccount、isTransfer、from=accountId、to=accountId）
  - `add_txn_save_result`：保存结果（字段：success=true/false、errCode/errMsg、durationMs、linkTargetsCount）

- 指标口径
  - 打开→保存 P50/P95；保存成功率；失败 Top3 原因；崩溃率

- 实施方式
  - Debug：`Log.d`/`println`（已在多个页面使用，便于快速验证）
  - 正式：统一埋点工具（后续对接 App 侧 Analytics），保证隐私合规

---

## DoD（第1期验收）

- 新旧布局可即时切换（开关验证通过）
- 功能等价（金额/分类/账户/账本/转账/时间/同步目标）
- 性能：打开→保存 P50 ≤ 3.0s，P95 ≤ 5.0s
- 稳定：崩溃率不高于旧版，错误原因可观测
- 视觉：明/暗色、空/错误态文案完成
- 文档：本执行包 + 变更记录更新

---

## 落地清单（开发）

1) 新建 `AddTransactionV2Screen`（生产目录 `feature/ledger/src/main/.../presentation/screen/v2/`）
2) 接线现有 `AddTransactionViewModel` 与 `LedgerUIStyleViewModel`
3) 产出组件：顶部 Tab、分类网格（用 `categoryGroups`）、金额显示与快捷项、iOS 风格数字键盘（调用 `updateAmount()`/`saveTransaction()`）
4) 接入对话框：账本/时间/账户选择，沿用现有组件与状态
5) `NavGraph.kt` 接入布局开关分支（本包已在相应位置写明注释占位）
6) 埋点与日志：按事件清单加入（Debug 阶段可先日志）
7) 回归与灰度：小流量验证→放量→可回退
