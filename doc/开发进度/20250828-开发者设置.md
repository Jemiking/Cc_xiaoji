# 开发者设置方案（自动记账设置分层）

创建时间：2025-08-28  
状态：方案评审通过；按本方案实施，避免跑偏

—

## 背景与目标
- 背景：当前“自动记账”设置项较多，既有用户向功能，也有用于排障/调试的高级开关，心智负担较重。
- 目标：将“记账设置”分为两类视图与能力，确保默认稳定易用，同时保留研发/测试所需的调试能力。
  - 用户向（默认）：稳定、易懂、少选项、默认安全。
  - 开发者向（仅 Debug 或显式开启）：用于诊断/绕过/高风险选项，默认隐藏。

—

## 可见性策略（显隐控制）
- 构建变体自动启用：`BuildConfig.DEBUG == true` 时，默认启用“开发者模式”，显示所有调试项。
- 手动启用（Release）：提供“开发者模式”隐形入口（两种方式选其一，按实现成本决定）：
  - 连点启用：在“自动记账设置”标题区域连续点击 7 次 → 弹窗提示“开发者模式已启用/关闭”。
  - 长按启用：长按标题区域 3 秒 → 弹窗提示“开发者模式已启用/关闭”。
- 状态保存：
  - DataStore 键：`developer_mode_enabled: Boolean`（默认 false）；仅 Release 生效；Debug 变体忽略该键并强制为 true。

—

## 信息架构与分组

### 用户向（一级页）
- 启用自动记账（总开关）。
- 模式选择（单选/分段控制）：
  - 半自动（默认）：支付后通知提醒，点击即可记账。
  - 支付宝自动入账（方案A）：仅凭金额/方向自动入账（需选择默认账户/分类）。
  - 通用自动创建：解析高置信度时自动入账（可调阈值/最小金额）。
- 方案A（条件显隐）：
  - 开关：启用/关闭方案A（默认关闭）。
  - 默认项：默认“支付宝账户”、默认“支出分类/收入分类”。
  - 说明：开启后仅凭金额/方向也可自动入账；保留 30 秒撤销与去重保护。
- 权限与可见性：
  - 通知使用权直达按钮。
  - 通知渠道直达（确认/状态）。
  - 监听状态（简版）：仅展示“已连接/未连接”。
- 用户向“高级设置”（已下沉项）：
  - 通用自动创建开关（与模式选择联动）。
  - 置信度阈值（默认 0.85）、最小金额（默认 20 分）。

### 开发者设置（仅开发者模式可见）
- 去重设置：
  - 启用去重（默认开启）。
  - 去重窗口（秒，默认 20）。
  - 清空去重缓存。
  - 调试采样：去重跳过时仍解析（默认关闭）。
- 监听层过滤：
  - 放宽关键词过滤（默认关闭/或按现状默认开启，具体以代码实际为准）。
  - 透传群组摘要（高风险，默认关闭，带警示文案）。
  - 记录未匹配通知日志（降噪开关，默认关闭）。
- 调试工具：
  - 打印最近 5 条交易（对话框预览）。
- 诊断细节（可选）：
  - 连接/断开次数、累计在线时长、最后状态变更时间（只读展示）。

—

## 行为与风控
- 开发者设置的开关不应改变默认用户体验：
  - 群组摘要透传、未匹配日志、去重跳过仍解析 → 默认均关闭。
- 方案A（支付宝自动入账）默认关闭；开启后若未配置默认账户/分类，则降级为半自动并给予引导提示。
- 保留随时撤销（30 秒）与去重幂等保护；
- 提供“一键恢复安全默认”按钮（重置 Debug 项为推荐值）。

—

## DataStore 键位（新增/现有）
- 开发者模式：`developer_mode_enabled: Boolean`（Release 使用；Debug 固定 true）。
- 方案A（支付宝自动）：
  - `auto_ledger_alipay_auto_on: Boolean`
  - `auto_ledger_alipay_default_account_id: String`
  - `auto_ledger_default_expense_category_id: String`
  - `auto_ledger_default_income_category_id: String`
- 通用自动创建：
  - `auto_ledger_autocreate_enabled: Boolean`
  - `auto_ledger_autocreate_confidence_threshold: Float`
  - `auto_ledger_min_amount_cents: Int`
- 去重与过滤/调试：
  - `auto_ledger_dedup_enabled: Boolean`
  - `auto_ledger_dedup_window_sec: Int`
  - `auto_ledger_dedup_debug_parse_on_skip: Boolean`
  - `auto_ledger_emit_without_keywords: Boolean`
  - `auto_ledger_emit_group_summary: Boolean`
  - `auto_ledger_log_unmatched: Boolean`

—

## 实施步骤（分阶段）
1) 显隐控制接入：
   - 在 `AutoLedgerSettingsViewModel` 中订阅 `developer_mode_enabled`；提供 `toggleDeveloperMode()`（Release）。
   - `AutoLedgerSettingsScreen` 读取 `isDeveloperMode = BuildConfig.DEBUG || developer_mode_enabled`，基于该值显隐“开发者设置”折叠区。
2) UI 分组与迁移：
   - 将现有“高级设置”重命名为“开发者设置”，迁移去重/过滤/调试项至该折叠区；用户向项保留在主界面。
   - 保留“通用自动创建开关”在主界面；阈值/最小金额继续下沉至折叠区。
3) 交互与文案：
   - 增加“开发者模式启用提示”与“恢复默认设置”入口（仅开发者设置内可见）。
   - 为高风险开关（群组摘要透传/未匹配日志）添加二次确认或提示说明。
4) 编排与行为：
   - 方案A优先分支已接入；确保“开发者设置”开关不改变决策顺序，仅作用于监听与去重调试。
5) 验收与回归：
   - Debug 变体默认可见开发者设置；Release 需手势开启。
   - 方案A/通用自动创建/半自动三种模式互斥清晰；默认安全值生效。

—

## 测试计划
- 变体与显隐：
  - Debug 构建：进入设置默认显示“开发者设置”。
  - Release 构建：默认隐藏开发者设置；手势启用后显示；重启后状态保持（或按策略选择不保持）。
- 用户向流畅度：
  - 模式切换显隐正确；方案A开启后仅金额/方向也可自动入账；未配置默认项时降级半自动并提示。
  - 通用自动创建阈值/最小金额在折叠区调整后生效；未误触发时不打扰。
- 开发者设置：
  - 去重开关/窗口/清空/采样生效；监听层过滤与日志开关生效；“打印最近 5 条交易”显示正确。
- 风险控制：
  - 高风险开关默认关闭，开启时有提示；“恢复默认设置”将 Debug 项重置为推荐值。

—

## 备注
- 该方案与“方案A（支付宝默认自动入账）”共同发挥作用：默认不开启；用户明确开启后可获得“仅金额/方向”的自动记账体验。
- 所有变更以“UI 显隐与交互”优先，尽量不破坏现有键位与编排逻辑；如需代码层重构，先评审再实施。

