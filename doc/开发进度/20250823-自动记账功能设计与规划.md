# 自动记账功能设计与规划

创建时间：2025-08-23  
更新时间：2025-08-26  
状态：技术方案已切换为通知监听（NotificationListenerService），移除无障碍方案

—

## 实现状态（快照｜2025-08-27）

已实现（对齐当前代码）：
- 通知监听：`NotificationListenerService`（`PaymentNotificationListener`），支持连接健康统计与节流重连；关键词透传/群组摘要透传/未匹配日志可配置。
- 半自动优先：解析成功后发送“确认通知”，主体点击通过 DeepLink 打开应用内添加交易页；全自动默认关闭；阈值与最小金额可调。
- 去重与幂等：双阶段去重（原文短窗 + 解析后指纹），频控保护，去重命中可选解析调试。
- 通知渠道：双通道（确认 `auto_ledger_prompt`｜状态 `auto_ledger_status`）。
- 设置页：监听服务控制（重连/去授权/健康统计/打印最近5条交易）、去重配置、自动创建阈值/最小金额、通知渠道直达按钮。
- 数据库迁移：v14 → v15（新增自动记账相关列/表/索引）。

待实现（保持在路线图，暂未启用）：
- 通知内一键记账：确认通知内 Action + `RemoteInput` 行内备注、TopN 快速动作（≤3）；缺字段自动回退弹窗；`PendingIntent` 使用 `FLAG_MUTABLE`（仅限带 RemoteInput 的 Action）。
- 微信/云闪付解析与固定规则映射（Phase 2/3）。
- 撤销窗口 DataStore 配置（当前固定 30 秒）。
- 支付宝默认自动入账（方案A，开关可控）：开启后对支付宝通知直接入账，账户取“默认支付宝账户”，分类取“默认分类（按方向）”。

## 增量更新（2025-08-26）

本次重点（【已实现】）：稳定半自动流程、增强可观测性与诊断能力；自动创建默认关闭。

- 【已实现】半自动优先
  - 默认关闭“自动创建交易”（DataStore: `auto_ledger_autocreate_enabled=false`）。
  - 解析成功后统一发送“半自动确认通知”，主体点击通过 DeepLink 进入应用添加交易页；【待实现】通知 Action（一键记账/备注/备用）与弹窗兜底。
  - 新增对话框式快速记账：`QuickLedgerActivity`（Compose），`QuickLedgerViewModel`。
    - 预填金额/方向/商户/推荐账户与分类；
    - 账户/分类提供可搜索下拉列表；
    - 本地校验（金额>0、账户/分类非空），失败给出错误提示。

- 【已实现】监听连接与重连
  - 新增 `NotificationAccessController`：
    - 授权检测（`Settings.Secure.enabled_notification_listeners`）；
    - 一键重连（组件 DISABLE→ENABLE 轻推 + `requestRebind`，15s 节流）；
    - 跳转“通知使用权”系统页。
  - 监听诊断指标扩展：连接状态、连接/断开次数、累计在线时长、最后状态变更时间。
  - `PaymentNotificationListener` 在 `onListenerDisconnected` 仅在授权有效时尝试节流重连；未授权则提示并跳过。

- 【已实现】去重与解析
  - 双阶段去重（DataStore 可配置）：
    1) 预判重（文本hash + 窗口秒）命中即跳过；
    2) 解析成功后记录金额/方向/商户 + 同窗指纹用于后续幂等。
  - 去重命中默认不解析（可通过调试开关允许“去重后解析”但不入账）。
  - 解析策略对支付宝“交易提醒…支出/收入”进行了快速路径提取，置信度默认 0.9。

- 【已实现】决策与阈值
  - 自动创建由以下条件门控：`auto_on && amount>=min && confidence>=threshold`；
  - 默认：`auto_on=false`，`threshold=0.85`，`min=20分`；
  - 可在设置页调整置信度与最小金额。

- 【已实现】设置页改动
  - 新增“监听服务控制”卡片：重连/去授权按钮 + 连接健康统计。
  - 新增“打印最近5条交易”调试按钮，并以对话框展示最新记录（便于核对落库）。
  - 去重开关/窗口/调试开关（去重后是否解析）可运行时调整。

- 通知点击行为
  - 半自动确认通知：
    - 【已实现】主体点击：通过 DeepLink `ccxiaoji://app/add_transaction` 打开应用内标准“添加交易”页；
    - 【待实现】Action 按钮：补充“一键记账（含 RemoteInput 备注）”与备用动作，缺字段时回退到弹窗编辑。

- 关键日志 TAG
  - 监听与事件流：`AutoLedger_Notification`, `AutoLedger_EventFlow`；
  - 管理器与解析：`AutoLedger_Manager`, `AutoLedger_Parser`；
  - 弹窗/通知：`AutoLedger_Popup`；
  - 设置与调试：`AutoLedger_Settings`。

已知问题与建议：
- MIUI/HyperOS 设备侧仍可能周期性断连，请确保：自启动/无限制省电/最近任务上锁。
- 若点击“记账”后未见交易：
  - 弹窗会提示本地校验错误；
  - 可用“打印最近5条交易”核对是否写库；
  - 检查当前账簿/过滤范围与插入记录是否一致。

---

## 增量更新（2025-08-26-二次）

本次重点：减少“权限/渠道”心智负担，完善“无需跳转”的半自动交互闭环。

- 通知渠道精简（由3合2）
  - 确认渠道：`auto_ledger_prompt`（HIGH）用于半自动确认，触发横幅/HUN；
  - 状态渠道：`auto_ledger_status`（LOW）用于结果/撤销等静默提示；
  - 已替换旧的通道常量（历史 `CHANNEL_ID` 不再使用）；重要级无法就地更改，采用新ID迁移；
  - 设置页新增“通知渠道设置”直达按钮（分别跳转两个渠道的系统设置页）。

- 【待实现】无需跳转的一键记账（通知内完成）
  - 一键记账 Action 支持 RemoteInput 行内备注（键：`extra_note`），无需切前台即可落库；
  - 多动作 TopN：在确认通知内最多展示3个快速记账按钮（默认推荐 + 备用1/2）；
  - 广播接收器解析行内备注与推荐参数，调用用例落库；
  - 缺少账户/分类时自动回退到对话框编辑（兜底，默认无需授权悬浮窗）；
  - 成功后用“状态渠道”发送结果通知，并保留30秒撤销。

- 设置与兼容
  - 设置页新增“通知渠道设置”卡片，分别直达“确认/状态”渠道系统页，指导开启“悬浮/横幅/锁屏显示”；
  - Manifest 启用 `android:enableOnBackInvokedCallback="true"` 以适配新导航后退；
  - MIUI/HyperOS 如仅出现状态栏图标无横幅，需手动在“确认渠道”开启悬浮/横幅。

- 流程与默认值（未变）
  - 决策门控：`auto_on && amount>=min && confidence>=threshold`；
  - 默认：`auto_on=false`，`threshold=0.85`，`min=20分`；仍以半自动为主。

- 影响范围与代码要点（简）
  - `AutoLedgerNotificationManager`：双通道已落地；确认通知 TopN/RemoteInput 为【待实现】，当前版本仅支持主体点击 DeepLink；
  - `AutoLedgerBroadcastReceiver`：处理 `ACTION_QUICK_SAVE`，解析 RemoteInput；缺字段回退对话框；
  - `AutoLedgerManager`：在 NeedConfirmation 分支生成 TopN（默认推荐 + 默认账户/默认分类的替代项）；
  - `NotificationAccessController`：新增 `openChannelSettings(channelId)` 方便跳转渠道设置；
  - 设置页：新增“通知渠道设置”入口（确认/状态）。

- 下一步计划（建议排期）
  1) 强化推荐器（历史学习/商户映射），将 TopN 按账户/分类名称直显到动作标题，提高一次命中率；
  2) 增加“严格确认”开关（缺少映射时是否必须弹窗，默认关闭）；
  3) 灰度与指标：统计“横幅展示率/一键占比/撤销率/回退率（弹窗）”。

验收补充：
- 半自动横幅当前以“主体点击进入应用添加交易页”为主；
- 【待实现】一键/备用/行内备注入账；
- 结果通知静默展示且可撤销，避免过度打扰。

---

## 方案收敛（快速上线版，2025-08-26-三次）

目标：尽快交付可用版本，避免引入“学习/复杂策略”。坚持“固定规则 + 轻量可配置”，半自动为主、全自动默认关闭。

- 规则而非学习
  - 不引入机器学习/在线学习/复杂推荐策略；
  - 使用确定性的“规则优先级”：
    1) 包名 / 支付渠道关键词 → 账户（支付宝=余额/余额宝；微信=零钱；云闪付=银联钱包；银行卡尾号命中则映射到对应卡账户）；
    2) 商户关键词 → 分类（餐饮/交通/购物/生活服务等高频小表）；
    3) 兜底：默认账户 / 默认支出/收入分类；
  - 规则在开发期内置，必要时通过设置页的小型映射表覆盖（可选，后续迭代）。

- 通知交互（保持极简）
  - 【已实现】半自动为主：横幅（确认渠道）+ 主体点击进入应用添加交易页 + 编辑兜底；
  - 【待实现】通知内一键记账（支持行内备注 RemoteInput）；
  - 全自动默认关闭；保留阈值与最小金额；
  - 双渠道策略保持：确认（HIGH）、状态（LOW）。

- 设置项（最小化）
  - 总开关、自动创建开关/阈值/最小金额、直达“确认/状态”渠道设置按钮；
  - 【新增（方案A）】支付宝默认自动入账开关（默认关闭）；
    - 选择“默认支付宝账户”（支持多支付宝账户场景，用户指定一个作为自动入账账户）；
    - 选择“默认支出分类/默认收入分类”（用于无商户场景的自动入账）；
    - 开关关闭时维持半自动流程；
  - 不提供“学习/历史纠正”界面（避免心智负担）。

- 非目标（暂不做）
  - 机器学习/在线学习/复杂策略；
  - 大型诊断面板与可视化规则编辑；
  - 悬浮窗默认关闭，仅作为高级可选。

实施计划（收敛版）
- Phase 1：支付宝 MVP（通知监听）
  - Task 1.1 服务与权限接入（不变）
  - Task 1.2 解析器与样本（不变，确保≥95%）
  - Task 1.3 去重与幂等（不变）
  - Task 1.4 落账编排与固定规则推荐（更新）
    - 用“包名/渠道关键词/商户关键词→账户/分类”的固定规则生成记账参数；
    - 无匹配时直接使用“默认账户/默认分类”兜底；
    - 验收：无需编辑也能通过“一键记账”直接入账（备注可行内输入）。
  - Task 1.5 通知交互（更新）
    - 半自动确认通知：主体点击进入应用添加交易页；
    - 【待实现】一键记账（+RemoteInput）、备用按钮（最多2个）、缺字段回退弹窗；
    - 双渠道：确认（HIGH）与状态（LOW）；设置页直达渠道按钮；
    - 验收：横幅可见；无横幅时仍可进入应用完成入账；撤销可用。
  - Task 1.6 方案A（支付宝默认自动入账，开关）
    - 新增设置项：开启“支付宝自动入账”；
    - 选择“默认支付宝账户”（多账户时指定一个作为自动入账账户）；
    - 选择默认分类（支出/收入各一项）；
    - 编排调整：当来源=支付宝且开关已开启→忽略解析置信度与商户缺失，直接使用默认账户/分类入账；
    - 与现有去重/撤销逻辑保持一致；
    - 默认关闭（避免误入账）。
  - Task 1.7 简化调试（收敛）
    - 保留“打印最近5条交易”、关键日志；不建设大型面板。
  - Task 1.8 测试与验收（不变）

- Phase 2：微信扩展（按同样规则表覆写）
  - 解析器 + 固定规则映射；遵循 Phase 1 的交互与规则优先级；

- Phase 3：云闪付与增强（按同样规则表覆写）
  - 解析器 + 固定规则映射；遵循 Phase 1 的交互与规则优先级；

里程碑与验收（收敛版补充）
- M1（支付宝 MVP）：
  - 半自动横幅主体点击进入应用添加交易页可完成入库；
  - 方案A（开关）可用：开启后，支付宝通知在“默认账户/默认分类”下自动入账；关闭则回退半自动；
  - 【待实现】通知内一键记账与行内备注；
  - 设置页可直达“确认/状态”渠道开启横幅；
  - 撤销稳定，无崩溃/卡死。
- M2（微信）：同 M1 指标；
- M3（云闪付）：同 M1 指标。

风险与回退（维持）
- MIUI/HyperOS 横幅策略差异：通过直达渠道设置引导解决；
- 横幅受限时，保留“通知按钮+编辑兜底”。
- 方案A风险：分类准确率依赖用户选择的默认分类；如存在误入账，建议关闭开关或调整默认账户/分类；随时可通过30秒撤销与历史编辑纠偏。

---

## 增量更新（2025-08-26-四次｜通知发布失败修复）

问题复盘：
- 现象：支付后未见横幅/确认通知。
- 日志：Not posted. PendingIntents attached to actions with remote inputs must be mutable。
- 原因：带 RemoteInput 的 Action 使用了不可变 PendingIntent（`FLAG_IMMUTABLE`），系统直接拒绝整条通知发布。

修复与规范：
- 【条件生效】当启用带 RemoteInput 的 Action 时，一键记账使用可变 PendingIntent：`FLAG_UPDATE_CURRENT | FLAG_MUTABLE`；
- 其他不含 RemoteInput 的 PendingIntent（contentIntent/编辑/撤销/清理等）仍使用 `FLAG_IMMUTABLE`；
- 位置：启用通知内一键记账时在 `AutoLedgerNotificationManager.createQuickSaveIntent(...)` 等处一并调整；当前版本未启用 RemoteInput，不受影响。

验证清单（MIUI/HyperOS 重点）：
- 通知成功发布（日志无 Not posted 异常）；
- 顶部横幅可见；若不可见，设置页“通知渠道设置”→为 `auto_ledger_prompt` 开启“悬浮/横幅/锁屏”；
- 【待实现】一键记账支持行内备注并可直接落库；
- 结果通知走 `auto_ledger_status`，30s 可撤销；
- 重复点击动作不重复入账（幂等仍生效）。

后续约束（开发规范补充）：
- 所有包含 `RemoteInput` 的通知 Action 必须使用 `FLAG_MUTABLE` PendingIntent；
- 统一 PendingIntent 策略：
  - RemoteInput Action → `MUTABLE`；
  - 其他（contentIntent/编辑/撤销/清理/重连等）→ `IMMUTABLE`；
- 提交前通过“发布前检查”脚本/代码审查核对标志位，避免再次引发 Not posted。

### Action 启用回归清单（启用通知内一键记账时）
- 发布与可见性：确认通知成功发布；横幅（HUN）出现；状态通知在入账/撤销后静默展示。
- RemoteInput：行内备注提交成功；中文输入不乱码；无备注时逻辑回退正常。
- 字段完整性：账户/分类缺失时回退至弹窗编辑；编辑完成后可入库。
- 幂等与去重：重复点击 Action 不重复入账；窗口内多次触发保持幂等。
- 撤销：30 秒窗口内撤销成功；撤销通知自动清理；撤销后数据一致。
- MIUI/HyperOS：在未开启横幅时，通知栏内 Action 仍可完成入账。

## 项目概述

### 需求背景
为 CC 小记的记账模块提供自动记账能力。通过 NotificationListenerService 监听第三方支付应用（支付宝、微信、云闪付等）的“支付成功/收款到账/退款”等系统通知，解析金额、商户、时间、来源等关键信息，自动创建交易记录，降低手动记账成本并提升完整性与准确性。

### 技术方案变更说明（最终版）
- 原方案（弃用）：AccessibilityService 解析 UI 页面与可视化文本。
- 新方案（采用）：NotificationListenerService 监听并解析系统通知。

变更理由：
- 厂商兼容性：MIUI/EMUI/ColorOS 对无障碍限制较多，易失效；通知监听为系统标准能力，稳定性更好。
- 维护成本：通知文案比 UI 结构稳定，规则维护量显著更低。
- 触发时机：支付完成即推送通知，可即时处理；无需切回本应用。
- 用户体验：可默认使用“系统通知 + Action 按钮”方式交互，降低悬浮窗权限负担。

### 目标用户价值
- 便利：支付完成自动落账或一键确认，减少操作。
- 准确：直接读取系统通知，金额/时间/来源更可靠。
- 智能：基于商户/历史偏好推荐分类与账户。

—

## 现有架构与复用点

- 架构：多模块 + Clean Architecture + MVVM + Compose。
- 可复用：`AddTransactionUseCase`、`TransactionRepository`、记账分类/账户/记账簿等现有实体与 UI 基础组件。
- 模块归属（微调后）：
  - 系统级通知监听入口与原始事件流：`shared/notification`
  - 自动记账解析/去重/业务编排与 UI：`feature/ledger`
  - 新增表与迁移：`core/database`；简单偏好：`core/common`（DataStore）或 `shared`
  - 依赖方向保持：`app → feature → shared → core`

—

## 通知监听方案概述

### 工作原理
系统层的 NotificationListenerService 接收通知事件（posted/removed）。服务根据包名与内容识别支付类通知，交由解析器提取结构化信息，再经去重幂等校验与规则判定，最终调用用例创建交易；根据模式（半自动/全自动）选择不同交互路径。

可获取信息：通知标题/文本/子文本、大文本、扩展 `extras`、小图标、`when/postTime`、发送应用包名等。

诊断与可观测性：
- 监听健康：连接状态/连接次数/断开次数/累计在线时长/最后变更时间；
- 事件流统计：透传次数（命中关键词/未命中关键词）、跳过群组摘要、不支持包跳过、因配置过滤跳过。
- 去重日志：命中/未命中、时间窗、指纹、窗口内计数、频控原因；
- 决策日志：`conf/th/min_ok/auto_on` 与最终路径（自动创建/半自动）。

### 支持应用与策略
- 第一梯队（优先支持）：支付宝（`com.eg.android.AlipayGphone`）、微信（`com.tencent.mm`）
  - 注：当前版本已接入支付宝解析；微信/云闪付为【待实现】（Phase 2/3）。
- 第二梯队（验证后支持）：云闪付（`com.unionpay`）
- 其他应用：电商/生活服务类默认黑/灰名单，通过关键词与去重策略避免重复记账（订单通知 vs 支付通知）。

—

## 权限与 Manifest 配置（统一）

AndroidManifest 片段（放置于 `shared/notification` 模块清单并由 `app` 合并）：

```xml
<!-- Android 13+ 运行时通知发布权限（用于自动记账完成后的提示/撤销） -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

<!-- 可选：悬浮窗。默认不要求，作为高级选项 -->
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />

<application>
    <service
        android:name="com.ccxiaoji.shared.notification.data.PaymentNotificationListener"
        android:enabled="true"
        android:exported="true"
        android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE">
        <intent-filter>
            <action android:name="android.service.notification.NotificationListenerService" />
        </intent-filter>
    </service>

    <!-- 可选：监听重启后引导用户恢复权限/自启动（不做强制保活） -->
    <!-- <receiver android:name="com.ccxiaoji.shared.notification.data.BootReceiver">
        <intent-filter>
            <action android:name="android.intent.action.BOOT_COMPLETED" />
        </intent-filter>
    </receiver> -->
    
</application>
```

运行时/设置页引导：
- 通知访问权限：跳转系统“通知使用权”设置页让用户勾选本应用。
- Android 13+：请求 `POST_NOTIFICATIONS` 运行时权限（用于反馈/撤销）。
- 悬浮窗（可选）：仅当用户选择“悬浮窗弹窗”交互方式时再引导申请。
- 厂商兼容引导：提供忽略电池优化/自启动/后台运行提示页（不强制，不影响基本可用）。

补充（App Manifest 合并项）：
- 已声明 DeepLink `ccxiaoji://app/add_transaction` 以便从确认通知主体点击跳转至应用内添加交易页；
- 已注册 `AutoLedgerBroadcastReceiver`（`ACTION_UNDO/ACTION_EDIT/ACTION_MANUAL_CONFIRM/ACTION_QUICK_SAVE`）；
- `android:enableOnBackInvokedCallback="true"` 已在 `application` 节点设置。

—

## 模块与目录结构（符合 api/data/domain/presentation）

```
shared/notification/src/main/kotlin/com/ccxiaoji/shared/notification/
├── api/
│   └── NotificationEventRepository.kt     # Flow<RawNotificationEvent> 接口
├── data/
│   ├── PaymentNotificationListener.kt     # 系统服务入口（系统绑定）
│   └── NotificationEventRepositoryImpl.kt # 将系统通知适配为 Flow
├── domain/
│   └── model/
│       └── RawNotificationEvent.kt        # 原始通用事件模型
└── di/
    └── NotificationModule.kt              # Hilt 绑定接口与实现

feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/
├── api/                                    # 如需对外暴露导航或入口
├── data/
│   ├── repository/
│   │   ├── AutoLedgerConfigRepository.kt   # 配置读写（依赖 core/database + DataStore）
│   │   └── DedupRepository.kt              # 幂等键持久化（依赖 core/database）
│   └── mapper/                             # 文本/商户归一化等
├── domain/
│   ├── model/
│   │   ├── PaymentNotification.kt
│   │   ├── AutoLedgerMode.kt
│   │   └── AppAutoLedgerConfig.kt
│   ├── parser/                             # 解析器属业务域
│   │   ├── BaseNotificationParser.kt
│   │   ├── AlipayNotificationParser.kt
│   │   ├── WechatNotificationParser.kt
│   │   └── UnionPayNotificationParser.kt
│   └── usecase/
│       ├── AutoLedgerManager.kt           # 自动记账编排（UseCase）
│       └── GenerateEventKeyUseCase.kt     # 幂等键生成
└── presentation/
    ├── screen/
    │   ├── AutoLedgerSettingsScreen.kt
    │   ├── PermissionGuideScreen.kt
    │   └── AppModeConfigScreen.kt
    ├── quickadd/
    │   ├── QuickLedgerDialog.kt
    │   └── QuickLedgerActivity.kt
    └── viewmodel/
        └── QuickLedgerViewModel.kt

core/database/src/main/java/com/ccxiaoji/core/database/
├── dao/ ...
├── entity/ ...        # 去重表/配置表/交易扩展字段所在
└── migration/         # v14 → v15 迁移脚本（新增表/字段）
```

—

## 跨模块接口（shared → feature）

`shared/notification` 仅暴露通用通知事件，不承载“支付”业务语义；`feature/ledger` 订阅该事件流并执行业务逻辑。

接口示例：

```kotlin
// shared/notification
data class RawNotificationEvent(
    val packageName: String,
    val title: String?,
    val text: String?,
    val extras: Bundle?,
    val postTime: Long,
)

interface NotificationEventRepository {
    val events: Flow<RawNotificationEvent>
}

// feature/ledger 侧依赖注入
@Inject lateinit var notifRepo: NotificationEventRepository

// 使用：
notifRepo.events
    .filter { it.packageName in supportedPkgs }
    .onEach { event -> autoLedgerManager.handle(event) }
    .launchIn(viewModelScope)
```

—

## 解析与规则设计

### 事件类型与收支方向
- 支出：向【商户】付款/支付成功
- 收入：收款到账/微信收款/转账收款
- 退款/撤销：退款成功/订单关闭
- 转账：你向【联系人】转账/对方已收款/待确认

解析输出字段（建议）：
- sourceApp（包名）、sourceType（alipay/wechat/unionpay）
- direction（expense/income/refund/transfer）
- amountCents、currency
- merchant/rawMerchant、normalizedMerchant
- method/channel（余额宝/微信零钱/银行卡末尾/信用卡）
- postedTime、notifId/notifKey
- rawText/rawExtras（可选加密/开关）
- parserVersion、confidence（0..1）

### 金额与商户归一化
- 金额正则覆盖：￥/¥/元、小数/千分位、空格、繁中/英文、负号/括号。
- 商户名清洗：去除书名号/表情/广告词，支持别名映射（STARBUCKS→星巴克）。
- 币种扩展：默认 CNY，预留多币种解析与映射。

### 账户推断与分类推荐
- 账户：根据“支付方式/渠道/银行卡尾号”映射到应用内账户，可配置关键词规则；支持用户纠正学习。
- 分类：基于包名/商户名称/历史记录的混合策略，提供默认分类，可在半自动时修改。

### 置信度与降级
- 解析打分；低于阈值（如 <0.85）降级到半自动或仅提醒不落账。
- 关键字段缺失（金额/方向）直接降级。
 - 例外（方案A）：当来源=支付宝且开启“支付宝默认自动入账”时，忽略商户/置信度，直接按默认账户/分类入账。

半自动交互（默认）：
- 解析成功→发送“半自动确认通知”；
- 点击通知主体→通过 DeepLink 打开应用内标准“添加交易”页；
- 【待实现】通知内一键记账/备用按钮，缺字段时回退到 `QuickLedgerActivity` 对话框；
- 预填金额/方向/商户/推荐账户分类；账户/分类提供可搜索下拉菜单；
- 本地校验（金额>0、账户/分类必填）；通过后调用 `AddTransactionUseCase` 落库；
- 成功后自动关闭弹窗并清理确认通知（可选 Toast）。

### 解析规则与样本集（精化）
- 支付宝（`com.eg.android.AlipayGphone`）常见文案：
  - 向【星巴克咖啡】付款28.50元 → expense, merchant=星巴克咖啡, amount=28.50
  - 向【张三】转账100.00元 → transfer, merchant=张三, amount=100.00
  - 退款28.50元已退回至余额宝 → refund, amount=28.50
  - 正则建议：金额 `(¥|￥)?\s?([0-9]{1,3}(?:,[0-9]{3})*(?:\.[0-9]{1,2})|[0-9]+(?:\.[0-9]{1,2}))\s?(元)?`
  - 商户：`[【\[](.+?)[】\]]` 优先；否则用分词/关键词窗取相邻名词串
- 微信（`com.tencent.mm`）常见文案：
  - 你向星巴克咖啡付款￥28.50 → expense
  - 已收款￥50.00（来自张三）→ income
  - 转账给张三成功￥100.00 → transfer
  - 红包已接收￥8.88 → income, tag=red_packet
- 云闪付（`com.unionpay`）样本（需实测校准）：
  - 向XX商户付款￥28.50成功 / 消费￥28.50成功 → expense
  - 入账通知￥100.00 → income
- Fallback 规则：
  - 未识别 direction 时根据关键词集（付款/收款/退款/转账/红包）判定；仍不确定则 `direction=unknown` 且降级半自动。
  - 多币种：若匹配到 USD/HKD 等标记，填充 `currency`，默认 CNY。

—

## 去重与幂等

最新实现（2025-08-26）：

- 双阶段去重（DataStore 可配置窗口，默认 20 秒）
  1) 预判重：使用“包名 + 规范化文本hash + 窗口桶”检查窗口内重复，命中即跳过，并记录原因（`dedup_within_window(delta, window)`）；
  2) 解析幂等：解析成功后使用“包名 + 金额 + 窗口桶 + 商户hash + 方向”生成解析指纹，持久化到去重表，重复创建被阻止。
- 频控保护：窗口内同包名事件过多（阈值可调）时跳过并打印 `too_many_events_in_window`。
- 可观测：打印去重命中/未命中、窗口值、delta、指纹/计数等信息，便于调参。
- 配置项：
  - `auto_ledger_dedup_enabled`（默认 true）
  - `auto_ledger_dedup_window_sec`（默认 20，范围 1~600）
  - `auto_ledger_dedup_debug_parse_on_skip`（默认 false；命中去重时仍解析但不入账，用于回归）


### 幂等键设计
建议 eventKey = hash(pkg + amountNorm + minuteBucket + normalizedMerchant + textHash)，并持久化到去重表，建立唯一索引保障幂等。

### 重复源处理
- 相同事件多条通知：按 `notifKey/postTime` 与文本哈希去重。
- 聚合通知（Group Summary）：忽略摘要行，优先明细行。
- 电商“订单成功”与支付应用“支付成功”：通过包名白/黑名单 + 关键词（订单/付款/收款）分流，默认仅记账支付应用事件。
- 退款对冲：与原消费关联（金额/订单号关键词/商户匹配）生成负向交易或冲销记录。

—

## 数据模型与存储

在不破坏现有交易表的前提下，建议（落在 `core/database`）：
 - 交易扩展字段：sourceApp、sourceType、postedTime、parserVersion、confidence、accountGuess（可为空）。
 - 去重表：`auto_ledger_dedup(event_key TEXT PRIMARY KEY, created_at TIMESTAMP)`，周期清理。
 - 配置表：`app_auto_ledger_config(appPkg TEXT PRIMARY KEY, mode INT, blacklist TEXT, whitelist TEXT, amountWindowSec INT, confidenceThreshold REAL, accountRules TEXT, categoryRules TEXT)`。
- 审计可选：rawText/rawExtras 加密存储或关闭，遵循最小化原则与保留期限。

### 数据库迁移 v14 → v15（已落地）
- 目标：在不影响既有业务的前提下，引入自动记账所需的新表、字段与索引（与实现一致）。
- 变更清单：
  - 交易表 `transactions`
    - 新增列：`sourceApp TEXT`、`sourceType TEXT`、`postedTime INTEGER`、`parserVersion INTEGER DEFAULT 1`、`confidence REAL`、`accountGuess TEXT`
    - 索引：
      - `idx_transactions_source_time ON transactions(sourceApp, postedTime)`
      - `idx_transactions_source_type ON transactions(sourceType)`
      - `idx_transactions_confidence ON transactions(confidence)`
  - 新表：`auto_ledger_dedup`
    - 结构：`eventKey TEXT PK NOT NULL, createdAt INTEGER NOT NULL, packageName TEXT NOT NULL, textHash TEXT NOT NULL, amountCents INTEGER NOT NULL, merchantHash TEXT NULL, postTime INTEGER NOT NULL`
    - 索引：`createdAt`、`packageName`、`postTime`
  - 新表：`app_auto_ledger_config`
    - 结构：`appPkg TEXT PK NOT NULL, mode INTEGER NOT NULL DEFAULT 1, blacklist TEXT, whitelist TEXT, amountWindowSec INTEGER NOT NULL DEFAULT 300, confidenceThreshold REAL NOT NULL DEFAULT 0.85, accountRules TEXT, categoryRules TEXT, createdAt INTEGER NOT NULL, updatedAt INTEGER NOT NULL`
    - 索引：`mode`
- 回滚策略：新增列与新表，低风险；必要时清空新表即可回滚功能。

### 迁移字段与 DAO 草案清单（v14→v15）

实体建议（简化示例，实际以现有命名/包路径为准）：
```kotlin
// core/database/entity
@Entity(tableName = "auto_ledger_dedup")
data class AutoLedgerDedupEntity(
    @PrimaryKey val eventKey: String,
    val createdAt: Long,
    val packageName: String,
    val textHash: String,
    val amountCents: Long,
    val merchantHash: String?,
    val postTime: Long,
)

@Entity(tableName = "app_auto_ledger_config")
data class AppAutoLedgerConfigEntity(
    @PrimaryKey val appPkg: String,
    val mode: Int = 1, // 0禁用/1半自动/2全自动
    val blacklist: String? = null, // JSON
    val whitelist: String? = null, // JSON
    val amountWindowSec: Int = 300,
    val confidenceThreshold: Double = 0.85,
    val accountRules: String? = null, // JSON
    val categoryRules: String? = null, // JSON
)

// 若需扩展 transactions 表，可用 @ColumnInfo 标注新增列（示例）
data class TransactionExtraFields(
    val sourceApp: String?,
    val sourceType: String?,
    val postedTime: Long?,
    val parserVersion: Int?,
    val confidence: Double?,
    val accountGuess: String?,
)
```

DAO 草案：
```kotlin
// core/database/dao
@Dao
interface AutoLedgerDedupDao {
    @Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insert(entity: AutoLedgerDedupEntity): Long

    @Query("DELETE FROM auto_ledger_dedup WHERE createdAt < :expiredBefore")
    suspend fun cleanup(expiredBefore: Long): Int

    @Query("SELECT * FROM auto_ledger_dedup WHERE packageName = :pkg AND postTime BETWEEN :from AND :to")
    suspend fun findByPackageAndTimeRange(pkg: String, from: Long, to: Long): List<AutoLedgerDedupEntity>
}

@Dao
interface AppAutoLedgerConfigDao {
    @Query("SELECT * FROM app_auto_ledger_config WHERE appPkg = :pkg")
    suspend fun getByPkg(pkg: String): AppAutoLedgerConfigEntity?

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun upsert(entity: AppAutoLedgerConfigEntity)

    @Query("SELECT * FROM app_auto_ledger_config")
    fun observeAll(): Flow<List<AppAutoLedgerConfigEntity>>
}

// 省略其他无关 DAO 示例，以现有实现为准
```

迁移骨架（Kotlin 伪代码）：
```kotlin
val MIGRATION_14_15 = object : Migration(14, 15) {
    override fun migrate(db: SupportSQLiteDatabase) {
        db.execSQL("ALTER TABLE transactions ADD COLUMN sourceApp TEXT")
        db.execSQL("ALTER TABLE transactions ADD COLUMN sourceType TEXT")
        db.execSQL("ALTER TABLE transactions ADD COLUMN postedTime INTEGER")
        db.execSQL("ALTER TABLE transactions ADD COLUMN parserVersion INTEGER DEFAULT 1")
        db.execSQL("ALTER TABLE transactions ADD COLUMN confidence REAL")
        db.execSQL("ALTER TABLE transactions ADD COLUMN accountGuess TEXT")

        db.execSQL("CREATE TABLE IF NOT EXISTS auto_ledger_dedup (eventKey TEXT NOT NULL PRIMARY KEY, createdAt INTEGER NOT NULL, packageName TEXT NOT NULL, textHash TEXT NOT NULL, amountCents INTEGER NOT NULL, merchantHash TEXT, postTime INTEGER NOT NULL)")
        db.execSQL("CREATE TABLE IF NOT EXISTS app_auto_ledger_config (appPkg TEXT NOT NULL PRIMARY KEY, mode INTEGER NOT NULL DEFAULT 1, blacklist TEXT, whitelist TEXT, amountWindowSec INTEGER NOT NULL DEFAULT 300, confidenceThreshold REAL NOT NULL DEFAULT 0.85, accountRules TEXT, categoryRules TEXT, createdAt INTEGER NOT NULL, updatedAt INTEGER NOT NULL)")

        db.execSQL("CREATE INDEX IF NOT EXISTS idx_transactions_source_time ON transactions(sourceApp, postedTime)")
        db.execSQL("CREATE INDEX IF NOT EXISTS idx_transactions_source_type ON transactions(sourceType)")
        db.execSQL("CREATE INDEX IF NOT EXISTS idx_transactions_confidence ON transactions(confidence)")
        db.execSQL("CREATE INDEX IF NOT EXISTS idx_auto_ledger_dedup_created ON auto_ledger_dedup(createdAt)")
        db.execSQL("CREATE INDEX IF NOT EXISTS idx_auto_ledger_dedup_package ON auto_ledger_dedup(packageName)")
        db.execSQL("CREATE INDEX IF NOT EXISTS idx_auto_ledger_dedup_post_time ON auto_ledger_dedup(postTime)")
    }
}
```

### DataStore（轻量偏好）键位建议
- `auto_ledger_global_enabled: Boolean`（总开关，默认 false）
- `auto_ledger_default_mode: Int`（0 禁用/1 半自动/2 全自动；默认 1）
- 【待实现】`auto_ledger_undo_window_seconds: Int`（默认 30；当前实现为常量 30 秒）
 - 【新增（方案A）】`auto_ledger_alipay_auto_on: Boolean`（是否开启支付宝默认自动入账，默认 false）
 - 【新增（方案A）】`auto_ledger_alipay_default_account_id: String`（默认支付宝账户ID）
 - 【新增（方案A）】`auto_ledger_default_expense_category_id: String`（默认支出分类ID）
 - 【新增（方案A）】`auto_ledger_default_income_category_id: String`（默认收入分类ID）

### 清理策略
- 去重表 TTL：建议保留 30–60 天，定期 `DELETE FROM auto_ledger_dedup WHERE created_at < now-ttl`。
- 审计原文：若开启，加密保存并设置 7–30 天保留期；默认关闭。

—

## 交互与 UX 策略

默认交互（推荐，零额外权限）：
- 系统通知 + Action 按钮：在自动解析成功后发送一条应用内通知，附带“记账/撤销/编辑”操作；Android 13+ 先请求 `POST_NOTIFICATIONS`。注：当前版本以“主体点击进入应用添加交易页”为主，通知内 Action 为【待实现】。

可选交互（高级用户）：
- 悬浮窗弹窗：在支付时刻于前台应用浮层展示“快速记账对话框”。需 `SYSTEM_ALERT_WINDOW` 权限，提供显式开关与打扰控制（不在全屏/勿扰模式弹出）。

自动模式（方案A，开关）
- 范围：仅支付宝包名 `com.eg.android.AlipayGphone`。
- 行为：开启后，解析仅需金额/方向即可入账；账户使用“默认支付宝账户”，分类使用“默认支出/收入分类”；备注可标注“来源=支付宝”。
- 交互：
  - 开关开启→自动入账（仍保留撤销30秒）；
  - 开关关闭→半自动（主体点击进入应用添加交易页/弹窗编辑）。
- 边界：退款/转账等类型可暂定“半自动/仅提醒”，后续细化；保留去重与幂等保护。

打扰控制：
- 安静时段、全屏/游戏场景不弹窗；仅保留通知提示。
- 失败/低置信度不自动落账，仅发提醒或待办。

撤销与编辑：
- 自动落账后提供 30 秒撤销窗口（通知 Action）。
- 历史页提供“最近自动记账”筛选与单条撤销/编辑入口。

### DeepLink 测试与演示
- 示例 DeepLink（URL 需进行编码，以下仅示意）：
  - `ccxiaoji://app/add_transaction?amountCents=2850&direction=EXPENSE&merchant=%E6%98%9F%E5%B7%B4%E5%85%8B`
  - 可选参数：`accountId`、`categoryId`、`note`（为空则由应用侧推荐/兜底）。
- ADB 触发（Debug 包名）：
  - `adb shell am start -a android.intent.action.VIEW -d "ccxiaoji://app/add_transaction?amountCents=2850&direction=EXPENSE&merchant=%E6%98%9F%E5%B7%B4%E5%85%8B" com.ccxiaoji.app.debug`
- ADB 触发（Release 包名）：
  - `adb shell am start -a android.intent.action.VIEW -d "ccxiaoji://app/add_transaction?amountCents=2850&direction=EXPENSE&merchant=%E6%98%9F%E5%B7%B4%E5%85%8B" com.ccxiaoji.app`

—

## 生命周期与兼容

- 实现 `onListenerConnected/onListenerDisconnected`，并在权限变化时更新内部状态。
- 提供权限状态监控与恢复引导（设置页一键跳转）。
- 提示用户将应用加入电池优化白名单/允许自启动（可选，不强制）。

### DI 与线程模型（Hilt + Coroutines）
- 作用域建议：
  - `NotificationEventRepository`（shared）：`@Singleton`，内部使用 `callbackFlow`/`SharedFlow` 暴露事件。
  - `AutoLedgerManager`（feature）：`@Singleton` 或 `@ViewModelScoped`，由设置开关控制订阅生命周期。
  - `DeduplicationManager`：无状态或轻状态，`@Singleton`。
- 线程：
  - 解析/正则：`Dispatchers.Default`
  - 数据库/去重：`Dispatchers.IO`
  - UI/通知：`Dispatchers.Main`
- 背压：
  - 对 `events` Flow 使用 `buffer(capacity=Channel.BUFFERED, onBufferOverflow=DROP_OLDEST)`
  - 使用 `distinctUntilChangedBy { notifKey or textHash }` 降噪
  - 错误隔离：解析失败不影响流（`catch { emit(FailureEvent) }`）

### shared/notification 的 Hilt 绑定接口签名与线程安全说明

接口与实现草案：
```kotlin
// shared/notification/api
interface NotificationEventRepository {
    val events: Flow<RawNotificationEvent>
    suspend fun emit(event: RawNotificationEvent) // 供系统服务适配层调用
}

// shared/notification/domain/model
data class RawNotificationEvent(
    val packageName: String,
    val title: String?,
    val text: String?,
    val extras: Bundle?,
    val postTime: Long,
)

// shared/notification/data
@Singleton
class NotificationEventRepositoryImpl @Inject constructor(): NotificationEventRepository {
    private val scope = CoroutineScope(SupervisorJob() + Dispatchers.Default)
    private val _events = MutableSharedFlow<RawNotificationEvent>(
        replay = 0,
        extraBufferCapacity = 64,
        onBufferOverflow = BufferOverflow.DROP_OLDEST
    )
    override val events: Flow<RawNotificationEvent> = _events.asSharedFlow()

    override suspend fun emit(event: RawNotificationEvent) {
        _events.emit(event) // 非阻塞：因 extraBufferCapacity 设置，普遍可用
    }
}

// Hilt 模块绑定（shared/notification/di）
@Module
@InstallIn(SingletonComponent::class)
abstract class NotificationModule {
    @Binds
    @Singleton
    abstract fun bindNotificationEventRepository(
        impl: NotificationEventRepositoryImpl
    ): NotificationEventRepository
}

// 系统服务入口（支持 Hilt 注入）：
@AndroidEntryPoint
class PaymentNotificationListener: NotificationListenerService() {
    @Inject lateinit var notifRepo: NotificationEventRepository

    override fun onListenerConnected() {
        super.onListenerConnected()
        // 可在此记录连接状态或上报诊断
    }

    override fun onNotificationPosted(sbn: StatusBarNotification) {
        val n = sbn.notification
        val event = RawNotificationEvent(
            packageName = sbn.packageName,
            title = n.extras?.getString(Notification.EXTRA_TITLE),
            text = n.extras?.getCharSequence(Notification.EXTRA_TEXT)?.toString(),
            extras = n.extras,
            postTime = sbn.postTime,
        )
        // 避免在系统回调线程做阻塞操作
        GlobalScope.launch(Dispatchers.Default) { notifRepo.emit(event) }
    }
}
```

线程安全与性能说明：
- 事件流：`MutableSharedFlow` + `extraBufferCapacity`，丢弃最旧策略，避免突发通知阻塞系统回调。
- 回调线程：`NotificationListenerService` 回调中仅做轻量封装与转发，重活放到 `Dispatchers.Default/IO`。
- 生命周期：`NotificationEventRepositoryImpl` 使用进程级 `@Singleton` 与 `SupervisorJob` 确保稳定；订阅端（feature/ledger）按开关控制收听与取消。
- 注入方式：推荐 `@AndroidEntryPoint` 直接注入 Repository，避免静态单例或 ServiceLocator；如遇特定厂商兼容性问题，可退回 EntryPointAccessors 获取。

—

## 设置与权限引导 UI 草图

本章节给出设置页与权限引导的结构、状态与交互流程，便于快速落地 Compose 实现与测试。

### 导航与路由
- 路由：
  - `settings/auto_ledger` → `AutoLedgerSettingsScreen`
  - `settings/auto_ledger/permission` → `PermissionGuideScreen`
  - `settings/auto_ledger/app_mode` → `AppModeConfigScreen`

### 统一状态模型（简化）
- `PermissionState`
  - `notificationListenerEnabled: Boolean`（系统通知使用权是否已授予）
  - `postNotificationsGranted: Boolean`（Android 13+ 通知发布权限）
  - `canDrawOverlays: Boolean`（悬浮窗权限，默认不强制）
  - `ignoreBatteryOptimizations: Boolean`（是否已忽略电池优化，推荐但不强制）
- `AutoLedgerPrefs`
  - `globalEnabled: Boolean`（自动记账总开关）
  - `defaultMode: AutoLedgerMode`（禁用/半自动/全自动）
  - `undoWindowSeconds: Int`（撤销窗口秒数，默认 30）
- `AppModeItem`
  - `appName: String`、`packageName: String`
  - `mode: AutoLedgerMode`（每应用覆盖）
  - `isSupported: Boolean`（是否在支持列表：支付宝/微信/云闪付）

### AutoLedgerSettingsScreen（设置总览）

草图（示意）：
```
[返回] 自动记账
────────────────────────────────────────
☑ 自动记账（总开关）               [开启/关闭]
默认模式： [ 禁用 | 半自动 | 全自动 ]
撤销窗口： [ 30秒 ▾ ]

[权限状态]
  通知使用权（必须）         [已开启/去开启]
  通知发布权限（Android13+） [已开启/去开启]
  悬浮窗（可选）             [关闭/去开启]
  电池优化（建议）           [未忽略/去设置]

[来源应用与模式]
  支付宝（com.eg.android.AlipayGphone）   [ 禁用 | 半自动 | 全自动 ]
  微信（com.tencent.mm）                  [ 禁用 | 半自动 | 全自动 ]
  云闪付（com.unionpay）                  [ 禁用 | 半自动 | 全自动 ]
  更多应用...  （进入 AppModeConfigScreen）

[规则与映射]
  账户映射规则  ＞
  分类推荐设置  ＞
  去重策略设置  ＞

[调试与诊断]
  调试面板（最近通知/解析/去重） ＞
```

交互要点：
- 若 `notificationListenerEnabled=false`，顶部固定显示黄色提示条与“去开启”按钮；其他开关允许配置但不生效，点击时弹出权限提示。
- 进入页面首次在 Android 13+ 触发一次 `POST_NOTIFICATIONS` 申请（若未授权），避免频繁弹窗。
- 悬浮窗仅当用户在“规则与映射”启用“悬浮窗弹窗模式”时，才提示授权入口。
- 模式优先级：每应用覆盖 > 全局默认；UI 上每个应用行显示最终生效模式（灰字注释“继承默认：半自动”）。

空/错误态：
- 若未检测到监听器连接：在“权限状态”下显示“服务未连接，可能被系统回收，点击恢复”与引导说明。
- 若没有已知支持应用：展示占位说明与“去添加应用规则”。

资源命名建议：
- 图标：`ic_permission_notifications`、`ic_overlay_window`、`ic_battery_optimization`、`ic_auto_ledger`
- 字符串：`auto_ledger_title`、`auto_ledger_enable`、`permission_notification_listener_title` 等

### PermissionGuideScreen（权限引导）

草图（示意）：
```
[返回] 权限与兼容性
────────────────────────────────────────
为实现自动记账，需要以下权限与设置：

① 通知使用权（必须）
   说明：仅用于读取支付成功等相关通知，所有数据本地处理。
   [去系统设置开启]

② 通知发布权限（Android 13+，用于提示/撤销）
   说明：用于展示“已记账/撤销”等通知。
   [申请权限]

③ 悬浮窗权限（可选，高级功能）
   说明：仅在你启用“悬浮窗弹窗模式”时，用于就地确认。
   [去开启]

④ 电池优化（建议）
   说明：避免系统在后台回收通知监听服务。
   [去设置]

[完成]（全部满足或允许跳过，返回设置页）
```

交互要点：
- 支持分步骤进行；每步完成后刷新状态，已满足的项显示“已开启”。
- 文案合规：强调“仅用于支付相关通知、本地处理、不上传、可随时关闭”。
- 若用户拒绝运行时权限，提供“稍后再说”并保留功能开关为关闭态。

展示状态示例：
- 成功：绿色勾选 + “已开启”。
- 未授权：橙色提示 + 动作按钮（去开启/申请）。
- 不适用：灰色说明（如 Android 12 及以下的通知发布权限）。

### AppModeConfigScreen（应用模式配置）

草图（示意）：
```
[返回] 应用模式配置
────────────────────────────────────────
已知应用
  [✓] 支付宝       [ 禁用 | 半自动 | 全自动 ]
  [✓] 微信         [ 禁用 | 半自动 | 全自动 ]
  [✓] 云闪付       [ 禁用 | 半自动 | 全自动 ]

其他应用（黑/白名单）
  关键词黑名单（排除订单/物流等）  ＞
  关键词白名单（仅匹配付款/收款）  ＞

账户/分类映射（来源维度）
  
  来源：支付宝  →  账户：余额宝（可选）  ＞
  来源：微信    →  账户：微信零钱（可选）  ＞
  渠道：银行卡尾号*1234 → 账户：招行借记卡  ＞

说明：每应用模式优先于“默认模式”。
```

交互要点：
- “来源应用与模式”在设置总览中入口直达，便于快速切换。
- 黑/白名单与账户/分类映射进入二级编辑页（简单表单 + 可搜索/可排序）。
- 所有改动即时保存至 `AppAutoLedgerConfig`。

### 关键交互流程（序列图摘要）

1) 首次开启自动记账
```
用户 → 设置页：打开“自动记账”
系统 → 检测权限：NL 未授权 → 高亮提示
用户 → 点击“去开启” → 跳系统设置页
返回 → 权限已开启 → 请求 Android13+ 通知发布权限（一次性）
完成 → 默认模式=半自动，准备就绪
```

2) 半自动模式（无悬浮窗）
```
监听到支付通知 → 解析成功（高置信度）
→ 发送应用通知：动作“记账/编辑/忽略”
→ 用户点“记账” → 落账 → 展示“撤销（30s）”
```

3) 用户启用悬浮窗（高级）
```
设置页启用“悬浮窗弹窗模式” → 检测权限 → 引导授权
支付时刻 → 前台浮层的 QuickLedgerDialog → 用户确认/编辑 → 落账/忽略
```

### 文案与资源（示例）
- 权限用途说明（短）：
  - “仅用于读取支付成功等相关通知，所有数据仅在本地处理，绝不上传。”
- 失败提示：
  - “未取得通知使用权，自动记账暂不可用。请在系统设置中开启。”
- Action 按钮：`去开启`、`申请权限`、`去设置`、`完成`

### 验收要点（UI）
- 权限缺失时有明显但不打扰的引导；所有入口可一跳直达。
- 默认零额外权限可用（用通知 Action 完成交互）。
- 悬浮窗作为高级可选项，默认关闭且不反复打扰。
- 配置项即时保存；状态刷新不闪动（使用 StateFlow/remember）。

## 实现复杂度与契合度

- 开发周期：MVP 约 1–2 周（支付宝），完整 Phase 1–3 共 3–4 周。
- 依赖变更：无新增三方依赖；仅系统 API 与现有基础设施。
- 数据库：新增配置与去重表，交易表增加少量可空扩展字段。
- 契合度：与现有 Clean Architecture 与模块划分一致。

—

## 实施计划（通知监听主线）

### Task 执行原则（统一适用于所有 Phase）
- 顺序执行：所有 Task 必须在“前一 Task 验收通过”后才能开始。
- 独立验收：每个 Task 均包含功能/性能/质量/集成维度的验收标准，未达标不得进入下一步。
- 依赖管理：每个 Task 明确输入/输出工件（代码、配置、Schema、样本与报告）。
- 质量门禁：关键指标（解析准确率、幂等性、崩溃率、性能阈值）为强门禁项。
- 变更控制：如需调整验收标准，需在评审中更新本文档并记录理由。

### Phase 1：支付宝 MVP（通知监听）— 预计 1 周

Task 1.1 服务与权限接入（shared/notification）  
执行前提：无（起始 Task）。  
内容：在 `shared/notification` 创建 `PaymentNotificationListener` 与 `NotificationEventRepository`；注册 Manifest（`exported/enabled/permission`）；在 `app` 合并清单；完善权限引导页；Android 13+ 请求 `POST_NOTIFICATIONS`。  
验收：能稳定收到系统通知；权限切换后自恢复；不崩溃；`events` Flow 正常发出事件。
输入：settings.gradle 模块清单、现有 app 合并清单、Android 13+ 设备。  
输出：`PaymentNotificationListener`/`NotificationEventRepository(Impl)` 源码与 Hilt 模块、Manifest 片段、`PermissionGuideScreen` 占位、手测脚本/验证记录。

Task 1.2 解析器框架与支付宝解析（feature/ledger）  
执行前提：Task 1.1 验收通过。  
内容：在 `feature/ledger` 定义 `BaseNotificationParser` 接口、工厂；实现 `AlipayNotificationParser`，覆盖支付/转账/收款/退款常见文案；输出结构化字段与 `confidence`。  
验收：样本集准确率 ≥95%（金额/商户/方向）；失败有降级策略。
输入：RawNotificationEvent 样本集（支付宝）、文案与正则规则库。  
输出：`BaseNotificationParser`、`AlipayNotificationParser`、`NotificationParserFactory`、单元测试与样本准确率报告。

Task 1.3 去重与幂等（feature/ledger + core/database）  
执行前提：Task 1.2 验收通过。  
内容：在 `feature/ledger` 实现 `DeduplicationManager` 与 `eventKey` 规则；在 `core/database` 新增去重表与唯一索引；电商关键词黑名单；摘要行忽略。  
验收：同一事件不重复落账；电商“订单成功”不记账。
输入：解析后的结构化事件、数据库 v12 schema。  
输出：`DeduplicationManager`、`auto_ledger_dedup` 与 `app_auto_ledger_config` 实体/DAO、`Migration_12_13`、索引、黑/白名单初始配置、去重单测与集成验证报告。

Task 1.4 落账编排与账户/分类推荐（feature/ledger）  
执行前提：Task 1.3 验收通过。  
内容：`AutoLedgerManager` 调用 `AddTransactionUseCase`；基于商户/渠道推断账户与分类（可配置默认）。  
验收：创建交易成功；可记录 `sourceApp/sourceType/parserVersion/confidence`。
输入：解析结果与去重判定、现有 `AddTransactionUseCase`。  
输出：`AutoLedgerManager` 源码、账户/分类映射默认规则、与用例的集成测试与回归用例。

Task 1.5 交互与撤销（默认通知方式，feature/ledger）  
执行前提：Task 1.4 验收通过。  
内容：自动落账后发送应用通知，提供“撤销/编辑”Action；30 秒撤销窗口；半自动模式仅展示“记账”Action。  
验收：通知展示稳定；撤销有效且幂等；无权限时给出友好提示。
输入：落账成功事件回调、Android 13+ 通知发布权限。  
输出：通知渠道与 Action 实现、撤销窗口逻辑与幂等校验、相关字符串/图标资源、用户操作路径验证记录。

Task 1.6 调试与诊断  
执行前提：Task 1.5 验收通过。  
内容：调试面板显示最近 N 条通知的解析/去重决策，支持导出脱敏样本。  
验收：便于定位问题；不泄露隐私（脱敏开关）。
输入：解析/去重/落账管道的内部状态与指标。  
输出：调试面板 UI、脱敏导出功能、开关项、诊断文档与问题定位流程。

Task 1.7 测试与验收  
执行前提：Task 1.6 验收通过。  
内容：Robolectric 覆盖解析逻辑；多机型实测（Android 8–14、MIUI/EMUI/ColorOS）。  
验收：准确率/稳定性达标；关键路径性能满足指标。
输入：全链路实现、测试矩阵与样本集。  
输出：单元/集成/手测报告、性能数据与问题清单、修复确认记录。

### Phase 2：微信支付扩展 — 预计 1–1.5 周

Task 2.1 微信解析器实现  
执行前提：Phase 1 全部 Task 验收通过。  
内容：`WechatNotificationParser` 覆盖扫码/转账/收款/红包等文案；调整别名与正则。  
验收：样本集准确率 ≥90%；与支付宝互斥/去重正常。
输入：RawNotificationEvent 样本集（微信）、Phase 1 的解析框架。  
输出：`WechatNotificationParser`、规则样本与单测、互斥/去重联调报告。

Task 2.2 账户映射与规则面板  
执行前提：Task 2.1 验收通过。  
内容：为不同来源/渠道配置账户映射规则；设置页支持每应用模式与关键词规则。  
验收：映射命中率可观；用户可配置覆盖默认。
输入：历史交易与渠道标识样本、用户反馈。  
输出：账户/分类映射编辑 UI、规则持久化（Room/DataStore）、预览与命中率统计。

Task 2.3 对冲与异常场景  
执行前提：Task 2.2 验收通过。  
内容：退款/撤单/红包退回与原记录关联；冲销策略可选。  
验收：不会形成双计；关联关系清晰可追溯。
输入：退款/撤单类通知样本、既有交易数据。  
输出：对冲策略实现（关联规则、负向交易/冲销记录）、关联关系查询接口、用例与报告。

Task 2.4 灰度与指标  
执行前提：Task 2.3 验收通过。  
内容：解析成功率、自动落账占比、撤销率、重复命中率等埋点（本地统计/隐私友好）。  
验收：支持发布后迭代优化决策。
输入：埋点定义与调试面板指标。  
输出：灰度配置与观测报表、迭代优化建议清单。

### Phase 3：云闪付与增强 — 预计 1 周

Task 3.1 云闪付解析器  
执行前提：Phase 2 全部 Task 验收通过。  
内容：样本采集与规则实现；与支付宝/微信去重。  
验收：准确率 ≥85%。
输入：RawNotificationEvent 样本集（云闪付）、既有去重/解析框架。  
输出：`UnionPayNotificationParser`、样本与单测、互斥/去重联调报告。

Task 3.2 悬浮窗（可选增强）  
执行前提：Task 3.1 验收通过。  
内容：在设置中提供“悬浮窗弹窗”模式；尊重全屏/勿扰/安静时段。  
验收：Android 8–14 与 MIUI/EMUI/ColorOS 至少各 1 机型验证；全屏/勿扰下不弹窗、降级为通知 Action；无新增崩溃/ANR；用户可一键关闭并回退；权限缺失自动降级；内测满意度 ≥80%。
输入：现有半自动流程与权限引导。  
输出：QuickLedgerDialog 集成路径、权限引导与降级逻辑、A/B 对比与满意度调研结果。

Task 3.3 兼容与稳健性  
执行前提：Task 3.2 验收通过（或跳过可选项时由产品评审确认）。  
内容：权限状态监听、自恢复引导、电池优化与自启动提示。  
验收：权限被收回/服务断连/系统重启等场景 100% 给出引导并可恢复；新增崩溃 0；关键流程通过率 100%。
输入：厂商系统兼容清单、已知问题与用户反馈。  
输出：恢复引导与提示 UI、兼容性清单与回归脚本、问题库与 FAQ。

—

## Feature Flag 与发布策略
- 默认关闭全自动，仅开放半自动与通知 Action，作为灰度首发。
- 开关层级：
  - 全局：`auto_ledger_global_enabled`
  - 每应用：`app_auto_ledger_config.mode`
  - 能力位：悬浮窗模式、退款对冲、账户学习映射（可分别开关）
- 灰度：先支付宝，再微信，最后云闪付；支持“内部测试 → 小范围 → 全量”。
- 回滚：关闭总开关即刻生效；清理去重表不影响既有交易。

—

## 性能与质量指标
- 监听服务冷启动 < 2s；解析单次 < 50ms；去重计算 < 10ms；落账整体 < 300ms。
- 解析准确率：支付宝 ≥95%，微信 ≥90%，云闪付 ≥85%。
- 去重命中率：重复通知 100% 去除；订单类误记账 < 1/1000。
- 崩溃率：新增路径不引入 ANR/崩溃；内存占用可控。

—

## 隐私与合规
- 权限目的最小化：仅用于读取支付相关通知以实现本地自动记账，数据不外发。
- 用户控制：随时关闭自动记账与通知访问；提供数据删除与重置。
- 数据最小化：`rawText/rawExtras` 默认不持久化，或经加密与开关控制；设定保留期限。
- 隐私政策：更新权限用途、处理范围、保留周期、用户权利说明。

### 监控与诊断（隐私友好）
- 本地指标：解析成功率、自动落账占比、撤销率、重复命中率、错误分类率；默认仅本地可视（调试面板）。
- 调试日志：结构化条目（时间、包名、文本哈希、规则版本、置信度、去重键、决策）；默认脱敏，不落盘或限时加密落盘。
- 故障自检：权限缺失、服务未连接、电池优化被限制时在设置页显著提示。

—

## 测试计划
- 单元测试：解析器正则/规则、金额与商户归一化、去重键生成与比较。
- 集成测试：服务生命周期、权限切换、落账幂等、撤销路径。
- 手动测试矩阵：Android 8–14；MIUI/EMUI/ColorOS；支付宝/微信/云闪付多场景样本（扫码/转账/收款/退款/红包）。
- 性能与稳定性：长时间运行、后台/前台切换、全屏应用场景。

### 测试用例细化（示例）
- 解析准确性：
  - 金额千分位：`你向星巴克付款￥1,234.50` → 1234.50
  - 多币种：`USD $10.00` → currency=USD, amount=10.00
  - 负向/退款：`退款28.50元已退回` → refund, amount=28.50
- 去重：
  - 同一事件多条通知：相同 `notifKey/textHash` 不重复落账
  - 电商订单与支付重复：订单关键词触发黑名单不过账
- 权限切换：
  - 运行中关闭通知使用权 → 服务断开 → 设置页提示 → 重新授权自动恢复
- 撤销：
  - 30s 内撤销成功；超时不可撤销；幂等保证仅撤销一次
- 性能：
  - 解析 < 50ms；整链路 < 300ms；长压测 2 小时无明显泄漏与崩溃

—

## 附：默认模式与建议
- 默认交互：系统通知 + Action（推荐）。
- 悬浮窗：作为高级可选项，默认关闭。
- 应用策略：优先支持支付类应用；电商类默认黑/灰名单，开放手动白名单。

—

## 性能与电量预算
- 运行形态：常驻 NLService，无前台服务；不启用周期性轮询；仅在通知到达时处理。
- 处理预算：
  - 解析单条 < 50ms（P95）；去重计算 < 10ms；落账整体 < 300ms
  - 内存占用增量 < 20MB；CPU 平均占用近 0，峰值 < 5%
- 唤醒控制：不主动唤醒设备；遵循系统节电策略；不持有长时 WakeLock。
- 全屏/游戏：不弹出悬浮窗，仅以通知提示（遵循勿扰与优先级）。

## 风险清单与缓解
- 通知权限被收回（厂商/系统升级）：设置页显著提示 + 一键跳转授权；保持半自动回退。
- 非标准通知文案导致误判：使用置信度阈值与降级策略；用户可快速修正并学习映射。
- 电商订单重复：默认黑名单 + 去重幂等；允许用户按包名强制排除。
- MIUI/厂商杀进程：不做激进保活；提供电池优化与自启动指导；依赖系统恢复 NLService。
- 隐私担忧：默认不落盘原文；严格本地处理；文案与政策透明可控。
