# æ•°æ®å¯¼å‡ºå’Œå¯¼å…¥åŠŸèƒ½é‡æ„æ–¹æ¡ˆ - FastExcelæ–¹æ¡ˆ

## ğŸ¯ é¡¹ç›®èƒŒæ™¯

### å½“å‰çŠ¶å†µ
- ç»å†äº†12ä¸ªé˜¶æ®µçš„ä¿®å¤ï¼Œä»ç„¶å­˜åœ¨å„ç§é—®é¢˜
- ä»£ç å¤æ‚åº¦é«˜ï¼Œç»´æŠ¤å›°éš¾
- CSVæ ¼å¼é™åˆ¶å¤šï¼Œç”¨æˆ·ä½“éªŒå·®
- å†…å­˜é—®é¢˜ã€æ€§èƒ½é—®é¢˜é¢‘å‘

### æ ¸å¿ƒå†³ç­–
**æ¨å€’é‡æ–°ç Œå¢™** - å®Œå…¨æŠ›å¼ƒç°æœ‰çš„CSV+ZIPæ–¹æ¡ˆï¼Œé‡‡ç”¨**CSV+JSON**ç»„åˆæ–¹æ¡ˆå®ç°å…¨æ–°çš„æ•°æ®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹©CSV+JSON
1. **é›¶ä¾èµ–ä¼˜åŠ¿**ï¼šä¸éœ€è¦ç¬¬ä¸‰æ–¹åº“ï¼Œå‡å°‘APKä½“ç§¯å’Œä¾èµ–é£é™©
2. **æ€§èƒ½å“è¶Š**ï¼šCSVè§£ææ¯”Excelæ›´å¿«ï¼ŒJSONå¤„ç†ä¸ºAndroidåŸç”Ÿæ”¯æŒ
3. **ç”¨æˆ·ä½“éªŒå¥½**ï¼šè®°è´¦æ•°æ®CSVæ ¼å¼å¯ç›´æ¥åœ¨Excelä¸­æŸ¥çœ‹ï¼Œç±»ä¼¼é’±è¿¹è½¯ä»¶
4. **æ•°æ®åŒ¹é…åº¦é«˜**ï¼šå¤§é‡è¡¨æ ¼æ•°æ®ç”¨CSVï¼Œå°‘é‡ç»“æ„åŒ–æ•°æ®ç”¨JSON
5. **æŠ€æœ¯å®ç°ç®€å•**ï¼šåŸç”ŸAPIæ”¯æŒï¼Œå¼€å‘ç»´æŠ¤æˆæœ¬æ›´ä½
6. **æ–‡ä»¶ä½“ç§¯æ›´å°**ï¼šæ¯”Excelæ ¼å¼æ–‡ä»¶æ›´å°ï¼Œä¼ è¾“å’Œå­˜å‚¨æ›´é«˜æ•ˆ

## ğŸ“‹ å®æ–½åŸåˆ™

### 1. å½»åº•é‡æ„åŸåˆ™
- **ä¸ä¿®å¤ï¼Œç›´æ¥æ›¿æ¢**ï¼šåˆ é™¤æ‰€æœ‰æ—§ä»£ç ï¼Œä»é›¶å¼€å§‹
- **ä¸å…¼å®¹æ—§æ ¼å¼**ï¼šé¡¹ç›®æœªå‘å¸ƒï¼Œæ— éœ€è€ƒè™‘å‘åå…¼å®¹
- **ç®€å•ä¼˜å…ˆ**ï¼šé€‰æ‹©æœ€ç®€å•ç›´æ¥çš„å®ç°æ–¹å¼

### 2. æŠ€æœ¯é€‰å‹åŸåˆ™
- **æ··åˆæ–‡ä»¶æ ¼å¼**ï¼šè®°è´¦æ•°æ®ä½¿ç”¨CSVæ ¼å¼ï¼Œå…¶ä»–æ•°æ®ä½¿ç”¨JSONæ ¼å¼
- **æµå¼å¤„ç†**ï¼šå¤§é‡æ•°æ®ï¼ˆCSVï¼‰ä½¿ç”¨æµå¼APIï¼Œç»“æ„åŒ–æ•°æ®ï¼ˆJSONï¼‰ä½¿ç”¨æ ‡å‡†è§£æ
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªä¸šåŠ¡æ¨¡å—ç‹¬ç«‹çš„å¯¼å…¥å¯¼å‡ºé€»è¾‘

### 3. ç”¨æˆ·ä½“éªŒåŸåˆ™
- **ç›´è§‚å¯è§†**ï¼šè®°è´¦CSVæ–‡ä»¶å¯ç›´æ¥åœ¨Excelä¸­æŸ¥çœ‹ï¼Œç±»ä¼¼é’±è¿¹è½¯ä»¶ä½“éªŒ
- **ç»“æ„æ¸…æ™°**ï¼šå¤§é‡æ•°æ®ç”¨CSVè¡¨æ ¼ï¼Œå°‘é‡æ•°æ®ç”¨JSONç»“æ„åŒ–å­˜å‚¨
- **è¿›åº¦åé¦ˆ**ï¼šå®æ—¶æ˜¾ç¤ºå¯¼å…¥å¯¼å‡ºè¿›åº¦

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### 1. æ•´ä½“æ¶æ„
```
app/src/main/kotlin/com/ccxiaoji/app/data/backup/
â”œâ”€â”€ BackupManager.kt              # æ€»æ§åˆ¶å™¨
â”œâ”€â”€ CsvExporter.kt               # CSVå¯¼å‡ºæ¥å£å’Œå®ç°
â”œâ”€â”€ CsvImporter.kt               # CSVå¯¼å…¥æ¥å£å’Œå®ç°
â”œâ”€â”€ JsonExporter.kt              # JSONå¯¼å‡ºæ¥å£å’Œå®ç°
â”œâ”€â”€ JsonImporter.kt              # JSONå¯¼å…¥æ¥å£å’Œå®ç°
â”œâ”€â”€ BackupMetadata.kt            # å…ƒæ•°æ®æ¨¡å‹
â”œâ”€â”€ BackupValidator.kt           # æ•°æ®éªŒè¯å™¨
â”œâ”€â”€ mappers/                     # æ•°æ®æ˜ å°„å™¨
â”‚   â”œâ”€â”€ TransactionCsvMapper.kt  # äº¤æ˜“è®°å½•CSVæ˜ å°„
â”‚   â”œâ”€â”€ LedgerJsonMapper.kt      # è®°è´¦ä¸»æ•°æ®JSONæ˜ å°„
â”‚   â”œâ”€â”€ TodoJsonMapper.kt        # å¾…åŠJSONæ˜ å°„
â”‚   â”œâ”€â”€ HabitJsonMapper.kt       # ä¹ æƒ¯JSONæ˜ å°„
â”‚   â””â”€â”€ ...
â””â”€â”€ models/                      # å¤‡ä»½æ•°æ®æ¨¡å‹
    â”œâ”€â”€ BackupConfig.kt
    â”œâ”€â”€ BackupResult.kt
    â””â”€â”€ BackupError.kt
```

### 2. æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### BackupManagerï¼ˆæ€»æ§åˆ¶å™¨ï¼‰
```kotlin
@Singleton
class BackupManager @Inject constructor(
    private val csvExporter: CsvExporter,
    private val csvImporter: CsvImporter,
    private val jsonExporter: JsonExporter,
    private val jsonImporter: JsonImporter,
    private val validator: BackupValidator
) {
    suspend fun exportBackup(
        uri: Uri,
        config: BackupConfig,
        progressCallback: (Float, String) -> Unit
    ): Result<BackupStats>
    
    suspend fun importBackup(
        uri: Uri,
        mode: ImportMode,
        progressCallback: (Float, String) -> Unit
    ): Result<BackupStats>
}
```

#### CsvExporterï¼ˆCSVå¯¼å‡ºå™¨ï¼‰
```kotlin
interface CsvExporter {
    suspend fun exportTransactions(
        outputStream: OutputStream,
        config: BackupConfig,
        onProgress: (Float, String) -> Unit
    ): CsvExportStats
}

class TransactionCsvExporter @Inject constructor(
    private val transactionMapper: TransactionCsvMapper
) : CsvExporter {
    override suspend fun exportTransactions(...): CsvExportStats {
        // 1. å†™å…¥CSVå¤´éƒ¨
        writer.writeHeader("ID", "æ—¶é—´", "ç±»å‹", "é‡‘é¢", "è´¦æˆ·", "åˆ†ç±»", "å¤‡æ³¨")
        
        // 2. æµå¼å†™å…¥äº¤æ˜“æ•°æ®
        transactionRepository.getAllTransactionsFlow().collect { transaction ->
            writer.writeRecord(
                transaction.id,
                transaction.formatDateTime(),
                transaction.type,
                transaction.formatAmount(),
                transaction.accountName,
                transaction.categoryName,
                transaction.note ?: ""
            )
        }
    }
}
```

#### JsonExporterï¼ˆJSONå¯¼å‡ºå™¨ï¼‰
```kotlin
interface JsonExporter {
    suspend fun exportModule(
        moduleType: ModuleType,
        config: BackupConfig
    ): JsonObject
}

class ModuleJsonExporter @Inject constructor(
    private val mappers: Map<ModuleType, JsonMapper>
) : JsonExporter {
    override suspend fun exportModule(moduleType: ModuleType, config: BackupConfig): JsonObject {
        val mapper = mappers[moduleType] ?: throw IllegalArgumentException("Unknown module: $moduleType")
        return mapper.exportToJson(config)
    }
}
```

### 3. æ•°æ®æ¨¡å‹è®¾è®¡

#### å¤‡ä»½æ–‡ä»¶ç»“æ„
```
CCå°è®°å¤‡ä»½_2025-07-31.zip
â”œâ”€â”€ metadata.json                    # å¤‡ä»½å…ƒæ•°æ®
â”‚   â”œâ”€â”€ ç‰ˆæœ¬ä¿¡æ¯
â”‚   â”œâ”€â”€ å¯¼å‡ºæ—¶é—´
â”‚   â”œâ”€â”€ åº”ç”¨ç‰ˆæœ¬
â”‚   â””â”€â”€ æ•°æ®ç»Ÿè®¡
â”œâ”€â”€ transactions.csv                 # äº¤æ˜“è®°å½•ï¼ˆå¤§é‡æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ äº¤æ˜“è®°å½•
â”‚   â””â”€â”€ å‚è€ƒé’±è¿¹æ ¼å¼ï¼Œç”¨æˆ·å‹å¥½
â”œâ”€â”€ ledger_master.json              # è®°è´¦ä¸»æ•°æ®
â”‚   â”œâ”€â”€ è´¦æˆ·ä¿¡æ¯
â”‚   â”œâ”€â”€ åˆ†ç±»ä¿¡æ¯
â”‚   â”œâ”€â”€ é¢„ç®—ä¿¡æ¯
â”‚   â””â”€â”€ ä¿¡ç”¨å¡ç­‰å…¶ä»–è®°è´¦æ•°æ®
â”œâ”€â”€ todo.json                        # å¾…åŠæ•°æ®
â”‚   â””â”€â”€ ä»»åŠ¡åˆ—è¡¨
â”œâ”€â”€ habit.json                       # ä¹ æƒ¯æ•°æ®
â”‚   â”œâ”€â”€ ä¹ æƒ¯å®šä¹‰
â”‚   â””â”€â”€ æ‰“å¡è®°å½•
â”œâ”€â”€ schedule.json                    # æ’ç­æ•°æ®
â”‚   â”œâ”€â”€ ç­æ¬¡å®šä¹‰
â”‚   â”œâ”€â”€ æ’ç­è®°å½•
â”‚   â””â”€â”€ æ’ç­æ¨¡å¼
â”œâ”€â”€ plan.json                        # è®¡åˆ’æ•°æ®ï¼ˆæ”¯æŒæ ‘å½¢ç»“æ„ï¼‰
â”‚   â”œâ”€â”€ è®¡åˆ’åˆ—è¡¨
â”‚   â”œâ”€â”€ é‡Œç¨‹ç¢‘
â”‚   â””â”€â”€ æ¨¡æ¿
â””â”€â”€ others.json                      # å…¶ä»–æ•°æ®
    â”œâ”€â”€ å€’è®¡æ—¶
    â”œâ”€â”€ ç”¨æˆ·è®¾ç½®
    â””â”€â”€ å˜æ›´æ—¥å¿—
```

#### å…ƒæ•°æ®æ–‡ä»¶è®¾è®¡ï¼ˆmetadata.jsonï¼‰
```json
{
  "fileType": "CCå°è®°å¤‡ä»½æ–‡ä»¶",
  "fileVersion": "2.0",
  "exportTime": "2025-07-31T10:30:00Z",
  "appVersion": "2.5.0",
  "deviceInfo": "Android 14",
  "dataRange": {
    "startDate": "2024-01-01",
    "endDate": "2025-07-31"
  },
  "statistics": {
    "transactionCount": 1234,
    "todoCount": 56,
    "habitRecordCount": 789,
    "scheduleCount": 150,
    "planCount": 25
  },
  "files": {
    "transactions.csv": "äº¤æ˜“è®°å½•æ•°æ®",
    "ledger_master.json": "è®°è´¦ä¸»æ•°æ®",
    "todo.json": "å¾…åŠæ•°æ®",
    "habit.json": "ä¹ æƒ¯æ•°æ®",
    "schedule.json": "æ’ç­æ•°æ®", 
    "plan.json": "è®¡åˆ’æ•°æ®",
    "others.json": "å…¶ä»–æ•°æ®"
  },
  "checksum": {
    "algorithm": "SHA-256",
    "value": "abc123..."
  }
}
```

#### äº¤æ˜“è®°å½•CSVæ ¼å¼ï¼ˆé’±è¿¹å…¼å®¹ï¼‰
```csv
"ID","æ—¶é—´","åˆ†ç±»","äºŒçº§åˆ†ç±»","ç±»å‹","é‡‘é¢","å¸ç§","è´¦æˆ·1","è´¦æˆ·2","å¤‡æ³¨","å·²æŠ¥é”€","æ‰‹ç»­è´¹","ä¼˜æƒ åˆ¸","è®°è´¦è€…","è´¦å•æ ‡è®°","æ ‡ç­¾","è´¦å•å›¾ç‰‡","å…³è”è´¦å•"
"cc_1722412200000","2025-07-31 10:30:00","é¤é¥®","","æ”¯å‡º","25.50","CNY","å¾®ä¿¡é›¶é’±","","åˆé¤","","","","CCå°è®°ç”¨æˆ·","","","",""
```

#### å­—æ®µæ˜ å°„ç­–ç•¥è¯´æ˜

| é’±è¿¹å­—æ®µ | CCå°è®°å­—æ®µ | æ˜ å°„è§„åˆ™ | ç¤ºä¾‹å€¼ |
|---------|-----------|---------|--------|
| ID | TransactionEntity.id | `cc_${createdAt}` | `cc_1722412200000` |
| æ—¶é—´ | TransactionEntity.date | ç›´æ¥æ˜ å°„ | `2025-07-31 10:30:00` |
| åˆ†ç±» | CategoryEntity.name | é€šè¿‡categoryIdå…³è” | `é¤é¥®` |
| äºŒçº§åˆ†ç±» | - | å›ºå®šç©ºå€¼ | `""` |
| ç±»å‹ | TransactionEntity.type | æšä¸¾è½¬å­—ç¬¦ä¸² | `æ”¯å‡º`/`æ”¶å…¥` |
| é‡‘é¢ | TransactionEntity.amount | åˆ†è½¬å…ƒå¤„ç† | `25.50` |
| å¸ç§ | - | å›ºå®šCNY | `CNY` |
| è´¦æˆ·1 | AccountEntity.name | é€šè¿‡accountIdå…³è” | `å¾®ä¿¡é›¶é’±` |
| è´¦æˆ·2 | - | è½¬è´¦åœºæ™¯ä½¿ç”¨ | `""` |
| å¤‡æ³¨ | TransactionEntity.note | ç›´æ¥æ˜ å°„ï¼Œç©ºå€¼å¤„ç† | `åˆé¤` |
| å·²æŠ¥é”€ | - | ä¼ä¸šç‰ˆåŠŸèƒ½é¢„ç•™ | `""` |
| æ‰‹ç»­è´¹ | - | é‡‘èæ‰©å±•é¢„ç•™ | `""` |
| ä¼˜æƒ åˆ¸ | - | è¥é”€åŠŸèƒ½é¢„ç•™ | `""` |
| è®°è´¦è€… | UserEntity.name | é»˜è®¤æˆ–å®é™…ç”¨æˆ·å | `CCå°è®°ç”¨æˆ·` |
| è´¦å•æ ‡è®° | - | æ ‡ç­¾æ‰©å±•é¢„ç•™ | `""` |
| æ ‡ç­¾ | TransactionEntity.tags | é€—å·åˆ†éš” | `æ ‡ç­¾1,æ ‡ç­¾2` |
| è´¦å•å›¾ç‰‡ | - | å›¾ç‰‡åŠŸèƒ½é¢„ç•™ | `""` |
| å…³è”è´¦å• | - | å…³è”åœºæ™¯é¢„ç•™ | `åŸäº¤æ˜“ID` |

### 4. æ•°æ®åº“çœŸå®ç»“æ„ï¼ˆåŸºäºä»£ç åˆ†æï¼‰

#### æ•°æ®åº“ç‰ˆæœ¬ï¼š7

#### å®Œæ•´å®ä½“åˆ—è¡¨ï¼ˆ23ä¸ªè¡¨ï¼‰
```
1. ç”¨æˆ·æ¨¡å— (1è¡¨)
   - UserEntity

2. è®°è´¦æ¨¡å— (9è¡¨)
   - TransactionEntity      - äº¤æ˜“è®°å½•
   - AccountEntity          - è´¦æˆ·ï¼ˆå«ä¿¡ç”¨å¡æ‰©å±•å­—æ®µï¼‰
   - CategoryEntity         - åˆ†ç±»
   - BudgetEntity          - é¢„ç®—
   - RecurringTransactionEntity - å®šæœŸäº¤æ˜“
   - SavingsGoalEntity     - å‚¨è“„ç›®æ ‡
   - SavingsContributionEntity - å‚¨è“„è´¡çŒ®
   - CreditCardBillEntity  - ä¿¡ç”¨å¡è´¦å•
   - CreditCardPaymentEntity - ä¿¡ç”¨å¡è¿˜æ¬¾

3. å¾…åŠæ¨¡å— (1è¡¨)
   - TaskEntity            - ä»»åŠ¡

4. ä¹ æƒ¯æ¨¡å— (2è¡¨)
   - HabitEntity           - ä¹ æƒ¯å®šä¹‰
   - HabitRecordEntity     - æ‰“å¡è®°å½•

5. æ’ç­æ¨¡å— (4è¡¨)
   - ShiftEntity           - ç­æ¬¡å®šä¹‰
   - ScheduleEntity        - æ’ç­è®°å½•
   - PatternEntity         - æ’ç­æ¨¡å¼
   - ExportHistoryEntity   - å¯¼å‡ºå†å²

6. è®¡åˆ’æ¨¡å— (3è¡¨)
   - PlanEntity            - è®¡åˆ’ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
   - MilestoneEntity       - é‡Œç¨‹ç¢‘
   - TemplateEntity        - è®¡åˆ’æ¨¡æ¿

7. å…¶ä»–æ•°æ® (2è¡¨)
   - CountdownEntity       - å€’è®¡æ—¶
   - ChangeLogEntity       - å˜æ›´æ—¥å¿—
```

#### å¯¼å…¥é¡ºåºä¾èµ–
```
ç¬¬1å±‚ï¼ˆç‹¬ç«‹è¡¨ï¼‰ï¼š
- UserEntity
- CategoryEntity
- ShiftEntity
- TemplateEntity
- PatternEntity

ç¬¬2å±‚ï¼ˆä¾èµ–Userï¼‰ï¼š
- AccountEntity
- TaskEntity
- HabitEntity
- PlanEntity (å¯è‡ªå¼•ç”¨)
- CountdownEntity

ç¬¬3å±‚ï¼ˆä¾èµ–ç¬¬2å±‚ï¼‰ï¼š
- TransactionEntity (ä¾èµ–Account, Category)
- BudgetEntity (ä¾èµ–Category)
- RecurringTransactionEntity (ä¾èµ–Account, Category)
- SavingsGoalEntity
- SavingsContributionEntity (ä¾èµ–SavingsGoal)
- CreditCardBillEntity (ä¾èµ–Account)
- CreditCardPaymentEntity (ä¾èµ–Account, Bill)
- HabitRecordEntity (ä¾èµ–Habit)
- ScheduleEntity (ä¾èµ–Shift)
- MilestoneEntity (ä¾èµ–Plan)
- ExportHistoryEntity

ç¬¬4å±‚ï¼ˆå˜æ›´è®°å½•ï¼‰ï¼š
- ChangeLogEntity
```

### 5. åŸºäºçœŸå®æ•°æ®ç»“æ„çš„æ•°æ®ç»„ç»‡æ–¹æ¡ˆ

#### 5.1 Excelå·¥ä½œè¡¨ç»“æ„è®¾è®¡
æ ¹æ®23ä¸ªè¡¨çš„å®é™…æƒ…å†µï¼Œè°ƒæ•´Excelæ–‡ä»¶ç»“æ„ï¼š
```
CCå°è®°å¤‡ä»½.xlsx
â”œâ”€â”€ å…ƒæ•°æ® (Metadata)
â”œâ”€â”€ è®°è´¦æ•°æ® (Ledger) - åŒ…å«9ä¸ªè¡¨çš„æ•°æ®
â”œâ”€â”€ å¾…åŠä»»åŠ¡ (Todo) - åŒ…å«1ä¸ªè¡¨çš„æ•°æ®  
â”œâ”€â”€ ä¹ æƒ¯è®°å½• (Habit) - åŒ…å«2ä¸ªè¡¨çš„æ•°æ®
â”œâ”€â”€ æ’ç­æ•°æ® (Schedule) - åŒ…å«4ä¸ªè¡¨çš„æ•°æ®
â”œâ”€â”€ è®¡åˆ’æ•°æ® (Plan) - åŒ…å«3ä¸ªè¡¨çš„æ•°æ®
â””â”€â”€ å…¶ä»–æ•°æ® (Others) - åŒ…å«Userã€Countdownã€ChangeLog
```

#### 5.2 å„å·¥ä½œè¡¨æ•°æ®ç»„ç»‡

**è®°è´¦æ•°æ®è¡¨ç»„ç»‡**ï¼ˆ9ä¸ªè¡¨åœ¨ä¸€ä¸ªSheetä¸­æŒ‰åŒºå—æ’åˆ—ï¼‰ï¼š
```
=== è´¦æˆ·ä¿¡æ¯ ===
[AccountEntityæ•°æ®]

=== åˆ†ç±»ä¿¡æ¯ ===
[CategoryEntityæ•°æ®]

=== äº¤æ˜“è®°å½• ===
[TransactionEntityæ•°æ®]

=== é¢„ç®—è®¾ç½® ===
[BudgetEntityæ•°æ®]

=== å®šæœŸäº¤æ˜“ ===
[RecurringTransactionEntityæ•°æ®]

=== å‚¨è“„ç›®æ ‡ ===
[SavingsGoalEntityæ•°æ®]
[SavingsContributionEntityæ•°æ®]

=== ä¿¡ç”¨å¡ç®¡ç† ===
[CreditCardBillEntityæ•°æ®]
[CreditCardPaymentEntityæ•°æ®]
```

**å…¶ä»–æ¨¡å—ç»„ç»‡**ï¼š
- Todoï¼šå•è¡¨ç›´æ¥å¯¼å‡º
- Habitï¼šHabitEntityå’ŒHabitRecordEntityåˆ†åŒºå—
- Scheduleï¼š4ä¸ªè¡¨åˆ†åŒºå—ï¼ˆæ³¨æ„snake_caseè½¬æ¢ï¼‰
- Planï¼š3ä¸ªè¡¨åˆ†åŒºå—ï¼ˆæ³¨æ„æ ‘å½¢ç»“æ„çš„parentIdï¼‰
- Othersï¼šUserã€Countdownã€ChangeLogåˆ†åŒºå—

#### 5.3 æ•°æ®å­—æ®µå¤„ç†è§„åˆ™

1. **å‘½åè§„èŒƒç»Ÿä¸€**ï¼š
   - Scheduleæ¨¡å—çš„snake_caseï¼ˆå¦‚`shift_id`ã€`created_at`ï¼‰å¯¼å‡ºæ—¶è½¬ä¸ºcamelCase
   - å¯¼å…¥æ—¶æ ¹æ®ç›®æ ‡è¡¨ç»“æ„è‡ªåŠ¨è½¬æ¢å›snake_case

2. **ç‰¹æ®Šå­—æ®µå¤„ç†**ï¼š
   - JSONå­—æ®µï¼ˆPlanEntityçš„tagsã€reminderSettingsï¼‰ä¿æŒJSONå­—ç¬¦ä¸²æ ¼å¼
   - æ—¶é—´æˆ³è½¬æ¢ä¸ºå¯è¯»æ—¥æœŸæ ¼å¼ï¼š`2025-07-31 10:30:00`
   - é‡‘é¢å­—æ®µä»åˆ†è½¬æ¢ä¸ºå…ƒï¼š`amountCents / 100`
   - Booleanå­—æ®µè½¬æ¢ä¸ºæ˜¯/å¦

3. **é’±è¿¹å…¼å®¹å­—æ®µå¤„ç†**ï¼š
   - **IDæ ¼å¼**ï¼šä½¿ç”¨`cc_[timestamp]`æ ¼å¼æ›¿ä»£ç®€å•ç¼–å·
   - **äºŒçº§åˆ†ç±»**ï¼šæš‚æ—¶ä¸ºç©ºå­—ç¬¦ä¸²`""`ï¼Œä¸ºæœªæ¥æ‰©å±•ä¿ç•™
   - **å¸ç§**ï¼šé»˜è®¤å¡«å…¥`"CNY"`ï¼Œæ”¯æŒå¤šå¸ç§æ—¶å¯æ‰©å±•
   - **è´¦æˆ·1/è´¦æˆ·2**ï¼šæ™®é€šäº¤æ˜“å¡«è´¦æˆ·1ï¼Œè½¬è´¦æ—¶ä½¿ç”¨åŒè´¦æˆ·
   - **å·²æŠ¥é”€**ï¼šæš‚æ—¶ä¸ºç©º`""`ï¼Œä¼ä¸šç‰ˆåŠŸèƒ½é¢„ç•™
   - **æ‰‹ç»­è´¹**ï¼šæš‚æ—¶ä¸ºç©º`""`ï¼Œé‡‘èè´¦æˆ·æ‰©å±•æ—¶ä½¿ç”¨
   - **ä¼˜æƒ åˆ¸**ï¼šæš‚æ—¶ä¸ºç©º`""`ï¼Œè¥é”€åŠŸèƒ½é¢„ç•™
   - **è®°è´¦è€…**ï¼šé»˜è®¤å¡«å…¥`"CCå°è®°ç”¨æˆ·"`æˆ–å®é™…ç”¨æˆ·å
   - **è´¦å•æ ‡è®°**ï¼šæš‚æ—¶ä¸ºç©º`""`ï¼Œæ ‡ç­¾æ‰©å±•åŠŸèƒ½
   - **æ ‡ç­¾**ï¼šå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼Œå¦‚`"æ ‡ç­¾1,æ ‡ç­¾2"`
   - **è´¦å•å›¾ç‰‡**ï¼šæš‚æ—¶ä¸ºç©º`""`ï¼Œæœªæ¥æ”¯æŒå›¾ç‰‡é™„ä»¶
   - **å…³è”è´¦å•**ï¼šç”¨äºé€€æ¬¾ç­‰å…³è”åœºæ™¯ï¼Œå¡«å…¥åŸäº¤æ˜“ID

4. **çŠ¶æ€å­—æ®µå¤„ç†**ï¼š
   - syncStatusï¼šå¯¼å‡ºæ—¶ä¿ç•™ï¼Œå¯¼å…¥æ—¶å¯é€‰é‡ç½®
   - isDeletedï¼šæä¾›é€‰é¡¹æ˜¯å¦å¯¼å‡ºå·²åˆ é™¤æ•°æ®

#### 5.4 å¯¼å…¥é¡ºåºæ§åˆ¶

åœ¨å…ƒæ•°æ®è¡¨ä¸­æ˜ç¡®è®°å½•å¯¼å…¥é¡ºåºï¼š
```
å¯¼å…¥é¡ºåº | è¡¨å | æ‰€åœ¨Sheet | ä¾èµ–è¡¨
-------|------|----------|--------
1 | UserEntity | å…¶ä»–æ•°æ® | æ— 
1 | CategoryEntity | è®°è´¦æ•°æ® | æ—   
1 | ShiftEntity | æ’ç­æ•°æ® | æ— 
1 | TemplateEntity | è®¡åˆ’æ•°æ® | æ— 
1 | PatternEntity | æ’ç­æ•°æ® | æ— 
2 | AccountEntity | è®°è´¦æ•°æ® | UserEntity
2 | TaskEntity | å¾…åŠä»»åŠ¡ | UserEntity
2 | HabitEntity | ä¹ æƒ¯è®°å½• | UserEntity
2 | PlanEntity | è®¡åˆ’æ•°æ® | UserEntity, TemplateEntity
2 | CountdownEntity | å…¶ä»–æ•°æ® | UserEntity
3 | TransactionEntity | è®°è´¦æ•°æ® | AccountEntity, CategoryEntity
3 | BudgetEntity | è®°è´¦æ•°æ® | CategoryEntity
... (å®Œæ•´åˆ—è¡¨)
```

#### 5.5 å¤–é”®å¼•ç”¨å¤„ç†ç­–ç•¥

1. **å¯¼å‡ºæ—¶**ï¼š
   - ä¿ç•™åŸå§‹IDå’Œæ‰€æœ‰å¤–é”®å€¼
   - ä¸åšä»»ä½•IDè½¬æ¢ï¼Œä¿æŒæ•°æ®åŸå§‹æ€§

2. **å¯¼å…¥æ—¶**ï¼š
   - æä¾›ä¸¤ç§æ¨¡å¼ï¼šä¿ç•™åŸID / é‡æ–°ç”ŸæˆID
   - å¦‚æœé‡æ–°ç”ŸæˆIDï¼Œå»ºç«‹æ˜ å°„è¡¨å¹¶æ›´æ–°æ‰€æœ‰å¤–é”®å¼•ç”¨

### 6. æ¨¡å—æ˜ å°„å™¨è®¾è®¡

æ¯ä¸ªä¸šåŠ¡æ¨¡å—éƒ½æœ‰ä¸“é—¨çš„æ˜ å°„å™¨è´Ÿè´£æ•°æ®è½¬æ¢ï¼š

```kotlin
interface ExcelMapper {
    val moduleType: ModuleType
    val sheetName: String
    
    suspend fun exportToSheet(
        workbook: Workbook,
        onProgress: (Float, String) -> Unit
    ): Int // è¿”å›å¯¼å‡ºçš„è®°å½•æ•°
    
    suspend fun importFromSheet(
        sheet: Sheet,
        mode: ImportMode,
        onProgress: (Float, String) -> Unit
    ): Int // è¿”å›å¯¼å…¥çš„è®°å½•æ•°
}

// ç¤ºä¾‹ï¼šè®°è´¦æ¨¡å—æ˜ å°„å™¨
class LedgerExcelMapper @Inject constructor(
    private val transactionRepo: TransactionRepository,
    private val accountRepo: AccountRepository,
    private val categoryRepo: CategoryRepository
) : ExcelMapper {
    override val moduleType = ModuleType.LEDGER
    override val sheetName = "è®°è´¦æ•°æ®"
    
    override suspend fun exportToSheet(workbook: Workbook, onProgress: (Float, String) -> Unit): Int {
        val sheet = workbook.newWorksheet(sheetName)
        var row = 0
        
        // å¯¼å‡ºäº¤æ˜“è®°å½•
        sheet.value(row, 0, "=== äº¤æ˜“è®°å½• ===")
        row = exportTransactions(sheet, row + 2, onProgress)
        
        // å¯¼å‡ºè´¦æˆ·ä¿¡æ¯
        sheet.value(row + 1, 0, "=== è´¦æˆ·ä¿¡æ¯ ===")
        row = exportAccounts(sheet, row + 3, onProgress)
        
        // å¯¼å‡ºåˆ†ç±»ä¿¡æ¯
        sheet.value(row + 1, 0, "=== åˆ†ç±»ä¿¡æ¯ ===")
        row = exportCategories(sheet, row + 3, onProgress)
        
        return row
    }
    
    private suspend fun exportTransactions(sheet: Worksheet, startRow: Int, onProgress: (Float, String) -> Unit): Int {
        // å†™å…¥è¡¨å¤´ï¼ˆé’±è¿¹å…¼å®¹æ ¼å¼ï¼‰
        val headers = listOf("ID", "æ—¶é—´", "åˆ†ç±»", "äºŒçº§åˆ†ç±»", "ç±»å‹", "é‡‘é¢", "å¸ç§", "è´¦æˆ·1", "è´¦æˆ·2", "å¤‡æ³¨", "å·²æŠ¥é”€", "æ‰‹ç»­è´¹", "ä¼˜æƒ åˆ¸", "è®°è´¦è€…", "è´¦å•æ ‡è®°", "æ ‡ç­¾", "è´¦å•å›¾ç‰‡", "å…³è”è´¦å•")
        headers.forEachIndexed { col, header ->
            sheet.style(startRow, col).bold().set()
            sheet.value(startRow, col, header)
        }
        
        // æµå¼å†™å…¥æ•°æ®ï¼ˆé’±è¿¹å…¼å®¹æ ¼å¼ï¼‰
        var row = startRow + 1
        var count = 0
        transactionRepo.getAllTransactionsFlow().collect { transaction ->
            sheet.value(row, 0, "cc_${transaction.createdAt}")  // IDï¼šcc_æ—¶é—´æˆ³æ ¼å¼
            sheet.value(row, 1, transaction.date.toString())    // æ—¶é—´
            sheet.value(row, 2, transaction.categoryName)       // åˆ†ç±»
            sheet.value(row, 3, "")                            // äºŒçº§åˆ†ç±»ï¼šæš‚æ—¶ä¸ºç©º
            sheet.value(row, 4, transaction.type.name)         // ç±»å‹
            sheet.value(row, 5, transaction.amount)            // é‡‘é¢
            sheet.value(row, 6, "CNY")                         // å¸ç§
            sheet.value(row, 7, transaction.accountName)       // è´¦æˆ·1
            sheet.value(row, 8, "")                            // è´¦æˆ·2ï¼šè½¬è´¦æ—¶ä½¿ç”¨
            sheet.value(row, 9, transaction.note ?: "")        // å¤‡æ³¨
            sheet.value(row, 10, "")                           // å·²æŠ¥é”€ï¼šä¼ä¸šç‰ˆåŠŸèƒ½
            sheet.value(row, 11, "")                           // æ‰‹ç»­è´¹
            sheet.value(row, 12, "")                           // ä¼˜æƒ åˆ¸
            sheet.value(row, 13, "CCå°è®°ç”¨æˆ·")                   // è®°è´¦è€…
            sheet.value(row, 14, "")                           // è´¦å•æ ‡è®°
            sheet.value(row, 15, transaction.tags.joinToString(","))  // æ ‡ç­¾
            sheet.value(row, 16, "")                           // è´¦å•å›¾ç‰‡
            sheet.value(row, 17, "")                           // å…³è”è´¦å•
            
            row++
            count++
            
            if (count % 100 == 0) {
                onProgress(count / estimatedTotal, "æ­£åœ¨å¯¼å‡ºäº¤æ˜“è®°å½•ï¼š$count æ¡")
            }
        }
        
        return row
    }
}
```

## ğŸ—ï¸ ç Œå¢™è®¡åˆ’ï¼ˆPhase 2-6: 22å°æ—¶ï¼‰

### Phase 2: æ­å»ºåŸºç¡€æ¡†æ¶ï¼ˆ3å°æ—¶ï¼‰

#### 2.1 åˆ›å»ºå…¨æ–°çš„åŒ…ç»“æ„
```
app/src/main/kotlin/com/ccxiaoji/app/data/backup/
â”œâ”€â”€ manager/
â”‚   â””â”€â”€ BackupManager.kt          # ç»Ÿä¸€å…¥å£
â”œâ”€â”€ export/
â”‚   â”œâ”€â”€ CsvExporter.kt           # CSVå¯¼å‡ºå™¨
â”‚   â”œâ”€â”€ JsonExporter.kt          # JSONå¯¼å‡ºå™¨
â”‚   â””â”€â”€ ZipPackager.kt           # ZIPæ‰“åŒ…å™¨
â”œâ”€â”€ import/
â”‚   â”œâ”€â”€ CsvImporter.kt           # CSVå¯¼å…¥å™¨
â”‚   â”œâ”€â”€ JsonImporter.kt          # JSONå¯¼å…¥å™¨
â”‚   â””â”€â”€ ZipExtractor.kt          # ZIPè§£å‹å™¨
â”œâ”€â”€ mapper/
â”‚   â”œâ”€â”€ TransactionMapper.kt     # äº¤æ˜“è®°å½•æ˜ å°„
â”‚   â”œâ”€â”€ LedgerMapper.kt          # è®°è´¦æ•°æ®æ˜ å°„
â”‚   â”œâ”€â”€ TodoMapper.kt            # å¾…åŠæ˜ å°„
â”‚   â”œâ”€â”€ HabitMapper.kt           # ä¹ æƒ¯æ˜ å°„
â”‚   â”œâ”€â”€ ScheduleMapper.kt        # æ’ç­æ˜ å°„
â”‚   â”œâ”€â”€ PlanMapper.kt            # è®¡åˆ’æ˜ å°„
â”‚   â””â”€â”€ OthersMapper.kt          # å…¶ä»–æ•°æ®æ˜ å°„
â””â”€â”€ model/
    â”œâ”€â”€ BackupMetadata.kt        # å…ƒæ•°æ®æ¨¡å‹
    â”œâ”€â”€ BackupResult.kt          # ç»“æœæ¨¡å‹
    â””â”€â”€ BackupError.kt           # é”™è¯¯æ¨¡å‹
```

#### 2.2 å®šä¹‰æ ¸å¿ƒæ¥å£
```kotlin
// BackupManager - ç»Ÿä¸€å…¥å£
@Singleton
class BackupManager @Inject constructor(
    private val csvExporter: CsvExporter,
    private val jsonExporter: JsonExporter,
    private val csvImporter: CsvImporter,
    private val jsonImporter: JsonImporter,
    private val zipPackager: ZipPackager,
    private val zipExtractor: ZipExtractor
) {
    suspend fun export(
        uri: Uri,
        config: ExportConfig,
        onProgress: (Float, String) -> Unit
    ): Result<BackupStats>
    
    suspend fun import(
        uri: Uri,
        mode: ImportMode,
        onProgress: (Float, String) -> Unit
    ): Result<ImportStats>
}
```

#### 2.3 é…ç½®Hiltä¾èµ–æ³¨å…¥
```kotlin
@Module
@InstallIn(SingletonComponent::class)
object BackupModule {
    @Provides
    @Singleton
    fun provideBackupManager(
        csvExporter: CsvExporter,
        jsonExporter: JsonExporter,
        // ... å…¶ä»–ä¾èµ–
    ): BackupManager = BackupManager(/* ... */)
}
```

### Phase 3: å®ç°æ ¸å¿ƒåŠŸèƒ½ï¼ˆ8å°æ—¶ï¼‰

#### 3.1 BackupMetadataå®ç°ï¼ˆ1å°æ—¶ï¼‰
```kotlin
@Serializable
data class BackupMetadata(
    val fileType: String = "CCå°è®°å¤‡ä»½æ–‡ä»¶",
    val fileVersion: String = "2.0",
    val exportTime: String,
    val appVersion: String,
    val deviceInfo: String,
    val dataRange: DataRange,
    val statistics: Statistics,
    val files: Map<String, String>,
    val checksum: Checksum
) {
    @Serializable
    data class Statistics(
        val transactionCount: Int,
        val todoCount: Int,
        val habitRecordCount: Int,
        val scheduleCount: Int,
        val planCount: Int
    )
}
```

#### 3.2 CsvExporterå®ç°ï¼ˆ2å°æ—¶ï¼‰
```kotlin
class CsvExporter @Inject constructor(
    private val transactionMapper: TransactionMapper
) {
    /**
     * å¯¼å‡ºäº¤æ˜“è®°å½•ä¸ºé’±è¿¹å…¼å®¹æ ¼å¼
     */
    suspend fun exportTransactions(
        outputStream: OutputStream,
        transactions: Flow<TransactionEntity>,
        onProgress: (Int, Int) -> Unit
    ) {
        val writer = outputStream.bufferedWriter()
        
        // å†™å…¥é’±è¿¹å…¼å®¹çš„CSVå¤´éƒ¨
        writer.appendLine(QIANJI_CSV_HEADER)
        
        var count = 0
        transactions.collect { transaction ->
            val csvLine = transactionMapper.toCsvLine(transaction)
            writer.appendLine(csvLine)
            count++
            if (count % 100 == 0) {
                onProgress(count, -1) // -1è¡¨ç¤ºæ€»æ•°æœªçŸ¥
            }
        }
        
        writer.flush()
    }
    
    companion object {
        private const val QIANJI_CSV_HEADER = 
            "ID,æ—¶é—´,åˆ†ç±»,äºŒçº§åˆ†ç±»,ç±»å‹,é‡‘é¢,å¸ç§,è´¦æˆ·1,è´¦æˆ·2,å¤‡æ³¨," +
            "å·²æŠ¥é”€,æ‰‹ç»­è´¹,ä¼˜æƒ åˆ¸,è®°è´¦è€…,è´¦å•æ ‡è®°,æ ‡ç­¾,è´¦å•å›¾ç‰‡,å…³è”è´¦å•"
    }
}
```

#### 3.3 JsonExporterå®ç°ï¼ˆ2å°æ—¶ï¼‰
```kotlin
class JsonExporter @Inject constructor(
    private val json: Json,
    private val ledgerMapper: LedgerMapper,
    private val todoMapper: TodoMapper,
    // ... å…¶ä»–mapper
) {
    /**
     * å¯¼å‡ºè®°è´¦ä¸»æ•°æ®
     */
    suspend fun exportLedgerMaster(
        accounts: List<AccountEntity>,
        categories: List<CategoryEntity>,
        budgets: List<BudgetEntity>,
        // ... å…¶ä»–æ•°æ®
    ): JsonElement {
        val ledgerData = LedgerMasterData(
            accounts = accounts.map { ledgerMapper.toExportModel(it) },
            categories = categories.map { ledgerMapper.toExportModel(it) },
            budgets = budgets.map { ledgerMapper.toExportModel(it) }
        )
        return json.encodeToJsonElement(ledgerData)
    }
    
    /**
     * å¯¼å‡ºå…¶ä»–æ¨¡å—æ•°æ®
     */
    suspend fun exportModule(
        moduleType: ModuleType,
        data: Any
    ): JsonElement {
        return when (moduleType) {
            ModuleType.TODO -> exportTodoData(data as TodoData)
            ModuleType.HABIT -> exportHabitData(data as HabitData)
            ModuleType.SCHEDULE -> exportScheduleData(data as ScheduleData)
            ModuleType.PLAN -> exportPlanData(data as PlanData)
            ModuleType.OTHERS -> exportOthersData(data as OthersData)
        }
    }
}
```

#### 3.4 å¯¼å…¥å™¨å®ç°ï¼ˆ3å°æ—¶ï¼‰
```kotlin
class CsvImporter @Inject constructor(
    private val transactionMapper: TransactionMapper
) {
    /**
     * ä»CSVå¯¼å…¥äº¤æ˜“è®°å½•
     */
    suspend fun importTransactions(
        inputStream: InputStream,
        onProgress: (Int) -> Unit
    ): Flow<TransactionImportModel> = flow {
        val reader = inputStream.bufferedReader()
        val headers = reader.readLine()?.split(",") ?: return@flow
        
        var line: String?
        var count = 0
        while (reader.readLine().also { line = it } != null) {
            line?.let {
                val values = parseCsvLine(it)
                val model = transactionMapper.fromCsvLine(headers, values)
                emit(model)
                count++
                if (count % 100 == 0) {
                    onProgress(count)
                }
            }
        }
    }
}
```

### Phase 4: æ¨¡å—æ˜ å°„å™¨å®ç°ï¼ˆ6å°æ—¶ï¼‰

#### 4.1 TransactionMapperï¼ˆé’±è¿¹å…¼å®¹ï¼‰ï¼ˆ2å°æ—¶ï¼‰
```kotlin
class TransactionMapper @Inject constructor(
    private val accountDao: AccountDao,
    private val categoryDao: CategoryDao
) {
    /**
     * å®ä½“è½¬CSVè¡Œï¼ˆé’±è¿¹æ ¼å¼ï¼‰
     */
    suspend fun toCsvLine(entity: TransactionEntity): String {
        val account = accountDao.getById(entity.accountId)
        val category = categoryDao.getById(entity.categoryId)
        
        return listOf(
            "cc_${entity.createdAt}",              // ID
            formatDateTime(entity.date),           // æ—¶é—´
            category?.name ?: "",                  // åˆ†ç±»
            "",                                    // äºŒçº§åˆ†ç±»ï¼ˆæš‚æœªæ”¯æŒï¼‰
            if (entity.type == TransactionType.EXPENSE) "æ”¯å‡º" else "æ”¶å…¥",
            formatAmount(entity.amount),           // é‡‘é¢
            "CNY",                                 // å¸ç§
            account?.name ?: "",                   // è´¦æˆ·1
            "",                                    // è´¦æˆ·2ï¼ˆè½¬è´¦æ—¶ä½¿ç”¨ï¼‰
            entity.note ?: "",                     // å¤‡æ³¨
            "",                                    // å·²æŠ¥é”€
            "",                                    // æ‰‹ç»­è´¹
            "",                                    // ä¼˜æƒ åˆ¸
            "CCå°è®°ç”¨æˆ·",                          // è®°è´¦è€…
            "",                                    // è´¦å•æ ‡è®°
            entity.tags.joinToString(","),         // æ ‡ç­¾
            "",                                    // è´¦å•å›¾ç‰‡
            ""                                     // å…³è”è´¦å•
        ).joinToString(",") { escapeCSV(it) }
    }
    
    /**
     * CSVè¡Œè½¬å¯¼å…¥æ¨¡å‹
     */
    fun fromCsvLine(headers: List<String>, values: List<String>): TransactionImportModel {
        val valueMap = headers.zip(values).toMap()
        
        return TransactionImportModel(
            originalId = valueMap["ID"] ?: "",
            date = parseDateTime(valueMap["æ—¶é—´"] ?: ""),
            categoryName = valueMap["åˆ†ç±»"] ?: "",
            type = if (valueMap["ç±»å‹"] == "æ”¯å‡º") TransactionType.EXPENSE else TransactionType.INCOME,
            amount = parseAmount(valueMap["é‡‘é¢"] ?: "0"),
            accountName = valueMap["è´¦æˆ·1"] ?: "",
            note = valueMap["å¤‡æ³¨"],
            tags = valueMap["æ ‡ç­¾"]?.split(",")?.filter { it.isNotBlank() } ?: emptyList()
        )
    }
}
```

#### 4.2 å…¶ä»–æ¨¡å—æ˜ å°„å™¨ï¼ˆ4å°æ—¶ï¼‰
```kotlin
// LedgerMapper - è®°è´¦ä¸»æ•°æ®æ˜ å°„
class LedgerMapper @Inject constructor() {
    fun toExportModel(entity: AccountEntity): AccountExportModel {
        return AccountExportModel(
            id = entity.id,
            name = entity.name,
            type = entity.type,
            balance = entity.balance,
            // ... å…¶ä»–å­—æ®µ
        )
    }
}

// TodoMapper - å¾…åŠä»»åŠ¡æ˜ å°„
class TodoMapper @Inject constructor() {
    fun toExportModel(entity: TaskEntity): TaskExportModel {
        return TaskExportModel(
            id = entity.id,
            content = entity.content,
            isCompleted = entity.isCompleted,
            // ... å…¶ä»–å­—æ®µ
        )
    }
}

// ScheduleMapper - å¤„ç†snake_caseè½¬æ¢
class ScheduleMapper @Inject constructor() {
    fun toExportModel(entity: ScheduleEntity): ScheduleExportModel {
        return ScheduleExportModel(
            shiftId = entity.shift_id,        // snake_case â†’ camelCase
            scheduleDate = entity.schedule_date,
            createdAt = entity.created_at,
            // ... å…¶ä»–å­—æ®µ
        )
    }
}
```

### Phase 5: UIå±‚å®ç°ï¼ˆ4å°æ—¶ï¼‰

#### 5.1 æ–°çš„ViewModelå®ç°ï¼ˆ2å°æ—¶ï¼‰
```kotlin
@HiltViewModel
class BackupExportViewModel @Inject constructor(
    private val backupManager: BackupManager
) : ViewModel() {
    
    private val _uiState = MutableStateFlow(ExportUiState())
    val uiState: StateFlow<ExportUiState> = _uiState.asStateFlow()
    
    fun exportData(uri: Uri) {
        viewModelScope.launch {
            _uiState.update { it.copy(isExporting = true, progress = 0f) }
            
            backupManager.export(
                uri = uri,
                config = ExportConfig(
                    modules = _uiState.value.selectedModules,
                    dateRange = _uiState.value.dateRange
                ),
                onProgress = { progress, message ->
                    _uiState.update { 
                        it.copy(
                            progress = progress,
                            progressMessage = message
                        )
                    }
                }
            ).fold(
                onSuccess = { stats ->
                    _uiState.update { 
                        it.copy(
                            isExporting = false,
                            exportResult = ExportResult.Success(stats)
                        )
                    }
                },
                onFailure = { error ->
                    _uiState.update { 
                        it.copy(
                            isExporting = false,
                            exportResult = ExportResult.Error(error.message)
                        )
                    }
                }
            )
        }
    }
}

data class ExportUiState(
    val selectedModules: Set<ModuleType> = ModuleType.values().toSet(),
    val dateRange: DateRange = DateRange.ALL,
    val isExporting: Boolean = false,
    val progress: Float = 0f,
    val progressMessage: String = "",
    val exportResult: ExportResult? = null
)
```

#### 5.2 æ–°çš„UIç•Œé¢ï¼ˆ2å°æ—¶ï¼‰
```kotlin
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun BackupExportScreen(
    onNavigateBack: () -> Unit,
    viewModel: BackupExportViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    val launcher = rememberLauncherForActivityResult(
        ActivityResultContracts.CreateDocument("application/zip")
    ) { uri ->
        uri?.let { viewModel.exportData(it) }
    }
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("æ•°æ®å¯¼å‡º") },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, "è¿”å›")
                    }
                }
            )
        }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
                .padding(16.dp)
        ) {
            // æ¨¡å—é€‰æ‹©
            ModuleSelectionSection(
                selectedModules = uiState.selectedModules,
                onModuleToggle = { module ->
                    viewModel.toggleModule(module)
                }
            )
            
            Spacer(modifier = Modifier.height(16.dp))
            
            // æ—¥æœŸèŒƒå›´é€‰æ‹©
            DateRangeSection(
                selectedRange = uiState.dateRange,
                onRangeSelected = { range ->
                    viewModel.selectDateRange(range)
                }
            )
            
            Spacer(modifier = Modifier.weight(1f))
            
            // å¯¼å‡ºæŒ‰é’®
            Button(
                onClick = {
                    launcher.launch("CCå°è®°å¤‡ä»½_${getCurrentDate()}.zip")
                },
                modifier = Modifier.fillMaxWidth(),
                enabled = !uiState.isExporting && uiState.selectedModules.isNotEmpty()
            ) {
                if (uiState.isExporting) {
                    CircularProgressIndicator(
                        modifier = Modifier.size(16.dp),
                        strokeWidth = 2.dp
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("å¯¼å‡ºä¸­... ${(uiState.progress * 100).toInt()}%")
                } else {
                    Icon(Icons.Default.CloudUpload, null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("å¼€å§‹å¯¼å‡º")
                }
            }
            
            // è¿›åº¦ä¿¡æ¯
            if (uiState.progressMessage.isNotEmpty()) {
                Text(
                    text = uiState.progressMessage,
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    modifier = Modifier.padding(top = 8.dp)
                )
            }
        }
    }
    
    // å¤„ç†å¯¼å‡ºç»“æœ
    uiState.exportResult?.let { result ->
        when (result) {
            is ExportResult.Success -> {
                LaunchedEffect(result) {
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                }
            }
            is ExportResult.Error -> {
                LaunchedEffect(result) {
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                }
            }
        }
    }
}
```

### Phase 6: æµ‹è¯•ã€ä¼˜åŒ–å’Œæ¢å¤ï¼ˆ4å°æ—¶ï¼‰

#### 6.1 å•å…ƒæµ‹è¯•ï¼ˆ1.5å°æ—¶ï¼‰
```kotlin
class TransactionMapperTest {
    @Test
    fun `test CSV export format matches Qianji`() {
        val transaction = TransactionEntity(
            id = "1",
            amount = 2550, // 25.50å…ƒ
            type = TransactionType.EXPENSE,
            categoryId = "food",
            accountId = "wechat",
            date = LocalDateTime.parse("2025-08-01T10:30:00"),
            note = "åˆé¤",
            tags = listOf("å·¥ä½œé¤")
        )
        
        val csvLine = mapper.toCsvLine(transaction)
        
        // éªŒè¯é’±è¿¹æ ¼å¼
        assertTrue(csvLine.contains("cc_"))
        assertTrue(csvLine.contains("25.50"))
        assertTrue(csvLine.contains("æ”¯å‡º"))
        assertTrue(csvLine.contains("CNY"))
    }
}
```

#### 6.2 é›†æˆæµ‹è¯•ï¼ˆ1.5å°æ—¶ï¼‰
- å®Œæ•´çš„å¯¼å‡ºå¯¼å…¥æµç¨‹æµ‹è¯•
- å¤§æ•°æ®é‡æ€§èƒ½æµ‹è¯•ï¼ˆ10ä¸‡æ¡è®°å½•ï¼‰
- å†…å­˜ä½¿ç”¨ç›‘æ§
- ZIPå‹ç¼©ç‡éªŒè¯

#### 6.3 æ¢å¤åŠŸèƒ½ï¼ˆ1å°æ—¶ï¼‰
1. **ç§»é™¤å‡çº§æç¤ºUI**
   - åˆ é™¤FeatureUpgradeScreenç»„ä»¶
   - æ¢å¤DataExportScreenå’ŒDataImportScreençš„æ­£å¸¸å®ç°

2. **æ¢å¤å¯¼èˆª**
   ```kotlin
   // ProfileScreen.kt
   NavigationItem(
       icon = Icons.Default.CloudUpload,
       title = "æ•°æ®å¯¼å‡º",
       onClick = { navController.navigate(Screen.DataExport.route) }
   )
   
   NavigationItem(
       icon = Icons.Default.CloudDownload,
       title = "æ•°æ®å¯¼å…¥",
       onClick = { navController.navigate(Screen.DataImport.route) }
   )
   ```

3. **æ›´æ–°NavGraph**
   ```kotlin
   composable(Screen.DataExport.route) {
       BackupExportScreen(
           onNavigateBack = { navController.popBackStack() }
       )
   }
   
   composable(Screen.DataImport.route) {
       BackupImportScreen(
           onNavigateBack = { navController.popBackStack() }
       )
   }
   ```


## âš ï¸ é£é™©å’Œæ³¨æ„äº‹é¡¹ï¼ˆå…ˆæ¨å¢™æ–¹æ¡ˆï¼‰

### 1. åŠŸèƒ½ä¸å¯ç”¨é£é™©
- **å½±å“èŒƒå›´**ï¼šå¯¼å…¥å¯¼å‡ºåŠŸèƒ½å°†æœ‰26å°æ—¶å®Œå…¨ä¸å¯ç”¨
- **ç”¨æˆ·å½±å“**ï¼šæœŸé—´ç”¨æˆ·æ— æ³•å¤‡ä»½æˆ–æ¢å¤æ•°æ®
- **ç¼“è§£æªæ–½**ï¼š
  - æå‰å‘å¸ƒå…¬å‘Šï¼Œæ˜ç¡®æ¢å¤æ—¶é—´
  - æä¾›æ¸…æ™°çš„å‡çº§æç¤ºUI
  - å¯è€ƒè™‘æä¾›ä¸´æ—¶çš„æ•°æ®åº“æ–‡ä»¶å¯¼å‡ºæ–¹æ¡ˆ

### 2. æŠ€æœ¯å®æ–½é£é™©
- **åˆ é™¤é”™è¯¯**ï¼šå¯èƒ½è¯¯åˆ å…¶ä»–æ¨¡å—ä¾èµ–çš„æ–‡ä»¶
  - **ç¼“è§£**ï¼šä½¿ç”¨IDEçš„"Find Usages"åŠŸèƒ½ä»”ç»†æ£€æŸ¥
  - **å¤‡ä»½**ï¼šåˆ›å»ºgitæ ‡ç­¾ï¼Œå¯å¿«é€Ÿæ¢å¤
- **æ–°ç³»ç»Ÿbug**ï¼šä»é›¶å¼€å§‹å¯èƒ½å¼•å…¥æ–°é—®é¢˜
  - **ç¼“è§£**ï¼šå……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  - **åˆ†é˜¶æ®µå‘å¸ƒ**ï¼šå…ˆå†…æµ‹ï¼Œç¡®è®¤ç¨³å®šåå†å‘å¸ƒ

### 3. æ—¶é—´è¶…æœŸé£é™©
- **é¢„ä¼°æ—¶é—´**ï¼š26å°æ—¶ï¼ˆPhase 1: 4å°æ—¶ + Phase 2-6: 22å°æ—¶ï¼‰
- **å¯èƒ½å»¶æœŸ**ï¼šæ–°ç³»ç»Ÿè°ƒè¯•å¯èƒ½éœ€è¦é¢å¤–æ—¶é—´
- **ç¼“è§£æªæ–½**ï¼š
  - é¢„ç•™20%çš„ç¼“å†²æ—¶é—´
  - å¯ä»¥å…ˆæ¢å¤å¯¼å‡ºåŠŸèƒ½ï¼Œå†æ¢å¤å¯¼å…¥åŠŸèƒ½

### 4. æŠ€æœ¯ç»†èŠ‚é£é™©
- **CSVå…¼å®¹æ€§**ï¼šé’±è¿¹æ ¼å¼å¯èƒ½æœ‰ç‰ˆæœ¬å·®å¼‚
- **JSONåºåˆ—åŒ–**ï¼šå¤æ‚å¯¹è±¡ï¼ˆå¦‚æ ‘å½¢ç»“æ„ï¼‰éœ€è¦ç‰¹æ®Šå¤„ç†
- **å†…å­˜ç®¡ç†**ï¼šæµå¼å¤„ç†éœ€è¦æ­£ç¡®å®ç°é¿å…OOM
- **æ–‡ä»¶æƒé™**ï¼šAndroid 11+çš„å­˜å‚¨æƒé™éœ€è¦ç‰¹æ®Šå¤„ç†

## ğŸ¯ æˆåŠŸæ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**
   - [ ] æ‰€æœ‰æ¨¡å—æ•°æ®éƒ½èƒ½æ­£ç¡®å¯¼å‡ºåˆ°CSV+JSON
   - [ ] æ‰€æœ‰æ¨¡å—æ•°æ®éƒ½èƒ½ä»ZIPæ–‡ä»¶æ­£ç¡®å¯¼å…¥
   - [ ] æ”¯æŒé’±è¿¹CSVæ ¼å¼å…¼å®¹å¯¼å…¥
   - [ ] æ”¯æŒè¿½åŠ å’Œè¦†ç›–ä¸¤ç§å¯¼å…¥æ¨¡å¼

2. **æ€§èƒ½æŒ‡æ ‡**
   - [ ] 10ä¸‡æ¡è®°å½•å¯¼å‡ºæ—¶é—´ < 20ç§’
   - [ ] å†…å­˜å³°å€¼å ç”¨ < 50MB
   - [ ] æ–‡ä»¶å¤§å°æ¯”åŸæ–¹æ¡ˆå‡å°30%+

3. **ç”¨æˆ·ä½“éªŒ**
   - [ ] äº¤æ˜“è®°å½•CSVå¯åœ¨Excelä¸­æ­£å¸¸æŸ¥çœ‹
   - [ ] æ•°æ®ç»“æ„æ¸…æ™°ï¼Œç±»ä¼¼é’±è¿¹ä½“éªŒ
   - [ ] é”™è¯¯æç¤ºæ˜ç¡®ï¼ŒæŒ‡å¯¼æ€§å¼º
   - [ ] æ”¯æŒä»é’±è¿¹ç­‰è½¯ä»¶è¿ç§»æ•°æ®

4. **ä»£ç è´¨é‡**
   - [ ] ä»£ç è¦†ç›–ç‡ > 80%
   - [ ] é›¶ç¼–è¯‘è­¦å‘Š
   - [ ] å®Œæ•´çš„é”™è¯¯å¤„ç†

## ğŸ“… æ—¶é—´çº¿ï¼ˆå…ˆæ¨å¢™æ–¹æ¡ˆï¼‰

### æ€»ä½“å®‰æ’
- **æ€»å·¥æœŸ**ï¼š26å°æ—¶ï¼ˆçº¦4ä¸ªå·¥ä½œæ—¥ï¼‰
- **åŠŸèƒ½ä¸å¯ç”¨æœŸ**ï¼šæ•´ä¸ªå¼€å‘æœŸé—´

### è¯¦ç»†æ—¶é—´åˆ†é…
- **Day 1 ä¸Šåˆ**ï¼šPhase 1 - æ¨å€’ï¼ˆ4å°æ—¶ï¼‰
  - å¤‡ä»½ä»£ç ã€åˆ›å»ºå‡çº§UIã€åˆ é™¤æ—§ç³»ç»Ÿã€éªŒè¯
- **Day 1 ä¸‹åˆ**ï¼šPhase 2 - æ­å»ºåŸºç¡€æ¡†æ¶ï¼ˆ3å°æ—¶ï¼‰
  - åˆ›å»ºåŒ…ç»“æ„ã€å®šä¹‰æ¥å£ã€é…ç½®ä¾èµ–æ³¨å…¥
- **Day 2**ï¼šPhase 3 - å®ç°æ ¸å¿ƒåŠŸèƒ½ï¼ˆ8å°æ—¶ï¼‰
  - BackupMetadataã€CsvExporterã€JsonExporterã€å¯¼å…¥å™¨
- **Day 3 ä¸Šåˆ**ï¼šPhase 4 - æ¨¡å—æ˜ å°„å™¨ï¼ˆ6å°æ—¶ï¼‰
  - TransactionMapperã€å…¶ä»–æ¨¡å—æ˜ å°„å™¨
- **Day 3 ä¸‹åˆ**ï¼šPhase 5 - UIå±‚å®ç°ï¼ˆ4å°æ—¶ï¼‰
  - ViewModelã€Screenç•Œé¢
- **Day 4 ä¸Šåˆ**ï¼šPhase 6 - æµ‹è¯•ã€ä¼˜åŒ–å’Œæ¢å¤ï¼ˆ4å°æ—¶ï¼‰
  - å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ¢å¤åŠŸèƒ½

### é‡Œç¨‹ç¢‘
- **8æœˆ1æ—¥ 12:00**ï¼šæ—§ç³»ç»Ÿå®Œå…¨åˆ é™¤
- **8æœˆ2æ—¥ 18:00**ï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°å®Œæˆ
- **8æœˆ3æ—¥ 18:00**ï¼šUIå±‚å®ç°å®Œæˆ
- **8æœˆ4æ—¥ 12:00**ï¼šåŠŸèƒ½æ¢å¤ä¸Šçº¿

## ğŸ”„ åç»­è®¡åˆ’

1. **ç‰ˆæœ¬2.1**ï¼šæ”¯æŒæ›´å¤šç¬¬ä¸‰æ–¹è½¯ä»¶CSVæ ¼å¼å¯¼å…¥ï¼ˆéšæ‰‹è®°ã€ç½‘æ˜“æœ‰é’±ç­‰ï¼‰
2. **ç‰ˆæœ¬2.2**ï¼šæ”¯æŒé€‰æ‹©æ€§å¯¼å‡ºï¼ˆæ—¥æœŸèŒƒå›´ã€ç‰¹å®šè´¦æˆ·ç­‰ï¼‰
3. **ç‰ˆæœ¬2.3**ï¼šæ·»åŠ æ•°æ®åˆ†æåŠŸèƒ½ï¼ˆç”Ÿæˆç»Ÿè®¡CSVæŠ¥è¡¨ï¼‰

## ğŸ¯ æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

æ–¹æ¡ˆæ ¸å¿ƒä¼˜åŠ¿ï¼š
- âœ… **é›¶ä¾èµ–**ï¼šå‡å°‘APKä½“ç§¯å’Œæ½œåœ¨é£é™©
- âœ… **å¼€å‘é«˜æ•ˆ**ï¼šæ¶æ„æ¸…æ™°ï¼Œå®ç°ç®€å•
- âœ… **æ›´å…¼å®¹**ï¼šæ”¯æŒé’±è¿¹ç­‰è½¯ä»¶æ•°æ®è¿ç§»
- âœ… **æ›´ç›´è§‚**ï¼šè®°è´¦æ•°æ®å¯ç›´æ¥åœ¨Excelä¸­æŸ¥çœ‹
- âœ… **æ›´å°å·§**ï¼šæ–‡ä»¶ä½“ç§¯æ›´å°ï¼Œä¼ è¾“æ›´å¿«

---

## ğŸ¯ æ–¹æ¡ˆæ€»ç»“ï¼šå…ˆæ¨å¢™ï¼Œå†ç Œå¢™

### æ ¸å¿ƒå†³ç­–
- **æ–¹æ¡ˆé€‰æ‹©**ï¼šCSV+JSONæ··åˆæ–¹æ¡ˆï¼ˆäº¤æ˜“è®°å½•ç”¨CSVï¼Œå…¶ä»–ç”¨JSONï¼‰
- **å®æ–½ç­–ç•¥**ï¼šå…ˆæ¨å¢™ï¼Œå†ç Œå¢™ï¼ˆå½»åº•åˆ é™¤æ—§ç³»ç»Ÿåé‡å»ºï¼‰
- **å…¼å®¹ç›®æ ‡**ï¼šé’±è¿¹CSVæ ¼å¼ï¼Œä¾¿äºç”¨æˆ·è¿ç§»

### å…³é”®ä¼˜åŠ¿
1. **ä»£ç çº¯å‡€**ï¼šæ–°ç³»ç»Ÿä¸å—æ—§ä»£ç å½±å“ï¼Œè®¾è®¡æ›´ä¼˜
2. **ç”¨æˆ·å‹å¥½**ï¼šäº¤æ˜“è®°å½•å¯ç›´æ¥ExcelæŸ¥çœ‹ï¼Œç±»ä¼¼é’±è¿¹
3. **æ€§èƒ½ä¼˜å¼‚**ï¼šæµå¼å¤„ç†ï¼Œå†…å­˜å ç”¨ä½
4. **é›¶ä¾èµ–**ï¼šä½¿ç”¨AndroidåŸç”ŸAPIï¼Œæ— ç¬¬ä¸‰æ–¹åº“é£é™©

### å®æ–½è¦ç‚¹
- Phase 1ï¼šæ¨å€’æ—§ç³»ç»Ÿï¼ˆ4å°æ—¶ï¼‰
- Phase 2-6ï¼šæ„å»ºæ–°ç³»ç»Ÿï¼ˆ22å°æ—¶ï¼‰
- æ€»å·¥æœŸï¼š26å°æ—¶ï¼ŒåŠŸèƒ½ä¸å¯ç”¨æœŸï¼š26å°æ—¶

---

**æœ€åæ›´æ–°æ—¶é—´**ï¼š2025-08-01 12:00  
**çŠ¶æ€**ï¼šæ–¹æ¡ˆç¡®å®šï¼Œé‡‡ç”¨"å…ˆæ¨å¢™ï¼Œå†ç Œå¢™"ç­–ç•¥å®æ–½CSV+JSONæ–¹æ¡ˆ  
**è´Ÿè´£äºº**ï¼šå¼€å‘å›¢é˜Ÿ  
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š2025-08-04 12:00