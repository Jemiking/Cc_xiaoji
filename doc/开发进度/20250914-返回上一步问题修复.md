# è¿”å›ä¸Šä¸€æ­¥é—®é¢˜ä¿®å¤æ–¹æ¡ˆï¼ˆLedger å¯¼èˆªï¼‰

## èƒŒæ™¯ä¸ç›®æ ‡
- èƒŒæ™¯ï¼šå½“å‰è¿”å›è¡Œä¸ºä¸ä¸€è‡´ï¼Œå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š
  - ä»å¤–éƒ¨/æ·±é“¾ç›´æ¥è¿›å…¥æŸäº›é¡µé¢ï¼ˆå¦‚â€œæ·»åŠ äº¤æ˜“â€ï¼‰æ—¶ï¼Œç‚¹è¿”å›å¯èƒ½ç›´æ¥é€€å‡ºæˆ–æ— ååº”ï¼Œæ— æ³•å›åˆ°ä¸Šä¸€çº§ï¼ˆè®°è´¦é¦–é¡µï¼‰ã€‚
  - è®°è´¦é¦–é¡µï¼ˆLedgerScreenï¼‰é¡¶éƒ¨ä¸ºæŠ½å±‰å…¥å£ï¼Œæ— â€œç»Ÿä¸€ç³»ç»Ÿè¿”å›â€å¤„ç†ï¼›åœ¨æŠ½å±‰æ‰“å¼€/æœç´¢æ¨¡å¼/é€‰æ‹©æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿè¿”å›é”®æœªä¼˜å…ˆå¤„ç†è¿™äº›çŠ¶æ€ã€‚
  - é¡µé¢é—´æ™®éç›´æ¥ä½¿ç”¨ `popBackStack()`/`navigateUp()`ï¼Œæœªå®šä¹‰â€œæ— æ ˆæ—¶çš„å…œåº•çˆ¶çº§â€ã€‚
- ç›®æ ‡ï¼š
  - æ˜ç¡®â€œçˆ¶çº§é¡µé¢â€å¹¶å»ºç«‹â€œæ™ºèƒ½è¿”å›â€ç­–ç•¥ï¼šä¼˜å…ˆ `popBackStack()`ï¼Œå¤±è´¥æ—¶å›é€€åˆ°çº¦å®šçˆ¶çº§è·¯ç”±ã€‚
  - è®°è´¦é¦–é¡µæŒ‰è¿”å›æ—¶åº”è¯¥å›åˆ° App é¦–é¡µï¼›è®°è´¦æ¨¡å—çš„å­é¡µé¢æŒ‰è¿”å›æ—¶åº”å›åˆ°è®°è´¦é¦–é¡µã€‚
  - æŠ½å±‰/æœç´¢æ¨¡å¼/é€‰æ‹©æ¨¡å¼ä¼˜å…ˆé€€å‡ºå…¶çŠ¶æ€ï¼Œå†è¿›è¡Œè·¯ç”±å›é€€ã€‚
  - å»ºç«‹æ ‡å‡†åŒ–ã€å¯å¤ç”¨çš„è¿”å›å¤„ç†æ–¹æ¡ˆï¼Œä¾¿äºåç»­æ¨¡å—å¤ç”¨ã€‚

## è®¾è®¡åŸåˆ™
1) ä¸€è‡´çš„çˆ¶çº§ï¼š
   - è®°è´¦é¦–é¡µï¼ˆLedger rootï¼‰çˆ¶çº§ = App é¦–é¡µï¼ˆ`Screen.Home.route`ï¼‰ã€‚
   - è®°è´¦å­é¡µï¼ˆæ·»åŠ /ç¼–è¾‘/ç­›é€‰/è¯¦æƒ…/ç®¡ç†ç­‰ï¼‰çˆ¶çº§ = è®°è´¦é¦–é¡µï¼ˆ`Screen.Ledger.route`ï¼‰ã€‚
2) ä¼˜å…ˆå…³é—­çŠ¶æ€ï¼šè‹¥æŠ½å±‰æ‰“å¼€/å¤„äºæœç´¢æ¨¡å¼/é€‰æ‹©æ¨¡å¼ï¼Œå…ˆé€€å‡ºè¿™äº›çŠ¶æ€ï¼›å¦åˆ™å†æ‰§è¡Œå¯¼èˆªå›é€€ã€‚
3) æ™ºèƒ½è¿”å›ç­–ç•¥ï¼š
   - å…ˆ `popBackStack()`/`navigateUp()`ï¼›
   - è‹¥è¿”å›å¤±è´¥ï¼ˆæ— å¯é€€æ ˆï¼‰ï¼Œåˆ™ `navigate(fallbackRoute)`ï¼›
   - é¿å…â€œæ¸…æ ˆè¿”å›â€ï¼Œé™¤éæ˜ç¡®éœ€è¦ï¼›å°½é‡ä¿æŒâ€œé€å±‚è¿”å›â€çš„ç›´è§‰ã€‚

## æŠ€æœ¯æ–¹æ¡ˆ

### 1. å¼•å…¥ NavController æ‰©å±•ï¼šæ™ºèƒ½è¿”å›
æ–°å¢æ‰©å±•å‡½æ•°ï¼ˆApp æ¨¡å—ï¼‰ï¼š`NavigationExtensions.kt`

```kotlin
package com.ccxiaoji.app.presentation.ui.navigation

import androidx.navigation.NavController
import androidx.navigation.NavGraph.Companion.findStartDestination

fun NavController.smartBack(fallbackRoute: String) {
    val popped = try { popBackStack() } catch (_: Throwable) { false }
    if (!popped) {
        navigate(fallbackRoute) {
            // é˜²æ­¢é‡å¤å åŠ åŒä¸€è·¯ç”±
            launchSingleTop = true
            restoreState = true
            // ä¸åšæ¸…æ ˆï¼Œä¿æŒâ€œé€å±‚è¿”å›â€çš„ä½“éªŒ
        }
    }
}

fun NavController.smartBackToHome() {
    smartBack(Screen.Home.route)
}

fun NavController.smartBackToLedger() {
    smartBack(Screen.Ledger.route)
}
```

è¯´æ˜ï¼š
- ç»Ÿä¸€å°è£…â€œå…ˆ pop å†å…œåº• navigateâ€çš„é€»è¾‘ï¼Œé¿å…é¡µé¢ç›´æ¥â€œçŒœæµ‹çˆ¶çº§â€ã€‚
- å°†å…œåº•è·¯ç”±é›†ä¸­åˆ° App å±‚ï¼ˆæŒæ¡å…¨å±€è·¯ç”±å¸¸é‡ï¼‰ï¼ŒFeature æ¨¡å—é€šè¿‡å›è°ƒè·ç›Šã€‚

### 2. æ ‡å‡†åŒ–å±å¹•è¿”å›å›è°ƒï¼šonNavigateBackï¼ˆå¯é€‰å‚æ•°ï¼‰
- ä¸ºéœ€è¦â€œè‡ªå¸¦è¿”å›æŒ‰é’®â€çš„é¡µé¢å¢åŠ å¯é€‰å‚æ•°ï¼š`onNavigateBack: (() -> Unit)? = null`ã€‚
- é¡µé¢å†…éƒ¨çš„ TopBar å·¦ä¸Šè§’è¿”å›æŒ‰é’®ä¼˜å…ˆè°ƒç”¨ `onNavigateBack?.invoke()`ï¼›è‹¥ä¸º `null`ï¼Œé™çº§ä¸º `navController.navigateUp()`ï¼ˆä¿ç•™é»˜è®¤è¡Œä¸ºï¼‰ã€‚
- å¥½å¤„ï¼šçˆ¶çº§ï¼ˆApp çš„ `NavGraph`ï¼‰æ ¹æ®ä¸Šä¸‹æ–‡ä¼ å…¥åˆé€‚çš„â€œæ™ºèƒ½è¿”å›ç­–ç•¥â€ï¼ˆå›åˆ° Ledger æˆ–å›åˆ° Homeï¼‰ï¼ŒFeature ä¸éœ€çŸ¥é“ä¸Šå±‚è·¯ç”±å¸¸é‡ã€‚

éœ€è¦æ–°å¢è¯¥å‚æ•°çš„é¡µé¢ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
- `feature/ledger/.../transaction/AddTransactionScreen.kt`
- `feature/ledger/.../transaction/EditTransactionScreen.kt`
- `feature/ledger/.../transaction/FilterTransactionScreen.kt`
- `feature/ledger/.../transaction/TransactionDetailScreen.kt`
- ï¼ˆå¯é€‰/æŒ‰éœ€ï¼‰`feature/ledger/.../account/*`ã€`.../budget/*`ã€`.../category/*` ç­‰å¸¦è¿”å›æŒ‰é’®çš„é¡µé¢

ç¤ºä¾‹ï¼ˆä»¥ AddTransactionScreen ä¸ºä¾‹ï¼Œä¼ªä»£ç å˜æ›´ç‚¹ï¼‰ï¼š
```kotlin
@Composable
fun AddTransactionScreen(
    navController: NavController,
    transactionId: String? = null,
    onNavigateBack: (() -> Unit)? = null,
    ...
) {
    // é¡¶éƒ¨è¿”å›æŒ‰é’®
    IconButton(onClick = { onNavigateBack?.invoke() ?: navController.navigateUp() }) {
        Icon(Icons.AutoMirrored.Filled.ArrowBack, ...)
    }
}
```

### 3. LedgerScreen å¢å¼ºç³»ç»Ÿè¿”å›å¤„ç†ï¼ˆBackHandlerï¼‰
- ä¸º `LedgerScreen` æ–°å¢å¯é€‰å‚æ•° `onBack: (() -> Unit)? = null`ï¼›åœ¨ Compose ä¸­ä½¿ç”¨ `BackHandler` å®ç°å¦‚ä¸‹ä¼˜å…ˆçº§ï¼š
  1) è‹¥æŠ½å±‰æ‰“å¼€ï¼šå…³é—­æŠ½å±‰ã€‚
  2) è‹¥å¤„äºæœç´¢æ¨¡å¼ï¼šé€€å‡ºæœç´¢æ¨¡å¼å¹¶æ¸…ç©ºæœç´¢ã€‚
  3) è‹¥å¤„äºé€‰æ‹©æ¨¡å¼ï¼šé€€å‡ºé€‰æ‹©æ¨¡å¼ã€‚
  4) å¦åˆ™ï¼šè°ƒç”¨ `onBack?.invoke()`ï¼›è‹¥ä¸º `null`ï¼Œé™çº§ä¸º `navController.popBackStack()`ã€‚
- App ä¾§ï¼ˆ`NavGraph.kt`ï¼‰åœ¨ Ledger è·¯ç”±å¤„ä¼ å…¥ï¼š`onBack = { navController.smartBackToHome() }`ã€‚
- æ³¨ï¼šéœ€å¼•å…¥ `androidx.activity.compose.BackHandler` ä¾èµ–ï¼ˆä¸€èˆ¬å·²å­˜åœ¨ï¼‰ã€‚

ç¤ºä¾‹ï¼ˆä¼ªä»£ç å˜æ›´ç‚¹ï¼‰ï¼š
```kotlin
@Composable
fun LedgerScreen(
    navController: NavController? = null,
    onBack: (() -> Unit)? = null,
    ...
) {
    val drawerState = rememberDrawerState(initialValue = DrawerValue.Closed)
    val selectionState by selectionViewModel.selectionState.collectAsState()
    val searchState by searchViewModel.searchState.collectAsState()

    BackHandler {
        when {
            drawerState.isOpen -> coroutineScope.launch { drawerState.close() }
            searchState.isSearchMode -> { searchViewModel.toggleSearchMode(); searchViewModel.clearSearch() }
            selectionState.isSelectionMode -> selectionViewModel.toggleSelectionMode()
            else -> onBack?.invoke() ?: navController?.popBackStack()
        }
    }
}
```

### 4. App NavGraph ç»Ÿä¸€æ¥çº¿
- åœ¨ `NavGraph.kt` ä¸­ä¸ºå„ Ledger å­è·¯ç”±ä¼ å…¥å¯¹åº”çš„â€œæ™ºèƒ½è¿”å›â€å›è°ƒï¼š

```kotlin
// è®°è´¦é¦–é¡µï¼ˆçˆ¶çº§ï¼šHomeï¼‰
composable(Screen.Ledger.route) {
    ledgerApi.getLedgerScreen(
        navController = navController,
        accountId = null,
        onBack = { navController.smartBackToHome() }
    )
}

// æ·»åŠ äº¤æ˜“ï¼ˆçˆ¶çº§ï¼šLedgerï¼‰
composable(AddTransactionRoute.route) { backStackEntry ->
    val transactionId = backStackEntry.arguments?.getString("transactionId")
    com.ccxiaoji.feature.ledger.presentation.screen.transaction.AddTransactionScreen(
        navController = navController,
        transactionId = transactionId,
        onNavigateBack = { navController.smartBackToLedger() }
    )
}

// ç¼–è¾‘äº¤æ˜“ / ç­›é€‰ / è¯¦æƒ…ç­‰åŒç†ï¼šä¼ å…¥ smartBackToLedger()
```

è¯´æ˜ï¼š
- è®°è´¦é¦–é¡µï¼ˆLedger rootï¼‰å›åˆ° Homeï¼›å…¶å®ƒå­é¡µå›åˆ° Ledgerã€‚
- å¯¹å·²æœ‰çš„ `onNavigateBack = { navController.popBackStack() }` é€æ­¥æ›¿æ¢ä¸º `smartBack...()`ã€‚

### 5. LedgerApi æ¥å£æ‰©å±•ï¼ˆå¿…è¦æ—¶ï¼‰
- è‹¥éœ€è¦ä» App ä¾§ä¸º `LedgerScreen` ä¼ å…¥ `onBack`ï¼Œå¯å°† `LedgerApi.getLedgerScreen(...)` ç­¾åæ‰©å±•ï¼š

```kotlin
// interface LedgerApi
fun getLedgerScreen(
    navController: NavHostController,
    accountId: String?,
    onBack: (() -> Unit)? = null
)

// impl å†…éƒ¨è°ƒç”¨ LedgerScreen(..., onBack = onBack)
```

> æ³¨ï¼šæ­¤æ”¹åŠ¨ä¼šå½±å“ app ä¸ feature çš„æ¥å£å¥‘çº¦ï¼Œéœ€è¦åŒæ—¶ä¿®æ”¹ `LedgerApi.kt`ã€`LedgerApiImpl.kt` ä¸ `NavGraph.kt` çš„è°ƒç”¨å¤„ã€‚

### 6. ä¾èµ–ä¸å…¼å®¹æ€§
- éœ€è¦ä¿è¯ä¾èµ–ï¼š`androidx.activity:activity-compose`ï¼ˆç”¨äº `BackHandler`ï¼‰ã€‚
- æœ¬æ–¹æ¡ˆä¸å¼•å…¥æ¸…æ ˆå¼è¿”å›ï¼ˆ`popUpTo(...){ inclusive = true }`ï¼‰ï¼Œä»¥ä¿è¯â€œé€å±‚è¿”å›â€ä½“éªŒç¨³å®šã€‚

## å˜æ›´æ¸…å•ï¼ˆæ–‡ä»¶çº§ï¼‰
1) [æ–°å¢] `app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavigationExtensions.kt`
   - `NavController.smartBack(fallbackRoute: String)`
   - `NavController.smartBackToHome()` / `smartBackToLedger()`

2) [ä¿®æ”¹] `feature/ledger/.../ledger/LedgerScreen.kt`
   - æ–°å¢å‚æ•°ï¼š`onBack: (() -> Unit)? = null`
   - æ–°å¢ `BackHandler`ï¼ŒæŒ‰ä¼˜å…ˆçº§å¤„ç†æŠ½å±‰/æœç´¢/é€‰æ‹©/æ™ºèƒ½è¿”å›

3) [ä¿®æ”¹] `feature/ledger/.../transaction/AddTransactionScreen.kt`
   - æ–°å¢å‚æ•°ï¼š`onNavigateBack: (() -> Unit)? = null`
   - TopBar è¿”å›è°ƒç”¨ï¼š`onNavigateBack?.invoke() ?: navController.navigateUp()`
   - ï¼ˆå¯é€‰ï¼‰`BackHandler { onNavigateBack?.invoke() ?: navController.navigateUp() }`

4) [ä¿®æ”¹] `feature/ledger/.../transaction/EditTransactionScreen.kt`
   - åŒ AddTransactionScreen å¤„ç†

5) [ä¿®æ”¹] `feature/ledger/.../transaction/FilterTransactionScreen.kt`
   - åŒ AddTransactionScreen å¤„ç†

6) [ä¿®æ”¹] `feature/ledger/.../transaction/TransactionDetailScreen.kt`
   - åŒ AddTransactionScreen å¤„ç†

7) [ä¿®æ”¹] `app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavGraph.kt`
   - åœ¨ Ledger æ ¹è·¯ç”±ä¼ å…¥ `onBack = { navController.smartBackToHome() }`
   - åœ¨ Ledger å­è·¯ç”±ï¼ˆæ·»åŠ /ç¼–è¾‘/ç­›é€‰/è¯¦æƒ…ï¼‰ä¼ å…¥ `onNavigateBack = { navController.smartBackToLedger() }`

8) [ï¼ˆå¯é€‰/æŒ‰éœ€ï¼‰ä¿®æ”¹] è´¦æˆ·/é¢„ç®—/åˆ†ç±»ç­‰å¸¦è¿”å›æŒ‰é’®çš„é¡µé¢æ–‡ä»¶
   - å¢åŠ  `onNavigateBack` å¹¶æ¥çº¿åˆ° `NavGraph`

9) [ï¼ˆå¦‚éœ€è¦ï¼‰ä¿®æ”¹] `feature/ledger/api/LedgerApi.kt` ä¸ `LedgerApiImpl.kt`
   - ä¸º `getLedgerScreen` å¢åŠ  `onBack` å‚æ•°ï¼Œå¹¶è´¯é€šåˆ°åº•å±‚ `LedgerScreen`

## å¼€å‘æ­¥éª¤ï¼ˆå»ºè®®é¡ºåºï¼‰
1) æ–°å¢ `NavigationExtensions.kt` å¹¶é€šè¿‡ IDE å¿«é€ŸéªŒè¯ç¼–è¯‘ã€‚
2) ä¿®æ”¹ `LedgerScreen`ï¼šå¢åŠ  `onBack` + `BackHandler`ï¼Œæœ¬åœ°ç¼–è¯‘éªŒè¯ã€‚
3) ä¿®æ”¹ `NavGraph.kt`ï¼š
   - `Screen.Ledger.route` ä¸ `LedgerWithAccountRoute.route` å¤„ï¼Œå‘ `getLedgerScreen` ä¼ å…¥ `onBack`ï¼ˆè‹¥æ¥å£æœªæ‰©å±•ï¼Œåˆ™å…ˆæ‰©å±•æ¥å£å†æ”¹è¿™é‡Œï¼‰ã€‚
4) ä¿®æ”¹å…³é”®äº¤æ˜“é¡µé¢ï¼ˆAdd/Edit/Filter/Detailï¼‰ï¼šå¢åŠ  `onNavigateBack` å¹¶å°†è¿”å›æŒ‰é’®æ¥å…¥ã€‚
5) åœ¨ `NavGraph.kt` ä¸ºä¸Šè¿°é¡µé¢ä¼ å…¥ `smartBackToLedger()`ã€‚
6) é€æ­¥è¦†ç›–å…¶å®ƒå¸¦è¿”å›æŒ‰é’®çš„ ledger é¡µé¢ï¼ˆè´¦æˆ·ã€é¢„ç®—ã€åˆ†ç±»ç­‰ï¼‰ã€‚

## å›å½’æµ‹è¯•ç”¨ä¾‹
1) ä» App é¦–é¡µè¿›å…¥è®°è´¦é¦–é¡µï¼šæŒ‰ç³»ç»Ÿè¿”å›é”® â†’ å›åˆ° App é¦–é¡µã€‚
2) ä» App é¦–é¡µè¿›å…¥è®°è´¦é¦–é¡µ â†’ æ·»åŠ äº¤æ˜“ â†’ è¿”å›æŒ‰é’® â†’ å›åˆ°è®°è´¦é¦–é¡µã€‚
3) ä»å¤–éƒ¨ Deep Link ç›´è¾¾â€œæ·»åŠ äº¤æ˜“â€ â†’ è¿”å›æŒ‰é’® â†’ å›åˆ°è®°è´¦é¦–é¡µ â†’ å†æŒ‰è¿”å› â†’ å›åˆ° App é¦–é¡µ â†’ å†æŒ‰è¿”å› â†’ é€€å‡ºåº”ç”¨ã€‚
4) ä»å¤–éƒ¨ Deep Link ç›´è¾¾â€œè®°è´¦é¦–é¡µâ€ â†’ ç³»ç»Ÿè¿”å›é”® â†’ å›åˆ° App é¦–é¡µã€‚
5) åœ¨è®°è´¦é¦–é¡µæ‰“å¼€æŠ½å±‰ â†’ ç³»ç»Ÿè¿”å›é”® â†’ å…ˆå…³é—­æŠ½å±‰ï¼›å†æŒ‰è¿”å› â†’ å›åˆ° App é¦–é¡µã€‚
6) è®°è´¦é¦–é¡µè¿›å…¥â€œæœç´¢æ¨¡å¼â€ â†’ ç³»ç»Ÿè¿”å›é”® â†’ é€€å‡ºæœç´¢æ¨¡å¼ï¼›å†æŒ‰è¿”å› â†’ å›åˆ° App é¦–é¡µã€‚
7) è®°è´¦é¦–é¡µè¿›å…¥â€œé€‰æ‹©æ¨¡å¼â€ â†’ ç³»ç»Ÿè¿”å›é”® â†’ é€€å‡ºé€‰æ‹©æ¨¡å¼ï¼›å†æŒ‰è¿”å› â†’ å›åˆ° App é¦–é¡µã€‚
8) äº¤æ˜“è¯¦æƒ…é¡µ â†’ è¿”å›æŒ‰é’® â†’ å›åˆ°è®°è´¦é¦–é¡µï¼ˆè‹¥ä»è¯¦æƒ…é¡µæ˜¯ä»åˆ—è¡¨è¿›å…¥ï¼‰ã€‚
9) ç­›é€‰é¡µç‚¹å‡»â€œå–æ¶ˆ/åº”ç”¨â€ â†’ å›åˆ°è®°è´¦é¦–é¡µï¼ˆæ— è®ºæ¥æºï¼‰ã€‚
10) è´¦æˆ·/é¢„ç®—/åˆ†ç±»ç¼–è¾‘é¡µ â†’ è¿”å›æŒ‰é’® â†’ å›åˆ°è®°è´¦é¦–é¡µã€‚

## éªŒæ”¶æ ‡å‡†
- æ‰€æœ‰ä¸Šè¿°ç”¨ä¾‹è¡Œä¸ºä¸é¢„æœŸä¸€è‡´ï¼›
- æ— â€œå¡æ­»æ— æ³•è¿”å›â€ä¸â€œç›´æ¥é€€å‡ºåº”ç”¨â€çš„å¼‚å¸¸ï¼›
- è¿”å›é“¾è·¯æ¸…æ™°ï¼Œä¸å‡ºç°â€œè¯¯æ¸…æ ˆå¯¼è‡´å†å²ä¸¢å¤±â€çš„ä½“éªŒï¼›
- è®°è´¦é¦–é¡µçš„æŠ½å±‰/æœç´¢/é€‰æ‹©æ¨¡å¼ä¸ç³»ç»Ÿè¿”å›é”®äº¤äº’ä¸€è‡´ã€è‡ªç„¶ã€‚

## é£é™©ä¸ç¼“è§£
- æ¥å£è°ƒæ•´é£é™©ï¼š`LedgerApi.getLedgerScreen` å¢å‚éœ€åŒæ­¥ä¿®æ”¹è°ƒç”¨å¤„ï¼›ä¸€æ¬¡æ€§å®Œæˆæ¥å£å¯¹é½ï¼Œå¹¶é€šè¿‡ IDE å…¨å±€æŸ¥æ‰¾æ ¡éªŒã€‚
- ä¾èµ–é£é™©ï¼šè‹¥æœªå¼•å…¥ `BackHandler` å¯¹åº”ä¾èµ–ï¼Œéœ€è¡¥å…… `androidx.activity:activity-compose`ã€‚
- è¡Œä¸ºå˜æ›´é£é™©ï¼šé¿å…â€œæ¸…æ ˆå¼è¿”å›â€ï¼Œä»…åœ¨æ˜ç¡®éœ€æ±‚å¤„ä¿ç•™ã€‚

## å›æ»šæ–¹æ¡ˆ
- è‹¥å¼•å…¥é—®é¢˜ï¼Œå¯ä»…ä¿ç•™ `NavigationExtensions.kt`ï¼Œå°†é¡µé¢ `onNavigateBack` å›é€€ä¸ºæ—§å®ç°ï¼ˆ`navigateUp()`/`popBackStack()`ï¼‰ï¼Œé€é¡µå›æ»šä¸å½±å“æ•°æ®åº“ç­‰çŠ¶æ€ã€‚

## é™„å½•ï¼šå¸¸ç”¨ä»£ç ç‰‡æ®µ
```kotlin
// 1) æ‰©å±•ï¼šNavigationExtensions.ktï¼ˆApp æ¨¡å—ï¼‰
fun NavController.smartBack(fallbackRoute: String) { ... }
fun NavController.smartBackToHome() = smartBack(Screen.Home.route)
fun NavController.smartBackToLedger() = smartBack(Screen.Ledger.route)

// 2) Screen ç«¯ï¼ˆFeature æ¨¡å—ï¼‰
IconButton(onClick = { onNavigateBack?.invoke() ?: navController.navigateUp() }) { ... }

// 3) LedgerScreen BackHandlerï¼ˆFeature æ¨¡å—ï¼‰
BackHandler {
    when { /* æŠ½å±‰/æœç´¢/é€‰æ‹© ä¼˜å…ˆå¤„ç† */ else -> onBack?.invoke() ?: navController?.popBackStack() }
}

// 4) NavGraphï¼ˆApp æ¨¡å—ï¼‰
ledgerApi.getLedgerScreen(navController, accountId = null, onBack = { navController.smartBackToHome() })
AddTransactionScreen(navController, transactionId, onNavigateBack = { navController.smartBackToLedger() })
```


## ÊµÊ©½øÕ¹£¨ÒÑÍê³É£©
- ÖÇÄÜ·µ»ØÀ©Õ¹ÒÑÂäµØ£º`app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavigationExtensions.kt`
- ¼ÇÕËÊ×Ò³ BackHandler ÒÑÊµÏÖ£º`feature/ledger/.../ledger/LedgerScreen.kt` ĞÂÔö `onBack` Óë BackHandler ´¦Àí³éÌë/ËÑË÷/Ñ¡ÔñÓÅÏÈ¼¶
- ½»Ò×Ò³ÃæÍ³Ò»»Øµ÷£º
  - `AddTransactionScreen`¡¢`EditTransactionScreen`¡¢`FilterTransactionScreen`¡¢`TransactionDetailScreen` ¾ùĞÂÔö `onNavigateBack`£¬¶¥À¸ÓëÏµÍ³·µ»Ø²ÉÓÃ»Øµ÷£¨¶µµ× navigateUp/popBackStack£©
- Ledger ×ÓÒ³ÃæÍ³Ò»»Øµ÷£¨ÕË»§/Ô¤Ëã/·ÖÀà/¿¨Æ¬£©£º
  - ÕË»§Àà£º`AccountScreen`¡¢`AddAccountScreen`¡¢`EditAccountScreen`¡¢`TransferScreen`£¨¾ùº¬ BackHandler£©
  - ·ÖÀàÀà£º`CategoryManagementScreen`¡¢`EditCategoryScreen`£¨±£´æ³É¹¦Ò²×ß»Øµ÷£©
  - Ô¤ËãÀà£º`AddEditBudgetScreen`¡¢`CategorySelectionScreen`
  - ¿¨Æ¬Àà£º`CardManagementScreen`¡¢`AddEditCardScreen`

## API ±ä¸ü»ã×Ü
- ĞÂÔö/µ÷Õû£º
  - `LedgerApi.getLedgerScreen(navController, accountId, onBack)`
  - `LedgerApi.getTransactionDetailScreen(transactionId, navController, onNavigateBack)`
  - `LedgerApi.getAccountScreen(navController, onNavigateBack)`
  - `LedgerApi.getCategoryManagementScreen(navController, onNavigateBack)`
- ÊµÏÖ£º`feature/ledger/api/LedgerApiImpl.kt` ÒÑ¹áÍ¨ÉÏÊö²ÎÊıÖÁ¸÷Ò³Ãæ¡£

## App µ¼º½½ÓÏß£¨NavGraph£©
- ¼ÇÕËÊ×Ò³/ÕË»§¶¨ÏòÊ×Ò³£º´«Èë `onBack = { navController.smartBackToHome() }`
- ½»Ò××ÓÒ³Ãæ£¨Ìí¼Ó/±à¼­/É¸Ñ¡/ÏêÇé£©£º´«Èë `onNavigateBack = { navController.smartBackToLedger() }`
- ÕË»§/·ÖÀà/Ô¤Ëã/¿¨Æ¬×ÓÒ³Ãæ£º
  - `AccountManagementRoute`¡¢`AddAccountRoute`¡¢`EditAccountRoute`¡¢`TransferRoute`
  - `CategoryManagementRoute`
  - `BudgetRoute`¡¢`AddEditBudgetRoute`¡¢`SelectCategoryRoute`
  - `CardManagementRoute`¡¢`AddEditCardRoute`
  - ¾ù´«Èë `onNavigateBack = { navController.smartBackToLedger() }`

## ÒÀÀµÓë±àÒë
- Îª BackHandler ÔÚ ledger Ä£¿é²¹È«ÒÀÀµ£º`feature/ledger/build.gradle.kts` Ôö¼Ó `implementation(libs.androidx.activity.compose)`
- ĞŞ¸´ Debug Í³¼Æ Demo µ¼Èë£º`StatsScreens.kt` Ôö¼Ó `import androidx.compose.ui.draw.clip`
- µ±Ç°ÒÑÍ¨¹ı±¾µØ±àÒë¡£

## »Ø¹é¼ì²éÖØµã£¨²¹³ä£©
- ÕË»§/Ô¤Ëã/·ÖÀà/¿¨Æ¬µÈĞÂ½ÓÈëÒ³ÃæµÄÏµÍ³·µ»ØÓë¶¥À¸·µ»Ø£¬¾ùÓ¦»Øµ½¼ÇÕËÊ×Ò³£¬¼´Ê¹´ÓÍâ²¿ÉîÁ´Ö±½Ó½øÈë¡£
- Ò³Ãæ±£´æ/Íê³É²Ù×÷ºóµÄ·µ»ØÒ²Ó¦±£³ÖÉÏÊöÒ»ÖÂĞÔ£¨ÀıÈç±à¼­·ÖÀà¡¢Ìí¼ÓÕË»§¡¢±à¼­¿¨Æ¬£©¡£

### ÉèÖÃÒ³Í³Ò»£¨ĞÂÔö£©
- ÉèÖÃÏà¹ØÒ³ÃæÍ³Ò»»Øµ÷ÓëÏµÍ³·µ»Ø£º
  - `feature/ledger/.../settings/AccountSelectionScreen.kt` ĞÂÔö `onNavigateBack` + BackHandler
  - `feature/ledger/.../settings/CurrencySelectionScreen.kt` ĞÂÔö `onNavigateBack` + BackHandler
  - `feature/ledger/.../settings/ReminderSettingsScreen.kt` ĞÂÔö `onNavigateBack` + BackHandler£¨±£´æºóÍ¨¹ı»Øµ÷·µ»Ø£©
  - `feature/ledger/.../settings/HomeDisplaySettingsScreen.kt` ĞÂÔö `onNavigateBack` + BackHandler£¨±£´æºóÍ¨¹ı»Øµ÷·µ»Ø£©
  - `feature/ledger/.../settings/AutoLedgerSettingsScreen.kt` ĞÂÔö `onNavigateBack` + BackHandler
  - `feature/ledger/.../settings/LedgerUIStyleScreen.kt` ĞÂÔö `onNavigateBack` + BackHandler
- App µ¼º½£ºÉÏÊöÉèÖÃÒ³Â·ÓÉÍ³Ò»´«Èë `onNavigateBack = { navController.smartBackToLedger() }`
- ±¸×¢£º`PermissionGuideScreen` ÈÔÍ¨¹ı»Øµ÷²ÎÊı `onNavigateBack` ·µ»Ø£¬NavGraph ÒÑ¸ÄÎª `smartBackToLedger()`£»Debug ¿ª·¢ÕßÒ³Óëµ÷ÊÔÃæ°å±£Áô×îĞ¡¸Ä¶¯£¨ÔÚµ÷ÊÔ»·¾³ÏÂÖ±½Ó `popBackStack()` Òà»Øµ½ÉèÖÃÒ³£©¡£
