# Todoæ¨¡å—åŠŸèƒ½ä¿®å¤ä¸UIä¼˜åŒ–æ–¹æ¡ˆ

> æ—¥æœŸï¼š2025-10-06ï¼ˆæœ¬æ¬¡è¿›å±•ï¼š2025-10-07ï¼‰
> å½“å‰çŠ¶æ€ï¼šP0/P1 æ ¸å¿ƒé“¾è·¯å·²å®Œæˆï¼›UI å…¨é‡æ›¿æ¢ä¸æ¸…ç†å·²å®Œæˆ
> ç‰ˆæœ¬ï¼šv2.0
> ä¼˜å…ˆçº§ï¼šP0 â†’ P1
> èŒƒå›´ï¼šTodo é€šçŸ¥é“¾è·¯ä¿®å¤ + UI/UX è§„èŒƒè½åœ°

## ä¸€ã€é—®é¢˜èƒŒæ™¯ï¼ˆæ‘˜è¦ï¼‰

- é€šçŸ¥é“¾è·¯å­˜åœ¨æ–°å»º/ç¼–è¾‘åæé†’å­—æ®µæœªè½åº“ã€ä¿å­˜åæœªè°ƒåº¦/é‡å¤è°ƒåº¦ç­‰é—®é¢˜ï¼Œå½±å“åˆ°æœŸæé†’çš„å¯é æ€§ã€‚
- Todo æ¨¡å— UI æœªç»Ÿä¸€ 8pt æ …æ ¼ä¸å“ç‰Œè‰²ï¼ŒLoading/Empty ç­‰çŠ¶æ€åé¦ˆä¸ä¸€è‡´ã€‚

## äºŒã€é˜¶æ®µä¸ä»»åŠ¡æ¸…å•

### 2.1 ä¿®å¤ç±»ï¼ˆP0ï¼‰

- [DONE] [TODO-FIX-001] ä¿®å¤ Repository.addTodoï¼šæ˜¾å¼å†™å…¥æé†’å­—æ®µé»˜è®¤å€¼ï¼ˆreminderEnabled=nullã€reminderMinutesBefore=nullã€reminderTime=nullï¼‰
  - ä½ç½®ï¼šfeature/todo/data/repository/TodoRepositoryImpl.kt
- [DONE] [TODO-FIX-002] ViewModel æ³¨å…¥é€šçŸ¥ç”¨ä¾‹ TodoNotificationUseCase
  - ä½ç½®ï¼šfeature/todo/presentation/viewmodel/AddEditTaskViewModel.kt
- [DONE] [TODO-FIX-003] å®ç°ä¿å­˜åé€šçŸ¥è°ƒåº¦
  - ä¿å­˜æˆåŠŸåè®¡ç®— calculatedReminderTimeï¼ˆå›ºå®šæ—¶åˆ» > æå‰åˆ†é’Ÿï¼‰ï¼Œè½åº“æé†’å­—æ®µå¹¶è°ƒåº¦ï¼›æ˜¾å¼å…³é—­æ—¶å–æ¶ˆè°ƒåº¦
  - ä½ç½®ï¼šfeature/todo/presentation/viewmodel/AddEditTaskViewModel.kt

### 2.2 å¢å¼ºç±»ï¼ˆP1ï¼‰

- [DONE] [TODO-ENH-001] æ‰©å±• AddTodoUseCase æ¥å£ï¼Œæ”¯æŒæé†’å‚æ•°å¹¶åœ¨åˆ›å»ºåæŒä¹…åŒ–åŸºç¡€é…ç½®
  - ä½ç½®ï¼šfeature/todo/domain/usecase/AddTodoUseCase.kt
- [DONE] [TODO-ENH-002] ç¼–è¾‘æ€é‡è°ƒåº¦å®Œå–„ï¼šå˜æ›´æé†’åå…ˆå–æ¶ˆå†é‡è°ƒåº¦ï¼Œé¿å…é‡å¤
  - ä½ç½®ï¼šfeature/todo/presentation/viewmodel/AddEditTaskViewModel.kt
- [DONE] [TODO-ENH-003] è°ƒåº¦ä¸å–æ¶ˆæ—¥å¿—è¾“å‡ºï¼ˆä¾¿äºæ’æŸ¥ï¼‰
  - ä½ç½®ï¼šfeature/todo/presentation/viewmodel/AddEditTaskViewModel.kt

### 2.3 UI/UXï¼ˆP1ï¼‰

- [DONE] [TODO-UI-001] æ–°å¢ Todo è§„èŒƒæ–‡ä»¶ï¼ˆ8pt æ …æ ¼ + å­—ä½“ï¼‰
  - æ–‡ä»¶ï¼šfeature/todo/presentation/theme/TodoDesignSpecs.kt
- [DONE] [TODO-UI-002] AddEditTaskScreen åº”ç”¨æ …æ ¼ä¸ç»†èŠ‚ä¼˜åŒ–
  - ç»Ÿä¸€ Loading ä¸»è‰²ã€PrioritySelector å°ºå¯¸ä¸åœ†è§’ï¼›æ§ä»¶é—´è·æŒ‰ TodoGrid/DesignTokens æ”¶æ•›
- [DONE] [TODO-UI-003] PrioritySelector é£æ ¼ç»Ÿä¸€
  - ç»Ÿä¸€é«˜åº¦ x5=40dp ä¸åœ†è§’ x1=8dp
- [DONE] [TODO-UI-004] ç©ºçŠ¶æ€ç»„ä»¶ EmptyStateViewï¼ˆå¯å¤ç”¨ï¼‰
  - æ–‡ä»¶ï¼šfeature/todo/presentation/component/EmptyStateView.kt
- [DONE] [TODO-UI-006] åŠ è½½ç»„ä»¶ LoadingState å¹¶åº”ç”¨åˆ°åˆ—è¡¨é¡µ
  - æ–‡ä»¶ï¼šfeature/todo/presentation/component/LoadingState.kt
  - åº”ç”¨ï¼šfeature/todo/presentation/screen/TodoScreen.kt
- [DONE] [TODO-UI-005] DatePickerScreen è§†è§‰ç»Ÿä¸€
  - ä½¿ç”¨ DesignTokens é—´è·ï¼›å›¾æ ‡å°ºå¯¸ä¿ç•™ 48dpï¼ˆä¸å±é—´è·ï¼‰ï¼›æŒ‰é’®/å®¹å™¨é¢œè‰²ç»Ÿä¸€
- [DONE] [TODO-UI-007] å“ç‰Œè‰²ç»Ÿä¸€
  - ä½¿ç”¨ DesignTokens.BrandColors.Todo ä½œä¸ºä¸»è‰²ï¼Œåˆ—è¡¨/ç¼–è¾‘é¡µæ§ä»¶ä¸€è‡´

## ä¸‰ã€å®æ–½è®°å½•ï¼ˆæ–‡ä»¶çº§ï¼‰

- æŒä¹…åŒ–é»˜è®¤å€¼ï¼šTodoRepositoryImpl.addTodo() å†™å…¥æé†’é»˜è®¤å€¼ã€‚
- ç”¨ä¾‹æ‰©å±•ï¼šAddTodoUseCase æ–°å¢æé†’å‚æ•°ï¼Œåˆ›å»ºåæŒä¹…åŒ–åŸºç¡€é…ç½®ã€‚
- ä¿å­˜åè°ƒåº¦ï¼šAddEditTaskViewModel.saveTask() è®¡ç®—è§¦å‘æ—¶åˆ»ï¼Œæ›´æ–°æé†’å­—æ®µå¹¶è°ƒåº¦/å–æ¶ˆã€‚
- UI è§„èŒƒè½åœ°ï¼š
  - æ–°å¢ TodoDesignSpecs.ktï¼›
  - æ–°å¢ EmptyStateView.ktã€LoadingState.ktï¼›
  - TodoScreen.kt ä½¿ç”¨ LoadingStateï¼›
  - AddEditTaskScreen.kt ä¸­ PrioritySelector é‡‡ç”¨ TodoGridï¼›
  - æ›¿æ¢éƒ¨åˆ†ç¡¬ç¼–ç  dpï¼šTodoSearchBar.ktã€TodoFilterBar.ktã€TaskReminderSettingSection.ktã€‚

## å››ã€éªŒè¯ä¸è‡ªæµ‹

### 4.1 éªŒæ”¶ç›®æ ‡
1) æ–°å»ºä»»åŠ¡æ—¶ï¼Œæé†’å­—æ®µæ­£ç¡®å†™å…¥æ•°æ®åº“ã€‚
2) æœ‰æé†’çš„ä»»åŠ¡åœ¨é˜Ÿåˆ—/WorkManager ä¸­å­˜åœ¨å¯¹åº”è°ƒåº¦ã€‚
3) ç¼–è¾‘æé†’ä¸ºâ€œæå‰1å°æ—¶â€åï¼Œæ—§è°ƒåº¦å–æ¶ˆï¼Œæ–°è°ƒåº¦ç”Ÿæ•ˆã€‚
4) æ˜¾å¼å…³é—­æé†’åï¼Œè°ƒåº¦è¢«å–æ¶ˆã€‚
5) UI é¡µé¢é—´è·éµå¾ª 8pt æ …æ ¼ï¼ˆ8/16/24/32/40ï¼‰ï¼ŒLoading/Empty çŠ¶æ€ä¸€è‡´ã€‚

### 4.2 è‡ªæµ‹ç”¨ä¾‹
- ç”¨ä¾‹1ï¼šæ–°å»ºä»»åŠ¡ + â€œæå‰30åˆ†é’Ÿâ€ â†’ æ•°æ®è½åº“ + é˜Ÿåˆ—å­˜åœ¨ + WorkManager ä»»åŠ¡å­˜åœ¨ã€‚
- ç”¨ä¾‹2ï¼šç¼–è¾‘ä»»åŠ¡ â†’ ä¿®æ”¹ä¸ºâ€œæå‰1å°æ—¶â€ â†’ æ—§è°ƒåº¦å–æ¶ˆ + æ–°è°ƒåº¦å­˜åœ¨ã€‚

## äº”ã€åç»­è®¡åˆ’

-ï¼ˆå·²å®Œæˆï¼‰UI å…¨é‡æ›¿æ¢ä¸æ¸…ç†ï¼šTodo æ¨¡å—ä½¿ç”¨ TodoGrid/DesignTokensã€ç»Ÿä¸€å“ç‰Œè‰²ã€ç»Ÿä¸€ç©º/åŠ è½½çŠ¶æ€ã€‚
- Phase 4ï¼ˆæ¶æ„ï¼‰ï¼šç»Ÿä¸€ä»»åŠ¡åˆ›å»ºå…¥å‚ä¸äº‹ä»¶æ€»çº¿ï¼ˆTaskCreationDto + TaskEventBusï¼‰ã€‚

## å…­ã€è¿›åº¦æ—¥å¿—

- 2025-10-06 v1.0ï¼šè¯†åˆ«é—®é¢˜ä¸æ¸…å•åŒ–ã€‚
- 2025-10-07 v2.0ï¼šå®Œæˆ P0/P1 æ ¸å¿ƒä¿®å¤ï¼›æ–°å¢è§„èŒƒä¸çŠ¶æ€ç»„ä»¶ï¼›å¼€å§‹ UI æ›¿æ¢ä¸æ”¶æ‹¢ã€‚

### å¼€å‘è¿›åº¦æ›´æ–°ï¼ˆ2025-10-07 ç¬¬äºŒæ‰¹ï¼‰

- [DONE] UI å…¨é‡æ›¿æ¢ä¸æ¸…ç†ï¼ˆTodo æ¨¡å—ï¼‰
  - åˆ—è¡¨ç©ºçŠ¶æ€ï¼šç»Ÿä¸€ä½¿ç”¨ EmptyStateViewï¼›åˆ é™¤æ—§ Column å®ç°ã€‚
    - å˜æ›´ï¼šfeature/todo/presentation/component/GroupedTaskList.kt
  - åˆ—è¡¨åŠ è½½çŠ¶æ€ï¼šç»Ÿä¸€ä½¿ç”¨ LoadingStateã€‚
    - å˜æ›´ï¼šfeature/todo/presentation/screen/TodoScreen.kt
  - æœç´¢/ç­›é€‰/æé†’è®¾ç½®ï¼šå»é™¤ç¡¬ç¼–ç  dpï¼Œç»Ÿä¸€ DesignTokens.Spacingã€‚
    - å˜æ›´ï¼šfeature/todo/presentation/component/TodoSearchBar.ktã€TodoFilterBar.ktã€TaskReminderSettingSection.kt
  - PrioritySelector å°ºå¯¸ä¸åœ†è§’ç»Ÿä¸€ï¼ˆTodoGrid.x5ã€TodoGrid.x1ï¼‰ã€‚
    - å˜æ›´ï¼šfeature/todo/presentation/screen/AddEditTaskScreen.kt
  - è­¦å‘Šæ¸…ç†ï¼š
    - ä½¿ç”¨ androidx.lifecycle.compose.LocalLifecycleOwnerï¼›å»é™¤ä¸å¿…è¦çš„å®‰å…¨è°ƒç”¨ã€‚
      - å˜æ›´ï¼šfeature/todo/presentation/screen/AddEditTaskScreen.kt
    - ç§»é™¤æœªä½¿ç”¨å˜é‡ showTimePicker ä¸æœªç”¨ datePickerState å£°æ˜ã€‚
      - å˜æ›´ï¼šfeature/todo/presentation/component/FlatTaskDialog.kt

ç¼–è¯‘éªŒè¯
- å‘½ä»¤ï¼š./gradlew :feature:todo:compileDebugKotlin
- ç»“æœï¼šBUILD SUCCESSFULï¼ˆä¸Šè¿°å‘Šè­¦å·²æ¸…ç†ï¼‰

## ä¸ƒã€é—®é¢˜ä¿®å¤æ–¹æ¡ˆï¼ˆ2025-10-09 v3 - ç®€åŒ–ç‰ˆï¼‰

### 7.1 é—®é¢˜æ·±åº¦åˆ†æ

#### è¡¨é¢ç°è±¡
ç¼–è¾‘ä»»åŠ¡æ—¶ï¼Œè‡ªå®šä¹‰æé†’è®¾ç½®æ— æ³•ä¿å­˜æˆ–å¤±æ•ˆ

#### æ ¹æœ¬åŸå› ï¼ˆ3ä¸ªå±‚é¢ï¼‰

**é—®é¢˜1ï¼šUseCaseå±‚ç¼ºå°‘å‚æ•°** ğŸ”´
- UpdateTodoUseCaseæ²¡æœ‰æé†’å‚æ•°ï¼Œæ— æ³•ä¼ é€’è®¾ç½®

**é—®é¢˜2ï¼šRepositoryå±‚æ•°æ®è¦†ç›–** ğŸ”´
```kotlin
// TodoRepositoryImpl.updateTodo
val updatedTask = existingTask.copy(
    title = title,
    priority = priority,
    // âŒ æ²¡æœ‰ä¿ç•™reminderEnabledç­‰å­—æ®µ
)
taskDao.updateTask(updatedTask) // ä¼šè¦†ç›–æé†’è®¾ç½®
```

**é—®é¢˜3ï¼šViewModelå±‚æ¡ä»¶åˆ¤æ–­ç¼ºé™·** ğŸŸ 
```kotlin
// å½“å‰é€»è¾‘çš„é—®é¢˜ï¼š
if (state.reminderEnabled != null || ...) {
    updateTaskReminder(...)
}
// 1. ç”¨æˆ·åªæ”¹æ ‡é¢˜æ—¶ä¸ä¼šè¿›å…¥ï¼ˆæé†’ä¸ä¼šé‡æ–°è°ƒåº¦ï¼‰
// 2. nullå€¼æ­§ä¹‰ï¼šæ˜¯"ç»§æ‰¿å…¨å±€"è¿˜æ˜¯"æœªä¿®æ”¹"ï¼Ÿ
```

### 7.2 ç®€åŒ–ä¿®å¤æ–¹æ¡ˆï¼ˆ1å¤©å³å¯ï¼‰

#### æœ€ç®€ä¿®å¤ï¼ˆç¬¦åˆé¡¹ç›®é£æ ¼ï¼‰

**ä¿®å¤1ï¼šUpdateTodoUseCaseæ·»åŠ æé†’å‚æ•°**
```kotlin
// feature/todo/domain/usecase/UpdateTodoUseCase.kt
class UpdateTodoUseCase @Inject constructor(
    private val repository: TodoRepository
) {
    suspend operator fun invoke(
        todoId: String,
        title: String,
        description: String? = null,
        dueAt: Instant? = null,
        priority: Int = 0,
        // ç®€å•æ·»åŠ æé†’å‚æ•°ï¼Œä¿æŒå¯é€‰
        reminderEnabled: Boolean? = null,
        reminderMinutesBefore: Int? = null,
        reminderTime: String? = null
    ) {
        // éªŒè¯
        if (todoId.isBlank()) {
            throw DomainException.ValidationException("å¾…åŠäº‹é¡¹IDä¸èƒ½ä¸ºç©º")
        }
        if (title.isBlank()) {
            throw DomainException.ValidationException("æ ‡é¢˜ä¸èƒ½ä¸ºç©º")
        }

        // ç›´æ¥è°ƒç”¨repositoryçš„updateTodoï¼ˆè®©å®ƒå¤„ç†æ‰€æœ‰å­—æ®µï¼‰
        repository.updateTodo(
            todoId = todoId,
            title = title.trim(),
            description = description?.trim(),
            dueAt = dueAt,
            priority = priority,
            reminderEnabled = reminderEnabled,
            reminderMinutesBefore = reminderMinutesBefore,
            reminderTime = reminderTime
        ).getOrThrow()
    }
}

**ä¿®å¤2ï¼šViewModelç¼–è¾‘æ¨¡å¼è°ƒç”¨**
```kotlin
// AddEditTaskViewModel.kt - saveTask()æ–¹æ³•
if (state.taskId != null) {
    // ç¼–è¾‘æ¨¡å¼ - ç›´æ¥ä¼ é€’æ‰€æœ‰å‚æ•°
    updateTodoUseCase(
        todoId = state.taskId,
        title = state.title,
        description = state.description.ifEmpty { null },
        dueAt = state.dueAt,
        priority = state.priority.ordinal,
        // ä¼ é€’æé†’å‚æ•°ï¼ˆä¸éœ€è¦é¢å¤–æ ‡è®°ï¼‰
        reminderEnabled = state.reminderEnabled,
        reminderMinutesBefore = state.reminderMinutesBefore,
        reminderTime = state.reminderTime
    )
    savedTaskId = state.taskId
}
// åç»­çš„æé†’è°ƒåº¦é€»è¾‘ä¿æŒä¸å˜ï¼ˆç¬¬152-187è¡Œï¼‰
```

**ä¿®å¤3ï¼šRepositoryæ‰©å±•updateTodoæ–¹æ³•**
```kotlin
// TodoRepositoryImpl.kt
override suspend fun updateTodo(
    todoId: String,
    title: String,
    description: String?,
    dueAt: Instant?,
    priority: Int,
    // æ–°å¢æé†’å‚æ•°ï¼ˆé»˜è®¤nullè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰
    reminderEnabled: Boolean? = null,
    reminderMinutesBefore: Int? = null,
    reminderTime: String? = null
): BaseResult<Unit> = safeSuspendCall {
    val existingTask = taskDao.getTaskById(todoId)
        ?: throw DomainException.DataException("ä»»åŠ¡ä¸å­˜åœ¨")

    val updatedTask = existingTask.copy(
        title = title,
        description = description,
        dueAt = dueAt?.toEpochMilliseconds(),
        priority = priority,
        updatedAt = now,
        syncStatus = SyncStatus.PENDING_SYNC,
        // åªæ›´æ–°énullçš„æé†’å­—æ®µ
        reminderEnabled = reminderEnabled ?: existingTask.reminderEnabled,
        reminderMinutesBefore = reminderMinutesBefore ?: existingTask.reminderMinutesBefore,
        reminderTime = reminderTime ?: existingTask.reminderTime
    )

    taskDao.updateTask(updatedTask)
}
```

### 7.3 ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆç¬¦åˆé¡¹ç›®é£æ ¼

**å¯¹æ¯”é¡¹ç›®ä¸­å…¶ä»–Updateç”¨ä¾‹**ï¼š
- `UpdateTransactionUseCase`ï¼šç›´æ¥ä¼ å®Œæ•´å¯¹è±¡ï¼Œæç®€å®ç°
- `ToggleTodoCompletionUseCase`ï¼šä¼ ID+ç‰¹å®šå­—æ®µï¼Œå•ä¸€èŒè´£
- æœ¬æ–¹æ¡ˆï¼šä¼ ID+æ‰€æœ‰å­—æ®µï¼Œä¿æŒç®€å•ç›´æ¥

**é¿å…çš„è¿‡åº¦è®¾è®¡**ï¼š
- âŒ ä¸ä½¿ç”¨é¢å¤–çš„å¸ƒå°”æ ‡è®°ï¼ˆå¦‚updateReminderï¼‰
- âŒ ä¸ä½¿ç”¨çŠ¶æ€è¿½è¸ªï¼ˆå¦‚reminderModifiedï¼‰
- âŒ ä¸ä½¿ç”¨å¯†å°ç±»æˆ–ç­–ç•¥æ¨¡å¼
- âœ… ç›´æ¥ä¼ å‚ï¼Œè®©Repositoryåˆ¤æ–­æ›´æ–°é€»è¾‘

### 7.4 æ·±åˆ»åæ€ï¼šæŠ€æœ¯å†³ç­–çš„æ•™è®­

**è¿‡åº¦è®¾è®¡çš„æ ¹æº**ï¼š
1. **è„±ç¦»é¡¹ç›®ä¸Šä¸‹æ–‡**ï¼šæ²¡æœ‰å…ˆç ”ç©¶é¡¹ç›®çš„è®¾è®¡é£æ ¼
2. **ç‚«æŠ€å¿ƒç†**ï¼šè¯•å›¾å±•ç¤º"é«˜çº§"çš„è®¾è®¡æ¨¡å¼
3. **å®Œç¾ä¸»ä¹‰**ï¼šæƒ³ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰æ½œåœ¨é—®é¢˜

**æ­£ç¡®çš„æŠ€æœ¯å†³ç­–æµç¨‹**ï¼š
1. å…ˆçœ‹é¡¹ç›®ä¸­ç±»ä¼¼åŠŸèƒ½çš„å®ç°
2. ä¿æŒé£æ ¼ä¸€è‡´æ€§
3. é€‰æ‹©æœ€ç®€å•çš„å¯è¡Œæ–¹æ¡ˆ
4. é€æ­¥è¿­ä»£ä¼˜åŒ–

**å…³é”®æ•™è®­**ï¼š
> "æœ€å¥½çš„ä»£ç æ˜¯ç¬¦åˆå›¢é˜Ÿé£æ ¼çš„ä»£ç ï¼Œä¸æ˜¯æœ€'å…ˆè¿›'çš„ä»£ç "

### 7.5 å®æ–½è¦ç‚¹
- å·¥æœŸï¼š1å¤©å³å¯å®Œæˆï¼ˆåŸæ–¹æ¡ˆéœ€è¦2-3å¤©ï¼‰
- é£é™©ï¼šæä½ï¼ˆæ”¹åŠ¨æœ€å°ï¼‰
- æµ‹è¯•ï¼šåªéœ€æµ‹è¯•ç¼–è¾‘æ¨¡å¼çš„æé†’æ›´æ–°

## å…«ã€Agentè¯„å®¡ï¼ˆ2025-10-09ï¼‰

### 8.1 ç»“è®ºï¼ˆåˆç†æ€§ä¸å¯è¡Œæ€§ï¼‰
- æ–‡æ¡£ç»“æ„æ¸…æ™°ï¼ˆé—®é¢˜â†’ä»»åŠ¡â†’å®æ–½â†’éªŒè¯â†’åç»­â†’æ·±æŒ–ï¼‰ï¼Œç¬¦åˆä»“åº“â€œè§£å†³é—®é¢˜æµç¨‹â€ã€‚
- P0/P1 æ”¹åŠ¨å·²å¤§éƒ¨åˆ†åœ¨ä»£ç å®Œæˆï¼ŒUI ç»Ÿä¸€ï¼ˆ8pt/å“ç‰Œè‰²/ç©º&åŠ è½½æ€ï¼‰ä¸é€šçŸ¥é“¾è·¯ï¼ˆUseCaseâ†’NotificationApiï¼‰å‡ä¸é¡¹ç›®è§„èŒƒä¸€è‡´ï¼Œæ•´ä½“åˆç†ã€å¯è¡Œæ€§é«˜ã€‚
- â€œç®€åŒ–ä¿®å¤æ–¹æ¡ˆï¼ˆ7.2ï¼‰â€å·¥ä½œé‡ä¸é£é™©è¯„ä¼°å‡†ç¡®ï¼Œå¯åœ¨1å¤©å†…äº¤ä»˜ï¼›å»ºè®®è¡¥å……ä¸¤ä¸ªè¾¹ç•Œè¯´æ˜ï¼Œé™ä½å›å½’é£é™©ã€‚

### 8.2 äº‹å®æ ¸å¯¹ï¼ˆä¸ä»£ç ä¸€è‡´æ€§ï¼‰
- AddTodoUseCase å·²æ”¯æŒæé†’å‚æ•°ï¼ˆå…ˆå»ºä»»åŠ¡â†’äºŒæ®µå¼æŒä¹…åŒ–æé†’é…ç½®ï¼‰ï¼š`feature/todo/.../AddTodoUseCase.kt`
- ViewModel ä¿å­˜åâ€œå…ˆå–æ¶ˆå†è°ƒåº¦â€ä¸”è®¡ç®— `reminderAt`ï¼š`feature/todo/.../AddEditTaskViewModel.kt`
- é€šçŸ¥ç»Ÿä¸€é€šè¿‡ UseCaseâ†’`NotificationApi` è®¿é—®ï¼š`shared/notification/api/NotificationApi.kt`
- Repositoryï¼š
  - `addTodo` æ˜¾å¼å†™å…¥æé†’é»˜è®¤å€¼ï¼ˆnull è¡¨ç¤ºç»§æ‰¿å…¨å±€ï¼‰ï¼š`feature/todo/.../TodoRepositoryImpl.kt`
  - `updateTaskReminder` ä¸“èŒæ›´æ–°æé†’å­—æ®µå¹¶æ‰“ç‚¹æ—¥å¿—ï¼š`feature/todo/.../TodoRepositoryImpl.kt`
  - `updateTodo` å½“å‰æœªæ¥æ”¶æé†’å‚æ•°ï¼Œä¸”ä¸ä¼šæ„å¤–æ¸…ç©ºæé†’å­—æ®µï¼ˆæœªåœ¨ copy ä¸­æŒ‡æ˜çš„å­—æ®µä¼šä¿ç•™åŸå€¼ï¼‰ã€‚
- è¿ç§»å·²è¦†ç›–æé†’å­—æ®µï¼ˆv21â†’v24ï¼‰ï¼š`app/src/main/java/com/ccxiaoji/app/data/local/migrations/AppMigrations.kt`

### 8.3 å¤šæ–¹æ¡ˆå¯¹æ¯”ï¼ˆæŒ‰é¡¹ç›®è§„èŒƒç»™å‡ºå¤‡é€‰ï¼‰
- æ–¹æ¡ˆAï¼šä¸º Update ç”¨ä¾‹ä¸ Repository.updateTodo â€œæ‰©å‚â€ä»¥æ‰¿æ¥æé†’å‚æ•°ï¼ˆä¸ 7.2 ä¸€è‡´ï¼‰
  - ä¼˜ç‚¹ï¼šå•æ¬¡è°ƒç”¨åŸå­æ›´æ–°ï¼›ä¸é¡¹ç›®ä¸­â€œç›´ä¼ å‚æ•°â€çš„ç”¨ä¾‹é£æ ¼ä¸€è‡´ï¼›è°ƒè¯•è·¯å¾„çŸ­ã€‚
  - ç¼ºç‚¹ï¼šæ¥å£æœ‰å°èŒƒå›´ç ´åæ€§ï¼Œéœ€è¦åŒæ­¥å®ç°ä¸è°ƒç”¨ï¼›å¯¹â€œæé†’ä¸“èŒæ›´æ–°æ¥å£â€çš„èŒè´£è¾¹ç•Œç•¥æœ‰æ”¶ç¼©ã€‚
- æ–¹æ¡ˆBï¼šä¸æ”¹æ¥å£ï¼Œå®Œå–„ ViewModel çš„é‡è°ƒåº¦åˆ¤æ–­
  - åšæ³•ï¼šä¿æŒ `updateTodo` ä¸å˜ï¼›åœ¨ä¿å­˜æ—¶åªè¦ dueAt æ”¹å˜ä¸”ï¼ˆå·²æœ‰è‡ªå®šä¹‰æé†’æˆ–ç¬¦åˆå…¨å±€ç­–ç•¥ï¼‰å°±ç»Ÿä¸€è°ƒç”¨ `updateTaskReminder` å¹¶é‡è°ƒåº¦ã€‚
  - ä¼˜ç‚¹ï¼šé›¶æ¥å£å˜æ›´ï¼›èŒè´£æ¸…æ™°ï¼ˆæé†’æ›´æ–°ä»èµ°ä¸“ç”¨æ¥å£ï¼‰ï¼›å›å½’é¢å°ã€‚
  - ç¼ºç‚¹ï¼šéœ€è¦åœ¨ VM ä¸­å¤„ç†æ›´å¤šåˆ†æ”¯ï¼›â€œä¸¤æ­¥å†™å…¥ï¼ˆå†…å®¹+æé†’ï¼‰â€éä¸¥æ ¼åŸå­ã€‚
- æ–¹æ¡ˆCï¼šå¼•å…¥ TaskUpdate DTOï¼Œç²¾ç¡®è¡¨è¾¾â€œæ›´æ–°å“ªäº›å­—æ®µâ€
  - ä¼˜ç‚¹ï¼šå¯æ‰©å±•ã€è¡¨è¾¾åŠ›å¼ºã€‚
  - ç¼ºç‚¹ï¼šé‡æ„é‡å¤§ã€è¶…å‡ºæœ¬æ¬¡ä¿®å¤æ€§ä»·æ¯”ã€‚

### 8.4 æ¨èä¸ç†ç”±
- æ¨èä¼˜å…ˆè½åœ°æ–¹æ¡ˆBï¼ˆä¸æ”¹æ¥å£ã€å®Œå–„é‡è°ƒåº¦ï¼‰ï¼š
  - å˜æ›´æœ€å°ã€ä¸å½“å‰èŒè´£åˆ’åˆ†ä¸€è‡´ï¼ˆæé†’æ›´æ–°èµ°ä¸“ç”¨æ¥å£ï¼‰ï¼Œä¾¿äºç°åº¦ä¸å›æ»šï¼›
  - å¯è¦†ç›– dueAt-only çš„å¸¸è§ä¿®æ”¹åœºæ™¯ï¼Œé¿å…é—æ¼é‡è°ƒåº¦ï¼›
  - è‹¥åç»­æ˜ç¡®éœ€è¦â€œä¸€æ¬¡ç¼–è¾‘åŸå­æ›´æ–°æ‰€æœ‰å­—æ®µâ€ï¼Œå†æ¼”è¿›è‡³æ–¹æ¡ˆAã€‚

### 8.5 é£é™©ä¸è¾¹ç•Œ
- null è¯­ä¹‰ä¿æŒï¼š`null=ç»§æ‰¿å…¨å±€`ï¼Œé¿å…è¯¯å°† null å½“â€œæœªä¿®æ”¹â€ã€‚å»ºè®®åœ¨ VM ä¿ç•™â€œåˆå§‹å€¼å¿«ç…§â€ä½œå·®å¼‚åˆ¤æ–­ã€‚
- dueAt-onlyï¼šå½“å‰ VM çš„é‡è°ƒåº¦è§¦å‘æ¡ä»¶ä¸ºâ€œå­˜åœ¨è‡ªå®šä¹‰æé†’å­—æ®µï¼ˆéç©ºï¼‰â€ã€‚è‹¥ä»»åŠ¡å¤„äºâ€œç»§æ‰¿å…¨å±€(null)â€ä¸”ä»…æ”¹ dueAtï¼Œæ˜¯å¦éœ€è¦æŒ‰å…¨å±€è®¾ç½®é‡è°ƒåº¦ï¼Ÿå»ºè®®åœ¨æ–‡æ¡£ä¸­æ˜ç¡®ç­–ç•¥ï¼Œå¹¶åœ¨ VM ä¸­å®ç°å¯¹åº”åˆ†æ”¯ã€‚
- æ—¶åŒº/DSTï¼šå›ºå®šæ—¶é—´è®¡ç®—åŸºäºç³»ç»Ÿæ—¶åŒºï¼Œè·¨æ—¶åŒºæˆ–å¤ä»¤æ—¶æ—¥ç•Œåˆ‡æ¢åœºæ™¯å»ºè®®è¡¥å……ä¸“é—¨ç”¨ä¾‹ã€‚

### 8.6 æ–‡æ¡£ä¿®è®¢å»ºè®®
- å°†â€œRepository å±‚æ•°æ®è¦†ç›–æé†’å­—æ®µâ€è¡¨è¿°è°ƒæ•´ä¸ºâ€œUpdate ç”¨ä¾‹ç¼ºæé†’å‚æ•°ï¼Œå¯¼è‡´æ— æ³•ä¸€æ¬¡åŸå­æ›´æ–°æé†’è®¾ç½®â€ï¼Œä¸ç°å®ç°æ›´è´´åˆï¼ˆ`updateTodo` ä¸ä¼šä¸»åŠ¨æ¸…ç©ºæé†’å­—æ®µï¼‰ã€‚
- æ˜ç¡® dueAt-only çš„é‡è°ƒåº¦ç­–ç•¥ï¼ˆå«å…¨å±€æé†’å¼€å¯æ—¶çš„å¤„ç†ï¼‰ï¼Œå¹¶åœ¨â€œ4.2 è‡ªæµ‹ç”¨ä¾‹â€æ–°å¢ä¸€æ¡ dueAt-only åœºæ™¯ç”¨ä¾‹ã€‚

### 8.7 éªŒè¯ä¸è‡ªæµ‹å»ºè®®
- æ„å»ºä¸ç¼–è¯‘ï¼š`./gradlew :feature:todo:compileDebugKotlin`
- ç”¨ä¾‹è¡¥å……ï¼š
  - ç”¨ä¾‹3ï¼ˆdueAt-onlyï¼‰ï¼šåŸä»»åŠ¡æé†’=ç»§æ‰¿å…¨å±€(null)ï¼Œå…¨å±€æé†’=å¼€å¯ï¼›ä»…ä¿®æ”¹ dueAt â†’ æœŸæœ›é‡ç®—å¹¶é‡è°ƒåº¦ã€‚
  - ç”¨ä¾‹4ï¼ˆå›ºå®šæ—¶é—´+DSTï¼‰ï¼š`reminderTime=08:00`ï¼ŒdueAt è·¨ DST åˆ‡æ¢æ—¥ â†’ æœŸæœ›è§¦å‘æ—¶åˆ»æ­£ç¡®ã€‚
- æ–­è¨€è¦ç‚¹ï¼š
  - æ•°æ®ï¼štasks è¡¨æé†’å­—æ®µä¸ dueAt ä¸€è‡´æ€§ï¼›
  - è°ƒåº¦ï¼šå…ˆå–æ¶ˆåé‡æ’æ— é‡å¤ï¼›WorkManager/é˜Ÿåˆ—å­˜åœ¨å¯¹åº”è®¡åˆ’ã€‚

### 8.8 é€‚ç”¨èŒƒå›´
- ä»…å½±å“ Todo æ¨¡å—ï¼ˆdomain/usecaseã€data/repositoryã€presentationï¼‰ï¼Œé€šçŸ¥è®¿é—®ä»é€šè¿‡ shared/notificationï¼Œå¯¹è·¨æ¨¡å—ä¾èµ–æ— é¢å¤–å½±å“ï¼›ç¬¦åˆ"appâ†’featureâ†’sharedâ†’core"çš„ä¾èµ–æ–¹å‘è¦æ±‚ã€‚

## ä¹ã€Ultrathinkæ·±åº¦æŠ€æœ¯å¤è¯„ï¼ˆ2025-10-09ï¼‰

### 9.1 è¯„å®¡æ–¹æ³•ä¸èŒƒå›´
- è¯„å®¡æ–¹æ³•ï¼šåŸºäºå®é™…ä»£ç åˆ†æï¼Œè€Œéä»…æ–‡æ¡£ç†è®ºè¯„ä¼°
- ä»£ç è¦†ç›–ï¼šUpdateTodoUseCaseã€TodoRepositoryImplã€AddEditTaskViewModelã€TodoNotificationUseCaseã€AddTodoUseCase
- é‡ç‚¹å…³æ³¨ï¼šé—®é¢˜è¯Šæ–­å‡†ç¡®æ€§ã€æ–¹æ¡ˆå¯è¡Œæ€§ã€æ¶æ„ä¸€è‡´æ€§

### 9.2 é—®é¢˜éªŒè¯ï¼ˆåŸºäºä»£ç ï¼‰

#### æ ¸å¿ƒé—®é¢˜ç¡®è®¤ âœ…
**UpdateTodoUseCaseç¼ºå°‘æé†’å‚æ•°**ï¼ˆfeature/todo/domain/usecase/UpdateTodoUseCase.kt:23-28ï¼‰
```kotlin
suspend operator fun invoke(
    todoId: String,
    title: String,
    description: String? = null,
    dueAt: Instant? = null,
    priority: Int = 0
    // âŒ ç¼ºå°‘ï¼šreminderEnabled, reminderMinutesBefore, reminderTime
)
```

**æ–‡æ¡£é—®é¢˜æè¿°100%å‡†ç¡®** - ä»£ç éªŒè¯å®Œå…¨å»åˆ

#### ä¸¤æ­¥å†™å…¥é—®é¢˜åˆ†æ ğŸ”´
AddEditTaskViewModel.saveTask()ï¼ˆç¬¬128-187è¡Œï¼‰å­˜åœ¨é€»è¾‘ç¼ºé™·ï¼š

1. **ç¼–è¾‘æ¨¡å¼é—®é¢˜**ï¼š
   - ç¬¬ä¸€æ­¥ï¼šupdateTodoUseCaseï¼ˆä¸å«æé†’ï¼‰
   - ç¬¬äºŒæ­¥ï¼šæ¡ä»¶æ€§updateTaskReminder
   - æ¡ä»¶ï¼š`if (state.reminderEnabled != null || state.reminderMinutesBefore != null || state.reminderTime != null)`

2. **å®é™…é—®é¢˜åœºæ™¯**ï¼š
   - ç”¨æˆ·åªæ”¹æ ‡é¢˜ï¼Œreminderå­—æ®µéƒ½æ˜¯null
   - ä¸è¿›å…¥æ¡ä»¶åˆ¤æ–­
   - æé†’ä¸ä¼šé‡æ–°è°ƒåº¦ï¼Œå³ä½¿dueAtæ”¹å˜

#### æ¶æ„ä¸ä¸€è‡´æ€§ âš ï¸
- **AddTodoUseCase**ï¼šUseCaseå±‚å¤„ç†äºŒæ®µå¼é€»è¾‘ï¼ˆç¬¬52-60è¡Œï¼‰
- **ç¼–è¾‘åŠŸèƒ½**ï¼šViewModelå±‚å¤„ç†äºŒæ®µå¼é€»è¾‘ï¼ˆç¬¬153-187è¡Œï¼‰
- **é—®é¢˜**ï¼šèŒè´£åˆ’åˆ†æ··ä¹±ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™

### 9.3 æ–¹æ¡ˆBå¯è¡Œæ€§æ·±åº¦åˆ†æ

#### nullè¯­ä¹‰é—®é¢˜
å½“å‰è®¾è®¡ï¼š`null = ç»§æ‰¿å…¨å±€`

**æŠ€æœ¯ç¼ºé™·**ï¼š
1. nullæ—¢è¡¨ç¤º"æœªä¿®æ”¹"åˆè¡¨ç¤º"ç»§æ‰¿å…¨å±€"
2. ViewModelæ— æ³•åŒºåˆ†"ç”¨æˆ·æœªè§¦ç¢°"å’Œ"ç”¨æˆ·è®¾ç½®ä¸ºnull"
3. ç¼ºå°‘åˆå§‹çŠ¶æ€è¿½è¸ªæœºåˆ¶

#### äº‹åŠ¡åŸå­æ€§é£é™©
- ä¸¤æ­¥å†™å…¥éåŸå­æ“ä½œ
- ç¬¬ä¸€æ­¥æˆåŠŸã€ç¬¬äºŒæ­¥å¤±è´¥ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- Repositoryå±‚æœªä½¿ç”¨@Transactionæ³¨è§£

### 9.4 æ”¹è¿›å»ºè®®ï¼ˆåŸºäºä»£ç ç»“æ„ï¼‰

#### æ¨èï¼šæ··åˆä¼˜åŒ–æ–¹æ¡ˆ

**æ­¥éª¤1ï¼šViewModelçŠ¶æ€è¿½è¸ª**
```kotlin
data class AddEditTaskUiState(
    // æ–°å¢ï¼šåˆå§‹æé†’çŠ¶æ€
    val initialReminderEnabled: Boolean? = null,
    val initialReminderMinutesBefore: Int? = null,
    val initialReminderTime: String? = null,
    val reminderModified: Boolean = false
)
```

**æ­¥éª¤2ï¼šæ™ºèƒ½æ›´æ–°é€»è¾‘**
```kotlin
fun saveTask() {
    if (state.taskId != null) {
        updateTodoUseCase(...)

        val shouldUpdateReminder = when {
            state.reminderModified -> true
            state.dueAt != initialDueAt && hasCustomReminder() -> true
            state.dueAt != initialDueAt && isUsingGlobalReminder() -> true
            else -> false
        }

        if (shouldUpdateReminder) {
            updateAndScheduleReminder(...)
        }
    }
}
```

**æ­¥éª¤3ï¼šRepositoryäº‹åŠ¡ä¿è¯**
```kotlin
@Transaction
suspend fun updateTodoWithReminder(
    todoId: String,
    todoUpdate: TodoUpdate,
    reminderUpdate: ReminderUpdate?
) {
    updateTodo(todoId, todoUpdate)
    reminderUpdate?.let { updateTaskReminder(todoId, it) }
}
```

### 9.5 æµ‹è¯•ç”¨ä¾‹è¡¥å……å»ºè®®

```kotlin
@Test
fun `ç¼–è¾‘ä»»åŠ¡ä»…æ”¹æ ‡é¢˜æ—¶_å·²æœ‰æé†’åº”ä¿æŒä¸å˜`() {
    // Given: ä»»åŠ¡æœ‰è‡ªå®šä¹‰æé†’ï¼ˆæå‰30åˆ†é’Ÿï¼‰
    // When: åªä¿®æ”¹æ ‡é¢˜
    // Then: æé†’è®¾ç½®å’Œè°ƒåº¦ä¿æŒä¸å˜
}

@Test
fun `ç¼–è¾‘ä»»åŠ¡æ”¹dueAtæ—¶_æé†’åº”é‡æ–°è®¡ç®—`() {
    // Given: ä»»åŠ¡ä½¿ç”¨ç›¸å¯¹æ—¶é—´æé†’
    // When: ä¿®æ”¹dueAt
    // Then: reminderAtåº”é‡æ–°è®¡ç®—ï¼Œé€šçŸ¥é‡æ–°è°ƒåº¦
}

@Test
fun `å›ºå®šæ—¶é—´æé†’è·¨DSTè¾¹ç•Œæ—¶_è®¡ç®—æ­£ç¡®`() {
    // Given: reminderTime="09:00", dueAtè·¨DST
    // When: è®¡ç®—reminderAt
    // Then: è€ƒè™‘æ—¶åŒºå˜åŒ–
}
```

### 9.6 è¯„åˆ†ä¿®æ­£ï¼ˆåŸºäºä»£ç åˆ†æï¼‰

| è¯„ä¼°ç»´åº¦ | æ–‡æ¡£è¯„åˆ† | ä»£ç è¯„åˆ† | ä¿®æ­£ç†ç”± |
|---------|---------|----------|----------|
| é—®é¢˜è¯Šæ–­å‡†ç¡®æ€§ | - | 10/10 | ä¸ä»£ç 100%å»åˆ |
| æ–¹æ¡ˆå¯è¡Œæ€§ | 8/10 | 6/10 | æ–¹æ¡ˆBåœ¨å½“å‰ä»£ç ç»“æ„ä¸‹å›°éš¾ |
| æ¶æ„ä¸€è‡´æ€§ | 9/10 | 7/10 | æ–°å»ºå’Œç¼–è¾‘æ¨¡å¼ä¸ä¸€è‡´ |
| é£é™©è¯†åˆ« | 7/10 | 9/10 | å‡†ç¡®è¯†åˆ«ä¸¤æ­¥å†™å…¥é£é™© |
| æµ‹è¯•è¦†ç›– | 6/10 | 5/10 | ç¼ºå°‘å…³é”®è¾¹ç•Œæµ‹è¯• |

**æ€»ä½“è¯„åˆ†ï¼š7.5/10**ï¼ˆåŸ8.0/10ï¼‰

### 9.7 å…³é”®å‘ç°ä¸å»ºè®®

**æ ¸å¿ƒå‘ç°**ï¼š
1. âœ… æ–‡æ¡£é—®é¢˜åˆ†ææå…¶å‡†ç¡®
2. âš ï¸ æ–¹æ¡ˆBå®æ–½ç»†èŠ‚éœ€è¦è°ƒæ•´
3. ğŸ”´ æ¶æ„ä¸€è‡´æ€§éœ€è¦æ”¹è¿›

**æ‰§è¡Œå»ºè®®**ï¼š
1. **çŸ­æœŸ**ï¼šé‡‡ç”¨æ··åˆä¼˜åŒ–æ–¹æ¡ˆï¼ŒViewModelå¢åŠ çŠ¶æ€è¿½è¸ª
2. **ä¸­æœŸ**ï¼šç»Ÿä¸€æ¶æ„ï¼Œè®©UpdateTodoUseCaseæ”¯æŒæé†’å‚æ•°
3. **é•¿æœŸ**ï¼šå»ºç«‹å®Œæ•´çš„å˜æ›´æ£€æµ‹å’Œäº‹åŠ¡æœºåˆ¶

**æŠ€æœ¯æ•™è®­**ï¼š
> "æŠ€æœ¯æ–¹æ¡ˆå¿…é¡»åŸºäºå®é™…ä»£ç ï¼Œè€Œéç†è®ºåˆ†æ"
> "æœ€å¥½çš„ä»£ç æ˜¯ç¬¦åˆå›¢é˜Ÿé£æ ¼çš„ä»£ç " - æ–‡æ¡£ä½œè€…ç†è§£æ·±åˆ»ï¼Œä½†éœ€æ›´è´´è¿‘ä»£ç å®é™…

### 9.8 é£é™©ä¸è¾¹ç•Œï¼ˆä»£ç å±‚é¢ï¼‰

**æœªè¦†ç›–çš„æŠ€æœ¯é£é™©**ï¼š
1. WorkManager 100ä¸ªä»»åŠ¡é™åˆ¶æœªå¤„ç†
2. å¹¶å‘ç¼–è¾‘åŒä¸€ä»»åŠ¡çš„å†²çªæ£€æµ‹ç¼ºå¤±
3. é€šçŸ¥æƒé™åŠ¨æ€å˜åŒ–çš„é™çº§ç­–ç•¥æœªå®šä¹‰
4. ç½‘ç»œæ–­å¼€æ—¶çš„ç¦»çº¿å¤„ç†æœºåˆ¶ä¸æ˜ç¡®

**éœ€è¦ç«‹å³ä¿®å¤**ï¼š
- Repositoryå±‚æ·»åŠ @Transactionæ³¨è§£
- ViewModelæ·»åŠ åˆå§‹çŠ¶æ€è¿½è¸ª
- å®Œå–„nullè¯­ä¹‰å¤„ç†ï¼ˆå»ºè®®ä½¿ç”¨å¯†å°ç±»ï¼‰
