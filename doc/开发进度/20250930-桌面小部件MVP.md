# 记账桌面小部件 MVP 开发方案（v2025-09-30）

本文档定义记账模块桌面小部件（Android App Widget）的首版实现标准（MVP）。用于指导研发按步骤落地，保障范围、功能、技术方案与验收一致，避免跑偏。

## 1. 目标与范围
- 目标
  - 在桌面提供“记账概览”小部件：一眼看到今日/本月收入支出，总览当前账本。
  - 提供一键“＋记一笔”入口，直达应用内“快速记账弹窗”（已存在）。
  - 支持多实例（多个小部件同时存在），并能为每个小部件绑定不同账本。
- 范围（MVP）
  - 样式：默认 2×2 尺寸；支持 4×2 拓展但不强制首发。
  - 展示数据：今日收入、今日支出、本月收入、本月支出、账本名。
  - 交互：
    - 点击“＋记一笔”→ 打开 `QuickLedgerActivity`。
    - 点击统计区域 → 打开 App 记账首页（或指定页面）。
    - 点击刷新图标 → 立即刷新数据。
  - 刷新机制：每日自动刷新、记账完成事件刷新、手动刷新。
- 非目标（MVP不做）
  - 趋势图/预算条/储蓄率图形化展示（放二期）。
  - Compose Glance 小部件（后续技术栈统一时迁移）。
  - 跨设备/云端同步的小部件配置迁移。

## 2. 用户场景（验收参考）
1) 用户早上查看桌面 → 看到“今日 0 / 本月支出 2,345 元”。
2) 午餐后点击“＋记一笔” → 打开快速记账弹窗 → 3 秒内完成。
3) 完成记账 5 秒内，小部件数字更新；若无网络也显示上次结果。
4) 同时放置两个小部件，分别绑定“家庭账本”“旅行账本”，互不影响。

## 3. 交互与 UI 要求
- 组件元素（2×2 默认）：
  - 标题行：账本名（如：家庭账本） + 右上角刷新按钮。
  - 主体：
    - 左侧：今日 收入/支出 两行数字。
    - 右侧：本月 收入/支出 两行数字。
  - 底部：主操作按钮“＋记一笔”。
- 文案/格式
  - 金额单位：元；千位分隔，≥10,000 可简写“2.3万”。
  - 空态：用“—”表示无数据；账本不可用时提示“未选择账本”。
- 明暗色/可读性
  - 跟随系统浅色/深色；文本对比度 ≥ 4.5:1。
- 触控目标
  - 关键点击区≥ 40dp；按钮≥ 44dp 高。

## 4. 架构与技术方案
- 现有基础
  - 工程已有 AppWidget 栈（倒计时小部件），可复用注册/资源路径。
  - 记账数据完整：`TransactionRepository` 提供日/月统计；`LedgerUIPreferencesRepository` 提供默认账本；`QuickLedgerActivity` 已实现。
- 方案概览
  - 使用 `AppWidgetProvider` + `RemoteViews` 实现视图与交互。
  - 使用 `WorkManager`（HiltWorker）拉取数据、组装 RemoteViews 并统一更新。
  - 多实例支持：按 `appWidgetId` 保存/读取该实例绑定的账本ID；新增配置页绑定账本。
- 模块职责
  - Provider：响应系统更新/手动刷新/点击事件，转发给 Worker；首装回调打开配置页。
  - Worker（Hilt 注入）：读取每个实例的偏好 → 取统计 → 更新所有目标实例。
  - 配置页（Activity）：选择账本 → 保存映射 → 立刻触发更新 → 结束。

## 5. 数据来源与口径
- 今日统计（本地时间 00:00–24:00）：
  - `TransactionRepository.getDailyTotalsByLedger(ledgerId, startDate, endDate)` 获取 Map，取当天键。
- 本月统计（本地自然月）：
  - `TransactionRepository.getMonthlyIncomesAndExpensesByLedger(ledgerId, year, month)` → Pair(收入, 支出)。
- 账本选择：
  - 每个 widget 独立保存 ledgerId；若未配置，则回退到 `LedgerUIPreferencesRepository.getUIPreferences().selectedLedgerId` 或默认账本。

## 6. 文件与目录清单（MVP 新增）
1) Provider 与动作常量
   - `app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetProvider.kt`
   - `app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetActions.kt`
2) Worker（数据拉取与更新）
   - `app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetUpdateWorker.kt`
3) 配置页（多实例账本选择）
   - `app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetConfigActivity.kt`
4) 资源
   - `app/src/main/res/xml/ledger_widget_info.xml`（小部件声明）
   - `app/src/main/res/layout/ledger_widget.xml`（小部件布局）
   - `app/src/main/res/values/strings_widget_ledger.xml`（文案）
   - `app/src/main/res/drawable/ic_widget_refresh.xml`（刷新图标，或复用）
5) Manifest 注册
   - 在 `app/src/main/AndroidManifest.xml` 中添加 `<receiver>` 与 `<activity>`（配置页）。
6) 偏好存储（沿用 DataStore）
   - 工具类：`app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetPreferences.kt`

## 7. 详细实现步骤
### 7.1 RemoteViews 布局（`ledger_widget.xml`）
- 结构：
  - 顶部：`TextView tvLedgerName`（左） + `ImageView btnRefresh`（右）。
  - 中部：两列四行（今日收入/支出；本月收入/支出）→ `TextView` 四个。
  - 底部：`TextView/FrameLayout btnQuickAdd`（整行点击）。
- 可点击区通过 `setOnClickPendingIntent` 绑定到 Provider 的自定义 Action。

### 7.2 Provider（`LedgerWidgetProvider`）
- 监听：
  - `onUpdate(...)`：收到系统更新 → 读取传入 `appWidgetIds` → 启动 Worker，输入 `KEY_WIDGET_IDS`。
  - `onReceive(...)`：处理手动刷新 `ACTION_REFRESH`、点击统计区 `ACTION_OPEN_APP`、点击“＋记一笔” `ACTION_QUICK_ADD`。
  - `onEnabled/onDisabled`：第一个添加/最后一个移除时的日志与清理。
- 首次添加配置：
  - `android:configure=".presentation.widget.ledger.LedgerWidgetConfigActivity"`（在 xml info 中声明），进入配置页绑定账本。

### 7.3 Worker（`LedgerWidgetUpdateWorker`）
- Hilt 注入：`TransactionRepository`、`LedgerUIPreferencesRepository`、`DataStore<Preferences>`。
- 输入：
  - 可选 `KEY_WIDGET_IDS`（仅更新这些）；为空时更新当前组件的所有实例。
- 逻辑：
  1) 获取目标 `appWidgetIds`（来自输入或 `AppWidgetManager` 查询 self `ComponentName`）。
  2) 对每个 `id`：
     - 读取映射 ledgerId → 若空则回退到 UI 偏好或默认账本。
     - 拉取“今日/本月”收入支出。
     - 组装 `RemoteViews`（格式化金额），设置 PendingIntent（刷新、打开首页、快速记账）。
     - `AppWidgetManager.updateAppWidget(id, views)`。
  3) 结束返回 `Result.success`。
- 时间口径：本地时区；“今日”按 0 点–24 点。“本月”按自然月。

### 7.4 多实例配置页（`LedgerWidgetConfigActivity`）
- 打开时从 `Intent` 读取 `AppWidgetManager.EXTRA_APPWIDGET_ID`。
- 展示账本列表（简洁列表即可，取自用例/仓库）。
- 点击确认 → 将选中的 `ledgerId` 保存到 DataStore（Key: `widget_ledger_{id}`）。
- 回写 `RESULT_OK` + `EXTRA_APPWIDGET_ID` → 触发一次 Provider/Worker 更新 → `finish()`。
- 取消时按系统要求返回 `RESULT_CANCELED` 同时删除占位。

### 7.5 偏好存储（`LedgerWidgetPreferences`）
- 使用 `DataStore<Preferences>`，约定 Key：
  - `widget_ledger_{appWidgetId}` → String（ledgerId）
- 提供方法：`getLedgerId(appWidgetId)`、`setLedgerId(appWidgetId, ledgerId)`、`remove(appWidgetId)`、`listWidgetIds()`（可选）。

### 7.6 刷新机制
- 自动（日更）：
  - 小部件 info 中 `android:updatePeriodMillis` 设定为 `86400000`（24h），用于兜底每日刷新。
- 事件驱动：
  - 在“新增交易成功”路径（现有 `AddTransactionUseCase` 完成后）发送本地广播 `ACTION_REFRESH_WIDGET` 或直接排队一次 `LedgerWidgetUpdateWorker`（推荐后者）。
  - 可在 `TransactionRepositoryImpl.addTransaction(...)` 成功后，通过辅助类触发 Worker（注意解耦，可由上层 ViewModel/UseCase 触发）。
- 手动：
  - 刷新按钮绑定 `ACTION_REFRESH` → Provider 启动 Worker。

### 7.7 点击行为
- 打开记账首页：
- 使用 `PendingIntent.getActivity` 指向 `MainActivity`，并带导航参数（如：直达记账页 Tab）。
- ＋记一笔：
  - 指向 `QuickLedgerActivity`，可附带 `pn_direction`（可选：收入/支出默认选项）。

### 7.8 Manifest 与权限
- 在 `app/src/main/AndroidManifest.xml`：
  - 新增 `<receiver android:name=".presentation.widget.ledger.LedgerWidgetProvider" ...>`；
  - 绑定 `<meta-data android:name="android.appwidget.provider" android:resource="@xml/ledger_widget_info"/>`；
  - 注册 `LedgerWidgetConfigActivity`（`exported=false`，主题可用 DialogTheme 或常规 Theme）。
- 无需新增敏感权限；沿用现有即可。

### 7.9 主题与适配
- 遵循系统明暗色；`RemoteViews` 受限，尽量使用中性背景 + 高对比文字。
- 多尺寸：
  - 2×2：核心信息 + 按钮。
  - 4×2（可选）：在右侧增加“本月累计”单行汇总或上次记账时间。
- 本地化：中文首发；英文文案预留。

## 8. 辅助与工具函数
- 金额格式化：`12345` → `12,345`；`123456` → `12.3万`；负数前置 `-`。
- 日期区间：提供“今日起止毫秒”“本月起止毫秒”的工具，避免重复代码。

## 9. 性能与稳定性
- 轻数据：仅取必要汇总，单次 I/O 常量级；避免高频 Work。
- 出错兜底：取数异常时显示“—”，按钮仍可点击；失败日志打印，5–15 分钟以内不自动重试（避免抖动）。
- 电量：以事件驱动为主，`updatePeriodMillis` 仅兜底；不做 15 分钟级别周期。

## 10. 日志与可观测性
- Provider/Worker 关键路径打日志 TAG：`CCXJ/WIDGET`。
- 统计：可在后续埋点（点击率、使用频次）。MVP 暂不接 SDK。

## 11. 验收标准（测试用例）
1) 添加小部件 → 默认显示当前账本名与今日/本月收支；无数据时显示“—”。
2) 点击“＋记一笔” → 打开 `QuickLedgerActivity` 并可正常完成记账。
3) 记账完成后 5 秒内，小部件数字刷新（或点击刷新按钮立即更新）。
4) 添加两个小部件 → 分别绑定不同账本 → 显示不同数据，互不影响。
5) 暗色模式、重启手机、跨天后仍显示正确数据。
6) 权限不弹出异常请求；无网络也能显示上次结果或“—”。

## 12. 风险与应对
- Provider 无法直接 Hilt 注入：采用 HiltWorker 获取数据；Provider 只触发 Worker。
- 多实例账本映射错误：以 `appWidgetId` 为唯一键存储，删除小部件时清理键。
- 品牌桌面差异：布局控件选择系统基础组件，避免复杂自定义视图。
- 频繁刷新耗电：以事件触发为主，日更兜底；避免短周期 Work。

## 13. 时间计划（建议）
- D1：确认文案与布局草图，完成 `ledger_widget.xml` 与 strings。
- D2：Provider / Worker 主流程打通，能显示静态 + 拉真数更新。
- D3：配置页（账本选择）与 DataStore 映射，多实例联调。
- D4：交互完善（点击跳转/刷新）、暗色适配、空态/异常兜底。
- D5：真机联测、验收用例走查、问题修复与代码整理。

## 14. 任务拆分（研发）
- T1 布局与资源：`ledger_widget.xml`、strings、icons（0.5d）
- T2 Provider/Actions：`LedgerWidgetProvider`/`LedgerWidgetActions`（0.5d）
- T3 Worker：`LedgerWidgetUpdateWorker` 数据拉取与更新（1d）
- T4 偏好：`LedgerWidgetPreferences`（0.5d）
- T5 配置页：`LedgerWidgetConfigActivity`（1d）
- T6 事件刷新接入：记账完成后触发小部件更新（0.5d）
- T7 适配与联调：暗色/多尺寸/多实例（1d）
- T8 验收与问题修复（0.5d）

## 15. 回滚与降级策略
- 如 Worker 路径不稳定：临时从 Provider 直接用轻量线程取数更新（不推荐，作为兜底）。
- 如配置页缺陷：可临时默认使用“当前默认账本”，关闭配置入口（临时版本）。

## 16. 后续扩展（第二阶段）
- 展示：预算进度、近7日趋势、储蓄率、信用卡账单倒计时。
- 交互：切换账本上下翻、长按二级菜单（查明细/分类排行）。
- 技术：迁移 Glance（Compose 小部件）、统一主题与样式 token。

---
执行从本方案出发，严格按文件清单与步骤推进；变更需在本文件下追加“变更记录”小节说明，避免偏离范围。
## 8. 刷新可靠性问题与修复方案（2025-10-04）

本节补充记录“新增/删除交易后小部件未及时刷新”的问题、原因与修复方案，归档于MVP范围内的“刷新机制”质量加固。

- 问题现象
  - 执行“新增交易/删除交易”后，桌面小部件未更新今日/本月统计。
  - 日志中无小部件侧日志（Provider/Worker），疑似未触发更新链路。

- 根因分析（高概率）
  - 隐式广播不可靠：当前通过隐式广播告知自家 `AppWidgetProvider`，在部分系统（如 MIUI）与新策略下，非导出接收器的隐式广播可能被抑制，导致 Provider 收不到事件。
  - WorkManager 未初始化：我们移除了默认初始化器（Manifest 中移除 `WorkManagerInitializer`），但 `Application` 未手动初始化，导致 `enqueue` 后台任务不执行。

- 修复方案（不改变UI/交互，提升稳定性）
  1) 将刷新广播改为“仅限本应用的定向广播”
     - 改造 `feature/ledger/.../presentation/widget/WidgetRefreshBroadcaster.send(Context)`：
       - 在 `Intent(ACTION_REFRESH)` 的基础上调用 `intent.setPackage(context.packageName)`，确保仅发送到本应用内匹配的接收器，提升投递可靠性；保留现有 Action，不跨模块引用 `Provider` 类，维持模块边界。
     - 可选：为 Intent 附加去重 `data`（如时间戳 Uri）以降低部分 ROM 的合并/抑制概率。
  2) 显式初始化 WorkManager
     - 在 `app/CcXiaoJiApplication.onCreate()` 中调用：`WorkManager.initialize(this, workManagerConfiguration)`。
     - 保留 `Configuration.Provider + HiltWorkerFactory` 方案，无需恢复默认初始化器。
  3) 轻量日志（便于回归与排障）
     - `WidgetRefreshBroadcaster.send`：打印“发送刷新广播/包名”。
     - `LedgerWidgetProvider.onReceive`：打印 `intent.action / appWidgetId` 与入队结果。
     - `WidgetUpdateScheduler.enqueue*`：打印 workName 与 ids。
     - `LedgerWidgetWorker.doWork`：打印“Worker start/finish”和计算的金额。

- 实施清单（代码路径）
  - `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/widget/WidgetRefreshBroadcaster.kt`
  - `app/src/main/java/com/ccxiaoji/app/CcXiaoJiApplication.kt`
  - 日志增强：
    - `app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetProvider.kt`
    - `app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/WidgetUpdateScheduler.kt`
    - `app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetWorker.kt`

- 测试计划（P0）
  - 新增/删除交易后，桌面小部件在 1–2 秒内更新数据。
  - 设备覆盖：原生 Android、MIUI、华为/荣耀或 OPPO/Vivo 至少三台。
  - 场景：飞行模式→恢复、新旧主题切换、重启手机后第一笔新增、点击小部件“刷新”按钮。
  - 日志链路完整：`Broadcaster → Provider → Scheduler → Worker`。

- 验收标准
  - P95 延时 ≤ 2s；失败率 < 0.1%。
  - 无新增崩溃/卡顿；耗电、前台可见行为无异常。

- 工期与风险
  - 开发 0.5 天；测试 0.5 天；总计 1 天交付。
  - 风险低；若极个别机型仍偶发延迟，保留“刷新”按钮作为兜底；必要时在 `QuickLedgerActivity` 结束新增时再次发送一次刷新广播（当前已有一次）。

- 回滚方案
  - 还原 `WidgetRefreshBroadcaster` 到旧实现；或临时恢复 `WorkManagerInitializer` 默认初始化（撤销 Manifest 移除）。

- 后续可选优化（非本次范围）
  - 引入数据库变更监听直驱刷新，减少广播依赖。
  - 收敛刷新频率，避免高频编辑下的过度入队。
  - 评估 Jetpack Glance 重构时机。

## 9. 与“通知统一方案”的协同与取舍（2025-10-04）

目标：评估是否“借助通知统一方案”的能力来兼容小部件数据更新，保持系统一致性、降低维护成本。

- 参考文档
  - 《2025-10-03｜通知统一方案与进度计划》：统一的 `NotificationApi`（发送/渠道）、`NotificationScheduler`（调度，基于 WorkManager）、监听与诊断能力已落地；业务端通过 Worker 注入 `NotificationApi` 完成提醒。

- 可选路径对比
  - 方案A（推荐）：小部件刷新与通知解耦，仅共享“调度与诊断”的底座
    - 不通过“发送通知”来触发刷新，小部件仍通过广播 + WorkManager 更新（当前修复方案）。
    - 与通知侧在“调度与可观测性”层打通：
      - 约定 Work Tag（如 `tag:widget_refresh`），纳入统一的 Work 监控面板与诊断日志，便于排障。
      - 允许 `NotificationScheduler` 在“每日检查”中顺带安排一次“日切刷新”（不展示通知）。
    - 优点：用户无多余通知噪音；职责清晰；代码更少。
    - 缺点：仍保留一套小部件专用的触发链路（广播）。
  - 方案B：完全纳入通知调度器，由 `NotificationScheduler` 统一编排小部件刷新
    - 触发新增/删除事件时，不再发广播，而是直接向统一调度器提交一次性 `WidgetRefreshWorker`。
    - 优点：统一入口，少一层广播；所有后台任务统一治理。
    - 缺点：需要将小部件刷新入口上提到 `app/notification` 层，跨模块耦合上升；对现有代码改动更大；无法降低小部件对 WorkManager 的依赖本质问题。
  - 方案C：通过“发送一条静默通知”触发刷新（不推荐）
    - 用通知作为“信号”，到达后再执行刷新。
    - 缺点：复杂、易被系统策略影响；可能造成误触与噪音；背离通知的“用户可见提醒”定位。

- 结论与落地建议
  - 采用方案A：保持“小部件刷新链路”与“通知发送链路”解耦，仅共享 WorkManager 调度与诊断底座。
  - 在小部件刷新任务中使用统一的 Tag 与日志规范，方便在同一诊断面板查看运行情况。
  - 在“每日检查”（NotificationScheduler 日常任务）中追加一次“日切刷新”安排作为兜底，不展示通知，避免用户感知干扰。

> 注：以上不改变用户体验与UI，仅提升稳定性与可运维性；后续如转向 Glance/完全统一后台编排，再评估融合为单一入口（方案B）。

## 10. 实施状态与验收结果（2025-10-04）

- 已实施清单（代码路径）
  - 显式组件广播（替代隐式广播）：
    - feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/widget/WidgetRefreshBroadcaster.kt
  - 显式初始化 WorkManager（Manifest 移除默认初始化器后补齐）：
    - app/src/main/java/com/ccxiaoji/app/CcXiaoJiApplication.kt
  - Provider 增强（日志 + 1.5 秒去抖，避免短时间重复刷新）：
    - app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/LedgerWidgetProvider.kt
  - 调度增强（统一 Tag + 日志，便于诊断）：
    - app/src/main/java/com/ccxiaoji/app/presentation/widget/ledger/WidgetUpdateScheduler.kt
  - 去重触发（移除快速记账页面的重复广播，改为仅仓库层触发）：
    - feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/presentation/quickadd/QuickLedgerActivity.kt
  - 每日兜底（不展示通知，跨天自动全量刷新）：
    - app/src/main/java/com/ccxiaoji/app/notification/NotificationWorkers.kt（DailyCheckWorker）

- 协同方案落地结论
  - 采纳“方案A”（与通知解耦，仅共享调度与诊断底座）。
  - 已在 DailyCheckWorker 中追加“日切刷新兜底”，不展示通知。
  - 小部件刷新任务统一打 Tag（tag:widget_refresh），可在 WorkManager 统一观测。

- 验收结果（真机日志验证）
  - 新增/删除交易后，刷新链路完整且稳定：Broadcaster → Provider → Scheduler → Worker → updateAppWidget。
  - 时延：约 1–2 秒；1.5 秒内重复触发被去抖丢弃；间隔较长的第二次触发功能正确但可观察，后续根据反馈评估是否进一步“运行态判重”。
  - 跨天场景：每日兜底生效，保障自然日切换后的正确展示。

- 风险与后续（不阻塞发布）
  - 如仍观察到“几秒后第二次刷新”，可在 Provider 入队前查询 tag:widget_refresh 的 RUNNING/ENQUEUED 状态以跳过再次入队；或微调去抖窗口（当前 1.5 秒）。
  - 中长期可评估迁移至 Glance，或在 NotificationScheduler 统一编排时再收敛入口（保持现状稳定优先）。

