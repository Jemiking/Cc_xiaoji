# 自动记账两挡模式（方案A）实施方案（上架前精简版｜更新：全自动软关闭）

> 目的：将自动记账相关设置精简为“总开关 + 模式选择”。当前按甲方要求“全自动软关闭”，仅展示与生效“半自动”，保留回退能力，本文同步记录变更供后续恢复使用。

---

## 一、背景与目标
- 当前问题：模式与开关碎片化（方案A/通用自动/一键记账/固定账本/来源策略/开发者调试等），用户心智复杂、维护成本高。
- 目标（上架前）：
  - 用户仅见两项：
    - 自动记账“总开关”
    - 模式选择“半自动/全自动”
  - 其他参数全部内置安全默认值，不对外暴露。
  - 保持现有功能稳定，尽量小改、快交付。

## 二、范围
- 涉及模块：feature/ledger（通知驱动自动记账流）、app（DeepLink/Manifest/NavGraph）。
- 不变更：定期交易（RecurringTransaction）、账本/分类/账户等既有能力。

## 三、用户体验（对外行为）
- 半自动记账：
  1) 监听到微信/支付宝等支付通知 → 弹出高优先通知（横幅）。
  2) 点击通知主体 → 直接进入“添加账单页面”（AddTransactionScreen）。
  3) 用户确认后保存。
  4) 不再弹出“快速记账对话框”；不再提供“一键记账”按钮。
- 全自动记账（软关闭）：
  - 保留实现但默认不生效；设置页隐藏“模式选择”，改为“当前模式：半自动（全自动软关闭）”。
- 权限与渠道：
  - 保留“通知权限/渠道直达”入口，确保横幅可达与状态通知可见。

## 四、默认策略与安全护栏（隐藏，内置）
- 去重：开启；时间窗口 20s；屏蔽电商聚合摘要/订单关键词/包级黑名单。
- 自动创建（仅“全自动”模式生效）：
  - 置信度阈值：0.85；最小金额：100 分（1 元）。
  - 方向限制：Refund/Transfer/Unknown 不自动创建（改走半自动）。
- 撤销保护：成功通知后 30s 撤销窗口；编辑入口保留。
- 账户/分类选取：优先“上一次使用” → 回退默认/首个可用；记账簿使用默认账本。
- 调试/日志：全部关闭（仅 Debug 构建保留调试面板入口）。

## 五、架构与代码改动清单（按文件）

### 1) 设置页与 ViewModel（仅保留两项）
- 文件：
  - feature/ledger/presentation/screen/settings/AutoLedgerSettingsScreen.kt
  - feature/ledger/presentation/viewmodel/AutoLedgerSettingsViewModel.kt
- 改动：
  - UI 仅显示：
    - “启用自动记账”（Switch）
    - “模式选择”（Radio：半自动/全自动）
    - 保留“通知渠道设置”入口；移除其它所有开关（去重窗口/关键词透传/固定账本/来源策略/开发者设置等）。
  - ViewModel 仅维护：
    - `auto_ledger_global_enabled`（总开关）
    - `auto_ledger_mode`（"SEMI"/"FULL"）
  - 其余 DataStore 键不再读写（改为 AutoLedgerManager 内部常量）。
  - AutoLedgerDeveloperSettingsScreen 不在 Release 导航中曝光（文件保留，Debug 可隐藏入口打开）。

### 2) 半自动记账统一为“通知 → 添加页”
- 文件：
  - feature/ledger/domain/service/AutoLedgerNotificationManager.kt
  - feature/ledger/domain/service/AutoLedgerBroadcastReceiver.kt
  - app/src/main/AndroidManifest.xml（DeepLink 与 Receiver 声明）
  - app/src/main/java/com/ccxiaoji/app/presentation/ui/navigation/NavGraph.kt（DeepLink 到 AddTransactionScreen）
- 改动：
  - 半自动通知仅提供“点击主体跳转添加页”的行为：使用 DeepLink `ccxiaoji://app/add_transaction?...` 传入预填参数。
  - 移除“一键记账”Action/RemoteInput 相关逻辑与分支。
  - BroadcastReceiver 仅保留 `ACTION_UNDO`、`ACTION_EDIT`；移除 `ACTION_MANUAL_CONFIRM`、`ACTION_QUICK_SAVE`。
  - QuickLedgerActivity/Dialog/ViewModel 不再被引用（代码保留以便 Debug 回退）。

### 3) 全自动（过渡实现：应用内自动创建）
- 文件：feature/ledger/domain/usecase/AutoLedgerManager.kt
- 改动：
  - 仅读取：`auto_ledger_global_enabled` 与 `auto_ledger_mode`。
  - 当 `mode == FULL` 时启用“自动创建”分支；`mode == SEMI` 时强制走半自动通知。
  - 移除“支付宝方案A”“一键记账”等复杂分支与多键订阅；内置常量：
    - `CONF_THRESHOLD = 0.85f`、`MIN_AMOUNT_CENTS = 100`
    - 方向为 Refund/Transfer/Unknown 则降级半自动。
  - 去重逻辑保留（窗口 20s），不提供 UI 调整。
  - “上一次使用”写入保留，用于后续推荐优先源。

### 4) 撤销与来源标记（短中期）
- 短期：UndoWorker 继续使用备注包含 `#auto` 作为“自动创建”识别（幂等保障）。
- 中期建议（不需 DB 迁移）：
  - AddTransactionUseCase 支持可选“来源元数据”入参（sourceApp/sourceType/postedTime/confidence/parserVersion）。
  - AutoLedgerManager 在自动创建时传入来源数据；UndoWorker 改以 `sourceType != null` 判别自动创建，去除对备注的依赖。

## 六、数据与配置
- DataStore 对外键（仅两项）：
  - `auto_ledger_global_enabled`：Boolean
  - `auto_ledger_mode`：String（"SEMI" / "FULL"）
- 其它全部转为内部常量，不对外暴露。

## 七、测试计划（手动验证清单）
- 半自动模式：
  - 微信/支付宝通知 → 横幅出现 → 点击跳转 AddTransactionScreen → 预填金额/方向/商户 → 保存成功。
  - 20s 内重复通知仅处理一次（验证去重）。
- 全自动模式：
  - 满足阈值与最小金额 → 自动创建 → 弹“已自动记账”通知 → 30s 内撤销成功。
  - 方向为 Refund/Transfer/Unknown → 不自动创建，改走半自动通知。
- 渠道/权限：
  - 提示渠道（高优先）可横幅显示；状态渠道（低优先）正常显示；未授权提示可达。
- 回归：
  - 手动记账不受影响；分类/账户/账本选择正常；统计/账本数据正确；无崩溃与明显卡顿。

## 八、风险与回滚
- 自动误记：置信度阈值 + 最小金额 + 方向过滤 + 去重 + 撤销窗口的多重护栏；默认阈值偏保守。
- DeepLink 跳转失败：Manifest 与 NavGraph 已配置；必要时 Debug 可回退到弹窗路径（Release 不启用）。
- 回滚策略：按工作包小步提交，可快速切回“半自动模式”并关闭总开关。

## 九、里程碑与时间计划
- M1（1–2 天）：设置页/VM 精简；半自动统一（通知→添加页）；清理广播“一键记账”；落地默认常量。
- M2（1–2 天）：全自动过渡（应用内自动创建）打磨；撤销/去重联调；手动回归与小范围体验验证。
- M3（规划）：无障碍“全自动”设计与 PoC；准备替换过渡实现。

## 十、交付物与验收标准
- 代码改动（上述文件清单）与版本说明：
  - 仅两项设置可见；其余参数不可见但行为符合默认策略。
  - 半自动统一为“通知→添加页”；全自动具备撤销窗口与方向/阈值护栏。
- 文档与构建：
  - 本文（方案与实施）+ `版本切换快速参考.md` 更新自动记账相关说明。
  - 构建命令：`./gradlew :app:assembleDebug` / `assembleRelease`。
- 验收：按“测试计划”逐条走通；出现问题可按“回滚策略”恢复到半自动。

---

### 附：术语与决策
- “全自动（过渡）”：当前指应用内直接创建（非无障碍填表）；上架后在后续版本替换为 AccessibilityService 实现的“真全自动”，对用户无感知（仅底层实现切换）。
- “固定账本/来源策略/开发者面板”等：本方案中默认关闭或仅 Debug 保留入口，不面向用户。
