# 2025-09-30 记账模块布局替换方案与迁移计划（Demo → 主模块）

本文档沉淀“在不破坏现有功能的前提下，用 Demo 的新布局逐步替换当前记账模块布局”的实施方案、阶段计划与验收口径，确保可灰度、可回退、可持续迁移后续页面。

## 背景与目标
- 背景：当前 Demo（钱迹风格）视觉与交互更贴近目标体验，未来希望替换现有记账模块布局。
- 目标：不改动业务能力与数据结构的前提下，引入新布局；全程支持开关切换新/旧布局，确保异常时可即时回退。

## 总体策略（推荐路线）
- 新布局做成“可切换皮肤”的外壳：仅负责 UI 展示，不承载业务逻辑。
- 复用现有 ViewModel 与 UseCase：状态（UiState）与事件（UiEvent）由既有代码提供。
- 引入“布局开关”（Feature Flag）：在关键入口根据开关选择渲染新/旧布局，实现灰度与回退。
- Demo 仅用于假数据预览；真正集成在主模块目录下，通过现有 ViewModel 驱动真实数据。

## 实施方法
- UI 契约
  - 为要替换的页面定义无业务的 Composable（仅接收 `UiState` + `UiEvent`/回调）。
  - 示例：`LedgerBooksV2Screen(state: BooksUiState, onEvent: BooksUiEvent)`。
- 目录与命名约定
  - 新布局放在主模块：`feature/ledger/src/main/.../presentation/screen/v2/...`。
  - Demo 下保留 Preview 页面（假数据），便于设计迭代。
- 连接现有 ViewModel
  - 由既有 ViewModel 负责拼装 `UiState`，并实现事件回调（如设默认、删除、新建）。
  - 禁止在新布局中直连仓库或写业务逻辑，避免双实现。
- 功能开关（灰度）
  - 临时：使用 BuildConfig/本地常量开关。
  - 正式：将开关持久化至 `LedgerUIPreferencesRepository`，在“界面风格设置”中暴露；或在“开发者设置”中提供开关。
  - 接入点：`feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/api/LedgerApiImpl.kt` 各 `get*Screen(...)` 入口，根据开关渲染 V1/V2。
- 样式统一
  - 复用 `DesignTokens`，将 Demo 的色值/间距抽到 Token，避免两套样式体系并存。

## 迁移范围与优先级
一期（2–3 周）：我的账本（记账簿管理）
- 目标：用新布局替换 Demo“我的账本”视觉，同时对接现有“记账簿管理”能力（增/改/删/设默认/排序/空态/错误态）。
- 交付物：
  - `LedgerBooksV2Screen` 及对应 `UiState/UiEvent`；
  - 接线 `LedgerBookManagementViewModel`；
  - LedgerApi 开关切换；
  - 文案、本地化与暗色模式适配；
  - 基础 UI 自动化用例（导航/设默认/删除保护）。
- 验收标准：
  - 新旧切换即时生效，功能等价；
  - 默认账本不可删除；
  - 排序持久化生效（`displayOrder`）。

二期（3–4 周）：主页与抽屉头部
- 目标：替换主页顶部区域与抽屉头部的新视觉（状态栏、封面、账本切换器），账单列表沿用现有逻辑。
- 交付物：
  - `LedgerHeaderV2`, `LedgerDrawerHeaderV2`；
  - 统计概览卡片 V2（接 `GetLedgerStatsUseCase`）；
  - LedgerApi 开关切换；
  - 灰度放量与问题回归表。
- 验收标准：
  - 主路径（记一笔、筛选、返回）无回退问题；
  - 抽屉切换账本一致、无状态错乱。

三期（按需）：分类管理视觉统一 + 高级功能预研
- 目标：
  - 分类管理采用新视觉细节（提示、长截屏兼容）并保留既有能力；
  - 高级功能（隐藏账本、迁移账本、清除账单、成员权限）拆分为独立需求评审与技术方案，不阻塞布局迁移。
- 验收标准：
  - 视觉统一，不降低原有操作路径与性能。

## 关键缺口与后续工作（不阻塞布局替换）
- 隐藏/恢复账本
  - 方案：新增 `isHidden` 字段与“已隐藏账本”管理页；短期使用“软删 isActive”替代，不对用户暴露“隐藏”。
- 迁移账本
  - 方案：新增 UseCase，实现批量将交易迁移到目标账本；分类与成员策略需界定（建议：保留原分类，复制共享成员）。
- 清除账单
  - 方案：按账本+日期范围批量删除，危险操作双确认，提供结果统计与撤销窗口（若有变更日志/回收站机制更佳）。
- 成员与权限
  - 方案：定义成员模型与角色权限（读/记账/管理），拉通邀请/移除流程；现阶段不纳入布局替换范围。

## 风险与回退
- 风险：新布局早期与旧逻辑契合度不足、边界态遗漏、性能抖动。
- 回退：任何时刻通过“布局开关”回到旧布局；切换后不丢失用户状态。
- 降风险手段：
  - 新布局仅做“外壳”，不复制业务；
  - 小步灰度、对关键路径设监控（崩溃、交互时长）。

## 测试与验证
- 用例清单：
  - 记账簿：新建/编辑/设默认/删除/排序/空态/失败重试；
  - 主页：切换账本、记一笔、筛选、返回、系统返回键；
  - 抽屉：打开/关闭、账本切换、导航到设置/分类/预算；
  - 暗色模式与多语言；
  - 开关：新/旧布局来回切换后状态一致。
- 自动化建议：为导航与关键按钮加 UI 测试桩；仓库层沿用既有单测。

## 时间与里程碑（初稿）
- 一期：T0~T0+3 周（布局+接线+灰度+回归）。
- 二期：T0+3~T0+7 周（主页头部/抽屉+统计卡片+放量）。
- 三期：评审通过后纳入版本里程碑。

## 任务清单（持续更新）

一期：我的账本（记账簿管理）
- [ ] 新建 v2 目录骨架（`presentation/screen/v2/...`）与 `v2/playground`（debug 变体）
- [ ] 定义 `BooksUiState`/`BooksUiEvent` 接口（仅 UI 所需字段/事件）
- [ ] 实现 `LedgerBooksV2Screen(state, onEvent)`（仅 UI 外壳、含加载/空态/错误态）
- [ ] 接线 `LedgerBookManagementViewModel` → 适配 `BooksUiState/UiEvent`
- [ ] 行为落实：新建、重命名、设为默认、删除（双确认、默认不可删）、排序持久化
- [ ] 将 Demo 色值/间距并入 `DesignTokens`，统一明暗色
- [ ] `LedgerApiImpl`：为记账簿管理入口增加“新布局开关”分支
- [ ] “开发者设置”新增“新布局试用”开关，持久化到 `LedgerUIPreferencesRepository`
- [ ] UI 自动化：
  - [ ] 设为默认成功与默认不可删校验
  - [ ] 排序后重进页面顺序一致
  - [ ] 新建/重命名/删除流程通过
- [ ] 灰度方案与回退预案记录（用例清单/问题回归表模板）

二期：主页头部与抽屉头部
- [ ] 定义并实现 `LedgerHeaderV2`、`LedgerDrawerHeaderV2`（状态栏适配、封面、账本切换器）
- [ ] 集成至 `LedgerScreen`：仅替换头部与抽屉头部，账单列表沿用现有实现
- [ ] 接入 `GetLedgerStatsUseCase` 渲染概览卡片 V2（性能与闪烁校验）
- [ ] `LedgerApiImpl`：为主屏入口增加“新布局开关”分支（可独立只开头部）
- [ ] UI 自动化：
  - [ ] 抽屉切换账本后主屏状态与统计正确
  - [ ] 记一笔/筛选/返回关键路径无回退问题
- [ ] 灰度放量与问题回归表更新

Playground 与接线（跨期支撑）
- [ ] 在 debug 变体暴露 `v2/playground` 路由，便于真数据联调
- [ ] 在 App NavGraph 或 `LedgerApiImpl` 增加 Playground 调试入口
- [ ] 统一文案与多语言资源抽取，补齐 contentDescription 与可达性


## 相关代码定位（便于接线）
- API 出入口（开关切换）：
  - `feature/ledger/src/main/kotlin/com/ccxiaoji/feature/ledger/api/LedgerApiImpl.kt`
- 记账簿管理能力：
  - `.../presentation/screen/ledgerbook/LedgerBookManagementScreen.kt`
  - `.../presentation/viewmodel/LedgerBookManagementViewModel.kt`
  - `.../domain/usecase/ManageLedgerUseCase.kt`
  - `.../data/repository/LedgerRepositoryImpl.kt`
- 主屏与抽屉：
  - `.../presentation/screen/ledger/LedgerScreen.kt`
  - `.../presentation/component/ledger/LedgerDrawerContent.kt`
- 样式：
  - `core/ui/.../DesignTokens.kt`

---
说明：本方案优先保障“可用+可回退”，先替换布局外壳，再逐步纳入高级功能；过程中任何新增业务能力（如迁移/清除/成员）需单独评审与落地方案。

## Demo 框架决策与集成方式（新增）
- 不调整 Demo 的导航/依赖注入框架。Demo 仅作为“样式/交互预览”与假数据演示，不承载业务逻辑。
- 在主模块内（debug 构建变体）新增 V2 Playground，用于在真实依赖注入与导航下联调新布局。
- 新布局以“V2 组件（仅 UI 外壳）”形态并入主模块，由现有 ViewModel/UseCase 提供状态与事件，避免业务重复实现。
- 在 `LedgerApiImpl.get*Screen(...)` 出入口增加“新布局开关”，实现新/旧布局灰度切换与快速回退。

## Playground 落地清单（可执行）
- 目录与路由
  - 在主模块新增 `presentation/screen/v2/playground` 入口（仅 debug 构建变体编译）。
  - 通过 App NavGraph 或在 `LedgerApiImpl` 增加调试路由接入 Playground。
- 组件与状态
  - 建立 `LedgerBooksV2Screen`、`LedgerHeaderV2`、`LedgerDrawerHeaderV2` 组件与 Preview，只负责 UI。
  - 使用现有 `LedgerBookManagementViewModel` 驱动“我的账本（记账簿）”真实数据；其他页面按阶段接线。
- 构建与开关
  - 仅在 debug 变体暴露 Playground；
  - 在“开发者设置”新增“新布局试用”开关，持久化到 `LedgerUIPreferencesRepository`；
  - 在 `LedgerApiImpl.get*Screen(...)` 根据开关选择 V1/V2 实现。
- 样式与资源
  - 将 Demo 的色值、间距抽取并合并到 `DesignTokens`；校验暗色模式一致性。
- 验收与测试
  - 验收：新/旧切换即时生效；记账簿新建/编辑/设默认/删除保护/排序；主页头部与抽屉切换账本稳定。
  - 测试：为关键导航与按钮补 UI 测试桩；建立灰度回归检查清单与问题回归表模板。

## 页面迁移模板（逐项勾选清单，复制使用）

基本信息
- [ ] 页面名称：<页面名>
- [ ] 关联入口/路由：<LedgerApiImpl.getXxxScreen 或 App NavGraph 路由>
- [ ] 所属期次与优先级：<一期/二期/三期>，<P0/P1/P2>

视觉与资源
- [ ] Demo 预览完成（路径 + 截图链接）：<feature/ledger/src/debug/...>
- [ ] 设计 Token 抽取完成（颜色/间距/圆角/字号）：已合入 `DesignTokens`
- [ ] 图标资源映射完成（如需，更新 `doc/图标/icons_manifest.json`）
- [ ] 明/暗色模式检查通过

v2 组件（仅 UI 外壳）
- [ ] 新建组件：`presentation/screen/v2/<Page>V2Screen.kt`
- [ ] 定义 `UiState` 字段：<列出关键字段>
- [ ] 定义 `UiEvent`/回调：<列出关键事件>
- [ ] 空态/加载/错误态规范完成
- [ ] 无障碍：contentDescription、触达区域、对比度校验
- [ ] 多语言：strings.xml 覆盖中文/英文（或按现有策略）

接线与开关
- [ ] 选用现有 ViewModel：<ViewModel 名称>
- [ ] `ViewModel -> UiState` 映射完成
- [ ] `UiEvent -> ViewModel` 方法映射完成
- [ ] debug 变体 Playground 路由挂载
- [ ] `LedgerApiImpl` 出入口增加“新布局开关”分支
- [ ] 开关持久化：`LedgerUIPreferencesRepository`（键：`ui_new_layout_<page>` 或全局）

行为校验（关键路径）
- [ ] 导航往返正确（系统返回键/应用返回一致）
- [ ] 主要操作：<列出，如新建/保存/删除/设默认/排序/筛选>
- [ ] 保护规则：默认不可删、危险操作双确认、权限限制

自动化与回归
- [ ] UI 自动化用例：<列出用例名或路径>
- [ ] 回归清单：关键场景与预期结果已记录

性能与稳定
- [ ] 首帧/渲染时间评估（与旧版对比）
- [ ] 滚动/交互流畅度检查（掉帧监控）
- [ ] 崩溃/异常监控接入（如有）

灰度与回退
- [ ] 灰度计划：范围/时间/观察指标
- [ ] 回退路径：关闭开关即时回退验证
- [ ] 风险与应对：<列出>

验收标准
- [ ] 新旧功能等价（不缺关键能力）
- [ ] 视觉规范一致（Token 应用一致）
- [ ] 可灰度、可回退、切换不丢状态

变更记录
- [ ] 日期/负责人/备注：<yyyy-MM-dd / name / note>
