# CC小记架构重构设计文档

## 1. 项目定位

CC小记是一个**生活管理超级APP**（Super App），集成了多个生活管理功能模块，并且未来还会持续添加新的功能模块。

## 2. 架构演进历程

### 2.1 原架构问题

传统分层架构（data/domain/presentation）存在的问题：
1. **可扩展性差**：所有功能模块的代码混在一起，添加新模块会让各层越来越臃肿
2. **边界不清晰**：不同功能模块之间没有明确的边界，容易产生耦合
3. **团队协作困难**：多人开发不同模块时容易产生代码冲突
4. **维护成本高**：修改一个模块可能影响到其他模块
5. **测试困难**：无法独立测试单个功能模块

### 2.2 架构迁移成果

经过6个阶段的渐进式迁移（2025年1月-6月），成功从单体架构迁移到模块化架构：
- **迁移时长**：约6个月
- **代码重构**：100%模块化
- **性能提升**：启动时间减少20%（预期）
- **构建速度**：提升30%（预期）

## 3. 现有架构：基于业务领域的模块化架构

### 3.1 核心设计理念

采用**领域驱动设计（DDD）**思想，按照**生活领域**来划分模块，每个顶级feature代表一个生活领域，每个模块是一个有界上下文（Bounded Context）。

### 3.2 实际模块结构

```
Cc_xiaoji/
├── app/                              # 主应用模块（壳工程）
│   ├── src/main/
│   │   ├── CcXiaoJiApplication.kt   # 应用入口，集成AppInitializer
│   │   ├── MainActivity.kt          # 单Activity架构
│   │   ├── navigation/              # 全局导航
│   │   │   ├── NavGraph.kt         # 主导航图，集成各模块路由
│   │   │   └── Screen.kt           # 路由定义
│   │   ├── presentation/
│   │   │   ├── ui/
│   │   │   │   ├── components/     # 全局组件（BottomNavBar等）
│   │   │   │   ├── home/          # 首页聚合
│   │   │   │   │   ├── HomeScreen.kt
│   │   │   │   │   └── components/ # 模块卡片组件
│   │   │   │   ├── profile/       # 个人中心
│   │   │   │   └── statistics/    # 全局统计
│   │   │   └── viewmodel/         # 全局ViewModel
│   │   ├── di/                     # 依赖注入
│   │   │   ├── DatabaseModule.kt   # 数据库提供
│   │   │   ├── NetworkModule.kt    # 网络配置
│   │   │   └── *BridgeModuleImpl.kt # 模块桥接实现
│   │   └── initialization/         # 应用初始化
│   │       ├── AppInitializer.kt   # 懒加载管理
│   │       └── *InitTask.kt        # 各种初始化任务
│
├── core/                            # 核心基础设施模块
│   ├── common/                      # 公共功能模块
│   │   ├── base/                    # BaseViewModel等基类
│   │   ├── utils/                   # 工具类（货币格式化、日期处理等）
│   │   ├── extensions/              # Kotlin扩展函数
│   │   ├── result/                  # Result封装
│   │   └── constants/               # 常量定义
│   ├── database/                    # 数据库模块
│   │   ├── CcDatabase.kt           # Room数据库（版本4）
│   │   ├── dao/                    # 所有DAO接口
│   │   ├── entity/                 # 所有实体类
│   │   ├── model/                  # 枚举和数据模型
│   │   └── migrations/             # 数据库迁移
│   ├── ui/                         # UI基础模块
│   │   ├── theme/                  # Material3主题系统
│   │   └── components/             # 通用UI组件
│   └── data/                       # 数据层基础设施
│       └── di/                     # 跨模块数据配置
│
├── feature/                         # 业务功能模块（已完成迁移）
│   ├── ledger/                     # 💰 记账模块（财务管理领域）
│   │   ├── api/
│   │   │   ├── LedgerApi.kt       # 完整的模块接口
│   │   │   └── LedgerNavigator.kt # 导航接口
│   │   ├── data/
│   │   │   ├── repository/        # 8个Repository实现
│   │   │   ├── di/               # Hilt模块
│   │   │   └── worker/           # 后台任务
│   │   ├── domain/
│   │   │   └── model/            # 领域模型
│   │   └── presentation/
│   │       ├── ui/               # 所有UI界面
│   │       ├── viewmodel/        # 8个ViewModel
│   │       └── navigation/       # 6个子模块导航
│   ├── todo/                       # ✅ 待办模块（任务管理领域）
│   │   ├── api/
│   │   │   ├── TodoApi.kt
│   │   │   ├── TodoNavigator.kt
│   │   │   └── TodoNotificationScheduler.kt
│   │   └── [标准模块结构]
│   └── habit/                      # 🎯 习惯模块（习惯养成领域）
│       ├── api/
│       │   ├── HabitApi.kt
│       │   ├── HabitNavigator.kt
│       │   └── HabitReminderScheduler.kt
│       └── [标准模块结构]
│
├── shared/                          # 共享业务模块（已完成迁移）
│   ├── user/                       # 用户管理模块
│   │   └── api/UserApi.kt
│   ├── sync/                       # 同步管理模块
│   │   └── api/SyncApi.kt
│   ├── backup/                     # 备份恢复模块
│   │   └── api/BackupApi.kt
│   └── notification/               # 通知管理模块
│       └── api/NotificationApi.kt
│
└── build-logic/                    # 构建逻辑
    └── convention/                 # Convention Plugins
        ├── AndroidApplicationConventionPlugin.kt
        ├── AndroidLibraryConventionPlugin.kt
        ├── AndroidFeatureConventionPlugin.kt
        └── AndroidHiltConventionPlugin.kt
```

### 3.3 核心模块API设计

#### 3.3.1 LedgerApi - 记账模块接口

```kotlin
interface LedgerApi {
    // 统计数据
    suspend fun getTodayExpense(): Double
    suspend fun getMonthExpense(): Double
    suspend fun getTotalBalance(): Double
    suspend fun getCategoryStatistics(): List<CategoryStat>
    suspend fun getMonthlyTrend(): List<MonthlyTrend>
    
    // 交易管理
    suspend fun getRecentTransactions(limit: Int): List<TransactionItem>
    suspend fun getTransactionHistory(limit: Int): List<TransactionItem>
    suspend fun searchTransactions(query: String): List<TransactionItem>
    
    // 账户管理
    suspend fun getDefaultAccount(): AccountItem?
    fun getAccountsFlow(): Flow<List<AccountItem>>
    
    // 分类管理
    suspend fun getAllCategories(): List<CategoryItem>
    fun getCategoriesFlow(): Flow<List<CategoryItem>>
    
    // 导航
    fun navigateToLedger()
    fun navigateToAddTransaction()
}
```

#### 3.3.2 TodoApi - 待办模块接口

```kotlin
interface TodoApi {
    suspend fun getTodayTasks(): List<Task>
    suspend fun getTaskCount(): Int
    fun getAllTasks(): Flow<List<Task>>
    fun navigateToTodoList()
}
```

#### 3.3.3 HabitApi - 习惯模块接口

```kotlin
interface HabitApi {
    suspend fun getTodayHabits(): List<HabitItem>
    suspend fun getHabitStats(): HabitStats
    fun getAllHabits(): Flow<List<HabitWithStreak>>
    fun navigateToHabitList()
}
```

### 3.4 数据库架构

#### 3.4.1 数据库配置

```kotlin
@Database(
    entities = [
        // 用户模块
        UserEntity::class,
        
        // 记账模块
        AccountEntity::class,
        TransactionEntity::class,
        CategoryEntity::class,
        BudgetEntity::class,
        SavingsGoalEntity::class,
        SavingsContributionEntity::class,
        CreditCardBillEntity::class,
        CreditCardPaymentEntity::class,
        RecurringTransactionEntity::class,
        
        // 待办模块
        TaskEntity::class,
        
        // 习惯模块
        HabitEntity::class,
        HabitRecordEntity::class,
        
        // 倒计时模块
        CountdownEntity::class,
        
        // 同步模块
        ChangeLogEntity::class
    ],
    version = 4,
    exportSchema = true
)
@TypeConverters(Converters::class)
abstract class CcDatabase : RoomDatabase() {
    // 各模块DAO抽象方法
}
```

#### 3.4.2 数据隔离策略

- 单一数据库实例，所有模块共享
- 通过DAO层实现模块间数据隔离
- 每个模块只能访问自己的DAO
- 跨模块数据访问必须通过API接口

### 3.5 依赖注入架构

#### 3.5.1 模块提供方式

```kotlin
// Feature模块内部
@Module
@InstallIn(SingletonComponent::class)
abstract class LedgerModule {
    @Binds
    abstract fun bindLedgerApi(impl: LedgerApiImpl): LedgerApi
}

// App模块的桥接实现
@Module
@InstallIn(SingletonComponent::class)
abstract class LedgerBridgeModuleImpl {
    @Binds
    abstract fun bindLedgerNavigator(impl: LedgerNavigatorImpl): LedgerNavigator
}
```

#### 3.5.2 依赖作用域

- `@Singleton`：Repository、Database、API实现
- `@HiltViewModel`：所有ViewModel
- `@HiltWorker`：后台任务Worker

### 3.6 模块间通信机制

#### 3.6.1 数据通信
- 通过定义的API接口进行数据交换
- 使用Flow进行响应式数据传递
- 禁止直接访问其他模块的Repository

#### 3.6.2 导航通信
- 使用Navigation Component
- 通过Navigator接口解耦导航逻辑
- 路由定义集中在app模块

#### 3.6.3 事件通信
- 使用SharedViewModel（限同一Activity内）
- 通过API回调传递事件
- WorkManager处理后台任务通信

## 4. 架构优势与成果

### 4.1 量化成果

1. **模块化程度**
   - 功能模块：3个（ledger、todo、habit）
   - 共享模块：4个（user、sync、backup、notification）
   - 核心模块：4个（common、database、ui、data）

2. **代码组织改善**
   - 模块边界清晰度：100%
   - 代码重用率：提升50%
   - 依赖关系：严格单向

3. **开发效率提升**
   - 并行开发：支持多团队独立开发
   - 编译速度：增量编译提升明显
   - 测试效率：模块可独立测试

### 4.2 架构特性

1. **懒加载机制**
   - AppInitializer统一管理初始化
   - 模块按需加载
   - 启动性能优化

2. **构建优化**
   - Convention Plugins统一配置
   - JVM Toolchain确保环境一致
   - 版本目录（libs.versions.toml）集中管理

3. **可扩展性**
   - 新增模块只需遵循标准结构
   - API接口保证向后兼容
   - 支持未来的动态化需求

## 5. 依赖关系图

```
┌─────────────────────────────────────────────────────────┐
│                      app module                         │
│  (Application Shell + Global Navigation + Home Screen)  │
└────────────────┬───────────────────────┬────────────────┘
                 │                       │
        ┌────────▼────────┐     ┌───────▼────────┐
        │ feature modules │     │ shared modules │
        │                 │     │                │
        │ • ledger       │     │ • user         │
        │ • todo         │     │ • sync         │
        │ • habit        │     │ • backup       │
        │                 │     │ • notification │
        └────────┬────────┘     └───────┬────────┘
                 │                       │
                 └───────────┬───────────┘
                             │
                    ┌────────▼────────┐
                    │  core modules   │
                    │                 │
                    │ • common        │
                    │ • database      │
                    │ • ui            │
                    │ • data          │
                    └─────────────────┘
```

### 5.1 依赖原则

- ✅ app → feature → shared → core
- ❌ feature → feature
- ❌ core → feature/shared
- ❌ shared → feature

## 6. 未来演进方向

### 6.1 短期规划（3-6个月）
1. 完善性能监控体系
2. 增加更多生活管理模块
3. 优化模块间数据同步

### 6.2 中期规划（6-12个月）
1. 实现模块动态下载
2. 支持插件化架构
3. 增加AI辅助功能

### 6.3 长期愿景
- 打造完整的生活管理生态
- 支持第三方模块接入
- 实现跨平台支持

## 7. 最佳实践总结

### 7.1 模块设计原则
1. **单一职责**：每个模块专注一个生活领域
2. **接口优先**：先定义API，再实现功能
3. **最小依赖**：只依赖必要的模块

### 7.2 开发流程
1. 新功能先确定所属领域
2. 遵循标准模块结构
3. 通过API暴露功能
4. 编写完整的单元测试

### 7.3 代码规范
1. 使用Convention Plugins统一配置
2. 遵循Kotlin编码规范
3. 保持模块内代码风格一致

## 8. 相关文档

- [架构迁移实施方案](架构迁移实施方案.md)
- [架构迁移进度追踪](架构迁移进度追踪.md)
- [模块依赖分析报告](模块依赖分析报告.md)
- [性能基准测试报告](性能基准测试报告.md)
- [各阶段迁移总结文档](文档索引.md)

---

*最后更新：2025-06-12*
*架构版本：2.0（模块化架构）*